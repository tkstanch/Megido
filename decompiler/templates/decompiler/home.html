{% extends 'base.html' %}
{% load static %}

{% block title %}Decompiler - Browser Extension Analysis{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-primary-600 dark:hover:text-primary-400">Megido Security</a>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Decompiler</span>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Home</span>
    </nav>

    <!-- Hero Section -->
    <div class="card bg-gradient-to-br from-primary-500 to-primary-600 text-white">
        <div class="card-body text-center">
            <h1 class="text-3xl font-bold mb-2">{{ title }}</h1>
            <p class="text-primary-100">{{ description }}</p>
        </div>
    </div>

    <!-- Development Notice -->
    <div class="card border-l-4 border-green-500 bg-green-50 dark:bg-green-900/20">
        <div class="card-body">
            <h3 class="text-xl font-semibold text-green-800 dark:text-green-200 mb-3">‚úÖ Production Ready</h3>
            <p class="text-green-700 dark:text-green-300">
                All decompilation, analysis, and traffic-inspection features are fully implemented and ready to use.
                Supports 14 extension formats including Chrome CRX, Firefox XPI, WASM, Electron ASAR, userscripts, and more.
            </p>
        </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-4xl font-bold text-primary-600 dark:text-primary-400">{{ total_packages }}</div>
                <div class="text-gray-600 dark:text-gray-400 mt-1">Extension Packages</div>
                <a href="{% url 'decompiler:list_packages' %}" class="text-sm text-primary-600 dark:text-primary-400 hover:underline">View all ‚Üí</a>
            </div>
        </div>
        <div class="card text-center">
            <div class="card-body">
                <div class="text-4xl font-bold text-green-600 dark:text-green-400">{{ jobs_by_status.completed|default:0 }}</div>
                <div class="text-gray-600 dark:text-gray-400 mt-1">Completed Jobs</div>
                {% if jobs_by_status.in_progress %}
                <div class="text-sm text-yellow-600 dark:text-yellow-400">{{ jobs_by_status.in_progress }} in progress</div>
                {% endif %}
            </div>
        </div>
        <div class="card text-center">
            <div class="card-body">
                <div class="text-4xl font-bold text-blue-600 dark:text-blue-400">{{ total_analyses }}</div>
                <div class="text-gray-600 dark:text-gray-400 mt-1">Analyses Completed</div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Quick Actions</h2>
        </div>
        <div class="card-body flex flex-wrap gap-3">
            <a href="{% url 'decompiler:upload_package' %}"
               class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 font-medium">
                ‚¨Ü Upload Extension
            </a>
            <a href="{% url 'decompiler:list_packages' %}"
               class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-300 font-medium">
                üì¶ Browse Packages
            </a>
            <a href="{% url 'decompiler:list_traffic' %}"
               class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-300 font-medium">
                üåê Traffic Intercepts
            </a>
            <a href="{% url 'decompiler:list_techniques' %}"
               class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-300 font-medium">
                üîç Obfuscation Techniques
            </a>
        </div>
    </div>

    <!-- Recent Packages -->
    {% if recent_packages %}
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Recent Packages</h2>
        </div>
        <div class="card-body">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-left text-gray-500 dark:text-gray-400 border-b dark:border-gray-700">
                        <th class="pb-2">Name</th>
                        <th class="pb-2">Type</th>
                        <th class="pb-2">Status</th>
                        <th class="pb-2">Uploaded</th>
                    </tr>
                </thead>
                <tbody>
                {% for pkg in recent_packages %}
                    <tr class="border-b dark:border-gray-700">
                        <td class="py-2">
                            <a href="{% url 'decompiler:get_package' pkg.package_id %}"
                               class="text-primary-600 dark:text-primary-400 hover:underline">
                                {{ pkg.name|truncatechars:40 }}
                            </a>
                        </td>
                        <td class="py-2">
                            <span class="px-2 py-1 rounded-full text-xs bg-gray-100 dark:bg-gray-800">
                                {{ pkg.extension_type }}
                            </span>
                        </td>
                        <td class="py-2">
                            <span class="px-2 py-1 rounded-full text-xs
                                {% if pkg.status == 'analyzed' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400
                                {% elif pkg.status == 'failed' %}bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400
                                {% else %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400{% endif %}">
                                {{ pkg.status }}
                            </span>
                        </td>
                        <td class="py-2 text-gray-500 dark:text-gray-400">{{ pkg.downloaded_at|date:"Y-m-d" }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Recent Jobs -->
    {% if recent_jobs %}
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Recent Jobs</h2>
        </div>
        <div class="card-body">
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-left text-gray-500 dark:text-gray-400 border-b dark:border-gray-700">
                        <th class="pb-2">Package</th>
                        <th class="pb-2">Tool</th>
                        <th class="pb-2">Status</th>
                        <th class="pb-2">Created</th>
                    </tr>
                </thead>
                <tbody>
                {% for job in recent_jobs %}
                    <tr class="border-b dark:border-gray-700">
                        <td class="py-2">{{ job.extension_package.name|truncatechars:30 }}</td>
                        <td class="py-2 text-gray-500 dark:text-gray-400">{{ job.decompiler_tool }}</td>
                        <td class="py-2">
                            <span class="px-2 py-1 rounded-full text-xs
                                {% if job.status == 'completed' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400
                                {% elif job.status == 'failed' %}bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400
                                {% elif job.status == 'in_progress' %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400
                                {% else %}bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400{% endif %}">
                                {{ job.status }}
                            </span>
                        </td>
                        <td class="py-2 text-gray-500 dark:text-gray-400">{{ job.created_at|date:"Y-m-d H:i" }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Key Features -->
    <div class="card">
        <div class="card-header">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Key Features</h2>
        </div>
        <div class="card-body">
            <ul class="space-y-3">
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <span class="text-gray-700 dark:text-gray-300">Upload and capture browser extension packages (Java applets, Flash SWF, Silverlight XAP)</span>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <span class="text-gray-700 dark:text-gray-300">Decompile bytecode to source code using appropriate tools</span>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <span class="text-gray-700 dark:text-gray-300">Detect and defeat obfuscation techniques</span>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <span class="text-gray-700 dark:text-gray-300">Analyze decompiled code for security vulnerabilities and API usage</span>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <span class="text-gray-700 dark:text-gray-300">Intercept and analyze browser extension traffic</span>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <span class="text-gray-700 dark:text-gray-300">Recompile and execute modified code</span>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <span class="text-gray-700 dark:text-gray-300">Inject JavaScript hooks for extension manipulation</span>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <span class="text-gray-700 dark:text-gray-300">Programmatically interact with target web applications</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- Supported Extension Types -->
    <div class="card">
        <div class="card-header">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Supported Extension Types</h2>
        </div>
        <div class="card-body">
            <ul class="space-y-3">
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Java Applets:</strong> .jar and .class files (Decompilers: JAD, CFR, Procyon, Krakatau)
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Flash/ActionScript:</strong> .swf files (Decompiler: JPEXS Free Flash Decompiler)
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Silverlight:</strong> .xap packages (Decompilers: ILSpy, dotPeek)
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">JavaScript:</strong> Browser extensions and scripts
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Workflow Steps -->
    <div class="card">
        <div class="card-header">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Workflow Steps</h2>
        </div>
        <div class="card-body">
            <ul class="space-y-3">
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Step 1:</strong> Download or capture the browser extension bytecode/package
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Step 2:</strong> Detect extension type and select appropriate decompiler
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Step 3:</strong> Decompile bytecode to source code
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Step 4:</strong> Detect obfuscation techniques and attempt deobfuscation
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Step 5:</strong> Analyze source code for APIs, vulnerabilities, and data flows
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Step 6:</strong> Identify JavaScript injection points
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Step 7:</strong> Optionally modify and recompile source code
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Step 8:</strong> Execute in browser or standalone environment
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Traffic Interception -->
    <div class="card">
        <div class="card-header">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Traffic Interception</h2>
        </div>
        <div class="card-body">
            <p class="text-gray-700 dark:text-gray-300 font-semibold mb-4">Obstacles and Solutions:</p>
            <ul class="space-y-3">
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">HTTPS Encryption:</strong> Use proxy tools like mitmproxy with SSL interception
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Certificate Pinning:</strong> Bypass using Frida or modify extension code
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">WebSocket Traffic:</strong> Protocol-aware interception required
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Custom/Binary Protocols:</strong> Implement parsers for AMF, Java serialization, etc.
                    </div>
                </li>
                <li class="flex items-start gap-3 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                    <span class="text-primary-600 dark:text-primary-400 font-bold text-lg">‚ñ∏</span>
                    <div class="text-gray-700 dark:text-gray-300">
                        <strong class="font-semibold">Anti-debugging:</strong> Defeat using code analysis and modification
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- API Endpoints -->
    <div class="card">
        <div class="card-header">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">API Endpoints</h2>
        </div>
        <div class="card-body">
            <p class="text-gray-700 dark:text-gray-300 mb-4">
                All endpoints are fully implemented and ready to use:
            </p>
            <ul class="space-y-2 font-mono text-sm">
                <li class="p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <code class="text-primary-600 dark:text-primary-400">POST /decompiler/packages/upload/</code> ‚Äî Upload extension package
                </li>
                <li class="p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <code class="text-primary-600 dark:text-primary-400">GET /decompiler/packages/</code> ‚Äî List extension packages
                </li>
                <li class="p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <code class="text-primary-600 dark:text-primary-400">POST /decompiler/jobs/start/</code> ‚Äî Start decompilation job
                </li>
                <li class="p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <code class="text-primary-600 dark:text-primary-400">GET /decompiler/jobs/&lt;job_id&gt;/status/</code> ‚Äî Get job status
                </li>
                <li class="p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <code class="text-primary-600 dark:text-primary-400">GET /decompiler/jobs/&lt;job_id&gt;/source/view/</code> ‚Äî View source code
                </li>
                <li class="p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <code class="text-primary-600 dark:text-primary-400">POST /decompiler/analyze/</code> ‚Äî Analyze decompiled code
                </li>
                <li class="p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <code class="text-primary-600 dark:text-primary-400">POST /decompiler/obfuscation/detect/</code> ‚Äî Detect obfuscation
                </li>
                <li class="p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <code class="text-primary-600 dark:text-primary-400">POST /decompiler/hooks/inject/</code> ‚Äî Inject JavaScript hook
                </li>
                <li class="p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <code class="text-primary-600 dark:text-primary-400">GET /decompiler/traffic/</code> ‚Äî List intercepted traffic
                </li>
                <li class="p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <code class="text-primary-600 dark:text-primary-400">POST /decompiler/traffic/capture/</code> ‚Äî Capture traffic
                </li>
                <li class="p-3 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                    <code class="text-primary-600 dark:text-primary-400">POST /decompiler/interact/</code> ‚Äî Interact with web app
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}
