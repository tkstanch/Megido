#!/usr/bin/env python3
"""
Exploit Plugin System Demo

This script demonstrates how to use the Megido exploit plugin system.
"""

import sys
import os
from pathlib import Path

# Add the project root to the path
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

from scanner.plugins import get_registry, get_payload_generator


def print_section(title):
    """Print a section header."""
    print("\n" + "=" * 80)
    print(f"  {title}")
    print("=" * 80)


def demo_plugin_registry():
    """Demonstrate plugin registry functionality."""
    print_section("Plugin Registry Demo")
    
    # Get the global plugin registry
    registry = get_registry()
    
    print(f"\nTotal plugins loaded: {registry.get_plugin_count()}")
    
    # List all available plugins
    print("\nAvailable Plugins:")
    plugins = registry.list_plugins()
    for plugin_info in plugins:
        print(f"\n  Plugin: {plugin_info['name']}")
        print(f"  Type: {plugin_info['vulnerability_type']}")
        print(f"  Version: {plugin_info['version']}")
        print(f"  Description: {plugin_info['description']}")
    
    # Get a specific plugin
    print("\n" + "-" * 80)
    if registry.has_plugin('sqli'):
        print("\nRetrieving SQL Injection Plugin...")
        sqli_plugin = registry.get_plugin('sqli')
        print(f"  Plugin Name: {sqli_plugin.name}")
        print(f"  Severity: {sqli_plugin.get_severity_level()}")
        print(f"  Required Config Keys: {sqli_plugin.get_required_config_keys()}")


def demo_payload_generator():
    """Demonstrate payload generator functionality."""
    print_section("Payload Generator Demo")
    
    # Get the global payload generator
    generator = get_payload_generator()
    
    # Get all supported vulnerability types
    vuln_types = generator.get_all_vulnerability_types()
    print(f"\nSupported Vulnerability Types: {', '.join(sorted(set(vuln_types)))}")
    
    # Get XSS payloads
    print("\n" + "-" * 80)
    print("\nXSS Payloads (first 5):")
    xss_payloads = generator.get_payloads('xss')
    for i, payload in enumerate(xss_payloads[:5], 1):
        print(f"  {i}. {payload}")
    print(f"  ... and {len(xss_payloads) - 5} more")
    
    # Get SQL injection payloads for different databases
    print("\n" + "-" * 80)
    print("\nSQL Injection Payloads:")
    
    for db_type in ['basic', 'mysql', 'postgresql', 'mssql']:
        payloads = generator.get_payloads('sqli', {'database_type': db_type})
        print(f"\n  {db_type.upper()} ({len(payloads)} payloads):")
        for i, payload in enumerate(payloads[:3], 1):
            print(f"    {i}. {payload}")
        if len(payloads) > 3:
            print(f"    ... and {len(payloads) - 3} more")
    
    # Demonstrate payload encoding
    print("\n" + "-" * 80)
    print("\nPayload Encoding:")
    original = '<script>alert(1)</script>'
    print(f"  Original: {original}")
    print(f"  URL:      {generator.encode_payload(original, 'url')}")
    print(f"  Base64:   {generator.encode_payload(original, 'base64')}")
    print(f"  HTML:     {generator.encode_payload(original, 'html')}")


def demo_sqli_plugin():
    """Demonstrate SQL injection plugin functionality."""
    print_section("SQL Injection Plugin Demo")
    
    registry = get_registry()
    
    if not registry.has_plugin('sqli'):
        print("\nSQL Injection plugin not available.")
        return
    
    sqli_plugin = registry.get_plugin('sqli')
    
    # Generate payloads for different contexts
    print("\n1. Generate Basic Payloads:")
    basic_payloads = sqli_plugin.generate_payloads()
    print(f"   Generated {len(basic_payloads)} basic payloads")
    print(f"   Examples: {basic_payloads[:3]}")
    
    print("\n2. Generate MySQL-specific Error-based Payloads:")
    mysql_payloads = sqli_plugin.generate_payloads({
        'database_type': 'mysql',
        'injection_type': 'error'
    })
    print(f"   Generated {len(mysql_payloads)} MySQL payloads")
    print(f"   Examples: {mysql_payloads[:3]}")
    
    print("\n3. Generate Time-based Payloads for PostgreSQL:")
    pg_time_payloads = sqli_plugin.generate_payloads({
        'database_type': 'postgresql',
        'injection_type': 'time'
    })
    print(f"   Generated {len(pg_time_payloads)} PostgreSQL time-based payloads")
    if pg_time_payloads:
        print(f"   Examples: {pg_time_payloads[:3]}")
    
    print("\n4. Remediation Advice:")
    advice = sqli_plugin.get_remediation_advice()
    # Print first 500 characters of advice
    print(f"   {advice[:500]}...")
    
    print("\n5. Plugin Configuration:")
    config_valid = sqli_plugin.validate_config({
        'timeout': 30,
        'verify_ssl': False,
        'enable_error_based': True
    })
    print(f"   Sample config is valid: {config_valid}")
    
    # Demonstrate attack execution (mock example - not actually attacking)
    print("\n6. Mock Attack Execution (example - not actually executed):")
    print("   Target: http://example.com/login")
    print("   Parameter: username")
    print("   Method: POST")
    print("   Note: This is just an example. Real attacks require proper authorization.")


def demo_custom_payloads():
    """Demonstrate adding custom payloads."""
    print_section("Custom Payloads Demo")
    
    generator = get_payload_generator()
    
    # Add custom payloads for a custom vulnerability type
    custom_payloads = [
        'custom_payload_1',
        'custom_payload_2',
        'custom_payload_3',
    ]
    
    print("\nAdding custom payloads for 'custom_vuln' type...")
    generator.add_custom_payloads('custom_vuln', custom_payloads)
    
    # Retrieve the custom payloads
    retrieved = generator.get_payloads('custom_vuln')
    print(f"Retrieved {len(retrieved)} custom payloads:")
    for i, payload in enumerate(retrieved, 1):
        print(f"  {i}. {payload}")
    
    # Get info about the custom payloads
    info = generator.get_payload_info('custom_vuln')
    print(f"\nCustom payload info: {info}")


def main():
    """Main demo function."""
    print("""
╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║                 Megido Exploit Plugin System Demo                            ║
║                                                                              ║
║  This demo showcases the plugin-based exploit registry and payload          ║
║  generator system for attacking vulnerabilities discovered by the scanner.  ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
    """)
    
    try:
        # Demo 1: Plugin Registry
        demo_plugin_registry()
        
        # Demo 2: Payload Generator
        demo_payload_generator()
        
        # Demo 3: SQL Injection Plugin
        demo_sqli_plugin()
        
        # Demo 4: Custom Payloads
        demo_custom_payloads()
        
        print("\n" + "=" * 80)
        print("  Demo Complete!")
        print("=" * 80)
        print("\nFor more information, see EXPLOIT_PLUGINS_GUIDE.md")
        print()
        
    except Exception as e:
        print(f"\nError during demo: {e}")
        import traceback
        traceback.print_exc()
        return 1
    
    return 0


if __name__ == '__main__':
    sys.exit(main())
