#!/usr/bin/env python3
"""
Demo script for enhanced CSRF and Info Disclosure exploit plugins with visual proof capture.

This demonstrates:
1. CSRF plugin capturing screenshots of vulnerable forms and PoC HTML
2. Info Disclosure plugin capturing screenshots of exposed sensitive files
"""

import sys
import json
from scanner.plugins.exploits.csrf_plugin import CSRFPlugin
from scanner.plugins.exploits.info_disclosure_plugin import InfoDisclosurePlugin


def demo_csrf_plugin():
    """Demonstrate CSRF plugin with visual proof capture."""
    print("=" * 80)
    print("CSRF PLUGIN DEMO - Visual Proof Capture")
    print("=" * 80)
    
    plugin = CSRFPlugin()
    print(f"\nPlugin: {plugin.name} v{plugin.version}")
    print(f"Description: {plugin.description}")
    print(f"Severity: {plugin.get_severity_level()}")
    
    # Example vulnerable form scenario
    print("\n--- Simulated CSRF Attack ---")
    
    # In a real scenario, this would be a URL with forms missing CSRF tokens
    target_url = "http://testphp.vulnweb.com/login.php"
    vulnerability_data = {}
    config = {
        'capture_visual_proof': True,
        'verify_ssl': False,
        'timeout': 10
    }
    
    print(f"Target: {target_url}")
    print("\nExecuting CSRF analysis...")
    
    result = plugin.execute_attack(target_url, vulnerability_data, config)
    
    print(f"\nSuccess: {result.get('success')}")
    print(f"Evidence: {result.get('evidence', 'N/A')}")
    
    if result.get('vulnerable_forms'):
        print(f"\nVulnerable Forms: {len(result['vulnerable_forms'])}")
        for i, form in enumerate(result['vulnerable_forms'][:2], 1):
            print(f"\n  Form {i}:")
            print(f"    Action: {form.get('action', 'N/A')}")
            print(f"    Method: {form.get('method', 'N/A')}")
    
    if result.get('visual_proofs'):
        print(f"\n✓ Visual Proofs Captured: {len(result['visual_proofs'])}")
        for i, proof in enumerate(result['visual_proofs'], 1):
            print(f"\n  Proof {i}:")
            print(f"    Type: {proof.get('type')}")
            print(f"    Title: {proof.get('title')}")
            print(f"    Description: {proof.get('description')}")
            print(f"    Data size: {len(proof.get('data', ''))} bytes")
    
    print("\n--- Remediation Advice ---")
    print(plugin.get_remediation_advice())


def demo_info_disclosure_plugin():
    """Demonstrate Info Disclosure plugin with visual proof capture."""
    print("\n\n" + "=" * 80)
    print("INFO DISCLOSURE PLUGIN DEMO - Visual Proof Capture")
    print("=" * 80)
    
    plugin = InfoDisclosurePlugin()
    print(f"\nPlugin: {plugin.name} v{plugin.version}")
    print(f"Description: {plugin.description}")
    print(f"Severity: {plugin.get_severity_level()}")
    
    # Example info disclosure scenario
    print("\n--- Simulated Info Disclosure Attack ---")
    
    # In a real scenario, this would be a URL with exposed sensitive files
    target_url = "http://testphp.vulnweb.com/"
    vulnerability_data = {}
    config = {
        'capture_visual_proof': True,
        'verify_ssl': False,
        'timeout': 10
    }
    
    print(f"Target: {target_url}")
    print("\nScanning for exposed sensitive files...")
    print(f"Testing paths: {', '.join(plugin.SENSITIVE_PATHS[:5])}")
    
    result = plugin.execute_attack(target_url, vulnerability_data, config)
    
    print(f"\nSuccess: {result.get('success')}")
    print(f"Evidence: {result.get('evidence', 'N/A')}")
    
    if result.get('disclosed_info'):
        print(f"\nExposed Files: {len(result['disclosed_info'])}")
        for path, content in list(result['disclosed_info'].items())[:3]:
            print(f"\n  File: {path}")
            print(f"    Content preview: {content[:100]}...")
    
    if result.get('visual_proofs'):
        print(f"\n✓ Visual Proofs Captured: {len(result['visual_proofs'])}")
        for i, proof in enumerate(result['visual_proofs'], 1):
            print(f"\n  Proof {i}:")
            print(f"    Type: {proof.get('type')}")
            print(f"    Title: {proof.get('title')}")
            print(f"    Description: {proof.get('description')}")
            print(f"    File Path: {proof.get('file_path', 'N/A')}")
            print(f"    Data size: {len(proof.get('data', ''))} bytes")
    
    print("\n--- Remediation Advice ---")
    print(plugin.get_remediation_advice())


def demo_payload_generation():
    """Demonstrate payload generation for both plugins."""
    print("\n\n" + "=" * 80)
    print("PAYLOAD GENERATION DEMO")
    print("=" * 80)
    
    # CSRF Payloads
    print("\n--- CSRF Payloads ---")
    csrf_plugin = CSRFPlugin()
    context = {
        'target_url': 'http://example.com/transfer',
        'method': 'POST',
        'parameters': {
            'to_account': '12345',
            'amount': '1000'
        }
    }
    csrf_payloads = csrf_plugin.generate_payloads(context)
    print(f"Generated {len(csrf_payloads)} CSRF payload(s)")
    if csrf_payloads:
        print("\nPoC HTML:")
        print(csrf_payloads[0][:300] + "...")
    
    # Info Disclosure Payloads
    print("\n\n--- Info Disclosure Payloads ---")
    info_plugin = InfoDisclosurePlugin()
    info_payloads = info_plugin.generate_payloads()
    print(f"Generated {len(info_payloads)} sensitive path(s) to test:")
    for i, payload in enumerate(info_payloads[:5], 1):
        print(f"  {i}. {payload}")
    print(f"  ... and {len(info_payloads) - 5} more")


def main():
    """Run all demos."""
    print("\n" + "=" * 80)
    print(" ENHANCED EXPLOIT PLUGINS DEMO - CSRF & INFO DISCLOSURE")
    print(" With Visual Proof Capture")
    print("=" * 80)
    
    try:
        demo_csrf_plugin()
        demo_info_disclosure_plugin()
        demo_payload_generation()
        
        print("\n\n" + "=" * 80)
        print("DEMO COMPLETE")
        print("=" * 80)
        print("\nKey Features Demonstrated:")
        print("✓ CSRF plugin with visual proof of vulnerable forms")
        print("✓ CSRF PoC HTML generation and screenshot capture")
        print("✓ Info Disclosure plugin with visual proof of exposed files")
        print("✓ Automatic screenshot capture of sensitive data")
        print("✓ Comprehensive evidence collection for both vulnerabilities")
        
    except Exception as e:
        print(f"\n❌ Error during demo: {e}")
        import traceback
        traceback.print_exc()
        return 1
    
    return 0


if __name__ == "__main__":
    sys.exit(main())
