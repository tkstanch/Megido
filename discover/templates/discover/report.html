{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    {% if error %}
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-primary-600 dark:hover:text-primary-400">Megido Security</a>
        <span>/</span>
        <a href="/discover/" class="hover:text-primary-600 dark:hover:text-primary-400">Discover</a>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Report</span>
    </nav>

    <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 rounded-lg">
        <h3 class="text-lg font-semibold text-red-800 dark:text-red-300 mb-2">‚ùå Error</h3>
        <p class="text-red-700 dark:text-red-400">{{ error }}</p>
    </div>
    <div class="flex justify-center gap-4 mt-8">
        <a href="/discover/" class="btn btn-primary">‚Üê Back to Discover</a>
    </div>
    {% else %}
    
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-primary-600 dark:hover:text-primary-400">Megido Security</a>
        <span>/</span>
        <a href="/discover/" class="hover:text-primary-600 dark:hover:text-primary-400">Discover</a>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Report</span>
    </nav>
    
    <div class="bg-gradient-to-br from-primary-500 to-purple-600 text-white p-8 rounded-xl shadow-lg text-center">
        <h2 class="text-3xl font-bold mb-4">üìä OSINT Scan Report</h2>
        <div class="text-sm opacity-90 space-y-1">
            <div><strong>Target:</strong> {{ scan.target }}</div>
            <div><strong>Scan Date:</strong> {{ scan.scan_date|date:"Y-m-d H:i" }}</div>
            <div><strong>Results:</strong> {{ scan.total_urls }} URLs | {{ scan.total_emails }} Emails</div>
        </div>
    </div>

    <!-- Wayback Machine Results -->
    <div class="card">
        <div class="card-header">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">{{ results.wayback_machine.title }}</h3>
        </div>
        <div class="card-body space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-primary-500 p-5 rounded-lg whitespace-pre-line leading-relaxed text-gray-700 dark:text-gray-300">
                {{ results.wayback_machine.guidance }}
            </div>
            
            {% if results.wayback_machine.success %}
                <p class="text-gray-900 dark:text-white font-semibold">Found {{ results.wayback_machine.count }} historical URLs</p>
                <ul class="space-y-3">
                    {% for url in results.wayback_machine.data|slice:":20" %}
                    <li class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-primary-500">
                        <div class="space-y-1">
                            <div><strong class="text-gray-900 dark:text-white">Original:</strong> <span class="text-gray-700 dark:text-gray-300">{{ url.original }}</span></div>
                            <div><strong class="text-gray-900 dark:text-white">Archive:</strong> <a href="{{ url.url }}" target="_blank" class="text-primary-600 dark:text-primary-400 hover:underline">{{ url.url }}</a></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Timestamp: {{ url.timestamp }}</div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% if results.wayback_machine.count > 20 %}
                <p class="text-gray-500 dark:text-gray-400 italic text-center py-4">Showing first 20 of {{ results.wayback_machine.count }} URLs</p>
                {% endif %}
            {% else %}
                <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-400 p-4 rounded-lg">
                    {{ results.wayback_machine.error|default:"No URLs found" }}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Shodan Results -->
    <div class="card">
        <div class="card-header">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">{{ results.shodan.title }}</h3>
        </div>
        <div class="card-body space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-primary-500 p-5 rounded-lg whitespace-pre-line leading-relaxed text-gray-700 dark:text-gray-300">
                {{ results.shodan.guidance }}
            </div>
            
            {% if results.shodan.success %}
                <div class="font-mono bg-gray-100 dark:bg-gray-800 p-4 rounded-lg max-h-96 overflow-y-auto text-sm text-gray-900 dark:text-gray-100">
                    <pre>{{ results.shodan.data }}</pre>
                </div>
            {% else %}
                <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-400 p-4 rounded-lg">
                    {{ results.shodan.error|default:"No data available" }}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Hunter.io Results -->
    <div class="card">
        <div class="card-header">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">{{ results.hunter.title }}</h3>
        </div>
        <div class="card-body space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-primary-500 p-5 rounded-lg whitespace-pre-line leading-relaxed text-gray-700 dark:text-gray-300">
                {{ results.hunter.guidance }}
            </div>
            
            {% if results.hunter.success %}
                <p class="text-gray-900 dark:text-white font-semibold">Found {{ results.hunter.count }} email addresses</p>
                <div class="space-y-2">
                    {% for email in results.hunter.data %}
                    <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                        <div>
                            <div class="font-bold text-primary-600 dark:text-primary-400">{{ email.email }}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                {% if email.first_name %}{{ email.first_name }} {{ email.last_name }}{% endif %}
                                {% if email.position %} - {{ email.position }}{% endif %}
                            </div>
                        </div>
                        {% if email.confidence %}
                        <span class="bg-green-500 text-white px-2 py-1 rounded text-xs font-semibold">{{ email.confidence }}% confidence</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-400 p-4 rounded-lg">
                    {{ results.hunter.error|default:"No emails found" }}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Google Dorks Results -->
    <div class="card" id="sensitive-findings-section">
        <div class="card-header">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">üîê Sensitive Information Scan</h3>
        </div>
        <div class="card-body space-y-4">
            {% if sensitive_scan_status.completed %}
                <div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 text-green-700 dark:text-green-400 p-4 rounded-lg">
                    ‚úì Scan completed on {{ sensitive_scan_status.date|date:"Y-m-d H:i" }}
                </div>
                
                {% if sensitive_scan_status.total_findings > 0 %}
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-400 p-4 rounded-lg">
                        ‚ö†Ô∏è <strong>Warning:</strong> This scan has discovered potentially sensitive information. 
                        Handle this data responsibly and ensure proper security measures are in place.
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <div class="text-center bg-gray-50 dark:bg-gray-700 p-5 rounded-lg border-l-4 border-primary-500">
                            <h4 class="text-3xl font-bold text-primary-600 dark:text-primary-400 my-2">{{ sensitive_scan_status.total_findings }}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total Findings</p>
                        </div>
                        <div class="text-center bg-gray-50 dark:bg-gray-700 p-5 rounded-lg border-l-4 border-primary-500">
                            <h4 class="text-3xl font-bold text-primary-600 dark:text-primary-400 my-2">{{ sensitive_scan_status.high_risk_findings }}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">High Risk</p>
                        </div>
                        <div class="text-center bg-gray-50 dark:bg-gray-700 p-5 rounded-lg border-l-4 border-primary-500">
                            <h4 class="text-3xl font-bold text-primary-600 dark:text-primary-400 my-2">{{ findings_by_severity.critical }}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Critical</p>
                        </div>
                        <div class="text-center bg-gray-50 dark:bg-gray-700 p-5 rounded-lg border-l-4 border-primary-500">
                            <h4 class="text-3xl font-bold text-primary-600 dark:text-primary-400 my-2">{{ findings_by_severity.high }}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">High</p>
                        </div>
                        <div class="text-center bg-gray-50 dark:bg-gray-700 p-5 rounded-lg border-l-4 border-primary-500">
                            <h4 class="text-3xl font-bold text-primary-600 dark:text-primary-400 my-2">{{ findings_by_severity.medium }}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Medium</p>
                        </div>
                        <div class="text-center bg-gray-50 dark:bg-gray-700 p-5 rounded-lg border-l-4 border-primary-500">
                            <h4 class="text-3xl font-bold text-primary-600 dark:text-primary-400 my-2">{{ findings_by_severity.low }}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Low</p>
                        </div>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mt-8 mb-4">Findings Details:</h4>
                    <div class="space-y-4">
                        {% for finding in sensitive_findings %}
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-primary-500">
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-bold text-gray-900 dark:text-white text-base">{{ finding.finding_type }}</span>
                                <span class="inline-block px-3 py-1 rounded text-xs font-bold uppercase 
                                    {% if finding.severity == 'critical' %}bg-red-600 text-white
                                    {% elif finding.severity == 'high' %}bg-orange-500 text-white
                                    {% elif finding.severity == 'medium' %}bg-yellow-400 text-gray-900
                                    {% elif finding.severity == 'low' %}bg-green-500 text-white
                                    {% else %}bg-blue-500 text-white{% endif %}">
                                    {{ finding.severity }}
                                </span>
                            </div>
                            <div class="text-gray-600 dark:text-gray-400 text-sm mb-2 break-all">
                                <strong>URL:</strong> {{ finding.url|truncatechars:100 }}
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-3 border border-gray-300 dark:border-gray-600 rounded font-mono text-sm mb-2 break-all">
                                <strong>Value:</strong> {{ finding.value|truncatechars:150 }}
                            </div>
                            {% if finding.context %}
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-2 text-sm text-gray-600 dark:text-gray-400 font-mono break-all">
                                <strong>Context:</strong> {{ finding.context|truncatechars:200 }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if sensitive_scan_status.total_findings > 100 %}
                    <p class="text-gray-500 dark:text-gray-400 italic text-center py-4">Showing first 100 of {{ sensitive_scan_status.total_findings }} findings</p>
                    {% endif %}
                {% else %}
                    <div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 text-green-700 dark:text-green-400 p-4 rounded-lg">
                        ‚úì No sensitive information found during the scan.
                    </div>
                {% endif %}
            {% else %}
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-400 p-4 rounded-lg" id="scan-in-progress">
                    ‚è≥ Sensitive information scan is in progress... 
                    <span id="scan-status-text">Checking status...</span>
                </div>
                <div id="partial-results" class="hidden">
                    <p class="text-gray-600 dark:text-gray-400">Results will appear here as the scan progresses.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Google Dorks Results -->
    <div class="card">
        <div class="card-header">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">{{ results.google_dorks.title }}</h3>
        </div>
        <div class="card-body space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-primary-500 p-5 rounded-lg whitespace-pre-line leading-relaxed text-gray-700 dark:text-gray-300">
                {{ results.google_dorks.guidance }}
            </div>
            
            {% if dork_results.api_configured %}
                <div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 text-green-700 dark:text-green-400 p-4 rounded-lg">
                    ‚úì Automated search enabled. Search results are displayed below each dork query.
                </div>
            {% elif dork_results.search_enabled %}
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-400 p-4 rounded-lg">
                    ‚ö†Ô∏è Automated search was requested but API credentials are not configured. Please configure GOOGLE_SEARCH_API_KEY and GOOGLE_SEARCH_ENGINE_ID in Django settings.
                </div>
            {% else %}
                <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-primary-500 p-4 rounded-lg text-gray-700 dark:text-gray-300">
                    üí° <strong>Tip:</strong> Enable automated dork search when starting a scan and configure Google Custom Search API to see results automatically. Otherwise, copy and manually search each query on Google.
                </div>
            {% endif %}
            
            <div class="space-y-8">
                {% for category_key, category in results.google_dorks.data.items %}
                <div>
                    <h4 class="text-lg font-semibold text-primary-600 dark:text-primary-400 mb-2">üìÅ {{ category.name }}</h4>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">{{ category.description }}</p>
                    
                    <div class="space-y-3">
                        {% for dork in category.dorks %}
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <div class="text-gray-700 dark:text-gray-300 mb-2">{{ dork.description }}</div>
                            <div class="font-mono bg-white dark:bg-gray-800 p-3 border border-gray-300 dark:border-gray-600 rounded my-2 break-all cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors" onclick="copyToClipboard(this)">
                                {{ dork.query }}
                            </div>
                            <button class="btn btn-secondary text-xs" onclick="copyToClipboard(this.previousElementSibling)">üìã Copy Query</button>
                            <span class="text-green-600 dark:text-green-400 text-xs ml-3 hidden copied">‚úì Copied!</span>
                            
                            {% if dork_results.api_configured and dork_results.categories %}
                                {% with dork_with_results=None %}
                                {% for cat_key, cat_data in dork_results.categories.items %}
                                    {% if cat_key == category_key %}
                                        {% for dork_result in cat_data.dorks %}
                                            {% if dork_result.query == dork.query %}
                                                <!-- Search Results -->
                                                <div class="mt-4 border-t border-gray-300 dark:border-gray-600 pt-4">
                                                    <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-lg cursor-pointer select-none flex justify-between items-center hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors" onclick="toggleSearchResults(this)">
                                                        <span>
                                                            <strong class="text-gray-900 dark:text-white">üîç Search Results</strong>
                                                            {% if dork_result.error %}
                                                                <span class="text-sm text-red-600 dark:text-red-400">(Error: {{ dork_result.error }})</span>
                                                            {% else %}
                                                                <span class="text-sm text-gray-600 dark:text-gray-400">({{ dork_result.result_count }} found)</span>
                                                            {% endif %}
                                                        </span>
                                                        <span class="font-bold text-primary-600 dark:text-primary-400 toggle-icon">‚ñº</span>
                                                    </div>
                                                    <div class="search-results-content hidden py-3">
                                                        {% if dork_result.error %}
                                                            <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-400 p-4 rounded-lg">
                                                                Error: {{ dork_result.error }}
                                                            </div>
                                                        {% elif dork_result.results %}
                                                            <div class="space-y-3">
                                                                {% for result in dork_result.results %}
                                                                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-600 hover:shadow-md transition-shadow">
                                                                    <div class="font-bold text-blue-700 dark:text-blue-400 text-base mb-1">
                                                                        <a href="{{ result.url }}" target="_blank" rel="noopener noreferrer" class="hover:underline">
                                                                            {{ result.title }}
                                                                        </a>
                                                                    </div>
                                                                    <div class="text-green-700 dark:text-green-400 text-sm mb-1 break-all">{{ result.url }}</div>
                                                                    <div class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed">{{ result.snippet }}</div>
                                                                </div>
                                                                {% endfor %}
                                                            </div>
                                                        {% else %}
                                                            <div class="text-gray-500 dark:text-gray-400 italic py-2">No results found for this query</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                                {% endwith %}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="flex justify-center gap-4 mt-8">
        <a href="/discover/" class="btn btn-primary">‚Üê New Scan</a>
        <a href="/discover/history/" class="btn btn-secondary">üìö Scan History</a>
    </div>
    
    {% endif %}
</div>

<script>
function copyToClipboard(element) {
    const text = element.textContent.trim();
    navigator.clipboard.writeText(text).then(function() {
        const copiedMsg = element.parentElement.querySelector('.copied');
        if (copiedMsg) {
            copiedMsg.classList.remove('hidden');
            setTimeout(() => {
                copiedMsg.classList.add('hidden');
            }, 2000);
        }
    }).catch(function(err) {
        console.error('Failed to copy text: ', err);
    });
}

function toggleSearchResults(toggleElement) {
    const content = toggleElement.nextElementSibling;
    const icon = toggleElement.querySelector('.toggle-icon');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = '‚ñ≤';
    } else {
        content.classList.add('hidden');
        icon.textContent = '‚ñº';
    }
}

// Auto-refresh for sensitive scan status
{% if not sensitive_scan_status.completed %}
let pollAttempts = 0;
const maxPollAttempts = 60;

function checkScanStatus() {
    if (pollAttempts >= maxPollAttempts) {
        document.getElementById('scan-status-text').textContent = 'Scan is taking longer than expected. Please refresh the page.';
        return;
    }
    
    pollAttempts++;
    
    fetch('/discover/scan-status/{{ scan.id }}/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.scan_completed) {
                window.location.reload();
            } else {
                if (data.total_findings > 0) {
                    document.getElementById('scan-status-text').textContent = 
                        `Found ${data.total_findings} items so far (${data.high_risk_findings} high risk)...`;
                }
                setTimeout(checkScanStatus, 5000);
            }
        })
        .catch(error => {
            console.error('Error checking scan status:', error);
            setTimeout(checkScanStatus, 10000);
        });
}

setTimeout(checkScanStatus, 5000);
{% endif %}
</script>
{% endblock %}
