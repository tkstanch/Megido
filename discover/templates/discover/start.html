{% extends 'base.html' %}

{% block title %}Discover - OSINT & Information Gathering{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-item">Megido Security</span>
<span class="breadcrumb-separator">‚Ä∫</span>
<span class="breadcrumb-item active">Discover</span>
{% endblock %}

{% block extra_style %}
.page-header {
    margin-bottom: 2rem;
}

.page-title {
    font-size: 1.875rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.info-box {
    background: var(--surface);
    padding: 1.5rem;
    border-radius: var(--border-radius-lg);
    margin-bottom: 2rem;
    border: 1px solid var(--border-light);
    border-left: 4px solid var(--primary-500);
}

.info-box h3 {
    margin-bottom: 0.75rem;
    color: var(--primary-600);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-box ul {
    margin-left: 1.5rem;
    line-height: 1.8;
    color: var(--text-secondary);
}
.loading {
    text-align: center;
    padding: 1.5rem;
    display: none;
}

.loading.active {
    display: block;
}

.spinner {
    border: 4px solid var(--gray-200);
    border-top: 4px solid var(--primary-500);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 0.75rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-message {
    background: #fee;
    color: #c33;
    padding: 1rem;
    border-radius: var(--border-radius-md);
    margin-top: 1rem;
    display: none;
}

.error-message.active {
    display: block;
}
{% endblock %}

{% block content %}
<div class="page-header">
    <h2 class="page-title">üîç Discover - OSINT Tool</h2>
</div>

<div class="info-box">
    <h3>üîç What is Discover?</h3>
    <p>Discover is an automated OSINT (Open Source Intelligence) tool that gathers information about a target domain or URL from multiple sources:</p>
    <ul>
        <li><strong>Wayback Machine:</strong> Historical URLs and archived pages</li>
        <li><strong>Shodan:</strong> Infrastructure data, open ports, and services</li>
        <li><strong>Hunter.io:</strong> Email addresses associated with the domain</li>
        <li><strong>Google Dorks:</strong> Pre-built search queries to find sensitive information</li>
    </ul>
    <p style="margin-top: 0.75rem;"><strong>Note:</strong> API keys for Shodan and Hunter.io are required in Django settings for those features to work.</p>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">üéØ Enter Target</h3>
    </div>
    <div class="card-body">
        <form id="scanForm">
            {% csrf_token %}
            <div class="form-group">
                <label for="target" class="form-label">Target Domain or URL:</label>
                <input 
                    type="text" 
                    id="target" 
                    name="target" 
                    class="form-input"
                    placeholder="e.g., example.com or https://example.com"
                    required
                >
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; cursor: pointer; gap: 0.5rem;">
                    <input 
                        type="checkbox" 
                        id="enable_sensitive_scan" 
                        name="enable_sensitive_scan" 
                        checked
                        style="width: auto; cursor: pointer;"
                    >
                    <span>Enable Sensitive Information Scanning</span>
                </label>
                <small class="form-help">
                    Scans discovered URLs for API keys, credentials, and other sensitive data. 
                    This runs in the background and won't delay the initial scan results.
                </small>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; cursor: pointer; gap: 0.5rem;">
                    <input 
                        type="checkbox" 
                        id="enable_dork_search" 
                        name="enable_dork_search"
                        style="width: auto; cursor: pointer;"
                    >
                    <span>Enable Automated Google Dorks Search</span>
                </label>
                <small class="form-help">
                    Automatically executes Google Dorks queries and displays results. 
                    Requires Google Custom Search API configuration (see documentation).
                </small>
            </div>
            
            <button type="submit" class="btn btn-primary" id="submitBtn">
                üöÄ Start OSINT Scan
            </button>
            
            <div class="error-message" id="errorMessage"></div>
        </form>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Gathering information... This may take a minute.</p>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
document.getElementById('scanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const targetInput = document.getElementById('target');
    const target = targetInput ? targetInput.value.trim() : '';
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('errorMessage');
    
    if (!target) {
        if (errorMessage) {
            errorMessage.textContent = 'Please enter a target domain or URL';
            errorMessage.classList.add('active');
        }
        if (window.MegidoToast) {
            window.MegidoToast.warning('Please enter a target domain or URL');
        }
        return;
    }
    
    // Hide error, show loading
    if (errorMessage) errorMessage.classList.remove('active');
    if (loading) loading.classList.add('active');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Scanning...';
    }
    
    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const enableSensitiveScan = document.getElementById('enable_sensitive_scan').checked;
    const enableDorkSearch = document.getElementById('enable_dork_search').checked;
    
    // Submit form
    fetch('/discover/scan/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        credentials: 'same-origin',
        body: 'target=' + encodeURIComponent(target) + '&enable_sensitive_scan=' + enableSensitiveScan + '&enable_dork_search=' + enableDorkSearch
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (window.MegidoToast) {
                window.MegidoToast.success('Scan started successfully!');
            }
            window.location.href = data.redirect_url;
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        if (loading) loading.classList.remove('active');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'üöÄ Start OSINT Scan';
        }
        if (errorMessage) {
            errorMessage.textContent = 'Error: ' + error.message;
            errorMessage.classList.add('active');
        }
        if (window.MegidoToast) {
            window.MegidoToast.error('Scan failed: ' + error.message);
        }
    });
});

})(); // End IIFE
</script>
{% endblock %}
