{% extends 'base.html' %}
{% load static %}

{% block title %}Discover - OSINT & Information Gathering{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-primary-600 dark:hover:text-primary-400">Megido Security</a>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Discover</span>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Start</span>
    </nav>

    <!-- Hero Section -->
    <div class="card">
        <div class="card-body text-center">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">üîç Discover - OSINT Tool</h1>
            <p class="text-gray-600 dark:text-gray-400">Automated Open Source Intelligence gathering from multiple sources</p>
        </div>
    </div>

    <!-- Info Box -->
    <div class="card border-l-4 border-primary-600">
        <div class="card-body">
            <h3 class="text-xl font-semibold text-primary-600 dark:text-primary-400 mb-4 flex items-center gap-2">
                <span>üîç</span>
                <span>What is Discover?</span>
            </h3>
            <p class="text-gray-700 dark:text-gray-300 mb-4">
                Discover is an automated OSINT (Open Source Intelligence) tool that gathers information about a target domain or URL from multiple sources:
            </p>
            <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300 ml-4">
                <li><strong class="font-semibold">Wayback Machine:</strong> Historical URLs and archived pages</li>
                <li><strong class="font-semibold">Shodan:</strong> Infrastructure data, open ports, and services</li>
                <li><strong class="font-semibold">Hunter.io:</strong> Email addresses associated with the domain</li>
                <li><strong class="font-semibold">Google Dorks:</strong> Pre-built search queries to find sensitive information</li>
            </ul>
            <p class="mt-4 text-gray-700 dark:text-gray-300">
                <strong class="font-semibold">Note:</strong> API keys for Shodan and Hunter.io are required in Django settings for those features to work.
            </p>
        </div>
    </div>

    <!-- Scan Form -->
    <div class="card">
        <div class="card-header">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">üéØ Enter Target</h3>
        </div>
        <div class="card-body">
            <form id="scanForm" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="target" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Target Domain or URL:
                    </label>
                    <input 
                        type="text" 
                        id="target" 
                        name="target" 
                        class="input"
                        placeholder="e.g., example.com or https://example.com"
                        required
                    >
                </div>
                
                <div class="space-y-3">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="enable_sensitive_scan" 
                            name="enable_sensitive_scan" 
                            checked
                            class="mt-1 h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600"
                        >
                        <div>
                            <span class="text-sm font-medium text-gray-900 dark:text-white">Enable Sensitive Information Scanning</span>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                Scans discovered URLs for API keys, credentials, and other sensitive data. 
                                This runs in the background and won't delay the initial scan results.
                            </p>
                        </div>
                    </label>
                    
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="enable_dork_search" 
                            name="enable_dork_search"
                            class="mt-1 h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600"
                        >
                        <div>
                            <span class="text-sm font-medium text-gray-900 dark:text-white">Enable Automated Google Dorks Search</span>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                Automatically executes Google Dorks queries and displays results. 
                                Requires Google Custom Search API configuration (see documentation).
                            </p>
                        </div>
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    üöÄ Start OSINT Scan
                </button>
                
                <div class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-800 dark:text-red-200" id="errorMessage"></div>
            </form>
            
            <div class="hidden text-center py-6" id="loading">
                <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-gray-200 dark:border-gray-700 border-t-primary-600 mb-3"></div>
                <p class="text-gray-700 dark:text-gray-300">Gathering information... This may take a minute.</p>
            </div>
        </div>
    </div>
</div>


<script>
(function() {
    'use strict';
    
    document.getElementById('scanForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const targetInput = document.getElementById('target');
        const target = targetInput ? targetInput.value.trim() : '';
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        
        if (!target) {
            if (errorMessage) {
                errorMessage.textContent = 'Please enter a target domain or URL';
                errorMessage.classList.remove('hidden');
            }
            if (window.MegidoToast) {
                window.MegidoToast.warning('Please enter a target domain or URL');
            }
            return;
        }
        
        // Hide error, show loading
        if (errorMessage) errorMessage.classList.add('hidden');
        if (loading) loading.classList.remove('hidden');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Scanning...';
        }
        
        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const enableSensitiveScan = document.getElementById('enable_sensitive_scan').checked;
        const enableDorkSearch = document.getElementById('enable_dork_search').checked;
        
        // Submit form
        fetch('/discover/scan/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            credentials: 'same-origin',
            body: 'target=' + encodeURIComponent(target) + '&enable_sensitive_scan=' + enableSensitiveScan + '&enable_dork_search=' + enableDorkSearch
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (window.MegidoToast) {
                    window.MegidoToast.success('Scan started successfully!');
                }
                window.location.href = data.redirect_url;
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            if (loading) loading.classList.add('hidden');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Start OSINT Scan';
            }
            if (errorMessage) {
                errorMessage.textContent = 'Error: ' + error.message;
                errorMessage.classList.remove('hidden');
            }
            if (window.MegidoToast) {
                window.MegidoToast.error('Scan failed: ' + error.message);
            }
        });
    });
})();
</script>
{% endblock %}
