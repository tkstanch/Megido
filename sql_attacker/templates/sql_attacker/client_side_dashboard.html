{% extends "base.html" %}
{% load static %}

{% block title %}Client-Side Security Scanning - SQL Attacker{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-browser"></i>
                Client-Side Security Scanning
            </h1>
            <p class="lead">
                Comprehensive client-side security testing including browser automation, 
                JavaScript static analysis, HTTP Parameter Pollution, and privacy analysis.
            </p>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Configure Client-Side Scan</h5>
                </div>
                <div class="card-body">
                    <form id="clientSideScanForm">
                        {% csrf_token %}
                        
                        <!-- Scan Types -->
                        <div class="form-group mb-3">
                            <label class="font-weight-bold">Scan Types</label>
                            <div class="row">
                                {% for scan_type in scan_types %}
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="scan_types" value="{{ scan_type.value }}" 
                                               id="scan_{{ scan_type.value }}">
                                        <label class="form-check-label" for="scan_{{ scan_type.value }}">
                                            {{ scan_type.label }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Target URL -->
                        <div class="form-group mb-3">
                            <label for="targetUrl" class="font-weight-bold">Target URL</label>
                            <input type="url" class="form-control" id="targetUrl" 
                                   placeholder="https://example.com" required>
                            <small class="form-text text-muted">
                                URL to scan for client-side vulnerabilities
                            </small>
                        </div>

                        <!-- JavaScript Code (Optional) -->
                        <div class="form-group mb-3">
                            <label for="jsCode" class="font-weight-bold">JavaScript Code (Optional)</label>
                            <textarea class="form-control" id="jsCode" rows="5" 
                                      placeholder="Paste JavaScript code for static analysis..."></textarea>
                            <small class="form-text text-muted">
                                Optional: JavaScript code to analyze for security issues
                            </small>
                        </div>

                        <!-- Advanced Options -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <a class="text-dark" data-toggle="collapse" href="#advancedOptions">
                                    <i class="fas fa-cog"></i> Advanced Options
                                </a>
                            </div>
                            <div id="advancedOptions" class="collapse">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="usePlaywright" checked>
                                                <label class="form-check-label" for="usePlaywright">
                                                    Use Playwright (recommended)
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="headless" checked>
                                                <label class="form-check-label" for="headless">
                                                    Headless mode
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="verifySsl" checked>
                                                <label class="form-check-label" for="verifySsl">
                                                    Verify SSL certificates
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="timeout">Timeout (ms)</label>
                                                <input type="number" class="form-control" 
                                                       id="timeout" value="30000">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-play"></i> Start Scan
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row mt-4" id="resultsSection" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Scan Results</h5>
                </div>
                <div class="card-body">
                    <div id="scanResults"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="row mt-4" id="loadingSection" style="display: none;">
        <div class="col-md-12 text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-3">Running client-side scans... This may take a few minutes.</p>
        </div>
    </div>
</div>

<script>
document.getElementById('clientSideScanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Show loading
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    
    // Collect form data
    const scanTypes = Array.from(document.querySelectorAll('input[name="scan_types"]:checked'))
        .map(cb => cb.value);
    
    const formData = {
        scan_types: scanTypes.length > 0 ? scanTypes : ['all'],
        target_url: document.getElementById('targetUrl').value,
        javascript_code: document.getElementById('jsCode').value || null,
        use_playwright: document.getElementById('usePlaywright').checked,
        headless: document.getElementById('headless').checked,
        timeout: parseInt(document.getElementById('timeout').value),
        verify_ssl: document.getElementById('verifySsl').checked
    };
    
    // Make API request
    fetch('{% url "sql_attacker:api_client_side_scan" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading
        document.getElementById('loadingSection').style.display = 'none';
        
        // Display results
        displayResults(data);
        document.getElementById('resultsSection').style.display = 'block';
    })
    .catch(error => {
        // Hide loading
        document.getElementById('loadingSection').style.display = 'none';
        
        // Show error
        alert('Error running scan: ' + error.message);
    });
});

function displayResults(data) {
    const resultsDiv = document.getElementById('scanResults');
    
    let html = '<h4>Scan Summary</h4>';
    html += `<p><strong>Scan ID:</strong> ${data.scan_id}</p>`;
    html += `<p><strong>Status:</strong> <span class="badge badge-${data.status === 'completed' ? 'success' : 'danger'}">${data.status}</span></p>`;
    html += `<p><strong>Total Findings:</strong> ${data.summary.total_findings}</p>`;
    
    // Severity breakdown
    html += '<h5 class="mt-3">Findings by Severity</h5>';
    html += '<div class="row">';
    for (const [severity, count] of Object.entries(data.summary.by_severity)) {
        if (count > 0) {
            const badgeClass = severity === 'CRITICAL' ? 'danger' : 
                              severity === 'HIGH' ? 'warning' : 
                              severity === 'MEDIUM' ? 'info' : 'secondary';
            html += `<div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h2 class="text-${badgeClass}">${count}</h2>
                        <p>${severity}</p>
                    </div>
                </div>
            </div>`;
        }
    }
    html += '</div>';
    
    // Findings by scan type
    html += '<h5 class="mt-3">Findings by Scan Type</h5>';
    html += '<ul class="list-group">';
    for (const [type, count] of Object.entries(data.summary.by_scan_type)) {
        if (count > 0) {
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                ${type.replace('_', ' ').toUpperCase()}
                <span class="badge badge-primary badge-pill">${count}</span>
            </li>`;
        }
    }
    html += '</ul>';
    
    <!-- Export button -->
    html += '<div class="mt-3">';
    html += '<button class="btn btn-secondary" onclick="exportResultsAsFile(\'json\')">Export as JSON</button> ';
    html += '<button class="btn btn-secondary" onclick="exportResultsAsFile(\'html\')">Export as HTML</button>';
    html += '</div>';
    
    resultsDiv.innerHTML = html;
    
    // Store results data for export
    window.currentScanResults = data;
}

function exportResultsAsFile(format) {
    const data = window.currentScanResults;
    if (!data) {
        alert('No scan results to export');
        return;
    }
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { 
        type: format === 'json' ? 'application/json' : 'text/html' 
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `client_side_scan_${data.scan_id}.${format}`;
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}