#!/usr/bin/env python3
"""
Demo script for Advanced Vulnerability Scanner Features

This script demonstrates the advanced features including:
- Risk-based scoring with verified vulnerabilities
- False positive management
- Proof of impact display
- Compliance mapping
- Automated remediation
"""

import os
import sys
import django

# Setup Django
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'megido_security.settings')
django.setup()

from scanner.models import ScanTarget, Scan, Vulnerability
from scanner.exploit_integration import (
    apply_advanced_features_to_scan,
    apply_risk_scoring,
    apply_compliance_mapping,
    filter_false_positives
)
from django.utils import timezone
import json


def print_banner():
    """Print demo banner"""
    print("=" * 80)
    print("Advanced Vulnerability Scanner - Feature Demonstration")
    print("Enterprise-Grade Security Scanning with Proof of Impact")
    print("=" * 80)
    print()


def demo_1_create_sample_scan():
    """Demo 1: Create a sample scan with vulnerabilities"""
    print("DEMO 1: Creating Sample Scan")
    print("-" * 80)
    
    # Create target
    target = ScanTarget.objects.create(
        url='https://demo-app.example.com',
        name='Demo Web Application'
    )
    print(f"‚úì Created scan target: {target.name}")
    
    # Create scan
    scan = Scan.objects.create(
        target=target,
        status='completed',
        completed_at=timezone.now()
    )
    print(f"‚úì Created scan #{scan.id}")
    
    # Create vulnerabilities
    vulns = [
        {
            'type': 'sqli',
            'severity': 'critical',
            'url': 'https://demo-app.example.com/api/users',
            'parameter': 'id',
            'description': 'SQL Injection in user lookup API',
            'evidence': 'MySQL error message exposed in response',
            'confidence': 0.9,
        },
        {
            'type': 'xss',
            'severity': 'high',
            'url': 'https://demo-app.example.com/search',
            'parameter': 'q',
            'description': 'Reflected XSS in search functionality',
            'evidence': 'Script tag reflected unescaped in HTML',
            'confidence': 0.85,
        },
        {
            'type': 'info_disclosure',
            'severity': 'low',
            'url': 'https://demo-app.example.com',
            'parameter': None,
            'description': 'Missing security headers',
            'evidence': 'X-Frame-Options and CSP headers not set',
            'confidence': 1.0,
        },
    ]
    
    created_vulns = []
    for vuln_data in vulns:
        vuln = Vulnerability.objects.create(
            scan=scan,
            vulnerability_type=vuln_data['type'],
            severity=vuln_data['severity'],
            url=vuln_data['url'],
            parameter=vuln_data['parameter'],
            description=vuln_data['description'],
            evidence=vuln_data['evidence'],
            confidence_score=vuln_data['confidence']
        )
        created_vulns.append(vuln)
        print(f"  ‚úì Created {vuln.severity} severity {vuln.vulnerability_type} vulnerability")
    
    print(f"\n‚úì Created {len(created_vulns)} vulnerabilities")
    print()
    return scan, created_vulns


def demo_2_apply_advanced_features(scan):
    """Demo 2: Apply advanced features to the scan"""
    print("DEMO 2: Applying Advanced Features")
    print("-" * 80)
    
    # Apply all advanced features
    results = apply_advanced_features_to_scan(scan.id)
    
    print(f"‚úì Processed {results['processed']} vulnerabilities")
    print(f"  - Risk scored: {results['risk_scored']}")
    print(f"  - Compliance mapped: {results['compliance_mapped']}")
    print(f"  - False positives identified: {results['false_positives_identified']}")
    print()
    
    return results


def demo_3_show_risk_scores(scan):
    """Demo 3: Display risk scores"""
    print("DEMO 3: Risk Scoring Results")
    print("-" * 80)
    
    vulnerabilities = scan.vulnerabilities.all().order_by('-risk_score')
    
    print(f"Vulnerabilities ordered by risk score (highest first):\n")
    for vuln in vulnerabilities:
        risk_indicator = "üî¥" if vuln.risk_level == 'critical' else "üü†" if vuln.risk_level == 'high' else "üü°" if vuln.risk_level == 'medium' else "üü¢"
        print(f"{risk_indicator} Risk Score: {vuln.risk_score:5.1f}/100 | Level: {vuln.risk_level.upper():8} | {vuln.get_vulnerability_type_display()}")
        print(f"   URL: {vuln.url}")
        print(f"   Confidence: {vuln.confidence_score*100:.0f}%")
        print()
    

def demo_4_simulate_exploitation(scan):
    """Demo 4: Simulate successful exploitation"""
    print("DEMO 4: Simulating Vulnerability Exploitation")
    print("-" * 80)
    
    # Get SQL injection vulnerability
    sqli_vuln = scan.vulnerabilities.filter(vulnerability_type='sqli').first()
    if sqli_vuln:
        print(f"Exploiting: {sqli_vuln.description}")
        print("Attempting SQL injection attack...")
        
        # Simulate successful exploitation
        sqli_vuln.exploited = True
        sqli_vuln.verified = True
        sqli_vuln.exploit_status = 'success'
        sqli_vuln.confidence_score = 1.0
        
        # Add proof of impact
        proof = """Evidence: Database enumeration successful via union-based injection

Extracted Data:
{
  "database_version": "MySQL 8.0.32",
  "current_user": "webapp@localhost",
  "databases": ["webapp_db", "information_schema", "mysql"],
  "tables": ["users", "orders", "payments", "sessions"],
  "user_count": 1523
}

Findings:
- Union-based SQL injection confirmed
- Full database enumeration achieved
- Extracted 1523 user records with email addresses
- Accessed payment information table
- Confirmed read access to all application tables"""
        
        sqli_vuln.proof_of_impact = proof
        sqli_vuln.exploit_result = "Plugin: SQL Injection Plugin\nStatus: SUCCESS\n" + proof
        
        # Recalculate risk score with verification
        apply_risk_scoring(sqli_vuln)
        sqli_vuln.save()
        
        print(f"‚úì Exploitation successful!")
        print(f"‚úì Marked as VERIFIED")
        print(f"‚úì Updated risk score: {sqli_vuln.risk_score:.1f}/100")
        print()
    
    # Get XSS vulnerability
    xss_vuln = scan.vulnerabilities.filter(vulnerability_type='xss').first()
    if xss_vuln:
        print(f"Exploiting: {xss_vuln.description}")
        print("Attempting XSS exploitation with browser automation...")
        
        # Simulate successful exploitation
        xss_vuln.exploited = True
        xss_vuln.verified = True
        xss_vuln.exploit_status = 'success'
        xss_vuln.confidence_score = 0.95
        
        # Add proof of impact
        proof = """Evidence: JavaScript successfully executed in browser context

Extracted Data:
{
  "cookies": "session=abc123def456789; PHPSESSID=xyz789",
  "localStorage": {
    "user": "admin",
    "role": "superadmin",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  },
  "document_domain": "demo-app.example.com",
  "user_agent": "Mozilla/5.0..."
}

Findings:
- JavaScript execution confirmed in victim browser
- Session cookie accessible (not HttpOnly)
- Admin credentials obtained from localStorage
- DOM manipulation successful
- Screenshot captured showing alert() execution"""
        
        xss_vuln.proof_of_impact = proof
        xss_vuln.exploit_result = "Plugin: XSS Plugin\nStatus: SUCCESS\n" + proof
        
        # Recalculate risk score
        apply_risk_scoring(xss_vuln)
        xss_vuln.save()
        
        print(f"‚úì Exploitation successful!")
        print(f"‚úì Marked as VERIFIED")
        print(f"‚úì Updated risk score: {xss_vuln.risk_score:.1f}/100")
        print()


def demo_5_display_verified_findings(scan):
    """Demo 5: Display verified findings with proof"""
    print("DEMO 5: Verified Findings with Proof of Impact")
    print("-" * 80)
    
    verified = scan.vulnerabilities.filter(verified=True)
    
    if not verified.exists():
        print("No verified vulnerabilities found.")
        return
    
    print(f"Found {verified.count()} VERIFIED vulnerabilities:\n")
    
    for vuln in verified:
        print("=" * 80)
        print(f"‚úì VERIFIED - {vuln.get_vulnerability_type_display()}")
        print(f"Risk Score: {vuln.risk_score:.1f}/100 ({vuln.risk_level.upper()})")
        print(f"Confidence: {vuln.confidence_score*100:.0f}%")
        print(f"URL: {vuln.url}")
        print()
        print("Proof of Impact:")
        print("-" * 80)
        print(vuln.proof_of_impact)
        print()


def demo_6_compliance_mapping(scan):
    """Demo 6: Show compliance mapping"""
    print("DEMO 6: Compliance Framework Mapping")
    print("-" * 80)
    
    vulnerabilities = scan.vulnerabilities.all()
    
    for vuln in vulnerabilities:
        apply_compliance_mapping(vuln)
        vuln.save()
    
    print("Vulnerabilities mapped to compliance frameworks:\n")
    
    for vuln in vulnerabilities:
        if vuln.compliance_violations:
            print(f"{vuln.get_vulnerability_type_display()}")
            print(f"  Frameworks: {', '.join(vuln.compliance_violations.keys())}")
            print()


def demo_7_false_positive_management(scan):
    """Demo 7: Demonstrate false positive management"""
    print("DEMO 7: False Positive Management")
    print("-" * 80)
    
    # Mark the low severity one as false positive for demo
    low_vuln = scan.vulnerabilities.filter(severity='low').first()
    if low_vuln:
        print(f"Marking as false positive: {low_vuln.description}")
        low_vuln.false_positive_status = 'false_positive'
        low_vuln.false_positive_reason = 'This is a staging environment with intentionally disabled headers'
        low_vuln.reviewed_by = 'security_team'
        low_vuln.reviewed_at = timezone.now()
        low_vuln.save()
        print("‚úì Marked as false positive")
        print(f"  Reason: {low_vuln.false_positive_reason}")
        print()
    
    # Show filtering
    all_vulns = list(scan.vulnerabilities.all())
    filtered = filter_false_positives(all_vulns)
    
    print(f"Total vulnerabilities: {len(all_vulns)}")
    print(f"After filtering false positives: {len(filtered)}")
    print(f"False positives filtered: {len(all_vulns) - len(filtered)}")
    print()


def demo_8_summary(scan):
    """Demo 8: Final summary"""
    print("DEMO 8: Scan Summary")
    print("-" * 80)
    
    total = scan.vulnerabilities.count()
    verified = scan.vulnerabilities.filter(verified=True).count()
    critical = scan.vulnerabilities.filter(risk_level='critical').count()
    high = scan.vulnerabilities.filter(risk_level='high').count()
    false_positives = scan.vulnerabilities.filter(false_positive_status='false_positive').count()
    
    print(f"Scan ID: {scan.id}")
    print(f"Target: {scan.target.name}")
    print(f"Status: {scan.status}")
    print()
    print(f"Total Vulnerabilities: {total}")
    print(f"  ‚úì Verified (Exploited): {verified}")
    print(f"  üî¥ Critical Risk: {critical}")
    print(f"  üü† High Risk: {high}")
    print(f"  ‚ùå False Positives: {false_positives}")
    print()
    print("Recommendations:")
    print("  1. Address verified vulnerabilities immediately")
    print("  2. Prioritize critical and high-risk findings")
    print("  3. Review false positive classifications")
    print("  4. Re-scan after remediation to verify fixes")
    print()


def main():
    """Run all demos"""
    print_banner()
    
    try:
        # Run demos
        scan, vulns = demo_1_create_sample_scan()
        demo_2_apply_advanced_features(scan)
        demo_3_show_risk_scores(scan)
        demo_4_simulate_exploitation(scan)
        demo_5_display_verified_findings(scan)
        demo_6_compliance_mapping(scan)
        demo_7_false_positive_management(scan)
        demo_8_summary(scan)
        
        print("=" * 80)
        print("All demonstrations completed successfully!")
        print("=" * 80)
        print()
        print("Next Steps:")
        print("  1. View the scan in the web UI: http://localhost:8000/scanner/")
        print(f"  2. View scan results: GET /scanner/api/scans/{scan.id}/results/")
        print("  3. Filter verified only: ?verified_only=true")
        print("  4. Exclude false positives: ?include_false_positives=false (default)")
        print()
        print("For more information, see ADVANCED_VULNERABILITY_SCANNER.md")
        
    except Exception as e:
        print(f"\n‚ùå Error during demo: {e}")
        import traceback
        traceback.print_exc()
        return 1
    
    return 0


if __name__ == '__main__':
    sys.exit(main())
