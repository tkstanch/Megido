"""
Exploit Configuration Module

This module provides configuration management for the exploit plugin system,
including scanning intensity levels, retry counts, and fallback strategies.
"""

from typing import Dict, Any
import logging

logger = logging.getLogger(__name__)


class ExploitConfig:
    """
    Configuration manager for exploit plugins.
    
    Provides centralized configuration for:
    - Scanning intensity levels
    - Retry strategies
    - Timeout settings
    - Fallback behavior
    - Parallel execution
    """
    
    # Intensity level presets
    INTENSITY_PRESETS = {
        'low': {
            'max_retries': 1,
            'timeout': 5,
            'parallel_execution': False,
            'enable_fallback': False,
            'max_payloads_per_plugin': 10,
            'max_fallback_files': 20,
            'max_fallback_directories': 5,
            'enable_mutations': False,
            'http_methods': ['GET'],
            'user_agent_rotation': False,
        },
        'medium': {
            'max_retries': 2,
            'timeout': 10,
            'parallel_execution': False,
            'enable_fallback': True,
            'max_payloads_per_plugin': 30,
            'max_fallback_files': 50,
            'max_fallback_directories': 10,
            'enable_mutations': True,
            'http_methods': ['GET', 'POST'],
            'user_agent_rotation': False,
        },
        'high': {
            'max_retries': 3,
            'timeout': 15,
            'parallel_execution': True,
            'enable_fallback': True,
            'max_payloads_per_plugin': 50,
            'max_fallback_files': 100,
            'max_fallback_directories': 15,
            'enable_mutations': True,
            'http_methods': ['GET', 'POST'],
            'user_agent_rotation': True,
            'max_workers': 3,
        },
        'aggressive': {
            'max_retries': 5,
            'timeout': 20,
            'parallel_execution': True,
            'enable_fallback': True,
            'max_payloads_per_plugin': 100,
            'max_fallback_files': 200,
            'max_fallback_directories': 20,
            'enable_mutations': True,
            'http_methods': ['GET', 'POST', 'PUT'],
            'user_agent_rotation': True,
            'max_workers': 5,
        }
    }
    
    def __init__(self, intensity: str = 'medium', custom_config: Dict[str, Any] = None):
        """
        Initialize exploit configuration.
        
        Args:
            intensity: Intensity level ('low', 'medium', 'high', 'aggressive')
            custom_config: Optional dictionary to override specific settings
        """
        self.intensity = intensity.lower()
        
        if self.intensity not in self.INTENSITY_PRESETS:
            logger.warning(f"Invalid intensity '{intensity}', defaulting to 'medium'")
            self.intensity = 'medium'
        
        # Start with preset
        self.config = self.INTENSITY_PRESETS[self.intensity].copy()
        
        # Apply custom overrides
        if custom_config:
            self.config.update(custom_config)
        
        # Add common defaults not in presets
        self._add_defaults()
    
    def _add_defaults(self):
        """Add common default values."""
        defaults = {
            'verify_ssl': self.config.get('verify_ssl', False),
            'capture_visual_proof': self.config.get('capture_visual_proof', True),
            'detect_partial_evidence': self.config.get('detect_partial_evidence', True),
            'log_failed_attempts': self.config.get('log_failed_attempts', True),
        }
        
        for key, value in defaults.items():
            if key not in self.config:
                self.config[key] = value
    
    def get_config(self) -> Dict[str, Any]:
        """
        Get the complete configuration dictionary.
        
        Returns:
            Dictionary with all configuration values
        """
        return self.config.copy()
    
    def get(self, key: str, default: Any = None) -> Any:
        """
        Get a specific configuration value.
        
        Args:
            key: Configuration key
            default: Default value if key not found
            
        Returns:
            Configuration value or default
        """
        return self.config.get(key, default)
    
    def set(self, key: str, value: Any):
        """
        Set a specific configuration value.
        
        Args:
            key: Configuration key
            value: Value to set
        """
        self.config[key] = value
    
    def update(self, updates: Dict[str, Any]):
        """
        Update multiple configuration values.
        
        Args:
            updates: Dictionary of updates
        """
        self.config.update(updates)
    
    def get_intensity(self) -> str:
        """
        Get the current intensity level.
        
        Returns:
            Intensity level string
        """
        return self.intensity
    
    def set_intensity(self, intensity: str):
        """
        Change the intensity level.
        
        Args:
            intensity: New intensity level
        """
        if intensity.lower() not in self.INTENSITY_PRESETS:
            raise ValueError(f"Invalid intensity level: {intensity}")
        
        self.intensity = intensity.lower()
        self.config = self.INTENSITY_PRESETS[self.intensity].copy()
        self._add_defaults()
    
    @classmethod
    def from_dict(cls, config_dict: Dict[str, Any]) -> 'ExploitConfig':
        """
        Create configuration from a dictionary.
        
        Args:
            config_dict: Configuration dictionary (must include 'intensity' key)
            
        Returns:
            ExploitConfig instance
        """
        intensity = config_dict.pop('intensity', 'medium')
        return cls(intensity=intensity, custom_config=config_dict)
    
    def to_dict(self) -> Dict[str, Any]:
        """
        Export configuration as dictionary.
        
        Returns:
            Dictionary with intensity and all config values
        """
        result = {'intensity': self.intensity}
        result.update(self.config)
        return result
    
    def __repr__(self) -> str:
        """String representation."""
        return f"ExploitConfig(intensity='{self.intensity}', config={self.config})"


# Global default config instance
_default_config = None


def get_default_config() -> ExploitConfig:
    """
    Get the global default configuration instance.
    
    Returns:
        Default ExploitConfig instance
    """
    global _default_config
    if _default_config is None:
        _default_config = ExploitConfig(intensity='medium')
    return _default_config


def set_default_intensity(intensity: str):
    """
    Set the default intensity level globally.
    
    Args:
        intensity: Intensity level to set as default
    """
    global _default_config
    _default_config = ExploitConfig(intensity=intensity)


def get_config_for_intensity(intensity: str) -> Dict[str, Any]:
    """
    Get configuration dictionary for a specific intensity level.
    
    Args:
        intensity: Intensity level
        
    Returns:
        Configuration dictionary
    """
    config = ExploitConfig(intensity=intensity)
    return config.get_config()


# Example usage and documentation
def print_intensity_comparison():
    """
    Print a comparison of all intensity levels.
    Useful for documentation and understanding the differences.
    """
    print("\n" + "="*80)
    print("EXPLOIT INTENSITY LEVEL COMPARISON")
    print("="*80 + "\n")
    
    for intensity in ['low', 'medium', 'high', 'aggressive']:
        config = ExploitConfig(intensity=intensity)
        print(f"\n{intensity.upper()} Intensity:")
        print("-" * 40)
        for key, value in sorted(config.get_config().items()):
            print(f"  {key:30s}: {value}")
    
    print("\n" + "="*80 + "\n")


if __name__ == '__main__':
    # Example usage
    print_intensity_comparison()
    
    # Create custom config
    custom = ExploitConfig(intensity='high', custom_config={
        'timeout': 30,
        'custom_header': 'X-Custom: Value'
    })
    print(f"\nCustom Config: {custom}")
    print(f"Timeout: {custom.get('timeout')}")
