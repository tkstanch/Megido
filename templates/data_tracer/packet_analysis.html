{% extends 'base.html' %}

{% block title %}Packet Analysis - Data Tracer{% endblock %}

{% block breadcrumb %}
<li class="text-gray-500 dark:text-gray-400">Megido Security</li>
<li class="text-gray-400 dark:text-gray-500 mx-2">/</li>
<li class="text-gray-500 dark:text-gray-400">Data Tracer</li>
<li class="text-gray-400 dark:text-gray-500 mx-2">/</li>
<li class="text-gray-900 dark:text-white font-medium">Packet Analysis</li>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <div class="mb-6">
        <a href="{% url 'data_tracer:result_detail' scan_result.id %}" class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 inline-flex items-center gap-1">
            ‚Üê Back to Results
        </a>
    </div>

    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Packet Analysis</h2>
        <p class="text-lg text-gray-600 dark:text-gray-400">
            <strong>Target:</strong> {{ scan_result.scan_target.target }}
        </p>
    </div>

    {% if aggregated %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Statistics</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="text-3xl font-bold text-primary-600 dark:text-primary-400">{{ aggregated.total_packets }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Total Packets</div>
                </div>
                <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="text-3xl font-bold text-primary-600 dark:text-primary-400">{{ aggregated.high_relevance_count }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">High Relevance</div>
                </div>
                <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="text-3xl font-bold text-primary-600 dark:text-primary-400">{{ aggregated.unique_ports|length }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Unique Ports</div>
                </div>
                <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="text-3xl font-bold text-primary-600 dark:text-primary-400">{{ aggregated.unique_ips|length }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Unique IPs</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if packets %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Captured Packets</h3>
        </div>
        <div class="card-body">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Source</th>
                            <th>Destination</th>
                            <th>Size</th>
                            <th>Relevance</th>
                            <th>Captured</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for packet in packets %}
                        <tr>
                            <td>{{ packet.packet_type|upper }}</td>
                            <td>{{ packet.source_ip }}:{{ packet.source_port|default:"N/A" }}</td>
                            <td>{{ packet.destination_ip }}:{{ packet.destination_port|default:"N/A" }}</td>
                            <td>{{ packet.packet_size }} bytes</td>
                            <td>
                                {% if packet.relevance == 'high' %}
                                    <span class="badge badge-danger">{{ packet.get_relevance_display }}</span>
                                {% elif packet.relevance == 'medium' %}
                                    <span class="badge badge-warning">{{ packet.get_relevance_display }}</span>
                                {% elif packet.relevance == 'low' %}
                                    <span class="badge badge-success">{{ packet.get_relevance_display }}</span>
                                {% else %}
                                    <span class="badge" style="background: #9e9e9e; color: white;">{{ packet.get_relevance_display }}</span>
                                {% endif %}
                            </td>
                            <td>{{ packet.captured_at|date:"H:i:s" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body text-center py-12">
            <div class="text-6xl mb-4">üì°</div>
            <p class="text-gray-600 dark:text-gray-400">No packets captured for this scan.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
