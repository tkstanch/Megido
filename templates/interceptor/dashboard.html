{% extends 'base.html' %}

{% block title %}Request Interceptor - Megido Security{% endblock %}

{% block extra_style %}
.interceptor-controls {
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 20px;
    margin-bottom: 20px;
}
.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: bold;
}
.status-indicator.enabled {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.status-indicator.disabled {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}
.toggle-slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}
input:checked + .toggle-slider {
    background-color: #28a745;
}
input:checked + .toggle-slider:before {
    transform: translateX(26px);
}
{% endblock %}

{% block content %}
<h2>Request Interceptor</h2>
<p>Intercept and modify HTTP requests before they reach the server.</p>

<div class="interceptor-controls">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
        <div>
            <strong>Interceptor Control:</strong>
        </div>
        <label class="toggle-switch">
            <input type="checkbox" id="interceptor-toggle" {% if interceptor_enabled %}checked{% endif %} onchange="toggleInterceptor()">
            <span class="toggle-slider"></span>
        </label>
    </div>
    
    <div id="status-display" class="status-indicator {% if interceptor_enabled %}enabled{% else %}disabled{% endif %}">
        <span id="status-icon">{% if interceptor_enabled %}üü¢{% else %}üî¥{% endif %}</span>
        <span id="status-text">{% if interceptor_enabled %}Active - Intercepting Requests{% else %}Inactive - Requests Pass Through{% endif %}</span>
    </div>
</div>

<div class="info-message" style="background: #e3f2fd; padding: 15px; border-left: 4px solid #2196f3; margin: 20px 0; border-radius: 3px;">
    <strong>‚ÑπÔ∏è How It Works</strong><br>
    When the interceptor is <strong>ON</strong>, HTTP requests from the integrated browser are captured here for inspection and modification before being forwarded.
    Toggle the switch above to enable or disable interception.
</div>

<div id="intercepted-list">
    <div style="padding: 20px; text-align: center; color: #666;">
        No intercepted requests
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
async function toggleInterceptor() {
    const toggle = document.getElementById('interceptor-toggle');
    const isEnabled = toggle.checked;
    
    try {
        const response = await fetch('/interceptor/api/status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ is_enabled: isEnabled })
        });
        
        const data = await response.json();
        
        // Update status display
        updateStatusDisplay(data.is_enabled);
        
    } catch (error) {
        console.error('Error toggling interceptor:', error);
        alert('Failed to toggle interceptor. Please try again.');
        // Revert toggle on error
        toggle.checked = !isEnabled;
    }
}

function updateStatusDisplay(isEnabled) {
    const statusDisplay = document.getElementById('status-display');
    const statusIcon = document.getElementById('status-icon');
    const statusText = document.getElementById('status-text');
    
    if (isEnabled) {
        statusDisplay.className = 'status-indicator enabled';
        statusIcon.textContent = 'üü¢';
        statusText.textContent = 'Active - Intercepting Requests';
    } else {
        statusDisplay.className = 'status-indicator disabled';
        statusIcon.textContent = 'üî¥';
        statusText.textContent = 'Inactive - Requests Pass Through';
    }
}

async function loadIntercepted() {
    try {
        const response = await fetch('/interceptor/api/intercepted/');
        const requests = await response.json();
        
        const listDiv = document.getElementById('intercepted-list');
        if (requests.length === 0) {
            listDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No intercepted requests</div>';
            return;
        }
        
        listDiv.innerHTML = requests.map(req => `
            <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;">
                <div><strong>${req.original_method}</strong> ${req.original_url}</div>
                <div style="margin-top: 10px; color: #666; font-size: 0.9em;">${new Date(req.timestamp).toLocaleString()}</div>
                <div style="margin-top: 10px;">
                    <button onclick="forwardRequest(${req.id})">Forward</button>
                    <button onclick="dropRequest(${req.id})">Drop</button>
                    <button onclick="editRequest(${req.id})">Edit</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading intercepted requests:', error);
    }
}

async function forwardRequest(id) {
    try {
        await fetch(`/interceptor/api/intercepted/${id}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({status: 'forwarded'})
        });
        loadIntercepted();
    } catch (error) {
        console.error('Error forwarding request:', error);
    }
}

async function dropRequest(id) {
    try {
        await fetch(`/interceptor/api/intercepted/${id}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({status: 'dropped'})
        });
        loadIntercepted();
    } catch (error) {
        console.error('Error dropping request:', error);
    }
}

function editRequest(id) {
    alert('Edit functionality - coming soon!');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

loadIntercepted();
setInterval(loadIntercepted, 3000);
</script>
{% endblock %}
