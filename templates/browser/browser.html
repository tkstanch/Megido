{% extends 'base.html' %}

{% block title %}Integrated Browser - Megido Security{% endblock %}

{% block extra_style %}
.browser-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 250px);
}
.browser-toolbar {
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.url-bar {
    flex: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
}
.toolbar-button {
    padding: 10px 15px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s;
}
.toolbar-button:hover {
    background: #5568d3;
}
.toolbar-button:disabled {
    background: #ccc;
    cursor: not-allowed;
}
.cef-launch-btn {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    font-weight: bold;
}
.cef-launch-btn:hover {
    background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
}
.cef-launch-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}
.interceptor-toggle-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 5px;
}
.interceptor-toggle-btn.enabled {
    background: #28a745;
    color: white;
}
.interceptor-toggle-btn.disabled {
    background: #dc3545;
    color: white;
}
.interceptor-toggle-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}
.app-toolbar {
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.app-button {
    padding: 8px 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.2s;
    font-size: 13px;
}
.app-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.app-button.disabled {
    background: #ccc;
    cursor: not-allowed;
}
.browser-frame {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
    overflow: hidden;
}
.browser-frame iframe {
    width: 100%;
    height: 100%;
    border: none;
}
.info-message {
    background: #e3f2fd;
    padding: 15px;
    border-left: 4px solid #2196f3;
    margin: 10px 0;
    border-radius: 3px;
}
.session-info {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
    font-size: 0.9em;
}
{% endblock %}

{% block content %}
<div class="session-info">
    <strong>Session ID:</strong> {{ session.id }} | 
    <strong>Started:</strong> {{ session.started_at|date:"Y-m-d H:i:s" }}
</div>

<div class="info-message">
    <strong>ðŸ’¡ Browser Options:</strong> 
    Use the iframe browser below for most sites. 
    Click "Launch Full Browser (CEF)" to open CEF desktop browser for sites that block iframes (Google, Facebook, etc.) or when you need Chrome DevTools (F12).
</div>

<div class="browser-container">
    <div class="browser-toolbar">
        <button class="toolbar-button" onclick="history.back()" title="Back">â—„</button>
        <button class="toolbar-button" onclick="history.forward()" title="Forward">â–º</button>
        <button class="toolbar-button" onclick="reload()" title="Reload">âŸ³</button>
        <input type="text" class="url-bar" id="url-bar" placeholder="Enter URL (e.g., https://example.com)" onkeypress="handleUrlEnter(event)">
        <button class="toolbar-button" onclick="navigate()">Go</button>
        <button class="toolbar-button cef-launch-btn" onclick="launchCEFBrowser()" title="Launch full desktop browser with CEF">ðŸš€ Launch Full Browser (CEF)</button>
        <button id="interceptor-toggle" class="interceptor-toggle-btn {% if interceptor_enabled %}enabled{% else %}disabled{% endif %}" onclick="toggleInterceptor()" title="Toggle Interceptor">
            <span id="interceptor-icon">{% if interceptor_enabled %}ðŸŸ¢{% else %}ðŸ”´{% endif %}</span>
            <span id="interceptor-label">{% if interceptor_enabled %}Interceptor ON{% else %}Interceptor OFF{% endif %}</span>
        </button>
    </div>
    
    <div class="app-toolbar">
        <strong>Available Apps:</strong>
        {% for app in enabled_apps %}
        <button class="app-button" onclick="triggerApp('{{ app.app_name }}', '{{ app.display_name }}')">
            {{ app.icon }} {{ app.display_name }}
        </button>
        {% endfor %}
        {% if not enabled_apps %}
        <span style="color: #999;">No apps enabled. Visit <a href="/app-manager/">App Manager</a> to enable apps.</span>
        {% endif %}
    </div>
    
    <div class="browser-frame">
        <iframe id="browser-iframe" sandbox="allow-scripts allow-popups allow-forms"></iframe>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
const sessionId = {{ session.id }};
let currentUrl = '';
let interceptorEnabled = {% if interceptor_enabled %}true{% else %}false{% endif %};

function navigate() {
    const urlBar = document.getElementById('url-bar');
    let url = urlBar.value.trim();
    
    if (!url) {
        alert('Please enter a URL');
        return;
    }
    
    // Add protocol if missing
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
    }
    
    currentUrl = url;
    
    // Load in iframe
    const iframe = document.getElementById('browser-iframe');
    
    // If interceptor is enabled, show a notice
    if (interceptorEnabled) {
        console.log('Interceptor is enabled - traffic would be routed through interceptor');
        // In a full implementation, this would configure the iframe to use a proxy
        // For now, we'll add a note to the user
        logHistory(url, 'Navigated with Interceptor ON');
    } else {
        logHistory(url);
    }
    
    iframe.src = url;
}

function handleUrlEnter(event) {
    if (event.key === 'Enter') {
        navigate();
    }
}

function reload() {
    const iframe = document.getElementById('browser-iframe');
    if (iframe.src) {
        iframe.contentWindow.location.reload();
    } else {
        alert('Please navigate to a URL first');
    }
}

async function toggleInterceptor() {
    try {
        const response = await fetch('/browser/api/interceptor-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ is_enabled: !interceptorEnabled })
        });
        
        const data = await response.json();
        
        if (data.success) {
            interceptorEnabled = data.is_enabled;
            updateInterceptorUI(interceptorEnabled);
            
            const message = interceptorEnabled 
                ? 'Interceptor enabled. Browser traffic will be routed through the interceptor.'
                : 'Interceptor disabled. Browser traffic will pass through normally.';
            alert(message);
        }
    } catch (error) {
        console.error('Error toggling interceptor:', error);
        alert('Failed to toggle interceptor. Please try again.');
    }
}

function updateInterceptorUI(isEnabled) {
    const toggleBtn = document.getElementById('interceptor-toggle');
    const icon = document.getElementById('interceptor-icon');
    const label = document.getElementById('interceptor-label');
    
    if (isEnabled) {
        toggleBtn.className = 'interceptor-toggle-btn enabled';
        icon.textContent = 'ðŸŸ¢';
        label.textContent = 'Interceptor ON';
    } else {
        toggleBtn.className = 'interceptor-toggle-btn disabled';
        icon.textContent = 'ðŸ”´';
        label.textContent = 'Interceptor OFF';
    }
}

// Poll for interceptor status changes
async function checkInterceptorStatus() {
    try {
        const response = await fetch('/browser/api/interceptor-status/');
        const data = await response.json();
        
        if (data.is_enabled !== interceptorEnabled) {
            interceptorEnabled = data.is_enabled;
            updateInterceptorUI(interceptorEnabled);
        }
    } catch (error) {
        console.error('Error checking interceptor status:', error);
    }
}

// Check status every 3 seconds
setInterval(checkInterceptorStatus, 3000);

function logHistory(url, title = '') {
    fetch('/browser/api/history/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            session_id: sessionId,
            url: url,
            title: title
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('History logged:', data);
    })
    .catch(error => {
        console.error('Error logging history:', error);
    });
}

function triggerApp(appName, displayName) {
    if (!currentUrl) {
        alert('Please navigate to a URL first');
        return;
    }
    
    // Log the app interaction
    fetch('/browser/api/interaction/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            session_id: sessionId,
            app_name: appName,
            action: 'triggered_from_browser',
            target_url: currentUrl,
            result: 'App integration triggered'
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('App interaction logged:', data);
        alert(`${displayName} triggered for ${currentUrl}\n\nIn production, this would invoke the ${appName} app functionality.`);
    })
    .catch(error => {
        console.error('Error logging interaction:', error);
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function launchCEFBrowser() {
    const button = document.querySelector('.cef-launch-btn');
    button.disabled = true;
    button.textContent = 'ðŸš€ Launching...';
    
    try {
        const response = await fetch('/browser/api/launch-cef/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                django_url: window.location.origin
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('âœ… CEF browser launched! Look for a new window.');
        } else {
            alert('âŒ Error: ' + data.error);
        }
    } catch (error) {
        alert('âŒ Failed to launch CEF browser: ' + error.message);
    } finally {
        button.disabled = false;
        button.textContent = 'ðŸš€ Launch Full Browser (CEF)';
    }
}

</script>
{% endblock %}
