{% extends 'base.html' %}

{% block title %}Bypasser - Character Probing & Filter Bypass - Megido Security{% endblock %}

{% block extra_style %}
.bypass-form {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
    margin: 20px 0;
}
.results-section {
    margin-top: 30px;
}
.character-item {
    display: inline-block;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    margin: 5px;
    min-width: 80px;
    text-align: center;
}
.char-blocked { 
    border-left: 5px solid #dc3545; 
    background: #fff5f5;
}
.char-allowed { 
    border-left: 5px solid #28a745;
    background: #f5fff5;
}
.char-error { 
    border-left: 5px solid #ffc107;
    background: #fffbf0;
}
.encoding-result {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin: 10px 0;
}
.bypass-success {
    border-left: 5px solid #28a745;
    background: #f5fff5;
}
.bypass-failed {
    border-left: 5px solid #6c757d;
    background: #f8f9fa;
}
input[type="text"], select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 10px;
}
button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
}
button:hover {
    opacity: 0.9;
}
button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.stats-box {
    background: #e7f3ff;
    border-left: 4px solid #007bff;
    padding: 15px;
    margin: 15px 0;
    border-radius: 5px;
}
.character-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 15px 0;
}
.tabs {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    border-bottom: 2px solid #ddd;
}
.tab {
    padding: 10px 20px;
    cursor: pointer;
    border: none;
    background: transparent;
    border-radius: 5px 5px 0 0;
}
.tab.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
{% endblock %}

{% block content %}
<h2>üõ°Ô∏è Bypasser - Character Probing & Filter Bypass Testing</h2>
<p>Test web applications for input filtering weaknesses and discover bypass techniques using various encoding methods.</p>

<div class="bypass-form">
    <h3>Start Character Probing</h3>
    <div style="margin-top: 15px;">
        <label>Target URL:</label>
        <input type="text" id="target-url" placeholder="https://example.com/search">
    </div>
    <div style="margin-top: 10px;">
        <label>HTTP Method:</label>
        <select id="http-method">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
        </select>
    </div>
    <div style="margin-top: 10px;">
        <label>Test Parameter:</label>
        <input type="text" id="test-parameter" placeholder="q" value="q">
    </div>
    <div style="margin-top: 10px;">
        <label>Target Name (optional):</label>
        <input type="text" id="target-name" placeholder="My Test Target">
    </div>
    <button onclick="startProbing()" id="start-btn" style="margin-top: 10px;">Start Probing</button>
</div>

<div id="status-message" style="margin: 20px 0;"></div>

<div id="results-container" class="results-section" style="display: none;">
    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview', event)">Overview</button>
        <button class="tab" onclick="switchTab('blocked', event)">Blocked Characters</button>
        <button class="tab" onclick="switchTab('allowed', event)">Allowed Characters</button>
        <button class="tab" onclick="switchTab('bypasses', event)">Bypass Techniques</button>
        <button class="tab" onclick="switchTab('custom', event)">Custom Techniques</button>
    </div>
    
    <div id="tab-overview" class="tab-content active">
        <div id="statistics"></div>
        <div id="character-summary"></div>
    </div>
    
    <div id="tab-blocked" class="tab-content">
        <div id="blocked-characters"></div>
        <button onclick="testEncodingBypasses()" id="test-bypass-btn" style="margin-top: 20px;">Test Encoding Bypasses</button>
        <button onclick="testCustomTechniques()" id="test-custom-btn" style="margin-top: 20px; margin-left: 10px;">Test Custom Techniques</button>
    </div>
    
    <div id="tab-allowed" class="tab-content">
        <div id="allowed-characters"></div>
    </div>
    
    <div id="tab-bypasses" class="tab-content">
        <div id="bypass-results"></div>
    </div>
    
    <div id="tab-custom" class="tab-content">
        <h3>üîß Custom Bypass Techniques</h3>
        <p>Craft and manage your own custom bypass techniques</p>
        
        <div style="margin: 20px 0;">
            <button onclick="showCreateTechniqueForm()" style="background: #28a745;">‚ûï Create New Technique</button>
            <button onclick="loadCustomTechniques()" style="background: #17a2b8; margin-left: 10px;">üîÑ Reload Library</button>
        </div>
        
        <div id="create-technique-form" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0;">
            <h4>Create Custom Technique</h4>
            <div style="margin-top: 15px;">
                <label>Name:</label>
                <input type="text" id="tech-name" placeholder="e.g., Triple Encoding Bypass">
            </div>
            <div style="margin-top: 10px;">
                <label>Category:</label>
                <select id="tech-category">
                    <option value="waf">WAF Bypass</option>
                    <option value="firewall">Firewall Bypass</option>
                    <option value="ips">IPS Bypass</option>
                    <option value="ids">IDS Bypass</option>
                    <option value="filter">Input Filter Bypass</option>
                    <option value="mixed">Mixed/Multi-Layer Bypass</option>
                </select>
            </div>
            <div style="margin-top: 10px;">
                <label>Technique Template:</label>
                <textarea id="tech-template" rows="3" style="width: 100%; padding: 10px; font-family: monospace;"></textarea>
                <small style="color: #666;">
                    Use {% templatetag openvariable %}payload{% templatetag closevariable %}, {% templatetag openvariable %}char{% templatetag closevariable %}, {% templatetag openvariable %}target{% templatetag closevariable %}, {% templatetag openvariable %}param{% templatetag closevariable %} with transformations like |url_encode|html_hex
                    <a href="#" onclick="showTechniqueHelp(); return false;" style="margin-left: 10px;">üìñ View Syntax Help</a>
                </small>
            </div>
            <div style="margin-top: 10px;">
                <label>Description:</label>
                <textarea id="tech-description" rows="2" style="width: 100%; padding: 10px;" placeholder="Describe what this technique does..."></textarea>
            </div>
            <div style="margin-top: 10px;">
                <label>Example Input:</label>
                <input type="text" id="tech-example-input" placeholder="<script>" value="<script>">
            </div>
            <div style="margin-top: 10px;">
                <label>Tags (comma-separated):</label>
                <input type="text" id="tech-tags" placeholder="url,encoding,waf">
            </div>
            <div style="margin-top: 10px;">
                <label>Author:</label>
                <input type="text" id="tech-author" placeholder="Your name">
            </div>
            <div style="margin-top: 15px;">
                <button onclick="testTechniqueTemplate()" style="background: #ffc107;">üß™ Test Template</button>
                <button onclick="saveTechnique()" style="background: #28a745; margin-left: 10px;">üíæ Save Technique</button>
                <button onclick="hideCreateTechniqueForm()" style="background: #6c757d; margin-left: 10px;">‚ùå Cancel</button>
            </div>
            <div id="template-test-result" style="margin-top: 15px;"></div>
        </div>
        
        <div id="technique-help" style="display: none; background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h4>üìñ Technique Template Syntax</h4>
            <p><strong>Variables:</strong></p>
            <ul>
                <li><code>{% templatetag openvariable %}payload{% templatetag closevariable %}</code> - The main payload to transform</li>
                <li><code>{% templatetag openvariable %}char{% templatetag closevariable %}</code> - A single character to test</li>
                <li><code>{% templatetag openvariable %}target{% templatetag closevariable %}</code> - The target URL</li>
                <li><code>{% templatetag openvariable %}param{% templatetag closevariable %}</code> - The parameter name</li>
            </ul>
            <p><strong>Transformations (pipe them together):</strong></p>
            <ul style="column-count: 2;">
                <li><code>url_encode</code> - Single URL encoding</li>
                <li><code>url_encode_double</code> - Double URL encoding</li>
                <li><code>url_encode_triple</code> - Triple URL encoding</li>
                <li><code>html_decimal</code> - HTML decimal entities</li>
                <li><code>html_hex</code> - HTML hex entities</li>
                <li><code>html5_entity</code> - HTML5 named entities</li>
                <li><code>unicode</code> - Unicode escape</li>
                <li><code>base64</code> - Base64 encoding</li>
                <li><code>hex</code> - Hexadecimal</li>
                <li><code>null_byte</code> - Null byte injection</li>
                <li><code>html_comment</code> - HTML comments between chars</li>
                <li><code>sql_comment</code> - SQL comments between chars</li>
                <li><code>upper</code> - Uppercase</li>
                <li><code>lower</code> - Lowercase</li>
            </ul>
            <p><strong>Examples:</strong></p>
            <ul>
                <li><code>{% templatetag openvariable %}payload|url_encode_double{% templatetag closevariable %}</code> - Double URL encode</li>
                <li><code>{% templatetag openvariable %}payload|html_hex|url_encode{% templatetag closevariable %}</code> - HTML hex then URL encode</li>
                <li><code>test{% templatetag openvariable %}payload|upper{% templatetag closevariable %}value</code> - Uppercase with surrounding text</li>
            </ul>
            <button onclick="hideTechniqueHelp()" style="margin-top: 10px;">Close Help</button>
        </div>
        
        <div id="custom-techniques-library">
            <h4>üìö Your Technique Library</h4>
            <div id="techniques-list"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
{% verbatim %}
<script>
let currentSessionId = null;

function switchTab(tabName, event) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    
    // Show selected tab
    document.getElementById(`tab-${tabName}`).classList.add('active');
    if (event && event.target) {
        event.target.classList.add('active');
    }
}

async function startProbing() {
    const url = document.getElementById('target-url').value;
    const method = document.getElementById('http-method').value;
    const parameter = document.getElementById('test-parameter').value;
    const name = document.getElementById('target-name').value;
    
    if (!url) {
        alert('Please enter a target URL');
        return;
    }
    
    const startBtn = document.getElementById('start-btn');
    startBtn.disabled = true;
    startBtn.textContent = 'Probing...';
    
    try {
        // Create target
        const targetResponse = await fetch('/bypasser/api/targets/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                url: url,
                name: name,
                http_method: method,
                test_parameter: parameter
            })
        });
        const target = await targetResponse.json();
        
        document.getElementById('status-message').innerHTML = 
            '<p style="color: #007bff;">üîç Probing for special characters...</p>';
        
        // Start character probing
        const probeResponse = await fetch(`/bypasser/api/targets/${target.id}/probe/`, {
            method: 'POST'
        });
        const session = await probeResponse.json();
        currentSessionId = session.id;
        
        document.getElementById('status-message').innerHTML = 
            '<p style="color: #28a745;">‚úì Probing completed!</p>';
        
        // Load results
        await loadResults(session.id);
        
    } catch (error) {
        document.getElementById('status-message').innerHTML = 
            `<p style="color: #dc3545;">‚úó Error: ${error.message}</p>`;
    } finally {
        startBtn.disabled = false;
        startBtn.textContent = 'Start Probing';
    }
}

async function loadResults(sessionId) {
    try {
        const response = await fetch(`/bypasser/api/sessions/${sessionId}/results/`);
        const data = await response.json();
        
        // Show results container
        document.getElementById('results-container').style.display = 'block';
        
        // Update statistics
        document.getElementById('statistics').innerHTML = `
            <div class="stats-box">
                <h3>üìä Statistics</h3>
                <p><strong>Target:</strong> ${data.target.url}</p>
                <p><strong>Status:</strong> ${data.status}</p>
                <p><strong>Characters Tested:</strong> ${data.statistics.characters_tested}</p>
                <p><strong>Characters Blocked:</strong> <span style="color: #dc3545;">${data.statistics.characters_blocked}</span></p>
                <p><strong>Characters Allowed:</strong> <span style="color: #28a745;">${data.statistics.characters_allowed}</span></p>
            </div>
        `;
        
        // Display all character probes
        const allChars = data.character_probes.map(probe => `
            <div class="character-item char-${probe.status}">
                <div style="font-size: 1.5em; font-weight: bold;">${escapeHtml(probe.character)}</div>
                <div style="font-size: 0.8em; margin-top: 5px;">${probe.character_name}</div>
                <div style="font-size: 0.8em; color: #666;">${probe.status}</div>
            </div>
        `).join('');
        
        document.getElementById('character-summary').innerHTML = `
            <h3>All Characters Tested</h3>
            <div class="character-grid">${allChars}</div>
        `;
        
        // Display blocked characters
        if (data.blocked_characters.length > 0) {
            document.getElementById('blocked-characters').innerHTML = `
                <h3>üö´ Blocked Characters (${data.blocked_characters.length})</h3>
                <p>These characters appear to be blocked by the application's input filter or WAF:</p>
                <div class="character-grid">
                    ${data.blocked_characters.map(char => `
                        <div class="character-item char-blocked">
                            <div style="font-size: 1.5em; font-weight: bold;">${escapeHtml(char.character)}</div>
                            <div style="font-size: 0.8em; margin-top: 5px;">${char.name}</div>
                            ${char.reason ? `<div style="font-size: 0.7em; color: #666; margin-top: 3px;">${char.reason}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            document.getElementById('blocked-characters').innerHTML = `
                <p style="color: #28a745;">‚úì No blocked characters detected.</p>
            `;
        }
        
        // Display allowed characters
        if (data.allowed_characters.length > 0) {
            document.getElementById('allowed-characters').innerHTML = `
                <h3>‚úì Allowed Characters (${data.allowed_characters.length})</h3>
                <p>These characters passed through the filter without being blocked:</p>
                <div class="character-grid">
                    ${data.allowed_characters.map(char => `
                        <div class="character-item char-allowed">
                            <div style="font-size: 1.5em; font-weight: bold;">${escapeHtml(char.character)}</div>
                            <div style="font-size: 0.8em; margin-top: 5px;">${char.name}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading results:', error);
    }
}

async function testEncodingBypasses() {
    if (!currentSessionId) return;
    
    const testBtn = document.getElementById('test-bypass-btn');
    testBtn.disabled = true;
    testBtn.textContent = 'Testing Bypasses...';
    
    try {
        document.getElementById('bypass-results').innerHTML = 
            '<p style="color: #007bff;">üîÑ Testing encoding bypass techniques...</p>';
        
        const response = await fetch(`/bypasser/api/sessions/${currentSessionId}/test-bypass/`, {
            method: 'POST'
        });
        const data = await response.json();
        
        // Load bypass results
        await loadBypassResults(currentSessionId);
        
        // Switch to bypasses tab
        switchTab('bypasses');
        document.querySelectorAll('.tab')[3].classList.add('active');
        
    } catch (error) {
        document.getElementById('bypass-results').innerHTML = 
            `<p style="color: #dc3545;">‚úó Error: ${error.message}</p>`;
    } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'Test Encoding Bypasses';
    }
}

async function loadBypassResults(sessionId) {
    try {
        const response = await fetch(`/bypasser/api/sessions/${sessionId}/bypasses/`);
        const bypasses = await response.json();
        
        if (bypasses.length === 0) {
            document.getElementById('bypass-results').innerHTML = `
                <p style="color: #666;">No successful bypass techniques found.</p>
            `;
            return;
        }
        
        document.getElementById('bypass-results').innerHTML = `
            <h3>üéØ Successful Bypass Techniques (${bypasses.length})</h3>
            <p style="color: #dc3545;">‚ö†Ô∏è The following encoding techniques successfully bypassed the input filter:</p>
            ${bypasses.map(bypass => `
                <div class="encoding-result bypass-success">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 1.2em;">Character: ${escapeHtml(bypass.character)}</strong>
                            <span style="margin-left: 10px; color: #666;">(${bypass.character_name})</span>
                        </div>
                        <span style="background: #dc3545; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.9em;">
                            ${bypass.risk_level.toUpperCase()}
                        </span>
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>Encoding Type:</strong> ${bypass.encoding_type.replace(/_/g, ' ').toUpperCase()}
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Encoded Payload:</strong> 
                        <code style="background: #f8f9fa; padding: 5px; border-radius: 3px;">${escapeHtml(bypass.encoded_payload)}</code>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Example:</strong> 
                        <code style="background: #f8f9fa; padding: 5px; border-radius: 3px;">${escapeHtml(bypass.payload_example)}</code>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Technique:</strong> ${bypass.technique_description}
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Impact:</strong> ${bypass.impact_description}
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 3px;">
                        <strong>Recommendation:</strong> ${bypass.recommendation}
                    </div>
                </div>
            `).join('')}
        `;
        
    } catch (error) {
        console.error('Error loading bypass results:', error);
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;',
        '\n': '\\n',
        '\r': '\\r',
        '\t': '\\t'
    };
    return String(text).replace(/[&<>"'\n\r\t]/g, m => map[m]);
}

// ==================== Custom Techniques Functions ====================

function showCreateTechniqueForm() {
    document.getElementById('create-technique-form').style.display = 'block';
}

function hideCreateTechniqueForm() {
    document.getElementById('create-technique-form').style.display = 'none';
    // Clear form
    document.getElementById('tech-name').value = '';
    document.getElementById('tech-template').value = '';
    document.getElementById('tech-description').value = '';
    document.getElementById('tech-example-input').value = '<script>';
    document.getElementById('tech-tags').value = '';
    document.getElementById('tech-author').value = '';
}

function showTechniqueHelp() {
    document.getElementById('technique-help').style.display = 'block';
}

function hideTechniqueHelp() {
    document.getElementById('technique-help').style.display = 'none';
}

async function testTechniqueTemplate() {
    const template = document.getElementById('tech-template').value;
    const exampleInput = document.getElementById('tech-example-input').value;
    
    if (!template) {
        alert('Please enter a technique template');
        return;
    }
    
    const resultDiv = document.getElementById('template-test-result');
    resultDiv.innerHTML = '<p style="color: #007bff;">üß™ Testing template...</p>';
    
    try {
        // Create a temporary technique to test
        const testResponse = await fetch('/bypasser/api/custom-techniques/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: '__TEST_TEMP__',
                category: 'mixed',
                technique_template: template,
                is_active: false
            })
        });
        
        if (!testResponse.ok) {
            const error = await testResponse.json();
            resultDiv.innerHTML = `<p style="color: #dc3545;">‚ùå Validation Error: ${error.error}</p>`;
            return;
        }
        
        const tempTech = await testResponse.json();
        
        // Test the technique
        const testResult = await fetch(`/bypasser/api/custom-techniques/${tempTech.id}/test/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({payload: exampleInput})
        });
        
        const result = await testResult.json();
        
        // Delete the temporary technique
        await fetch(`/bypasser/api/custom-techniques/${tempTech.id}/`, {method: 'DELETE'});
        
        if (result.success) {
            resultDiv.innerHTML = `
                <div style="padding: 10px; background: #d4edda; border-left: 3px solid #28a745; border-radius: 3px;">
                    <strong>‚úì Template Valid!</strong><br>
                    <strong>Input:</strong> <code>${escapeHtml(exampleInput)}</code><br>
                    <strong>Output:</strong> <code>${escapeHtml(result.result)}</code>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `<p style="color: #dc3545;">‚ùå Execution Error: ${result.error}</p>`;
        }
        
    } catch (error) {
        resultDiv.innerHTML = `<p style="color: #dc3545;">‚ùå Error: ${error.message}</p>`;
    }
}

async function saveTechnique() {
    const name = document.getElementById('tech-name').value;
    const category = document.getElementById('tech-category').value;
    const template = document.getElementById('tech-template').value;
    const description = document.getElementById('tech-description').value;
    const exampleInput = document.getElementById('tech-example-input').value;
    const tags = document.getElementById('tech-tags').value;
    const author = document.getElementById('tech-author').value;
    
    if (!name || !template) {
        alert('Name and Template are required');
        return;
    }
    
    try {
        const response = await fetch('/bypasser/api/custom-techniques/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                category: category,
                technique_template: template,
                description: description,
                example_input: exampleInput,
                tags: tags,
                author: author
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            alert(`Error: ${error.error}`);
            return;
        }
        
        const result = await response.json();
        alert(\"‚úì Technique \"${name}" created successfully!`);
        hideCreateTechniqueForm();
        loadCustomTechniques();
        
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function loadCustomTechniques() {
    try {
        const response = await fetch('/bypasser/api/custom-techniques/');
        const techniques = await response.json();
        
        const listDiv = document.getElementById('techniques-list');
        
        if (techniques.length === 0) {
            listDiv.innerHTML = '<p style="color: #666;">No custom techniques yet. Create your first one!</p>';
            return;
        }
        
        listDiv.innerHTML = techniques.map(tech => `
            <div style="border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin: 10px 0; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h5 style="margin: 0;">${escapeHtml(tech.name)}</h5>
                        <span style="background: #667eea; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.85em; margin-right: 5px;">
                            ${tech.category.toUpperCase()}
                        </span>
                        ${tech.tags ? `<span style="color: #666; font-size: 0.9em;">üè∑Ô∏è ${escapeHtml(tech.tags)}</span>` : ''}
                    </div>
                    <div>
                        <span style="background: ${tech.is_active ? '#28a745' : '#6c757d'}; color: white; padding: 5px 10px; border-radius: 3px; font-size: 0.9em;">
                            ${tech.is_active ? '‚úì Active' : '‚úó Inactive'}
                        </span>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <strong>Description:</strong> ${escapeHtml(tech.description || 'No description')}
                </div>
                <div style="margin-top: 10px; background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 0.9em;">
                    ${escapeHtml(tech.technique_template)}
                </div>
                <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 0.9em; color: #666;">
                        üìä Used: ${tech.times_used} | Success: ${tech.times_successful} | Rate: ${tech.success_rate.toFixed(1)}%
                        ${tech.author ? `| üë§ ${escapeHtml(tech.author)}` : ''}
                    </div>
                    <div>
                        <button onclick="testSingleTechnique(${tech.id})" style="padding: 5px 10px; font-size: 0.9em; background: #ffc107;">
                            üß™ Test
                        </button>
                        <button onclick="deleteTechnique(${tech.id}, '${escapeHtml(tech.name)}')" style="padding: 5px 10px; font-size: 0.9em; background: #dc3545; margin-left: 5px;">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading techniques:', error);
        document.getElementById('techniques-list').innerHTML = '<p style="color: #dc3545;">Error loading techniques</p>';
    }
}

async function testSingleTechnique(techniqueId) {
    const payload = prompt('Enter test payload:', '<script>alert(1)</script>');
    if (!payload) return;
    
    try {
        const response = await fetch(`/bypasser/api/custom-techniques/${techniqueId}/test/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({payload: payload})
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úì Test Successful!\n\nInput: ${payload}\nOutput: ${result.result}`);
        } else {
            alert(`‚úó Test Failed\n\nError: ${result.error}`);
        }
        
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function deleteTechnique(techniqueId, name) {
    if (!confirm(\"Delete technique \"${name}"?\")) return;
    
    try {
        const response = await fetch(`/bypasser/api/custom-techniques/${techniqueId}/`, {
            method: 'DELETE'
        });
        
        if (response.ok || response.status === 204) {
            alert(\"‚úì Technique \"${name}" deleted\");
            loadCustomTechniques();
        } else {
            alert('Error deleting technique');
        }
        
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function testCustomTechniques() {
    if (!currentSessionId) return;
    
    const testBtn = document.getElementById('test-custom-btn');
    testBtn.disabled = true;
    testBtn.textContent = 'Testing Custom Techniques...';
    
    try {
        const response = await fetch(`/bypasser/api/sessions/${currentSessionId}/use-custom/`, {
            method: 'POST'
        });
        const data = await response.json();
        
        alert(`Custom Technique Testing Complete!\n\nTechniques tested: ${data.techniques_tested}\nSuccessful bypasses: ${data.successful_bypasses}`);
        
        // Reload results
        await loadResults(currentSessionId);
        
    } catch (error) {
        alert(`Error: ${error.message}`);
    } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'Test Custom Techniques';
    }
}

// Load custom techniques when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadCustomTechniques();
});
</script>
{% endverbatim %}
{% endblock %}
