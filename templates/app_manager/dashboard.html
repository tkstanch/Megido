{% extends 'base.html' %}

{% block title %}App Manager - Megido Security{% endblock %}

{% block extra_style %}
.app-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
}
.app-card {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    transition: all 0.3s;
}
.app-card.enabled {
    border-color: #4caf50;
    background: #f1f8f4;
}
.app-card.disabled {
    border-color: #f44336;
    background: #fef1f1;
    opacity: 0.7;
}
.app-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.app-icon {
    font-size: 2em;
    margin-right: 10px;
}
.app-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #333;
}
.app-description {
    color: #666;
    line-height: 1.6;
    margin-bottom: 15px;
}
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}
input:checked + .slider {
    background-color: #4caf50;
}
input:checked + .slider:before {
    transform: translateX(26px);
}
.capabilities {
    margin-top: 10px;
}
.capability-tag {
    display: inline-block;
    background: #667eea;
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.85em;
    margin: 3px;
}
.status-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.9em;
    font-weight: bold;
}
.status-badge.active {
    background: #4caf50;
    color: white;
}
.status-badge.inactive {
    background: #f44336;
    color: white;
}
.info-panel {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
    margin-bottom: 20px;
}
.stats {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
}
.stat-item {
    text-align: center;
}
.stat-value {
    font-size: 2em;
    font-weight: bold;
    color: #667eea;
}
.stat-label {
    color: #666;
    margin-top: 5px;
}
{% endblock %}

{% block content %}
<div class="info-panel">
    <h2>üîß App Management Dashboard</h2>
    <p>Control which apps are enabled/disabled in the Megido Security platform. Toggle switches to enable or disable specific functionality.</p>
    
    <div class="stats">
        <div class="stat-item">
            <div class="stat-value" id="total-apps">{{ apps|length }}</div>
            <div class="stat-label">Total Apps</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="enabled-apps">0</div>
            <div class="stat-label">Enabled Apps</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="disabled-apps">0</div>
            <div class="stat-label">Disabled Apps</div>
        </div>
    </div>
</div>

{% if apps %}
<div class="app-grid">
    {% for app in apps %}
    <div class="app-card {% if app.is_enabled %}enabled{% else %}disabled{% endif %}" data-app-id="{{ app.id }}">
        <div class="app-header">
            <div>
                <span class="app-icon">{{ app.icon }}</span>
                <span class="app-title">{{ app.display_name }}</span>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" {% if app.is_enabled %}checked{% endif %} onchange="toggleApp({{ app.id }}, this)">
                <span class="slider"></span>
            </label>
        </div>
        <div class="app-description">{{ app.description }}</div>
        <div>
            <span class="status-badge {% if app.is_enabled %}active{% else %}inactive{% endif %}">
                {% if app.is_enabled %}‚óè Active{% else %}‚óã Inactive{% endif %}
            </span>
        </div>
        <div class="capabilities">
            {% for capability in app.get_capabilities_list %}
            <span class="capability-tag">{{ capability }}</span>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="info-panel" style="margin-top: 20px; text-align: center; padding: 40px;">
    <h3>‚ö†Ô∏è No Apps Found</h3>
    <p>No application configurations were found in the database.</p>
    <p>Please run the following command to populate the apps:</p>
    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; display: inline-block; margin-top: 10px;">python manage.py populate_apps</pre>
</div>
{% endif %}
{% endblock %}

{% block extra_script %}
<script>
function updateStats() {
    console.log('[App Manager] Updating statistics...');
    const totalApps = document.querySelectorAll('.app-card').length;
    const enabledApps = document.querySelectorAll('.app-card.enabled').length;
    const disabledApps = totalApps - enabledApps;
    
    console.log(`[App Manager] Stats - Total: ${totalApps}, Enabled: ${enabledApps}, Disabled: ${disabledApps}`);
    
    document.getElementById('total-apps').textContent = totalApps;
    document.getElementById('enabled-apps').textContent = enabledApps;
    document.getElementById('disabled-apps').textContent = disabledApps;
}

function toggleApp(appId, checkbox) {
    console.log(`[App Manager] Toggling app ID: ${appId}, current state: ${checkbox.checked}`);
    
    fetch(`/app-manager/api/apps/${appId}/toggle/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        console.log(`[App Manager] Received response with status: ${response.status}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('[App Manager] Toggle response:', data);
        if (data.success) {
            const card = document.querySelector(`[data-app-id="${appId}"]`);
            const badge = card.querySelector('.status-badge');
            
            if (data.is_enabled) {
                console.log(`[App Manager] Enabling app: ${data.app_name}`);
                card.classList.remove('disabled');
                card.classList.add('enabled');
                badge.classList.remove('inactive');
                badge.classList.add('active');
                badge.textContent = '‚óè Active';
            } else {
                console.log(`[App Manager] Disabling app: ${data.app_name}`);
                card.classList.remove('enabled');
                card.classList.add('disabled');
                badge.classList.remove('active');
                badge.classList.add('inactive');
                badge.textContent = '‚óã Inactive';
            }
            
            updateStats();
        } else {
            console.error('[App Manager] Toggle failed:', data.error || 'Unknown error');
            alert('Failed to toggle app: ' + (data.error || 'Unknown error'));
            checkbox.checked = !checkbox.checked;
        }
    })
    .catch(error => {
        console.error('[App Manager] Error toggling app:', error);
        alert('Error toggling app: ' + error.message);
        checkbox.checked = !checkbox.checked; // Revert toggle
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize stats on page load
console.log('[App Manager] Dashboard loaded, initializing...');
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[App Manager] DOM Content Loaded');
        updateStats();
    });
} else {
    // DOM is already loaded
    updateStats();
}
</script>
{% endblock %}
