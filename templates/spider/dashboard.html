{% extends 'base.html' %}

{% block title %}Web Spider - Megido Security{% endblock %}

{% block extra_style %}
.spider-form {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
    margin: 20px 0;
}
.spider-config {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin: 15px 0;
}
.config-option {
    display: flex;
    align-items: center;
    gap: 10px;
}
.spider-results {
    margin-top: 30px;
}
.result-section {
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin: 15px 0;
}
.result-section h4 {
    margin-bottom: 15px;
    color: #667eea;
    border-bottom: 2px solid #667eea;
    padding-bottom: 5px;
}
.url-item, .content-item {
    border-left: 3px solid #007bff;
    padding: 10px;
    margin: 8px 0;
    background: #f8f9fa;
    border-radius: 3px;
}
.url-item.hidden {
    border-left-color: #ffc107;
}
.url-item.interesting {
    border-left-color: #dc3545;
}
.risk-critical { border-left: 4px solid #dc3545; }
.risk-high { border-left: 4px solid #fd7e14; }
.risk-medium { border-left: 4px solid #ffc107; }
.risk-low { border-left: 4px solid #28a745; }
.risk-info { border-left: 4px solid #17a2b8; }
.badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 0.85em;
    font-weight: bold;
    margin-right: 5px;
}
.badge-crawl { background: #007bff; color: white; }
.badge-dirbuster { background: #28a745; color: white; }
.badge-nikto { background: #dc3545; color: white; }
.badge-wikto { background: #fd7e14; color: white; }
.badge-brute_force { background: #6c757d; color: white; }
.badge-inference { background: #6f42c1; color: white; }
.badge-GET { background: #17a2b8; color: white; }
.badge-POST { background: #e83e8c; color: white; }
.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}
.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}
.stat-card .number {
    font-size: 2em;
    font-weight: bold;
}
.stat-card .label {
    font-size: 0.9em;
    opacity: 0.9;
}
input[type="text"], input[type="number"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 10px;
}
input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}
label {
    font-weight: 500;
}
button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
}
button:hover {
    opacity: 0.9;
}
button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 10px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 5px;
    padding: 15px;
    margin: 15px 0;
    color: #0c5460;
}
.tabs {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 20px;
}
.tab {
    padding: 10px 20px;
    cursor: pointer;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-bottom: none;
    margin-right: 5px;
    border-radius: 5px 5px 0 0;
}
.tab.active {
    background: white;
    border-bottom: 2px solid white;
    margin-bottom: -2px;
    color: #667eea;
    font-weight: bold;
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
/* Parameter Filter Styles */
.filter-bar {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 20px;
    position: sticky;
    top: 10px;
    z-index: 10;
}
.filter-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
    align-items: center;
}
.filter-input, .filter-select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95em;
    transition: border-color 0.2s;
}
.filter-input:focus, .filter-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}
.filter-input {
    flex: 1;
    min-width: 200px;
}
.filter-select {
    min-width: 150px;
}
.filter-checkbox-group {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}
.filter-checkbox-label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: normal;
    cursor: pointer;
    font-size: 0.9em;
}
.filter-checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    margin: 0;
}
.clear-filters-btn {
    background: #6c757d;
    padding: 8px 16px;
    font-size: 0.9em;
}
.clear-filters-btn:hover {
    background: #5a6268;
}
.results-counter {
    font-size: 0.9em;
    color: #666;
    margin-top: 5px;
}
.highlight {
    background-color: #fff3cd;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: bold;
}
.no-results-message {
    text-align: center;
    padding: 40px 20px;
    color: #666;
    font-size: 1.1em;
}
.parameter-item {
    transition: opacity 0.2s;
}
.parameter-item.filtered-out {
    display: none;
}
@media (max-width: 768px) {
    .filter-row {
        flex-direction: column;
    }
    .filter-input, .filter-select {
        width: 100%;
    }
    .filter-bar {
        position: relative;
        top: 0;
    }
}
{% endblock %}

{% block content %}
<h2>üï∑Ô∏è Web Spider & Content Discovery</h2>
<p>Automated web spidering with DirBuster, Nikto, Wikto integration, brute force, and content inference.</p>

<div class="result-section" style="margin-bottom: 30px;">
    <h3>üìä Spider Analytics</h3>
    <button onclick="loadAnalytics()" style="margin-bottom: 15px;">
        üîÑ Refresh Analytics
    </button>
    <div id="analytics-content">
        <div style="text-align: center; padding: 20px;">
            <span class="spinner"></span> Loading analytics...
        </div>
    </div>
</div>

<hr style="border: none; border-top: 2px solid #ddd; margin: 30px 0;">

<div class="spider-form">
    <h3>Configure Spider Target</h3>
    <div style="margin-top: 15px;">
        <label>Target URL:</label>
        <input type="text" id="target-url" placeholder="https://example.com" value="https://example.com">
    </div>
    <div style="margin-top: 10px;">
        <label>Target Name (optional):</label>
        <input type="text" id="target-name" placeholder="My Target">
    </div>
    <div style="margin-top: 10px;">
        <label>Maximum Crawl Depth:</label>
        <input type="number" id="max-depth" value="3" min="1" max="10">
    </div>
    
    <div class="spider-config">
        <div class="config-option">
            <input type="checkbox" id="use-dirbuster" checked>
            <label for="use-dirbuster">Use DirBuster Discovery</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="use-nikto" checked>
            <label for="use-nikto">Use Nikto Scanning</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="use-wikto" checked>
            <label for="use-wikto">Use Wikto Scanning</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="enable-brute" checked>
            <label for="enable-brute">Enable Brute Force</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="enable-inference" checked>
            <label for="enable-inference">Enable Content Inference</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="enable-param-discovery" checked>
            <label for="enable-param-discovery">Enable Parameter Discovery</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="follow-external">
            <label for="follow-external">Follow External Links</label>
        </div>
    </div>
    
    <h4 style="margin-top: 20px;">üîí Stealth Options</h4>
    <div class="spider-config">
        <div class="config-option">
            <input type="checkbox" id="enable-stealth" checked>
            <label for="enable-stealth">Enable Stealth Mode</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="use-random-ua" checked>
            <label for="use-random-ua">Use Random User Agents</label>
        </div>
    </div>
    <div class="spider-config">
        <div style="grid-column: span 1;">
            <label for="delay-min" style="display: block; margin-bottom: 5px;">Min Delay (seconds):</label>
            <input type="number" id="delay-min" value="1.0" step="0.1" min="0.1" max="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
        </div>
        <div style="grid-column: span 1;">
            <label for="delay-max" style="display: block; margin-bottom: 5px;">Max Delay (seconds):</label>
            <input type="number" id="delay-max" value="3.0" step="0.1" min="0.1" max="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
        </div>
        <div style="grid-column: span 1;">
            <label for="request-timeout" style="display: block; margin-bottom: 5px;">Request Timeout (seconds):</label>
            <input type="number" id="request-timeout" value="30" step="1" min="5" max="120" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
        </div>
        <div style="grid-column: span 1;">
            <label for="max-retries" style="display: block; margin-bottom: 5px;">Max Retries:</label>
            <input type="number" id="max-retries" value="3" step="1" min="0" max="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
        </div>
    </div>
    
    <button onclick="startSpider()" id="start-btn" style="margin-top: 15px;">
        üï∑Ô∏è Start Spider
    </button>
</div>

<div id="spider-status" style="margin: 20px 0;"></div>

<div class="spider-results" id="spider-results">
</div>
{% endblock %}

{% block extra_script %}
<script>
let currentSessionId = null;

// Extract CSRF token from browser cookies for API requests
function getCsrfTokenFromCookies(tokenName) {
    const allCookies = document.cookie;
    if (!allCookies || allCookies.length === 0) {
        return null;
    }
    
    const cookiePairs = allCookies.split(';');
    for (let i = 0; i < cookiePairs.length; i++) {
        const cookiePair = cookiePairs[i].trim();
        const separatorIndex = cookiePair.indexOf('=');
        if (separatorIndex > 0) {
            const key = cookiePair.substring(0, separatorIndex);
            if (key === tokenName) {
                const encodedValue = cookiePair.substring(separatorIndex + 1);
                return decodeURIComponent(encodedValue);
            }
        }
    }
    return null;
}

async function startSpider() {
    const url = document.getElementById('target-url').value;
    const name = document.getElementById('target-name').value;
    const maxDepth = parseInt(document.getElementById('max-depth').value);
    const useDirbuster = document.getElementById('use-dirbuster').checked;
    const useNikto = document.getElementById('use-nikto').checked;
    const useWikto = document.getElementById('use-wikto').checked;
    const enableBrute = document.getElementById('enable-brute').checked;
    const enableInference = document.getElementById('enable-inference').checked;
    const enableParamDiscovery = document.getElementById('enable-param-discovery').checked;
    const followExternal = document.getElementById('follow-external').checked;
    const enableStealth = document.getElementById('enable-stealth').checked;
    const useRandomUA = document.getElementById('use-random-ua').checked;
    const delayMin = parseFloat(document.getElementById('delay-min').value);
    const delayMax = parseFloat(document.getElementById('delay-max').value);
    const requestTimeout = parseInt(document.getElementById('request-timeout').value);
    const maxRetries = parseInt(document.getElementById('max-retries').value);
    
    if (!url) {
        alert('Please enter a target URL');
        return;
    }
    
    const startBtn = document.getElementById('start-btn');
    startBtn.disabled = true;
    startBtn.innerHTML = '<span class="spinner"></span> Spidering in progress...';
    
    // Extract CSRF token for authenticated requests
    const csrfToken = getCsrfTokenFromCookies('csrftoken');
    
    try {
        // Create target
        const targetResponse = await fetch('/spider/api/targets/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                url, name, max_depth: maxDepth,
                use_dirbuster: useDirbuster,
                use_nikto: useNikto,
                use_wikto: useWikto,
                enable_brute_force: enableBrute,
                enable_inference: enableInference,
                enable_parameter_discovery: enableParamDiscovery,
                follow_external_links: followExternal,
                enable_stealth_mode: enableStealth,
                use_random_user_agents: useRandomUA,
                stealth_delay_min: delayMin,
                stealth_delay_max: delayMax,
                request_timeout: requestTimeout,
                max_retries: maxRetries
            })
        });
        
        // Check response status before parsing JSON
        if (!targetResponse.ok) {
            const errorText = await targetResponse.text();
            throw new Error(`Failed to create target: ${targetResponse.status} - ${errorText}`);
        }
        
        const target = await targetResponse.json();
        
        document.getElementById('spider-status').innerHTML = `
            <div class="info">
                <strong>‚è≥ Spider running...</strong><br>
                This may take several minutes depending on the target size and enabled features.
            </div>
        `;
        
        // Start spider
        const spiderResponse = await fetch(`/spider/api/targets/${target.id}/spider/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        });
        
        // Check response status before parsing JSON
        if (!spiderResponse.ok) {
            const errorText = await spiderResponse.text();
            throw new Error(`Failed to start spider: ${spiderResponse.status} - ${errorText}`);
        }
        
        const session = await spiderResponse.json();
        
        if (session.error) {
            throw new Error(session.error);
        }
        
        currentSessionId = session.id;
        
        // Start polling for results
        pollForResults(session.id);
        
    } catch (error) {
        document.getElementById('spider-status').innerHTML = `
            <div class="info" style="background: #f8d7da; border-color: #f5c6cb; color: #721c24;">
                <strong>‚ùå Error:</strong> ${error.message}
            </div>
        `;
        startBtn.disabled = false;
        startBtn.innerHTML = 'üï∑Ô∏è Start Spider';
    }
}

async function checkSessionStatus(sessionId) {
    try {
        const response = await fetch(`/spider/api/sessions/${sessionId}/results/`);
        if (!response.ok) {
            return { status: 'unknown', error: `HTTP ${response.status}` };
        }
        const data = await response.json();
        return { status: data.status, data: data };
    } catch (error) {
        return { status: 'error', error: error.message };
    }
}

async function pollForResults(sessionId, attempt = 0, maxAttempts = 60) {
    // Poll every 3 seconds for up to 60 attempts (total: 180 seconds = 3 minutes)
    const retryDelay = 3000;
    const startBtn = document.getElementById('start-btn');
    
    try {
        const statusCheck = await checkSessionStatus(sessionId);
        
        if (statusCheck.status === 'completed') {
            // Spider finished successfully
            await loadResults(sessionId);
        } else if (statusCheck.status === 'running') {
            // Spider still running, continue polling
            document.getElementById('spider-status').innerHTML = `
                <div class="info">
                    <strong>‚è≥ Spider running...</strong><br>
                    Checking progress (${attempt + 1}/${maxAttempts})...
                </div>
            `;
            
            if (attempt < maxAttempts) {
                setTimeout(() => pollForResults(sessionId, attempt + 1, maxAttempts), retryDelay);
            } else {
                document.getElementById('spider-status').innerHTML = `
                    <div class="info" style="background: #fff3cd; border-color: #ffc107; color: #856404;">
                        <strong>‚ö†Ô∏è Spider taking longer than expected</strong><br>
                        The spider is still running. <a href="#" onclick="pollForResults('${sessionId}', 0, ${maxAttempts}); return false;">Click to refresh</a>
                    </div>
                `;
            }
        } else if (statusCheck.status === 'failed') {
            document.getElementById('spider-status').innerHTML = `
                <div class="info" style="background: #f8d7da; border-color: #f5c6cb; color: #721c24;">
                    <strong>‚ùå Spider failed:</strong> ${statusCheck.data.error_message || 'Unknown error'}
                </div>
            `;
            startBtn.disabled = false;
            startBtn.innerHTML = 'üï∑Ô∏è Start Spider';
        } else {
            // Network or unknown error
            throw new Error(statusCheck.error || 'Unknown error checking status');
        }
    } catch (error) {
        // Network error or other failure - retry up to 3 times before giving up
        // Note: Network retries are separate from polling attempts
        if (attempt < maxAttempts) {
            const networkRetryCount = attempt % 3;
            if (networkRetryCount < 2) {
                // Still have network retries available
                document.getElementById('spider-status').innerHTML = `
                    <div class="info">
                        <strong>‚è≥ Retrying connection...</strong><br>
                        Network retry ${networkRetryCount + 1} of 3
                    </div>
                `;
                setTimeout(() => pollForResults(sessionId, attempt + 1, maxAttempts), retryDelay);
                return;
            }
        }
        
        // Max retries exceeded or max attempts reached
        document.getElementById('spider-status').innerHTML = `
            <div class="info" style="background: #f8d7da; border-color: #f5c6cb; color: #721c24;">
                <strong>‚ùå Network Error:</strong> Unable to connect to server.<br>
                Error: ${error.message}<br>
                <a href="#" onclick="pollForResults('${sessionId}', 0, ${maxAttempts}); return false;">Click to retry</a>
            </div>
        `;
        startBtn.disabled = false;
        startBtn.innerHTML = 'üï∑Ô∏è Start Spider';
    }
}

async function loadResults(sessionId) {
    try {
        const response = await fetch(`/spider/api/sessions/${sessionId}/results/`);
        
        // Check response status before parsing JSON
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to load results: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        
        const startBtn = document.getElementById('start-btn');
        startBtn.disabled = false;
        startBtn.innerHTML = 'üï∑Ô∏è Start Spider';
        
        // Display statistics
        document.getElementById('spider-status').innerHTML = `
            <div class="stats">
                <div class="stat-card">
                    <div class="number">${data.statistics.urls_discovered}</div>
                    <div class="label">URLs Discovered</div>
                </div>
                <div class="stat-card">
                    <div class="number">${data.statistics.urls_crawled}</div>
                    <div class="label">URLs Crawled</div>
                </div>
                <div class="stat-card">
                    <div class="number">${data.statistics.hidden_content_found}</div>
                    <div class="label">Hidden Content</div>
                </div>
                <div class="stat-card">
                    <div class="number">${data.statistics.inference_results}</div>
                    <div class="label">Inferred URLs</div>
                </div>
                <div class="stat-card">
                    <div class="number">${data.statistics.parameters_discovered}</div>
                    <div class="label">Parameters Found</div>
                </div>
            </div>
        `;
        
        // Display results in tabs
        const resultsDiv = document.getElementById('spider-results');
        resultsDiv.innerHTML = `
            <h3>Spider Results</h3>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('discovered')">Discovered URLs</div>
                <div class="tab" onclick="showTab('hidden')">Hidden Content</div>
                <div class="tab" onclick="showTab('tools')">Tool Results</div>
                <div class="tab" onclick="showTab('inferred')">Inferred Content</div>
                <div class="tab" onclick="showTab('parameters')">Hidden Parameters</div>
            </div>
            
            <div id="tab-discovered" class="tab-content active">
                <div class="result-section">
                    <h4>üìã Discovered URLs (${data.discovered_urls.length})</h4>
                    ${data.discovered_urls.length === 0 ? '<p>No URLs discovered.</p>' : 
                        data.discovered_urls.map(url => `
                            <div class="url-item ${url.is_hidden ? 'hidden' : ''} ${url.is_interesting ? 'interesting' : ''}">
                                <span class="badge badge-${url.method}">${url.method}</span>
                                <strong>${url.status_code || 'N/A'}</strong> - ${url.url}
                                ${url.is_hidden ? ' <span style="color: #ffc107;">üîí Hidden</span>' : ''}
                                ${url.is_interesting ? ' <span style="color: #dc3545;">‚≠ê Interesting</span>' : ''}
                            </div>
                        `).join('')
                    }
                </div>
            </div>
            
            <div id="tab-hidden" class="tab-content">
                <div class="result-section">
                    <h4>üîç Hidden Content (${data.hidden_content.length})</h4>
                    ${data.hidden_content.length === 0 ? '<p>No hidden content found.</p>' :
                        data.hidden_content.map(content => `
                            <div class="content-item risk-${content.risk_level}">
                                <span class="badge badge-${content.method}">${content.method}</span>
                                <strong>${content.risk_level.toUpperCase()}</strong> - ${content.type}
                                <div style="margin-top: 5px; font-size: 0.9em;">
                                    <strong>URL:</strong> ${content.url}
                                </div>
                                <div style="margin-top: 3px;">
                                    <strong>Status:</strong> ${content.status_code}
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
            
            <div id="tab-tools" class="tab-content">
                <div class="result-section">
                    <h4>üõ†Ô∏è Security Tool Results</h4>
                    ${data.tool_results.length === 0 ? '<p>No tool scans performed.</p>' :
                        data.tool_results.map(tool => `
                            <div class="url-item">
                                <span class="badge badge-${tool.tool}">${tool.tool.toUpperCase()}</span>
                                <strong>Status:</strong> ${tool.status} | 
                                <strong>Findings:</strong> ${tool.findings_count}
                                ${tool.completed_at ? ` | <strong>Completed:</strong> ${new Date(tool.completed_at).toLocaleString()}` : ''}
                            </div>
                        `).join('')
                    }
                </div>
            </div>
            
            <div id="tab-inferred" class="tab-content">
                <div class="result-section">
                    <h4>üß† Inferred & Verified Content</h4>
                    ${data.inferred_content.length === 0 ? '<p>No verified inferences.</p>' :
                        data.inferred_content.map(inf => `
                            <div class="url-item ${inf.exists ? 'interesting' : ''}">
                                <span class="badge badge-inference">${inf.type}</span>
                                <strong>Confidence:</strong> ${(inf.confidence * 100).toFixed(0)}%
                                ${inf.exists ? ' ‚úÖ <strong>Exists!</strong>' : ' ‚ùå Not found'}
                                <div style="margin-top: 5px;">
                                    <strong>URL:</strong> ${inf.url}
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
            
            <div id="tab-parameters" class="tab-content">
                <div class="result-section">
                    <h4>üîë Discovered Hidden Parameters (<span id="param-total-count">${data.discovered_parameters ? data.discovered_parameters.length : 0}</span>)</h4>
                    ${!data.discovered_parameters || data.discovered_parameters.length === 0 ? '<p>No hidden parameters discovered.</p>' : `
                        <div class="filter-bar">
                            <div class="filter-row">
                                <input type="text" id="param-search" class="filter-input" placeholder="üîç Search by parameter name, value, or URL..." title="Search for parameters">
                                <select id="param-risk-filter" class="filter-select" title="Filter by risk level">
                                    <option value="all">All Risk Levels</option>
                                    <option value="critical">Critical</option>
                                    <option value="high">High</option>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                    <option value="info">Info</option>
                                </select>
                                <select id="param-type-filter" class="filter-select" title="Filter by parameter type">
                                    <option value="all">All Types</option>
                                    <option value="debug">Debug</option>
                                    <option value="test">Test</option>
                                    <option value="admin">Admin</option>
                                    <option value="developer">Developer</option>
                                    <option value="feature_flag">Feature Flag</option>
                                    <option value="other">Other</option>
                                </select>
                                <select id="param-method-filter" class="filter-select" title="Filter by HTTP method">
                                    <option value="all">All Methods</option>
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                </select>
                            </div>
                            <div class="filter-row">
                                <div class="filter-checkbox-group">
                                    <label class="filter-checkbox-label" title="Show only parameters that reveal debug information">
                                        <input type="checkbox" id="param-reveals-debug">
                                        <span>Shows Debug Info</span>
                                    </label>
                                    <label class="filter-checkbox-label" title="Show only parameters that reveal source code">
                                        <input type="checkbox" id="param-reveals-source">
                                        <span>Shows Source Code</span>
                                    </label>
                                    <label class="filter-checkbox-label" title="Show only parameters that reveal hidden content">
                                        <input type="checkbox" id="param-reveals-hidden">
                                        <span>Shows Hidden Content</span>
                                    </label>
                                </div>
                            </div>
                            <div class="filter-row">
                                <select id="param-sort" class="filter-select" title="Sort parameters">
                                    <option value="risk-desc">Risk Level (High to Low)</option>
                                    <option value="risk-asc">Risk Level (Low to High)</option>
                                    <option value="name-asc">Name (A-Z)</option>
                                    <option value="name-desc">Name (Z-A)</option>
                                </select>
                                <button onclick="clearParameterFilters()" class="clear-filters-btn">Clear All Filters</button>
                            </div>
                            <div class="results-counter" id="param-results-counter">
                                Showing ${data.discovered_parameters.length} of ${data.discovered_parameters.length} parameters
                            </div>
                        </div>
                        <div id="parameters-container">
                            ${data.discovered_parameters.map((param, index) => `
                                <div class="content-item parameter-item risk-${param.risk_level}" 
                                     data-index="${index}"
                                     data-risk="${param.risk_level}"
                                     data-type="${param.parameter_type}"
                                     data-method="${param.http_method}"
                                     data-reveals-debug="${param.reveals_debug_info || false}"
                                     data-reveals-source="${param.reveals_source_code || false}"
                                     data-reveals-hidden="${param.reveals_hidden_content || false}"
                                     data-name="${param.parameter_name.toLowerCase()}"
                                     data-value="${param.parameter_value.toLowerCase()}"
                                     data-url="${param.target_url.toLowerCase()}">
                                    <span class="badge badge-${param.http_method === 'GET' ? 'crawl' : 'brute_force'}">${param.http_method}</span>
                                    <strong>${param.risk_level.toUpperCase()}</strong> - ${param.parameter_type}
                                    <div style="margin-top: 8px;">
                                        <strong>Parameter:</strong> <span class="param-name-value">${param.parameter_name}=${param.parameter_value}</span>
                                    </div>
                                    <div style="margin-top: 5px;">
                                        <strong>URL:</strong> <span class="param-url">${param.target_url}</span>
                                    </div>
                                    ${param.reveals_debug_info ? '<div style="margin-top: 5px; color: #dc3545;">‚ö†Ô∏è Reveals Debug Information</div>' : ''}
                                    ${param.reveals_source_code ? '<div style="margin-top: 5px; color: #dc3545;">‚ö†Ô∏è Reveals Source Code</div>' : ''}
                                    ${param.reveals_hidden_content ? '<div style="margin-top: 5px; color: #ffc107;">üìÇ Reveals Hidden Content</div>' : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div id="no-params-message" class="no-results-message" style="display: none;">
                            üîç No parameters match your filters. Try adjusting your search criteria.
                        </div>
                    `}
                </div>
            </div>
        `;
        
        // Set up parameter filters after loading results
        setupParameterFilters();
        
    } catch (error) {
        console.error('Error loading results:', error);
        
        let errorMessage = 'Unknown error';
        let errorType = 'Error';
        
        if (error instanceof TypeError && error.message.includes('fetch')) {
            errorType = 'Network Error';
            errorMessage = 'Unable to connect to the server. Check if Django is running.';
        } else if (error.message.includes('500')) {
            errorType = 'Server Error';
            errorMessage = 'The server encountered an error processing your request.';
        } else if (error.message.includes('404')) {
            errorType = 'Not Found';
            errorMessage = 'Spider session not found. It may have been deleted.';
        } else {
            errorMessage = error.message;
        }
        
        const startBtn = document.getElementById('start-btn');
        startBtn.disabled = false;
        startBtn.innerHTML = 'üï∑Ô∏è Start Spider';
        
        document.getElementById('spider-status').innerHTML = `
            <div class="info" style="background: #f8d7da; border-color: #f5c6cb; color: #721c24;">
                <strong>‚ùå ${errorType}:</strong> ${errorMessage}
            </div>
        `;
    }
}

function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
}

async function loadAnalytics() {
    const analyticsContent = document.getElementById('analytics-content');
    
    // Show loading state
    analyticsContent.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <span class="spinner"></span> Loading analytics...
        </div>
    `;
    
    try {
        // Extract CSRF token for authenticated requests
        const csrfToken = getCsrfTokenFromCookies('csrftoken');
        
        const response = await fetch('/spider/api/analytics/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to load analytics: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        
        // Helper function to get status color
        const getStatusColor = (status) => {
            switch(status) {
                case 'completed': return '#28a745';
                case 'failed': return '#dc3545';
                case 'running': return '#ffc107';
                default: return '#6c757d';
            }
        };
        
        // Render global statistics
        const globalStats = data.global_stats;
        let statsHtml = `
            <div class="stats">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="number">${globalStats.total_sessions}</div>
                    <div class="label">Total Sessions</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="number">${globalStats.completed_sessions}</div>
                    <div class="label">Completed</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);">
                    <div class="number">${globalStats.failed_sessions}</div>
                    <div class="label">Failed</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
                    <div class="number">${globalStats.running_sessions}</div>
                    <div class="label">Running</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <div class="number">${globalStats.total_urls_discovered}</div>
                    <div class="label">Total URLs Found</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #6f42c1 0%, #553087 100%);">
                    <div class="number">${globalStats.total_hidden_content}</div>
                    <div class="label">Hidden Content</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fd7e14 0%, #e8590c 100%);">
                    <div class="number">${globalStats.total_parameters_discovered}</div>
                    <div class="label">Parameters Discovered</div>
                </div>
            </div>
        `;
        
        // Render recent sessions
        const sessions = data.recent_sessions;
        if (sessions.length === 0) {
            statsHtml += `
                <div style="text-align: center; padding: 20px; color: #6c757d;">
                    <p>No sessions found. Start a spider session to see analytics!</p>
                </div>
            `;
        } else {
            statsHtml += `
                <h4 style="margin-top: 30px; margin-bottom: 15px; color: #667eea;">Recent Sessions</h4>
                <div style="max-height: 600px; overflow-y: auto;">
            `;
            
            sessions.forEach(session => {
                const statusColor = getStatusColor(session.status);
                const startTime = session.started_at ? new Date(session.started_at).toLocaleString() : 'N/A';
                const endTime = session.completed_at ? new Date(session.completed_at).toLocaleString() : 'Running...';
                
                statsHtml += `
                    <div class="result-section" style="border-left: 4px solid ${statusColor}; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong>Session #${session.id}</strong>
                                <span class="badge" style="background: ${statusColor}; color: white; margin-left: 10px;">
                                    ${session.status.toUpperCase()}
                                </span>
                            </div>
                            <button onclick="loadResults(${session.id})" style="padding: 8px 16px; font-size: 0.9em;">
                                üëÅÔ∏è View Details
                            </button>
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                            <strong>Target:</strong> ${session.target_url}
                        </div>
                        <div style="font-size: 0.85em; color: #888; margin-bottom: 10px;">
                            <strong>Started:</strong> ${startTime} | <strong>Completed:</strong> ${endTime}
                        </div>
                        <div class="stats" style="margin-top: 15px;">
                            <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${session.urls_discovered}</div>
                                <div style="font-size: 0.85em; color: #666;">URLs Discovered</div>
                            </div>
                            <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #6f42c1;">${session.hidden_content_found}</div>
                                <div style="font-size: 0.85em; color: #666;">Hidden Content</div>
                            </div>
                            <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #28a745;">${session.brute_force.successful}/${session.brute_force.total}</div>
                                <div style="font-size: 0.85em; color: #666;">Brute Force Success</div>
                            </div>
                            <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #17a2b8;">${session.inference.verified}/${session.inference.created}</div>
                                <div style="font-size: 0.85em; color: #666;">Inference Verified</div>
                            </div>
                            <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #fd7e14;">${session.parameter_discovery.discovered}</div>
                                <div style="font-size: 0.85em; color: #666;">Hidden Parameters</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            statsHtml += `</div>`;
        }
        
        analyticsContent.innerHTML = statsHtml;
        
    } catch (error) {
        console.error('Error loading analytics:', error);
        analyticsContent.innerHTML = `
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; color: #721c24;">
                <strong>‚ùå Error loading analytics:</strong> ${error.message}
            </div>
        `;
    }
}

// Auto-load analytics when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
});

// Parameter Filtering Functions
function setupParameterFilters() {
    const searchInput = document.getElementById('param-search');
    const riskFilter = document.getElementById('param-risk-filter');
    const typeFilter = document.getElementById('param-type-filter');
    const methodFilter = document.getElementById('param-method-filter');
    const revealsDebug = document.getElementById('param-reveals-debug');
    const revealsSource = document.getElementById('param-reveals-source');
    const revealsHidden = document.getElementById('param-reveals-hidden');
    const sortSelect = document.getElementById('param-sort');
    
    // Only set up if search input exists (parameter tab has been loaded)
    if (!searchInput) {
        return;
    }
    
    // Remove any existing event listeners by cloning and replacing (prevents duplicates)
    const newSearchInput = searchInput.cloneNode(true);
    searchInput.parentNode.replaceChild(newSearchInput, searchInput);
    
    // Add event listeners to elements
    newSearchInput.addEventListener('input', filterParameters);
    if (riskFilter) riskFilter.addEventListener('change', filterParameters);
    if (typeFilter) typeFilter.addEventListener('change', filterParameters);
    if (methodFilter) methodFilter.addEventListener('change', filterParameters);
    if (revealsDebug) revealsDebug.addEventListener('change', filterParameters);
    if (revealsSource) revealsSource.addEventListener('change', filterParameters);
    if (revealsHidden) revealsHidden.addEventListener('change', filterParameters);
    if (sortSelect) sortSelect.addEventListener('change', filterParameters);
}

function filterParameters() {
    const searchTerm = document.getElementById('param-search')?.value.toLowerCase() || '';
    const riskLevel = document.getElementById('param-risk-filter')?.value || 'all';
    const paramType = document.getElementById('param-type-filter')?.value || 'all';
    const httpMethod = document.getElementById('param-method-filter')?.value || 'all';
    const revealsDebug = document.getElementById('param-reveals-debug')?.checked || false;
    const revealsSource = document.getElementById('param-reveals-source')?.checked || false;
    const revealsHidden = document.getElementById('param-reveals-hidden')?.checked || false;
    const sortBy = document.getElementById('param-sort')?.value || 'risk-desc';
    
    const container = document.getElementById('parameters-container');
    if (!container) return;
    
    const items = Array.from(container.querySelectorAll('.parameter-item'));
    let visibleCount = 0;
    const totalCount = items.length;
    
    // Filter items
    items.forEach(item => {
        let visible = true;
        
        // Search filter
        if (searchTerm) {
            const name = item.dataset.name || '';
            const value = item.dataset.value || '';
            const url = item.dataset.url || '';
            const searchableText = `${name} ${value} ${url}`;
            visible = visible && searchableText.includes(searchTerm);
        }
        
        // Risk level filter
        if (riskLevel !== 'all') {
            visible = visible && item.dataset.risk === riskLevel;
        }
        
        // Parameter type filter
        if (paramType !== 'all') {
            visible = visible && item.dataset.type === paramType;
        }
        
        // HTTP method filter
        if (httpMethod !== 'all') {
            visible = visible && item.dataset.method === httpMethod;
        }
        
        // Reveals filters (only apply if checked)
        if (revealsDebug) {
            visible = visible && item.dataset.revealsDebug === 'true';
        }
        if (revealsSource) {
            visible = visible && item.dataset.revealsSource === 'true';
        }
        if (revealsHidden) {
            visible = visible && item.dataset.revealsHidden === 'true';
        }
        
        if (visible) {
            item.classList.remove('filtered-out');
            visibleCount++;
            
            // Highlight search terms
            if (searchTerm) {
                highlightSearchTerms(item, searchTerm);
            } else {
                removeHighlights(item);
            }
        } else {
            item.classList.add('filtered-out');
        }
    });
    
    // Apply sorting
    sortParameters(items, sortBy, container);
    
    // Update counter
    updateParameterCounter(visibleCount, totalCount);
    
    // Show/hide no results message
    const noResultsMsg = document.getElementById('no-params-message');
    if (noResultsMsg) {
        noResultsMsg.style.display = visibleCount === 0 ? 'block' : 'none';
    }
}

function sortParameters(items, sortBy, container) {
    const riskOrder = { critical: 5, high: 4, medium: 3, low: 2, info: 1 };
    
    items.sort((a, b) => {
        switch(sortBy) {
            case 'risk-desc':
                return (riskOrder[b.dataset.risk] || 0) - (riskOrder[a.dataset.risk] || 0);
            case 'risk-asc':
                return (riskOrder[a.dataset.risk] || 0) - (riskOrder[b.dataset.risk] || 0);
            case 'name-asc':
                return (a.dataset.name || '').localeCompare(b.dataset.name || '');
            case 'name-desc':
                return (b.dataset.name || '').localeCompare(a.dataset.name || '');
            default:
                return 0;
        }
    });
    
    // Reorder items in the DOM
    items.forEach(item => container.appendChild(item));
}

function highlightSearchTerms(item, searchTerm) {
    const nameValueSpan = item.querySelector('.param-name-value');
    const urlSpan = item.querySelector('.param-url');
    
    if (nameValueSpan && !nameValueSpan.dataset.original) {
        nameValueSpan.dataset.original = nameValueSpan.textContent;
    }
    if (urlSpan && !urlSpan.dataset.original) {
        urlSpan.dataset.original = urlSpan.textContent;
    }
    
    if (nameValueSpan && nameValueSpan.dataset.original) {
        nameValueSpan.innerHTML = highlightText(nameValueSpan.dataset.original, searchTerm);
    }
    if (urlSpan && urlSpan.dataset.original) {
        urlSpan.innerHTML = highlightText(urlSpan.dataset.original, searchTerm);
    }
}

function removeHighlights(item) {
    const nameValueSpan = item.querySelector('.param-name-value');
    const urlSpan = item.querySelector('.param-url');
    
    if (nameValueSpan && nameValueSpan.dataset.original) {
        nameValueSpan.textContent = nameValueSpan.dataset.original;
    }
    if (urlSpan && urlSpan.dataset.original) {
        urlSpan.textContent = urlSpan.dataset.original;
    }
}

function highlightText(text, searchTerm) {
    if (!searchTerm) return text;
    const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function updateParameterCounter(visible, total) {
    const counter = document.getElementById('param-results-counter');
    if (counter) {
        counter.textContent = `Showing ${visible} of ${total} parameters`;
    }
}

function clearParameterFilters() {
    // Reset all filters
    const searchInput = document.getElementById('param-search');
    const riskFilter = document.getElementById('param-risk-filter');
    const typeFilter = document.getElementById('param-type-filter');
    const methodFilter = document.getElementById('param-method-filter');
    const revealsDebug = document.getElementById('param-reveals-debug');
    const revealsSource = document.getElementById('param-reveals-source');
    const revealsHidden = document.getElementById('param-reveals-hidden');
    const sortSelect = document.getElementById('param-sort');
    
    if (searchInput) searchInput.value = '';
    if (riskFilter) riskFilter.value = 'all';
    if (typeFilter) typeFilter.value = 'all';
    if (methodFilter) methodFilter.value = 'all';
    if (revealsDebug) revealsDebug.checked = false;
    if (revealsSource) revealsSource.checked = false;
    if (revealsHidden) revealsHidden.checked = false;
    if (sortSelect) sortSelect.value = 'risk-desc';
    
    // Reapply filters (which will show all items)
    filterParameters();
}

</script>
{% endblock %}
