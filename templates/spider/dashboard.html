{% extends 'base.html' %}

{% block title %}Web Spider - Megido Security{% endblock %}

{% block extra_style %}
.spider-form {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
    margin: 20px 0;
}
.spider-config {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin: 15px 0;
}
.config-option {
    display: flex;
    align-items: center;
    gap: 10px;
}
.spider-results {
    margin-top: 30px;
}
.result-section {
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin: 15px 0;
}
.result-section h4 {
    margin-bottom: 15px;
    color: #667eea;
    border-bottom: 2px solid #667eea;
    padding-bottom: 5px;
}
.url-item, .content-item {
    border-left: 3px solid #007bff;
    padding: 10px;
    margin: 8px 0;
    background: #f8f9fa;
    border-radius: 3px;
}
.url-item.hidden {
    border-left-color: #ffc107;
}
.url-item.interesting {
    border-left-color: #dc3545;
}
.risk-critical { border-left: 4px solid #dc3545; }
.risk-high { border-left: 4px solid #fd7e14; }
.risk-medium { border-left: 4px solid #ffc107; }
.risk-low { border-left: 4px solid #28a745; }
.risk-info { border-left: 4px solid #17a2b8; }
.badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 0.85em;
    font-weight: bold;
    margin-right: 5px;
}
.badge-crawl { background: #007bff; color: white; }
.badge-dirbuster { background: #28a745; color: white; }
.badge-nikto { background: #dc3545; color: white; }
.badge-wikto { background: #fd7e14; color: white; }
.badge-brute_force { background: #6c757d; color: white; }
.badge-inference { background: #6f42c1; color: white; }
.badge-GET { background: #17a2b8; color: white; }
.badge-POST { background: #e83e8c; color: white; }
.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}
.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}
.stat-card .number {
    font-size: 2em;
    font-weight: bold;
}
.stat-card .label {
    font-size: 0.9em;
    opacity: 0.9;
}
input[type="text"], input[type="number"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 10px;
}
input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}
label {
    font-weight: 500;
}
button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
}
button:hover {
    opacity: 0.9;
}
button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 10px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 5px;
    padding: 15px;
    margin: 15px 0;
    color: #0c5460;
}
.tabs {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 20px;
}
.tab {
    padding: 10px 20px;
    cursor: pointer;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-bottom: none;
    margin-right: 5px;
    border-radius: 5px 5px 0 0;
}
.tab.active {
    background: white;
    border-bottom: 2px solid white;
    margin-bottom: -2px;
    color: #667eea;
    font-weight: bold;
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
{% endblock %}

{% block content %}
<h2>üï∑Ô∏è Web Spider & Content Discovery</h2>
<p>Automated web spidering with DirBuster, Nikto, Wikto integration, brute force, and content inference.</p>

<div class="result-section" style="margin-bottom: 30px;">
    <h3>üìä Spider Analytics</h3>
    <button onclick="loadAnalytics()" style="margin-bottom: 15px;">
        üîÑ Refresh Analytics
    </button>
    <div id="analytics-content">
        <div style="text-align: center; padding: 20px;">
            <span class="spinner"></span> Loading analytics...
        </div>
    </div>
</div>

<hr style="border: none; border-top: 2px solid #ddd; margin: 30px 0;">

<div class="spider-form">
    <h3>Configure Spider Target</h3>
    <div style="margin-top: 15px;">
        <label>Target URL:</label>
        <input type="text" id="target-url" placeholder="https://example.com" value="https://example.com">
    </div>
    <div style="margin-top: 10px;">
        <label>Target Name (optional):</label>
        <input type="text" id="target-name" placeholder="My Target">
    </div>
    <div style="margin-top: 10px;">
        <label>Maximum Crawl Depth:</label>
        <input type="number" id="max-depth" value="3" min="1" max="10">
    </div>
    
    <div class="spider-config">
        <div class="config-option">
            <input type="checkbox" id="use-dirbuster" checked>
            <label for="use-dirbuster">Use DirBuster Discovery</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="use-nikto" checked>
            <label for="use-nikto">Use Nikto Scanning</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="use-wikto" checked>
            <label for="use-wikto">Use Wikto Scanning</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="enable-brute" checked>
            <label for="enable-brute">Enable Brute Force</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="enable-inference" checked>
            <label for="enable-inference">Enable Content Inference</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="enable-param-discovery" checked>
            <label for="enable-param-discovery">Enable Parameter Discovery</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="follow-external">
            <label for="follow-external">Follow External Links</label>
        </div>
    </div>
    
    <h4 style="margin-top: 20px;">üîí Stealth Options</h4>
    <div class="spider-config">
        <div class="config-option">
            <input type="checkbox" id="enable-stealth" checked>
            <label for="enable-stealth">Enable Stealth Mode</label>
        </div>
        <div class="config-option">
            <input type="checkbox" id="use-random-ua" checked>
            <label for="use-random-ua">Use Random User Agents</label>
        </div>
    </div>
    <div class="spider-config">
        <div style="grid-column: span 1;">
            <label for="delay-min" style="display: block; margin-bottom: 5px;">Min Delay (seconds):</label>
            <input type="number" id="delay-min" value="1.0" step="0.1" min="0.1" max="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
        </div>
        <div style="grid-column: span 1;">
            <label for="delay-max" style="display: block; margin-bottom: 5px;">Max Delay (seconds):</label>
            <input type="number" id="delay-max" value="3.0" step="0.1" min="0.1" max="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
        </div>
        <div style="grid-column: span 1;">
            <label for="request-timeout" style="display: block; margin-bottom: 5px;">Request Timeout (seconds):</label>
            <input type="number" id="request-timeout" value="30" step="1" min="5" max="120" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
        </div>
        <div style="grid-column: span 1;">
            <label for="max-retries" style="display: block; margin-bottom: 5px;">Max Retries:</label>
            <input type="number" id="max-retries" value="3" step="1" min="0" max="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
        </div>
    </div>
    
    <button onclick="startSpider()" id="start-btn" style="margin-top: 15px;">
        üï∑Ô∏è Start Spider
    </button>
</div>

<div id="spider-status" style="margin: 20px 0;"></div>

<div class="spider-results" id="spider-results">
</div>
{% endblock %}

{% block extra_script %}
<script>
let currentSessionId = null;

// Extract CSRF token from browser cookies for API requests
function getCsrfTokenFromCookies(tokenName) {
    const allCookies = document.cookie;
    if (!allCookies || allCookies.length === 0) {
        return null;
    }
    
    const cookiePairs = allCookies.split(';');
    for (let i = 0; i < cookiePairs.length; i++) {
        const cookiePair = cookiePairs[i].trim();
        const separatorIndex = cookiePair.indexOf('=');
        if (separatorIndex > 0) {
            const key = cookiePair.substring(0, separatorIndex);
            if (key === tokenName) {
                const encodedValue = cookiePair.substring(separatorIndex + 1);
                return decodeURIComponent(encodedValue);
            }
        }
    }
    return null;
}

async function startSpider() {
    const url = document.getElementById('target-url').value;
    const name = document.getElementById('target-name').value;
    const maxDepth = parseInt(document.getElementById('max-depth').value);
    const useDirbuster = document.getElementById('use-dirbuster').checked;
    const useNikto = document.getElementById('use-nikto').checked;
    const useWikto = document.getElementById('use-wikto').checked;
    const enableBrute = document.getElementById('enable-brute').checked;
    const enableInference = document.getElementById('enable-inference').checked;
    const enableParamDiscovery = document.getElementById('enable-param-discovery').checked;
    const followExternal = document.getElementById('follow-external').checked;
    const enableStealth = document.getElementById('enable-stealth').checked;
    const useRandomUA = document.getElementById('use-random-ua').checked;
    const delayMin = parseFloat(document.getElementById('delay-min').value);
    const delayMax = parseFloat(document.getElementById('delay-max').value);
    const requestTimeout = parseInt(document.getElementById('request-timeout').value);
    const maxRetries = parseInt(document.getElementById('max-retries').value);
    
    if (!url) {
        alert('Please enter a target URL');
        return;
    }
    
    const startBtn = document.getElementById('start-btn');
    startBtn.disabled = true;
    startBtn.innerHTML = '<span class="spinner"></span> Spidering in progress...';
    
    // Extract CSRF token for authenticated requests
    const csrfToken = getCsrfTokenFromCookies('csrftoken');
    
    try {
        // Create target
        const targetResponse = await fetch('/spider/api/targets/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                url, name, max_depth: maxDepth,
                use_dirbuster: useDirbuster,
                use_nikto: useNikto,
                use_wikto: useWikto,
                enable_brute_force: enableBrute,
                enable_inference: enableInference,
                enable_parameter_discovery: enableParamDiscovery,
                follow_external_links: followExternal,
                enable_stealth_mode: enableStealth,
                use_random_user_agents: useRandomUA,
                stealth_delay_min: delayMin,
                stealth_delay_max: delayMax,
                request_timeout: requestTimeout,
                max_retries: maxRetries
            })
        });
        
        // Check response status before parsing JSON
        if (!targetResponse.ok) {
            const errorText = await targetResponse.text();
            throw new Error(`Failed to create target: ${targetResponse.status} - ${errorText}`);
        }
        
        const target = await targetResponse.json();
        
        document.getElementById('spider-status').innerHTML = `
            <div class="info">
                <strong>‚è≥ Spider running...</strong><br>
                This may take several minutes depending on the target size and enabled features.
            </div>
        `;
        
        // Start spider
        const spiderResponse = await fetch(`/spider/api/targets/${target.id}/spider/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        });
        
        // Check response status before parsing JSON
        if (!spiderResponse.ok) {
            const errorText = await spiderResponse.text();
            throw new Error(`Failed to start spider: ${spiderResponse.status} - ${errorText}`);
        }
        
        const session = await spiderResponse.json();
        
        if (session.error) {
            throw new Error(session.error);
        }
        
        currentSessionId = session.id;
        
        // Load results
        setTimeout(() => loadResults(session.id), 2000);
        
    } catch (error) {
        document.getElementById('spider-status').innerHTML = `
            <div class="info" style="background: #f8d7da; border-color: #f5c6cb; color: #721c24;">
                <strong>‚ùå Error:</strong> ${error.message}
            </div>
        `;
        startBtn.disabled = false;
        startBtn.innerHTML = 'üï∑Ô∏è Start Spider';
    }
}

async function loadResults(sessionId) {
    try {
        const response = await fetch(`/spider/api/sessions/${sessionId}/results/`);
        
        // Check response status before parsing JSON
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to load results: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        
        const startBtn = document.getElementById('start-btn');
        startBtn.disabled = false;
        startBtn.innerHTML = 'üï∑Ô∏è Start Spider';
        
        // Display statistics
        document.getElementById('spider-status').innerHTML = `
            <div class="stats">
                <div class="stat-card">
                    <div class="number">${data.statistics.urls_discovered}</div>
                    <div class="label">URLs Discovered</div>
                </div>
                <div class="stat-card">
                    <div class="number">${data.statistics.urls_crawled}</div>
                    <div class="label">URLs Crawled</div>
                </div>
                <div class="stat-card">
                    <div class="number">${data.statistics.hidden_content_found}</div>
                    <div class="label">Hidden Content</div>
                </div>
                <div class="stat-card">
                    <div class="number">${data.statistics.inference_results}</div>
                    <div class="label">Inferred URLs</div>
                </div>
                <div class="stat-card">
                    <div class="number">${data.statistics.parameters_discovered}</div>
                    <div class="label">Parameters Found</div>
                </div>
            </div>
        `;
        
        // Display results in tabs
        const resultsDiv = document.getElementById('spider-results');
        resultsDiv.innerHTML = `
            <h3>Spider Results</h3>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('discovered')">Discovered URLs</div>
                <div class="tab" onclick="showTab('hidden')">Hidden Content</div>
                <div class="tab" onclick="showTab('tools')">Tool Results</div>
                <div class="tab" onclick="showTab('inferred')">Inferred Content</div>
                <div class="tab" onclick="showTab('parameters')">Hidden Parameters</div>
            </div>
            
            <div id="tab-discovered" class="tab-content active">
                <div class="result-section">
                    <h4>üìã Discovered URLs (${data.discovered_urls.length})</h4>
                    ${data.discovered_urls.length === 0 ? '<p>No URLs discovered.</p>' : 
                        data.discovered_urls.map(url => `
                            <div class="url-item ${url.is_hidden ? 'hidden' : ''} ${url.is_interesting ? 'interesting' : ''}">
                                <span class="badge badge-${url.method}">${url.method}</span>
                                <strong>${url.status_code || 'N/A'}</strong> - ${url.url}
                                ${url.is_hidden ? ' <span style="color: #ffc107;">üîí Hidden</span>' : ''}
                                ${url.is_interesting ? ' <span style="color: #dc3545;">‚≠ê Interesting</span>' : ''}
                            </div>
                        `).join('')
                    }
                </div>
            </div>
            
            <div id="tab-hidden" class="tab-content">
                <div class="result-section">
                    <h4>üîç Hidden Content (${data.hidden_content.length})</h4>
                    ${data.hidden_content.length === 0 ? '<p>No hidden content found.</p>' :
                        data.hidden_content.map(content => `
                            <div class="content-item risk-${content.risk_level}">
                                <span class="badge badge-${content.method}">${content.method}</span>
                                <strong>${content.risk_level.toUpperCase()}</strong> - ${content.type}
                                <div style="margin-top: 5px; font-size: 0.9em;">
                                    <strong>URL:</strong> ${content.url}
                                </div>
                                <div style="margin-top: 3px;">
                                    <strong>Status:</strong> ${content.status_code}
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
            
            <div id="tab-tools" class="tab-content">
                <div class="result-section">
                    <h4>üõ†Ô∏è Security Tool Results</h4>
                    ${data.tool_results.length === 0 ? '<p>No tool scans performed.</p>' :
                        data.tool_results.map(tool => `
                            <div class="url-item">
                                <span class="badge badge-${tool.tool}">${tool.tool.toUpperCase()}</span>
                                <strong>Status:</strong> ${tool.status} | 
                                <strong>Findings:</strong> ${tool.findings_count}
                                ${tool.completed_at ? ` | <strong>Completed:</strong> ${new Date(tool.completed_at).toLocaleString()}` : ''}
                            </div>
                        `).join('')
                    }
                </div>
            </div>
            
            <div id="tab-inferred" class="tab-content">
                <div class="result-section">
                    <h4>üß† Inferred & Verified Content</h4>
                    ${data.inferred_content.length === 0 ? '<p>No verified inferences.</p>' :
                        data.inferred_content.map(inf => `
                            <div class="url-item ${inf.exists ? 'interesting' : ''}">
                                <span class="badge badge-inference">${inf.type}</span>
                                <strong>Confidence:</strong> ${(inf.confidence * 100).toFixed(0)}%
                                ${inf.exists ? ' ‚úÖ <strong>Exists!</strong>' : ' ‚ùå Not found'}
                                <div style="margin-top: 5px;">
                                    <strong>URL:</strong> ${inf.url}
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
            
            <div id="tab-parameters" class="tab-content">
                <div class="result-section">
                    <h4>üîë Discovered Hidden Parameters (${data.discovered_parameters ? data.discovered_parameters.length : 0})</h4>
                    ${!data.discovered_parameters || data.discovered_parameters.length === 0 ? '<p>No hidden parameters discovered.</p>' :
                        data.discovered_parameters.map(param => `
                            <div class="content-item risk-${param.risk_level}">
                                <span class="badge badge-${param.http_method === 'GET' ? 'crawl' : 'brute_force'}">${param.http_method}</span>
                                <strong>${param.risk_level.toUpperCase()}</strong> - ${param.parameter_type}
                                <div style="margin-top: 8px;">
                                    <strong>Parameter:</strong> ${param.parameter_name}=${param.parameter_value}
                                </div>
                                <div style="margin-top: 5px;">
                                    <strong>URL:</strong> ${param.target_url}
                                </div>
                                ${param.reveals_debug_info ? '<div style="margin-top: 5px; color: #dc3545;">‚ö†Ô∏è Reveals Debug Information</div>' : ''}
                                ${param.reveals_source_code ? '<div style="margin-top: 5px; color: #dc3545;">‚ö†Ô∏è Reveals Source Code</div>' : ''}
                                ${param.reveals_hidden_content ? '<div style="margin-top: 5px; color: #ffc107;">üìÇ Reveals Hidden Content</div>' : ''}
                            </div>
                        `).join('')
                    }
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading results:', error);
        document.getElementById('spider-status').innerHTML = `
            <div class="info" style="background: #f8d7da; border-color: #f5c6cb; color: #721c24;">
                <strong>Error loading results:</strong> ${error.message}
            </div>
        `;
    }
}

function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
}

async function loadAnalytics() {
    const analyticsContent = document.getElementById('analytics-content');
    
    // Show loading state
    analyticsContent.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <span class="spinner"></span> Loading analytics...
        </div>
    `;
    
    try {
        // Extract CSRF token for authenticated requests
        const csrfToken = getCsrfTokenFromCookies('csrftoken');
        
        const response = await fetch('/spider/api/analytics/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to load analytics: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        
        // Helper function to get status color
        const getStatusColor = (status) => {
            switch(status) {
                case 'completed': return '#28a745';
                case 'failed': return '#dc3545';
                case 'running': return '#ffc107';
                default: return '#6c757d';
            }
        };
        
        // Render global statistics
        const globalStats = data.global_stats;
        let statsHtml = `
            <div class="stats">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="number">${globalStats.total_sessions}</div>
                    <div class="label">Total Sessions</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="number">${globalStats.completed_sessions}</div>
                    <div class="label">Completed</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);">
                    <div class="number">${globalStats.failed_sessions}</div>
                    <div class="label">Failed</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
                    <div class="number">${globalStats.running_sessions}</div>
                    <div class="label">Running</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <div class="number">${globalStats.total_urls_discovered}</div>
                    <div class="label">Total URLs Found</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #6f42c1 0%, #553087 100%);">
                    <div class="number">${globalStats.total_hidden_content}</div>
                    <div class="label">Hidden Content</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fd7e14 0%, #e8590c 100%);">
                    <div class="number">${globalStats.total_parameters_discovered}</div>
                    <div class="label">Parameters Discovered</div>
                </div>
            </div>
        `;
        
        // Render recent sessions
        const sessions = data.recent_sessions;
        if (sessions.length === 0) {
            statsHtml += `
                <div style="text-align: center; padding: 20px; color: #6c757d;">
                    <p>No sessions found. Start a spider session to see analytics!</p>
                </div>
            `;
        } else {
            statsHtml += `
                <h4 style="margin-top: 30px; margin-bottom: 15px; color: #667eea;">Recent Sessions</h4>
                <div style="max-height: 600px; overflow-y: auto;">
            `;
            
            sessions.forEach(session => {
                const statusColor = getStatusColor(session.status);
                const startTime = session.started_at ? new Date(session.started_at).toLocaleString() : 'N/A';
                const endTime = session.completed_at ? new Date(session.completed_at).toLocaleString() : 'Running...';
                
                statsHtml += `
                    <div class="result-section" style="border-left: 4px solid ${statusColor}; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong>Session #${session.id}</strong>
                                <span class="badge" style="background: ${statusColor}; color: white; margin-left: 10px;">
                                    ${session.status.toUpperCase()}
                                </span>
                            </div>
                            <button onclick="loadResults(${session.id})" style="padding: 8px 16px; font-size: 0.9em;">
                                üëÅÔ∏è View Details
                            </button>
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                            <strong>Target:</strong> ${session.target_url}
                        </div>
                        <div style="font-size: 0.85em; color: #888; margin-bottom: 10px;">
                            <strong>Started:</strong> ${startTime} | <strong>Completed:</strong> ${endTime}
                        </div>
                        <div class="stats" style="margin-top: 15px;">
                            <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${session.urls_discovered}</div>
                                <div style="font-size: 0.85em; color: #666;">URLs Discovered</div>
                            </div>
                            <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #6f42c1;">${session.hidden_content_found}</div>
                                <div style="font-size: 0.85em; color: #666;">Hidden Content</div>
                            </div>
                            <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #28a745;">${session.brute_force.successful}/${session.brute_force.total}</div>
                                <div style="font-size: 0.85em; color: #666;">Brute Force Success</div>
                            </div>
                            <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #17a2b8;">${session.inference.verified}/${session.inference.created}</div>
                                <div style="font-size: 0.85em; color: #666;">Inference Verified</div>
                            </div>
                            <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #fd7e14;">${session.parameter_discovery.discovered}</div>
                                <div style="font-size: 0.85em; color: #666;">Hidden Parameters</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            statsHtml += `</div>`;
        }
        
        analyticsContent.innerHTML = statsHtml;
        
    } catch (error) {
        console.error('Error loading analytics:', error);
        analyticsContent.innerHTML = `
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; color: #721c24;">
                <strong>‚ùå Error loading analytics:</strong> ${error.message}
            </div>
        `;
    }
}

// Auto-load analytics when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
});

</script>
{% endblock %}
