#!/usr/bin/env python3
"""
Demo: Exploitation Automation Enhancement

This demo showcases the new exploitation automation capabilities:
- XSS with form injection, browser automation, and OOB callbacks
- Information disclosure with file/path testing
- Security misconfiguration with header checking and CSP exploitation
- XXE with OOB verification
- Mixed content detection

Usage:
    python demo_exploitation_automation.py [target_url]
"""

import sys
import os
import json
import logging
from typing import Dict, Any

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from scanner.plugins.exploitation_automation_controller import (
    ExploitationAutomationController,
    ExploitationConfig,
    ExploitationResult
)

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


def print_banner():
    """Print demo banner."""
    print("""
╔══════════════════════════════════════════════════════════════╗
║                                                              ║
║    Megido Exploitation Automation Enhancement Demo          ║
║                                                              ║
║    Features:                                                 ║
║    ✓ XSS (form injection, browser automation, OOB)          ║
║    ✓ Information Disclosure (file/path testing)             ║
║    ✓ Security Misconfiguration (headers, CSP)               ║
║    ✓ XXE (entity injection, OOB verification)                ║
║    ✓ Mixed Content (HTTPS/HTTP detection)                   ║
║                                                              ║
╚══════════════════════════════════════════════════════════════╝
    """)


def demo_xss_exploitation(controller: ExploitationAutomationController, target_url: str):
    """Demo XSS exploitation with automation."""
    print("\n" + "="*70)
    print("1. XSS EXPLOITATION DEMO")
    print("="*70)
    
    print(f"\n[*] Testing XSS exploitation for: {target_url}")
    print("[*] Features:")
    print("    - Automatic form field injection")
    print("    - Headless browser automation")
    print("    - OOB callback verification")
    print("    - Screenshot evidence capture")
    
    vulnerability_data = {
        'parameter': 'q',
        'method': 'GET',
        'context': 'html',
        'injection_point': 'parameter',
    }
    
    print("\n[*] Attempting exploitation...")
    result = controller.exploit_xss(target_url, vulnerability_data)
    
    print(f"\n[+] Result: {'SUCCESS' if result.success else 'FAILED'}")
    print(f"[+] Verified: {'YES' if result.verified else 'NO'}")
    
    if result.success:
        print(f"[+] Evidence: {json.dumps(result.evidence, indent=2)}")
        if result.proof_of_exploit:
            print(f"[+] Proof of Exploit: {list(result.proof_of_exploit.keys())}")
    
    if result.error:
        print(f"[-] Error: {result.error}")
    
    return result


def demo_info_disclosure_exploitation(controller: ExploitationAutomationController, target_url: str):
    """Demo information disclosure exploitation."""
    print("\n" + "="*70)
    print("2. INFORMATION DISCLOSURE EXPLOITATION DEMO")
    print("="*70)
    
    print(f"\n[*] Testing information disclosure for: {target_url}")
    print("[*] Features:")
    print("    - Automatic sensitive file/path testing")
    print("    - Content verification")
    print("    - Multiple file extraction")
    
    vulnerability_data = {
        'paths': ['.env', 'config.php', '.git/config'],
    }
    
    print("\n[*] Attempting exploitation...")
    result = controller.exploit_info_disclosure(target_url, vulnerability_data)
    
    print(f"\n[+] Result: {'SUCCESS' if result.success else 'FAILED'}")
    
    if result.success:
        print(f"[+] Evidence: {json.dumps(result.evidence, indent=2)}")
    
    if result.error:
        print(f"[-] Error: {result.error}")
    
    return result


def demo_security_misconfiguration_exploitation(controller: ExploitationAutomationController, target_url: str):
    """Demo security misconfiguration exploitation."""
    print("\n" + "="*70)
    print("3. SECURITY MISCONFIGURATION EXPLOITATION DEMO")
    print("="*70)
    
    print(f"\n[*] Testing security misconfiguration for: {target_url}")
    print("[*] Features:")
    print("    - Comprehensive header checking")
    print("    - CSP policy analysis")
    print("    - Browser-based exploitation testing")
    print("    - Screenshot evidence")
    
    vulnerability_data = {
        'headers_to_check': ['CSP', 'HSTS', 'X-Frame-Options'],
    }
    
    print("\n[*] Attempting exploitation...")
    result = controller.exploit_security_misconfiguration(target_url, vulnerability_data)
    
    print(f"\n[+] Result: {'SUCCESS' if result.success else 'FAILED'}")
    print(f"[+] Verified: {'YES' if result.verified else 'NO'}")
    
    if result.success:
        print(f"[+] Evidence: {json.dumps(result.evidence, indent=2)[:500]}...")
    
    if result.error:
        print(f"[-] Error: {result.error}")
    
    return result


def demo_xxe_exploitation(controller: ExploitationAutomationController, target_url: str):
    """Demo XXE exploitation with OOB verification."""
    print("\n" + "="*70)
    print("4. XXE EXPLOITATION DEMO")
    print("="*70)
    
    print(f"\n[*] Testing XXE exploitation for: {target_url}")
    print("[*] Features:")
    print("    - XML entity injection")
    print("    - File extraction")
    print("    - OOB callback verification")
    
    vulnerability_data = {
        'endpoint': '/xml',
        'method': 'POST',
    }
    
    print("\n[*] Attempting exploitation...")
    result = controller.exploit_xxe(target_url, vulnerability_data)
    
    print(f"\n[+] Result: {'SUCCESS' if result.success else 'FAILED'}")
    print(f"[+] Verified: {'YES' if result.verified else 'NO'}")
    
    if result.success:
        print(f"[+] Evidence: {json.dumps(result.evidence, indent=2)}")
    
    if result.error:
        print(f"[-] Error: {result.error}")
    
    return result


def demo_mixed_content_detection(controller: ExploitationAutomationController, target_url: str):
    """Demo mixed content detection."""
    print("\n" + "="*70)
    print("5. MIXED CONTENT DETECTION DEMO")
    print("="*70)
    
    # Convert to HTTPS for mixed content detection
    if not target_url.startswith('https://'):
        target_url = target_url.replace('http://', 'https://')
    
    print(f"\n[*] Testing mixed content for: {target_url}")
    print("[*] Features:")
    print("    - HTTP resource detection on HTTPS pages")
    print("    - Risk classification")
    print("    - Browser verification")
    
    print("\n[*] Attempting detection...")
    result = controller.detect_mixed_content(target_url)
    
    print(f"\n[+] Result: {'SUCCESS' if result.success else 'FAILED'}")
    print(f"[+] Verified: {'YES' if result.verified else 'NO'}")
    
    if result.success:
        print(f"[+] Evidence: {json.dumps(result.evidence, indent=2)}")
        if result.proof_of_exploit:
            print(f"[+] Mixed Content Resources Found:")
            for resource_type, resources in result.proof_of_exploit.items():
                if isinstance(resources, dict) and 'html_analysis' in resources:
                    for res_type, res_list in resources['html_analysis'].items():
                        print(f"    - {res_type}: {len(res_list)} resources")
    
    if result.error:
        print(f"[-] Error: {result.error}")
    
    return result


def generate_summary_report(results: list, controller: ExploitationAutomationController):
    """Generate a summary report of all exploitation attempts."""
    print("\n" + "="*70)
    print("EXPLOITATION SUMMARY REPORT")
    print("="*70)
    
    report = controller.generate_report(results)
    
    print(f"\n[+] Total Exploitation Attempts: {report['summary']['total_exploits']}")
    print(f"[+] Successful: {report['summary']['successful']}")
    print(f"[+] Verified: {report['summary']['verified']}")
    print(f"[+] Failed: {report['summary']['failed']}")
    
    print("\n[+] By Vulnerability Type:")
    for vuln_type, stats in report['by_type'].items():
        print(f"    - {vuln_type}:")
        print(f"        Total: {stats['total']}")
        print(f"        Successful: {stats['successful']}")
        print(f"        Verified: {stats['verified']}")
        print(f"        Failed: {stats['failed']}")
    
    print("\n[+] Overall Statistics:")
    for key, value in controller.get_statistics().items():
        if not isinstance(value, dict):
            print(f"    - {key}: {value}")
    
    return report


def main():
    """Main demo function."""
    print_banner()
    
    # Get target URL from command line or use default
    if len(sys.argv) > 1:
        target_url = sys.argv[1]
    else:
        target_url = 'http://testphp.vulnweb.com'
        print(f"[*] No target URL provided, using default: {target_url}")
    
    print(f"\n[*] Target URL: {target_url}")
    
    # Configure exploitation automation
    config = ExploitationConfig(
        # Enable all features
        enable_xss_exploitation=True,
        enable_info_disclosure_exploitation=True,
        enable_security_misconfiguration_exploitation=True,
        enable_xxe_exploitation=True,
        enable_mixed_content_detection=True,
        
        # OOB configuration (optional - would need real callback server)
        oob_endpoint_base_url=None,  # e.g., 'https://your-callback-server.com'
        oob_use_ngrok=False,  # Set to True to use ngrok
        oob_timeout=15,  # Reduced for demo
        
        # Browser automation
        browser_automation_enabled=True,
        browser_automation_engine='playwright',
        browser_headless=True,
        
        # Evidence collection
        capture_screenshots=True,
        capture_dom_snapshots=True,
        
        # Other settings
        max_exploitation_attempts=2,
        exploitation_timeout=15,  # Reduced for demo
        verbose_logging=True,
    )
    
    print("\n[*] Configuration:")
    print(f"    - XSS Exploitation: {config.enable_xss_exploitation}")
    print(f"    - Info Disclosure: {config.enable_info_disclosure_exploitation}")
    print(f"    - Security Misconfig: {config.enable_security_misconfiguration_exploitation}")
    print(f"    - XXE Exploitation: {config.enable_xxe_exploitation}")
    print(f"    - Mixed Content: {config.enable_mixed_content_detection}")
    print(f"    - Browser Automation: {config.browser_automation_enabled}")
    print(f"    - OOB Callbacks: {bool(config.oob_endpoint_base_url or config.oob_use_ngrok)}")
    
    # Initialize controller
    print("\n[*] Initializing exploitation automation controller...")
    try:
        controller = ExploitationAutomationController(config)
        print("[+] Controller initialized successfully!")
    except Exception as e:
        print(f"[-] Failed to initialize controller: {e}")
        return 1
    
    # Run demos
    results = []
    
    try:
        # Demo 1: XSS
        result = demo_xss_exploitation(controller, target_url)
        results.append(result)
    except Exception as e:
        logger.error(f"XSS demo failed: {e}", exc_info=True)
    
    try:
        # Demo 2: Info Disclosure
        result = demo_info_disclosure_exploitation(controller, target_url)
        results.append(result)
    except Exception as e:
        logger.error(f"Info disclosure demo failed: {e}", exc_info=True)
    
    try:
        # Demo 3: Security Misconfiguration
        result = demo_security_misconfiguration_exploitation(controller, target_url)
        results.append(result)
    except Exception as e:
        logger.error(f"Security misconfiguration demo failed: {e}", exc_info=True)
    
    try:
        # Demo 4: XXE
        result = demo_xxe_exploitation(controller, target_url + '/xml')
        results.append(result)
    except Exception as e:
        logger.error(f"XXE demo failed: {e}", exc_info=True)
    
    try:
        # Demo 5: Mixed Content
        result = demo_mixed_content_detection(controller, target_url)
        results.append(result)
    except Exception as e:
        logger.error(f"Mixed content demo failed: {e}", exc_info=True)
    
    # Generate summary report
    if results:
        report = generate_summary_report(results, controller)
        
        # Save report to file
        report_file = 'exploitation_automation_report.json'
        with open(report_file, 'w') as f:
            json.dump(report, f, indent=2)
        print(f"\n[+] Full report saved to: {report_file}")
    
    print("\n" + "="*70)
    print("DEMO COMPLETED")
    print("="*70)
    
    return 0


if __name__ == '__main__':
    sys.exit(main())
