"""
ClamAV Scanner Integration

Provides real malware scanning using ClamAV antivirus engine.

⚠️  EDUCATIONAL/DEMONSTRATION USE ONLY ⚠️

LEGAL WARNINGS:
- This is for educational purposes in controlled environments
- Never use for production malware analysis without proper security
- Always use in isolated/sandboxed environments
- Follow all applicable laws and regulations

SECURITY NOTES:
- ClamAV provides real malware detection
- Files are scanned but not executed
- Use only in secure, isolated environments
- Follow best practices for malware handling
"""

import pyclamd
import logging
from typing import Dict, Optional, Tuple
import os

logger = logging.getLogger(__name__)


class ClamAVScanner:
    """
    Wrapper for ClamAV scanning functionality.
    
    Provides methods to scan files for malware using ClamAV daemon.
    """
    
    def __init__(self, host='clamav', port=3310, timeout=60):
        """
        Initialize ClamAV scanner.
        
        Args:
            host: ClamAV daemon host (default: 'clamav' for Docker)
            port: ClamAV daemon port (default: 3310)
            timeout: Connection timeout in seconds
        """
        self.host = host
        self.port = port
        self.timeout = timeout
        self._connection = None
    
    def _get_connection(self) -> Optional[pyclamd.ClamdNetworkSocket]:
        """Get or create ClamAV connection."""
        try:
            cd = pyclamd.ClamdNetworkSocket(host=self.host, port=self.port, timeout=self.timeout)
            # Test connection
            if cd.ping():
                return cd
            else:
                logger.error("ClamAV daemon not responding to ping")
                return None
        except Exception as e:
            logger.error(f"Failed to connect to ClamAV: {e}")
            return None
    
    def is_available(self) -> bool:
        """
        Check if ClamAV is available and responding.
        
        Returns:
            True if ClamAV is available, False otherwise
        """
        connection = self._get_connection()
        if connection:
            try:
                return connection.ping()
            except Exception as e:
                logger.error(f"ClamAV ping failed: {e}")
                return False
        return False
    
    def get_version(self) -> Optional[str]:
        """
        Get ClamAV version information.
        
        Returns:
            Version string or None if unavailable
        """
        connection = self._get_connection()
        if connection:
            try:
                return connection.version()
            except Exception as e:
                logger.error(f"Failed to get ClamAV version: {e}")
                return None
        return None
    
    def scan_file(self, file_path: str) -> Tuple[bool, Optional[str], Dict]:
        """
        Scan a file for malware.
        
        Args:
            file_path: Path to the file to scan
        
        Returns:
            Tuple of (is_infected, virus_name, scan_details)
            - is_infected: True if malware detected, False if clean
            - virus_name: Name of detected malware or None
            - scan_details: Dictionary with detailed scan information
        """
        scan_details = {
            'clamav_available': False,
            'scan_completed': False,
            'error': None
        }
        
        # Check if ClamAV is available
        if not self.is_available():
            scan_details['error'] = 'ClamAV daemon is not available or not responding'
            logger.warning("ClamAV not available for scanning")
            return False, None, scan_details
        
        scan_details['clamav_available'] = True
        
        # Check if file exists
        if not os.path.exists(file_path):
            scan_details['error'] = f'File not found: {file_path}'
            logger.error(f"File not found for scanning: {file_path}")
            return False, None, scan_details
        
        # Perform scan
        connection = self._get_connection()
        if not connection:
            scan_details['error'] = 'Failed to connect to ClamAV daemon'
            return False, None, scan_details
        
        try:
            # Scan the file
            result = connection.scan_file(file_path)
            scan_details['scan_completed'] = True
            
            if result is None:
                # File is clean
                logger.info(f"ClamAV scan: {file_path} is CLEAN")
                return False, None, scan_details
            else:
                # Malware detected
                # Result format: {'/path/to/file': ('FOUND', 'Virus.Name')}
                for file, (status, virus_name) in result.items():
                    if status == 'FOUND':
                        logger.warning(f"ClamAV scan: {file_path} is INFECTED with {virus_name}")
                        scan_details['virus_signature'] = virus_name
                        return True, virus_name, scan_details
                
                # Shouldn't reach here, but handle it
                return False, None, scan_details
                
        except Exception as e:
            scan_details['error'] = f'Scan error: {str(e)}'
            logger.error(f"ClamAV scan error for {file_path}: {e}")
            return False, None, scan_details
    
    def scan_stream(self, file_stream) -> Tuple[bool, Optional[str], Dict]:
        """
        Scan a file stream for malware.
        
        Args:
            file_stream: File-like object to scan
        
        Returns:
            Tuple of (is_infected, virus_name, scan_details)
        """
        scan_details = {
            'clamav_available': False,
            'scan_completed': False,
            'error': None
        }
        
        # Check if ClamAV is available
        if not self.is_available():
            scan_details['error'] = 'ClamAV daemon is not available or not responding'
            logger.warning("ClamAV not available for scanning")
            return False, None, scan_details
        
        scan_details['clamav_available'] = True
        
        connection = self._get_connection()
        if not connection:
            scan_details['error'] = 'Failed to connect to ClamAV daemon'
            return False, None, scan_details
        
        try:
            # Read file content
            file_stream.seek(0)  # Reset to beginning
            file_content = file_stream.read()
            
            # Scan the content
            result = connection.scan_stream(file_content)
            scan_details['scan_completed'] = True
            
            if result is None:
                # File is clean
                logger.info("ClamAV stream scan: content is CLEAN")
                return False, None, scan_details
            else:
                # Malware detected
                # Result format: {'stream': ('FOUND', 'Virus.Name')}
                if 'stream' in result:
                    status, virus_name = result['stream']
                    if status == 'FOUND':
                        logger.warning(f"ClamAV stream scan: content is INFECTED with {virus_name}")
                        scan_details['virus_signature'] = virus_name
                        return True, virus_name, scan_details
                
                return False, None, scan_details
                
        except Exception as e:
            scan_details['error'] = f'Stream scan error: {str(e)}'
            logger.error(f"ClamAV stream scan error: {e}")
            return False, None, scan_details
        finally:
            # Reset stream position
            try:
                file_stream.seek(0)
            except (IOError, OSError, ValueError) as e:
                # Stream might not be seekable or already closed
                logger.debug(f"Could not reset stream position: {e}")
                pass


# Global scanner instance with configurable settings
def get_clamav_scanner() -> ClamAVScanner:
    """
    Get a ClamAV scanner instance with configured settings.
    
    Settings can be overridden via environment variables:
    - CLAMAV_HOST: ClamAV daemon host (default: 'clamav')
    - CLAMAV_PORT: ClamAV daemon port (default: 3310)
    - CLAMAV_TIMEOUT: Connection timeout (default: 60)
    """
    host = os.environ.get('CLAMAV_HOST', 'clamav')
    port = int(os.environ.get('CLAMAV_PORT', 3310))
    timeout = int(os.environ.get('CLAMAV_TIMEOUT', 60))
    
    return ClamAVScanner(host=host, port=port, timeout=timeout)
