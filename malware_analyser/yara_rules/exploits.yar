/*
    Exploit / Shellcode Detection Rules
    Covers NOP sleds, heap spray, SEH overwrites, ROP gadget chains
*/

rule NOP_Sled_x86 {
    meta:
        description = "x86 NOP sled (classic shellcode indicator)"
        author      = "Megido Malware Analyser"
        category    = "exploits"
        severity    = "high"
    strings:
        $nop16  = { 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 }
        $nop32  = { 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
                    90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 }
    condition:
        $nop16 or $nop32
}

rule NOP_Sled_Polymorphic {
    meta:
        description = "Polymorphic NOP equivalent sled (inc/dec register sequences)"
        category    = "exploits"
        severity    = "high"
    strings:
        /* inc eax / dec eax repeated */
        $poly_nop1 = { 40 48 40 48 40 48 40 48 40 48 40 48 }
        /* inc ecx / dec ecx repeated */
        $poly_nop2 = { 41 49 41 49 41 49 41 49 41 49 41 49 }
    condition:
        $poly_nop1 or $poly_nop2
}

rule Heap_Spray_0c0c0c0c {
    meta:
        description = "Heap spray pattern 0x0c0c0c0c (browser exploit indicator)"
        author      = "Megido Malware Analyser"
        category    = "exploits"
        severity    = "high"
    strings:
        $spray8  = { 0C 0C 0C 0C 0C 0C 0C 0C }
        $spray16 = { 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C }
    condition:
        $spray16
}

rule Heap_Spray_0d0d0d0d {
    meta:
        description = "Heap spray pattern 0x0d0d0d0d"
        category    = "exploits"
        severity    = "high"
    strings:
        $spray = { 0D 0D 0D 0D 0D 0D 0D 0D 0D 0D 0D 0D 0D 0D 0D 0D }
    condition:
        $spray
}

rule SEH_Overwrite_Pattern {
    meta:
        description = "SEH chain overwrite pattern (stack-based buffer overflow exploit)"
        category    = "exploits"
        severity    = "high"
    strings:
        /* AAAA repeated (classic canary destruction) + POP POP RET */
        $aaaa = { 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 }
        $seh_trampoline = { 58 58 C3 }   /* POP EAX / POP EAX / RET */
        $seh_trampoline2 = { 59 59 C3 }  /* POP ECX / POP ECX / RET */
    condition:
        $aaaa and ( $seh_trampoline or $seh_trampoline2 )
}

rule Shellcode_GetPC_Technique {
    meta:
        description = "Position-independent shellcode GetPC via CALL/POP technique"
        category    = "exploits"
        severity    = "high"
    strings:
        /* CALL $+5 / POP EAX pattern */
        $call_pop_eax = { E8 00 00 00 00 58 }
        /* CALL $+5 / POP ECX */
        $call_pop_ecx = { E8 00 00 00 00 59 }
        /* CALL $+5 / POP EDI */
        $call_pop_edi = { E8 00 00 00 00 5F }
    condition:
        any of them
}

rule Egg_Hunter_Shellcode {
    meta:
        description = "Egg-hunter shellcode pattern (for memory search exploitation)"
        category    = "exploits"
        severity    = "high"
    strings:
        /* Common egg: w00t */
        $egg_w00t = { 77 30 30 74 77 30 30 74 }
        /* egg: \x90\x50\x90\x50 */
        $egg_5090 = { 90 50 90 50 }
    condition:
        any of them
}

rule Return_Oriented_Programming {
    meta:
        description = "Dense ROP gadget chain (multiple consecutive short RET sequences)"
        category    = "exploits"
        severity    = "medium"
    strings:
        /* Sequences of: POP reg / RET -- typical in ROP chains */
        $pop_ret_chain = {
            5? C3
            5? C3
            5? C3
            5? C3
            5? C3
        }
    condition:
        #pop_ret_chain > 20
}

rule CVE_2012_0158_RTF {
    meta:
        description = "RTF exploit CVE-2012-0158 (MSCOMCTL.OCX)"
        reference   = "CVE-2012-0158"
        category    = "exploits"
        severity    = "critical"
    strings:
        $rtf_hdr  = "{\\rt"
        $listview = "\\object\\objocx" nocase
        $clsid    = "E0A602FE" nocase
    condition:
        $rtf_hdr and $listview and $clsid
}
