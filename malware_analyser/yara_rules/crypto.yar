/*
    Cryptographic Constant Detection Rules
    Detects AES S-box, RC4 KSA, Base64 alphabet, and other crypto constants
*/

rule AES_SBox_Constant {
    meta:
        description = "AES SubBytes S-box constant present in binary"
        author      = "Megido Malware Analyser"
        category    = "crypto"
        severity    = "informational"
    strings:
        /* First 16 bytes of AES S-box */
        $sbox_start = {
            63 7C 77 7B F2 6B 6F C5
            30 01 67 2B FE D7 AB 76
        }
        /* AES round constants */
        $rcon = {
            01 00 00 00  02 00 00 00
            04 00 00 00  08 00 00 00
        }
    condition:
        $sbox_start or $rcon
}

rule AES_InvSBox_Constant {
    meta:
        description = "AES inverse S-box (decryption) constant present"
        category    = "crypto"
        severity    = "informational"
    strings:
        $inv_sbox = {
            52 09 6A D5 30 36 A5 38
            BF 40 A3 9E 81 F3 D7 FB
        }
    condition:
        $inv_sbox
}

rule RC4_KSA_Init {
    meta:
        description = "RC4 key-scheduling algorithm initialisation loop"
        author      = "Megido Malware Analyser"
        category    = "crypto"
        severity    = "informational"
    strings:
        /* Typical x86 RC4 KSA initialisation: xor eax, eax / inc eax loop */
        $ksa_x86 = {
            31 C0
            88 04 0E
            FE C0
            75 F9
        }
        /* RC4 PRGA core: two-byte swap pattern */
        $prga = {
            8A 04 0E
            8A 14 16
            88 14 0E
            88 04 16
        }
    condition:
        $ksa_x86 or $prga
}

rule Base64_Alphabet {
    meta:
        description = "Standard Base64 alphabet constant"
        category    = "crypto"
        severity    = "informational"
    strings:
        $b64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/" ascii
        $b64url = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_" ascii
    condition:
        $b64 or $b64url
}

rule XOR_Obfuscation_Loop {
    meta:
        description = "Single-byte XOR obfuscation loop (common in malware loaders)"
        category    = "crypto"
        severity    = "medium"
    strings:
        /* xor byte [esi+ecx], al / inc ecx / loop */
        $xor_loop1 = { 30 04 0E 41 }
        /* xor [edi], bl / inc edi pattern */
        $xor_loop2 = { 30 1F 47 }
        $xor_key   = "xorkey" ascii nocase
    condition:
        2 of them
}

rule CRC32_Table {
    meta:
        description = "CRC32 lookup table (first few entries)"
        category    = "crypto"
        severity    = "informational"
    strings:
        $crc32 = {
            00 00 00 00
            77 07 30 96
            EE 0E 61 2C
            99 09 51 BA
        }
    condition:
        $crc32
}

rule MD5_Init_Constants {
    meta:
        description = "MD5 initialisation constants"
        category    = "crypto"
        severity    = "informational"
    strings:
        /* MD5 magic init values: 67452301 EFCDAB89 98BADCFE 10325476 */
        $md5_init = {
            01 23 45 67
            89 AB CD EF
            FE DC BA 98
            76 54 32 10
        }
    condition:
        $md5_init
}

rule SHA256_Init_Constants {
    meta:
        description = "SHA-256 initialisation constants (first two)"
        category    = "crypto"
        severity    = "informational"
    strings:
        /* 6a09e667 bb67ae85 */
        $sha256_h0 = { 67 E6 09 6A 85 AE 67 BB }
    condition:
        $sha256_h0
}
