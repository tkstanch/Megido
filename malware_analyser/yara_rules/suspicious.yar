/*
    Suspicious Behaviour Detection Rules
    Covers: anti-debug, anti-VM, process injection, persistence, privilege escalation
*/

/* =========================================================
   Anti-Debug Techniques
   ========================================================= */

rule AntiDebug_IsDebuggerPresent {
    meta:
        description = "Anti-debug: IsDebuggerPresent API call"
        author      = "Megido Malware Analyser"
        category    = "anti_debug"
        severity    = "medium"
    strings:
        $api  = "IsDebuggerPresent" ascii wide
        $api2 = "CheckRemoteDebuggerPresent" ascii wide
    condition:
        any of them
}

rule AntiDebug_NtQueryInformationProcess {
    meta:
        description = "Anti-debug: NtQueryInformationProcess with ProcessDebugPort"
        category    = "anti_debug"
        severity    = "high"
    strings:
        $ntq = "NtQueryInformationProcess" ascii wide
        $dbg = "ProcessDebugPort" ascii wide
        $dbg2 = { 07 00 00 00 }  /* ProcessDebugPort = 7 as DWORD */
    condition:
        $ntq and ( $dbg or $dbg2 )
}

rule AntiDebug_Timing_RDTSC {
    meta:
        description = "Timing-based anti-debug using RDTSC instruction"
        category    = "anti_debug"
        severity    = "medium"
    strings:
        /* RDTSC opcode */
        $rdtsc = { 0F 31 }
        /* Multiple RDTSC calls close together */
        $rdtsc_pair = { 0F 31 ?? ?? ?? 0F 31 }
    condition:
        $rdtsc_pair or #rdtsc > 5
}

rule AntiDebug_OutputDebugString {
    meta:
        description = "Anti-debug via OutputDebugString error check"
        category    = "anti_debug"
        severity    = "low"
    strings:
        $ods = "OutputDebugStringA" ascii wide
    condition:
        $ods
}

/* =========================================================
   Anti-VM / Anti-Sandbox Techniques
   ========================================================= */

rule AntiVM_Registry_Keys {
    meta:
        description = "Anti-VM: checks for hypervisor-specific registry keys"
        author      = "Megido Malware Analyser"
        category    = "anti_vm"
        severity    = "high"
    strings:
        $vmware_reg   = "SOFTWARE\\VMware, Inc.\\VMware Tools" ascii wide nocase
        $vbox_reg     = "HARDWARE\\ACPI\\DSDT\\VBOX__" ascii wide nocase
        $vbox_reg2    = "SOFTWARE\\Oracle\\VirtualBox Guest Additions" ascii wide nocase
        $parallels_reg = "Parallels Tools" ascii wide nocase
    condition:
        any of them
}

rule AntiVM_CPUID_Check {
    meta:
        description = "Anti-VM: CPUID-based hypervisor detection"
        category    = "anti_vm"
        severity    = "high"
    strings:
        $vmware_str = "VMware" ascii nocase
        $vbox_str   = "VirtualBox" ascii nocase
        $vbox_str2  = "VBOX" ascii nocase
        $qemu_str   = "QEMU" ascii nocase
        $kvm_str    = "KVMKVMKVM" ascii
        /* CPUID leaf 0x40000000 hypervisor string */
        $cpuid_hyp  = { 0F A2 }  /* CPUID instruction */
    condition:
        ( $vmware_str or $vbox_str or $vbox_str2 or $qemu_str or $kvm_str )
        and $cpuid_hyp
}

rule AntiVM_Artifact_Files {
    meta:
        description = "Anti-VM: checks for hypervisor-specific driver/tool files"
        category    = "anti_vm"
        severity    = "medium"
    strings:
        $vbox_drv   = "vboxguest.sys"   ascii nocase
        $vmware_drv = "vmhgfs.sys"      ascii nocase
        $vmtools    = "vmtoolsd.exe"    ascii nocase
        $wireshark  = "wireshark.exe"   ascii nocase
        $procmon    = "procmon.exe"     ascii nocase
        $x64dbg     = "x64dbg.exe"     ascii nocase
    condition:
        2 of them
}

rule AntiSandbox_Sleep_Skipping {
    meta:
        description = "Sandbox evasion: Sleep call with long delay (sleep skipping attempt)"
        category    = "anti_vm"
        severity    = "medium"
    strings:
        $sleep     = "Sleep" ascii wide
        $get_ticks = "GetTickCount" ascii wide
    condition:
        $sleep and $get_ticks
}

/* =========================================================
   Process Injection
   ========================================================= */

rule ProcessInjection_Classic {
    meta:
        description = "Classic process injection: VirtualAllocEx + WriteProcessMemory + CreateRemoteThread"
        author      = "Megido Malware Analyser"
        category    = "process_injection"
        severity    = "critical"
    strings:
        $vae  = "VirtualAllocEx"    ascii wide
        $wpm  = "WriteProcessMemory" ascii wide
        $crt  = "CreateRemoteThread" ascii wide
        $opp  = "OpenProcess"       ascii wide
    condition:
        $opp and $vae and $wpm and $crt
}

rule ProcessInjection_QueueUserAPC {
    meta:
        description = "APC injection: QueueUserAPC process injection technique"
        category    = "process_injection"
        severity    = "critical"
    strings:
        $qua  = "QueueUserAPC"      ascii wide
        $othread = "OpenThread"     ascii wide
        $wpm  = "WriteProcessMemory" ascii wide
    condition:
        $qua and $othread and $wpm
}

rule ProcessInjection_Hollowing {
    meta:
        description = "Process hollowing: NtUnmapViewOfSection-based injection"
        category    = "process_injection"
        severity    = "critical"
    strings:
        $unmap  = "NtUnmapViewOfSection"  ascii wide
        $create = "CreateProcessA"        ascii wide
        $setctx = "SetThreadContext"       ascii wide
        $resume = "ResumeThread"           ascii wide
    condition:
        $unmap and $create and $setctx and $resume
}

/* =========================================================
   Persistence
   ========================================================= */

rule Persistence_Registry_Run {
    meta:
        description = "Persistence via HKCU/HKLM Run registry key"
        author      = "Megido Malware Analyser"
        category    = "persistence"
        severity    = "high"
    strings:
        $run1 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide nocase
        $run2 = "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon" ascii wide nocase
        $setreg = "RegSetValueExA" ascii wide
    condition:
        ( $run1 or $run2 ) and $setreg
}

rule Persistence_Scheduled_Task {
    meta:
        description = "Persistence via Windows Scheduled Tasks"
        category    = "persistence"
        severity    = "high"
    strings:
        $schtasks = "schtasks" ascii wide nocase
        $at_cmd   = " /create " ascii nocase
        $xml_task = "<Task version=" ascii
        $itr      = "ITaskScheduler" ascii wide
    condition:
        ( $schtasks and $at_cmd ) or $xml_task or $itr
}

rule Persistence_Services {
    meta:
        description = "Persistence via Windows Service creation"
        category    = "persistence"
        severity    = "high"
    strings:
        $create_svc = "CreateServiceA" ascii wide
        $open_scm   = "OpenSCManagerA" ascii wide
        $start_svc  = "StartServiceA"  ascii wide
    condition:
        $open_scm and $create_svc
}
