/*
    Malware Family Signature Rules
    Covers: Emotet, Cobalt Strike, Metasploit, TrickBot
*/

rule Emotet_Config_Blob {
    meta:
        description = "Emotet banking trojan configuration blob marker"
        author      = "Megido Malware Analyser"
        category    = "malware_family"
        family      = "Emotet"
        severity    = "critical"
    strings:
        /* Emotet uses a specific XOR decryption loop + RC4 */
        $decrypt_loop = {
            8B ?? ??
            33 ?? ??
            89 ?? ??
            83 ?? 04
            83 ?? 04
            4? 75 ??
        }
        $cmd_pattern  = "/Uccex1/" ascii
        $mutex_prefix = "Global\\" ascii wide
        $str_emotet   = "Emotet" ascii nocase
    condition:
        2 of them
}

rule Emotet_C2_Communication {
    meta:
        description = "Emotet C2 HTTP communication pattern"
        family      = "Emotet"
        severity    = "critical"
    strings:
        /* Emotet embeds IP list in a specific structure */
        $http_pattern = /\/[a-zA-Z0-9]{4,8}\/([\d]{1,3}\/){3}/ ascii
        $user_agent   = "Mozilla/4.0 (compatible; MSIE 7.0;" ascii
    condition:
        $http_pattern and $user_agent
}

rule CobaltStrike_Beacon {
    meta:
        description = "Cobalt Strike beacon payload (reflective DLL loader)"
        author      = "Megido Malware Analyser"
        category    = "malware_family"
        family      = "CobaltStrike"
        severity    = "critical"
    strings:
        /* CS reflective loader magic */
        $reflective  = { 4D 5A 41 52 55 48 89 E5 }
        /* CS beacon watermark area (common default) */
        $watermark   = { 00 00 00 00 ?? ?? ?? ?? 00 00 00 00 }
        /* CS malleable C2 profile indicators */
        $profile_ua  = "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)" ascii
        $cs_magic    = "cobaltstrike" ascii nocase
        /* CS beacon config marker */
        $cfg_marker  = { 69 68 69 68 69 6B }
        /* CS staging string */
        $staging     = "%s (admin)" ascii
    condition:
        $reflective or $cs_magic or ($watermark and $profile_ua) or $cfg_marker
}

rule CobaltStrike_Shellcode_Stager {
    meta:
        description = "Cobalt Strike download stager shellcode"
        family      = "CobaltStrike"
        severity    = "critical"
    strings:
        /* Classic CS stager: URLDownloadToFileA + exec */
        $stager_url  = "http" ascii
        $stager_api1 = "URLDownloadToFileA" ascii wide
        $stager_api2 = "WinExec" ascii wide
        $stager_api3 = "ShellExecuteA" ascii wide
    condition:
        $stager_url and $stager_api1 and ( $stager_api2 or $stager_api3 )
}

rule Metasploit_Meterpreter {
    meta:
        description = "Metasploit Meterpreter payload"
        author      = "Megido Malware Analyser"
        category    = "malware_family"
        family      = "Metasploit"
        severity    = "critical"
    strings:
        $meter_str1  = "meterpreter" ascii nocase
        $meter_str2  = "Meterpreter" ascii
        $meter_str3  = "metepreter" ascii   /* common typo variant */
        $reflective  = "ReflectiveLoader" ascii
        $channel_str = "stdapi_" ascii
        $migrate     = "MIGRATE_PID" ascii wide
    condition:
        any of ($meter_str*) or ($reflective and $channel_str) or $migrate
}

rule Metasploit_Shellcode_Reverse_TCP {
    meta:
        description = "Metasploit reverse_tcp shellcode stub"
        family      = "Metasploit"
        severity    = "critical"
    strings:
        /* Classic windows/shell_reverse_tcp: ws2_32 socket setup */
        $ws2_32   = "ws2_32" ascii wide nocase
        $connect  = { 6A 06 6A 01 6A 02 FF D5 }   /* push 6/1/2 + call */
        $recv_shc = { 68 02 00 ?? ?? }              /* push SOCKADDR struct */
    condition:
        $ws2_32 and ( $connect or $recv_shc )
}

rule TrickBot_Core {
    meta:
        description = "TrickBot banking trojan core module"
        author      = "Megido Malware Analyser"
        category    = "malware_family"
        family      = "TrickBot"
        severity    = "critical"
    strings:
        $trickbot_id  = "<moduleconfig>" ascii
        $group_tag    = "<gtag>" ascii
        $autostart    = "Start" ascii
        $network_tag  = "<server>" ascii
        $module_name  = "trickbot" ascii nocase
        $cfg_url      = "/cfg/" ascii
        $dll_entry    = "Control_RunDLL" ascii
    condition:
        ( $trickbot_id and $group_tag ) or
        ( $network_tag and $cfg_url )   or
        $module_name                    or
        $dll_entry
}

rule TrickBot_Module_Loader {
    meta:
        description = "TrickBot module download and injection pattern"
        family      = "TrickBot"
        severity    = "critical"
    strings:
        $inject_api1 = "NtWriteVirtualMemory" ascii wide
        $inject_api2 = "NtCreateThreadEx"     ascii wide
        $inject_api3 = "RtlCreateUserThread"  ascii wide
        $module_ext  = ".dll" ascii wide
        $loader_url  = "/images/" ascii
    condition:
        2 of ($inject_api*) and ( $module_ext or $loader_url )
}

rule Generic_RAT_Keylogger {
    meta:
        description = "Generic RAT keylogger API usage"
        category    = "malware_family"
        severity    = "high"
    strings:
        $kl1 = "GetAsyncKeyState" ascii wide
        $kl2 = "SetWindowsHookExA" ascii wide
        $kl3 = "GetForegroundWindow" ascii wide
        $kl4 = "keybd_event" ascii wide
    condition:
        2 of them
}
