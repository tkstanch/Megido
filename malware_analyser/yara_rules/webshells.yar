/*
    Webshell Detection Rules
    Covers PHP, ASP/ASPX, JSP webshells
*/

/* =========================================================
   PHP Webshells
   ========================================================= */

rule PHP_Webshell_Eval_Request {
    meta:
        description = "PHP webshell using eval() on request parameter"
        author      = "Megido Malware Analyser"
        category    = "webshells"
        severity    = "critical"
    strings:
        $php_open  = "<?php"  ascii nocase
        $php_open2 = "<?"     ascii
        $eval1 = /eval\s*\(\s*\$_(POST|GET|REQUEST|COOKIE)/ ascii nocase
        $eval2 = /eval\s*\(\s*base64_decode/ ascii nocase
        $eval3 = /eval\s*\(\s*gzinflate/    ascii nocase
        $eval4 = /eval\s*\(\s*str_rot13/    ascii nocase
    condition:
        ( $php_open or $php_open2 ) and any of ($eval*)
}

rule PHP_Webshell_System_Passthru {
    meta:
        description = "PHP webshell executing system commands"
        category    = "webshells"
        severity    = "critical"
    strings:
        $php_open   = "<?php" ascii nocase
        $system     = /system\s*\(\s*\$_(POST|GET|REQUEST|COOKIE)/ ascii nocase
        $passthru   = /passthru\s*\(\s*\$_(POST|GET|REQUEST|COOKIE)/ ascii nocase
        $exec       = /exec\s*\(\s*\$_(POST|GET|REQUEST|COOKIE)/ ascii nocase
        $shell_exec = /shell_exec\s*\(\s*\$_(POST|GET|REQUEST|COOKIE)/ ascii nocase
        $popen      = /popen\s*\(\s*\$_(POST|GET|REQUEST|COOKIE)/ ascii nocase
        $proc_open  = /proc_open\s*\(\s*\$_(POST|GET|REQUEST|COOKIE)/ ascii nocase
    condition:
        $php_open and any of ($system, $passthru, $exec, $shell_exec, $popen, $proc_open)
}

rule PHP_Webshell_Base64_Obfuscated {
    meta:
        description = "PHP webshell using Base64 obfuscation"
        category    = "webshells"
        severity    = "critical"
    strings:
        $b64_eval   = /eval\s*\(\s*base64_decode\s*\(/ ascii nocase
        $b64_create = /create_function\s*\(.*base64_decode/ ascii nocase
        $b64_assert  = /assert\s*\(\s*base64_decode/ ascii nocase
        $b64_preg   = /preg_replace\s*\(.*\/e.*base64_decode/ ascii nocase
    condition:
        any of them
}

rule PHP_Webshell_Assert_Backdoor {
    meta:
        description = "PHP webshell using assert() as execution primitive"
        category    = "webshells"
        severity    = "critical"
    strings:
        $assert_req = /assert\s*\(\s*\$_(POST|GET|REQUEST|COOKIE)/ ascii nocase
        $assert_b64 = /assert\s*\(\s*base64_decode\s*\(/ ascii nocase
        $assert_str = /assert\s*\(\s*stripslashes\s*\(/ ascii nocase
    condition:
        any of them
}

rule PHP_Webshell_FileBrowser {
    meta:
        description = "PHP webshell with file browsing and command execution"
        category    = "webshells"
        severity    = "high"
    strings:
        $cmd  = "$_POST['cmd']"   ascii nocase
        $cmd2 = "$_GET['cmd']"    ascii nocase
        $cmd3 = "$_REQUEST['cmd']" ascii nocase
        $dir  = "scandir("        ascii nocase
        $fget = "file_get_contents(" ascii nocase
        $fput = "file_put_contents(" ascii nocase
    condition:
        ( $cmd or $cmd2 or $cmd3 ) and ( $dir or $fget or $fput )
}

rule PHP_C99_WSO_Shell {
    meta:
        description = "PHP C99 or WSO webshell signature"
        category    = "webshells"
        severity    = "critical"
    strings:
        $c99      = "c99shell"   ascii nocase
        $wso      = "WSO"        ascii
        $filesman = "FilesMan"   ascii
        $safe_mode = "safemode"  ascii nocase
        $php_ver  = "phpinfo()"  ascii nocase
        $bind     = "bind_port"  ascii nocase
    condition:
        2 of them
}

/* =========================================================
   ASP / ASPX Webshells
   ========================================================= */

rule ASP_Webshell_Exec {
    meta:
        description = "ASP(X) webshell executing OS commands"
        author      = "Megido Malware Analyser"
        category    = "webshells"
        severity    = "critical"
    strings:
        $asp_open   = "<%"     ascii
        $cmd_obj    = "WScript.Shell" ascii nocase
        $cmd_obj2   = "Shell.Application" ascii nocase
        $exec_str1  = ".Exec(" ascii nocase
        $exec_str2  = ".Run("  ascii nocase
        $request    = "Request" ascii
    condition:
        $asp_open and
        ( $cmd_obj or $cmd_obj2 ) and
        ( $exec_str1 or $exec_str2 ) and
        $request
}

rule ASPX_Webshell_CodeCompile {
    meta:
        description = "ASPX webshell using runtime code compilation"
        category    = "webshells"
        severity    = "critical"
    strings:
        $csc      = "CSharpCodeProvider" ascii
        $compile  = "CompileAssemblyFromSource" ascii
        $assembly = "Assembly.Load(" ascii
        $invoke   = ".InvokeMember(" ascii
        $request  = "Request[" ascii
    condition:
        ( $csc and $compile ) or ( $assembly and $invoke and $request )
}

/* =========================================================
   JSP Webshells
   ========================================================= */

rule JSP_Webshell_Runtime_Exec {
    meta:
        description = "JSP webshell using Runtime.exec() for OS command execution"
        author      = "Megido Malware Analyser"
        category    = "webshells"
        severity    = "critical"
    strings:
        $jsp_open   = "<%"         ascii
        $runtime    = "Runtime.getRuntime()" ascii
        $exec       = ".exec("     ascii
        $request    = "request.getParameter" ascii
    condition:
        $jsp_open and $runtime and $exec and $request
}

rule JSP_Webshell_ProcessBuilder {
    meta:
        description = "JSP webshell using ProcessBuilder for command execution"
        category    = "webshells"
        severity    = "critical"
    strings:
        $pb       = "ProcessBuilder" ascii
        $start    = ".start()"       ascii
        $request  = "getParameter"   ascii
    condition:
        $pb and $start and $request
}

/* =========================================================
   Generic Indicators
   ========================================================= */

rule Webshell_Password_Protected {
    meta:
        description = "Password-protected webshell with hardcoded credential check"
        category    = "webshells"
        severity    = "high"
    strings:
        $pass1 = /\$pass\s*=\s*["'][a-zA-Z0-9]{6,}["']/ ascii
        $pass2 = /\$password\s*=\s*["'][a-zA-Z0-9]{6,}["']/ ascii
        $pass3 = /md5\s*\(\s*\$_(POST|GET|REQUEST)/ ascii nocase
        $check = /if\s*\(\s*\$_/ ascii
    condition:
        any of ($pass*) and $check
}
