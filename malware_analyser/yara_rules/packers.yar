/*
    Packer Detection Rules
    Detects common executable packers: UPX, Themida, VMProtect, ASPack
*/

rule UPX_Packed {
    meta:
        description = "UPX packed executable"
        author      = "Megido Malware Analyser"
        category    = "packer"
        severity    = "medium"
    strings:
        $upx0 = "UPX0" ascii
        $upx1 = "UPX1" ascii
        $upx2 = "UPX!" ascii
        $magic = { 55 50 58 21 }
    condition:
        ( $upx0 or $upx1 ) and $upx2
        or $magic
}

rule UPX_NRV_Decompressor {
    meta:
        description = "UPX with NRV decompressor stub"
        category    = "packer"
        severity    = "medium"
    strings:
        $nrv  = "NRV" ascii
        $upx1 = "UPX1" ascii
    condition:
        $nrv and $upx1
}

rule Themida_Protected {
    meta:
        description = "Themida / WinLicense protected binary"
        author      = "Megido Malware Analyser"
        category    = "packer"
        severity    = "high"
    strings:
        $a = ".themida" ascii nocase
        $b = "Themida" ascii
        $c = "WinLicense" ascii
        $d = { 45 6E 69 67 6D 61 }   /* Enigma */
        $stub1 = { 60 E8 00 00 00 00 }
    condition:
        any of ($a, $b, $c, $d)
}

rule VMProtect_Protected {
    meta:
        description = "VMProtect protected binary"
        author      = "Megido Malware Analyser"
        category    = "packer"
        severity    = "high"
    strings:
        $vmp0 = ".vmp0" ascii
        $vmp1 = ".vmp1" ascii
        $vmp_str = "VMProtect" ascii
        $vmp_magic = { 56 4D 50 72 6F 74 65 63 74 }
    condition:
        ( $vmp0 and $vmp1 ) or $vmp_str or $vmp_magic
}

rule ASPack_Packer {
    meta:
        description = "ASPack packed executable"
        author      = "Megido Malware Analyser"
        category    = "packer"
        severity    = "medium"
    strings:
        $aspack = ".aspack" ascii nocase
        $adata  = ".adata"  ascii nocase
        $magic  = { 60 E8 72 ?? ?? ?? }
    condition:
        $aspack or $adata or $magic
}

rule MPRESS_Packer {
    meta:
        description = "MPRESS packed executable"
        category    = "packer"
        severity    = "medium"
    strings:
        $s = ".MPRESS1" ascii
        $s2 = ".MPRESS2" ascii
    condition:
        $s and $s2
}

rule PECompact_Packer {
    meta:
        description = "PECompact packed executable"
        category    = "packer"
        severity    = "medium"
    strings:
        $pec = "PEC2" ascii
        $pec2 = "PECompact2" ascii
    condition:
        $pec or $pec2
}

rule Generic_Packer_HighEntropy {
    meta:
        description = "Generic high-entropy PE section (possible packing)"
        category    = "packer"
        severity    = "low"
    strings:
        $mz = { 4D 5A }
    condition:
        $mz at 0
        and filesize < 10MB
        and math.entropy(0, filesize) > 7.2
}
