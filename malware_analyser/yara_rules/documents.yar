/*
    Document Malware Detection Rules
    Covers: malicious VBA macros, PDF JavaScript, RTF exploits, OOXML macros
*/

rule Malicious_VBA_AutoExec {
    meta:
        description = "VBA macro with auto-execution entry point"
        author      = "Megido Malware Analyser"
        category    = "documents"
        severity    = "high"
    strings:
        $auto1 = "AutoOpen"        ascii nocase
        $auto2 = "Document_Open"   ascii nocase
        $auto3 = "Workbook_Open"   ascii nocase
        $auto4 = "Auto_Open"       ascii nocase
        $auto5 = "AutoExec"        ascii nocase
        $auto6 = "AutoClose"       ascii nocase
        $auto7 = "Document_Close"  ascii nocase
    condition:
        any of them
}

rule Malicious_VBA_Shell_Execution {
    meta:
        description = "VBA macro executing shell commands"
        category    = "documents"
        severity    = "critical"
    strings:
        $shell1 = "Shell"        ascii nocase
        $shell2 = "WScript.Shell" ascii nocase
        $shell3 = "CreateObject" ascii nocase
        $shell4 = "PowerShell"   ascii nocase
        $shell5 = "cmd.exe"      ascii nocase wide
        $shell6 = "mshta"        ascii nocase
        $shell7 = "wscript"      ascii nocase
        $shell8 = "cscript"      ascii nocase
    condition:
        2 of them
}

rule Malicious_VBA_Download {
    meta:
        description = "VBA macro downloading remote content"
        category    = "documents"
        severity    = "critical"
    strings:
        $dl1 = "URLDownloadToFile" ascii nocase
        $dl2 = "XMLHTTP"          ascii nocase
        $dl3 = "WinHttp"          ascii nocase
        $dl4 = "InternetExplorer.Application" ascii nocase
        $dl5 = "Shell.Application" ascii nocase
        $url1 = "http://"  ascii nocase
        $url2 = "https://" ascii nocase
        $url3 = "ftp://"   ascii nocase
    condition:
        any of ($dl1, $dl2, $dl3, $dl4, $dl5) and any of ($url*)
}

rule Malicious_VBA_Obfuscation {
    meta:
        description = "VBA macro with heavy string obfuscation (Chr() encoding)"
        category    = "documents"
        severity    = "high"
    strings:
        /* Many consecutive Chr() calls */
        $chr_concat1 = /Chr\(\d+\) & Chr\(\d+\) & Chr\(\d+\)/
        $chr_concat2 = "Chr(" ascii
        $str_reverse = "StrReverse" ascii nocase
        $base64_dec  = "FromBase64String" ascii nocase
    condition:
        #chr_concat2 > 10 or $str_reverse or $base64_dec
}

rule PDF_JavaScript {
    meta:
        description = "PDF file containing JavaScript"
        author      = "Megido Malware Analyser"
        category    = "documents"
        severity    = "high"
    strings:
        $js_key1 = "/JavaScript" ascii
        $js_key2 = "/JS"         ascii
        $js_eval = "eval("       ascii
        $js_unescape = "unescape(" ascii
        $js_fromcharcode = "fromCharCode(" ascii
    condition:
        ( $js_key1 or $js_key2 ) and
        ( $js_eval or $js_unescape or $js_fromcharcode )
}

rule PDF_OpenAction_Exploit {
    meta:
        description = "PDF with suspicious OpenAction (auto-execute on open)"
        category    = "documents"
        severity    = "critical"
    strings:
        $openaction = "/OpenAction" ascii
        $aa         = "/AA"         ascii
        $launch     = "/Launch"     ascii
        $submitform = "/SubmitForm" ascii
        $importdata = "/ImportData" ascii
    condition:
        $openaction and any of ($launch, $submitform, $importdata, $aa)
}

rule PDF_Embedded_File {
    meta:
        description = "PDF with embedded file object"
        category    = "documents"
        severity    = "medium"
    strings:
        $embedded = "/EmbeddedFile" ascii
        $filespec  = "/Filespec"    ascii nocase
        $annot     = "/RichMedia"   ascii
    condition:
        any of them
}

rule RTF_Exploit_Object {
    meta:
        description = "RTF document with embedded OLE object exploit"
        author      = "Megido Malware Analyser"
        category    = "documents"
        severity    = "critical"
    strings:
        $rtf_hdr   = "{\\rt" ascii
        $objclass  = "\\objclass" ascii
        $objdata   = "\\objdata" ascii
        $equation  = "Equation.3" ascii     /* Equation Editor exploit */
        $word_obj  = "Word.Document" ascii
    condition:
        $rtf_hdr and ( ($objclass and $objdata) or $equation )
}

rule RTF_CVE_2017_11882 {
    meta:
        description = "RTF Equation Editor exploit CVE-2017-11882"
        reference   = "CVE-2017-11882"
        category    = "documents"
        severity    = "critical"
    strings:
        $rtf_hdr   = "{\\rt"
        $eq3       = { 45 71 75 61 74 69 6F 6E 2E 33 }  /* Equation.3 */
        $clsid     = { 02 CE 02 00 }
    condition:
        $rtf_hdr and $eq3 and $clsid
}

rule OOXML_Macro_Enabled {
    meta:
        description = "OOXML macro-enabled document (.docm/.xlsm/.pptm)"
        category    = "documents"
        severity    = "medium"
    strings:
        /* ZIP entry for VBA project */
        $vba_entry  = "word/vbaProject.bin" ascii
        $vba_entry2 = "xl/vbaProject.bin"   ascii
        $vba_entry3 = "ppt/vbaProject.bin"  ascii
    condition:
        any of them
}
