"""
Basic tests for malware analyser enhancements.
"""

from django.test import TestCase, Client
from django.contrib.auth import get_user_model
from malware_analyser.models import (
    AnalysisGoal, AnalysisTechnique, MalwareType, BestPractice,
    StaticAnalysisResult, DynamicAnalysisResult, AnalysisReport,
    FileUpload, ScanResult
)

User = get_user_model()


class AnalysisGoalTest(TestCase):
    """Test Analysis Goals functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(username='testuser', password='testpass123')
        
    def test_create_analysis_goal(self):
        """Test creating an analysis goal."""
        goal = AnalysisGoal.objects.create(
            name='Test Goal',
            goal_type='identification',
            description='Test description',
            priority=1,
            is_default=True,
            created_by=self.user
        )
        self.assertEqual(goal.name, 'Test Goal')
        self.assertEqual(goal.goal_type, 'identification')
        self.assertTrue(goal.is_default)
        
    def test_goal_string_representation(self):
        """Test string representation of goal."""
        goal = AnalysisGoal.objects.create(
            name='Test Goal',
            goal_type='functionality',
            description='Test',
            created_by=self.user
        )
        self.assertIn('Test Goal', str(goal))


class AnalysisTechniqueTest(TestCase):
    """Test Analysis Techniques functionality."""
    
    def test_create_technique(self):
        """Test creating an analysis technique."""
        technique = AnalysisTechnique.objects.create(
            name='Hash Calculation',
            category='basic_static',
            description='Calculate file hashes',
            guidance='Use md5sum, sha256sum',
            tools_required=['md5sum', 'sha256sum']
        )
        self.assertEqual(technique.name, 'Hash Calculation')
        self.assertEqual(technique.category, 'basic_static')
        self.assertEqual(len(technique.tools_required), 2)


class MalwareTypeTest(TestCase):
    """Test Malware Type classification."""
    
    def test_create_malware_type(self):
        """Test creating a malware type."""
        malware_type = MalwareType.objects.create(
            name='Test Trojan',
            category='trojan',
            description='A test trojan',
            characteristics={'disguise': True},
            detection_patterns=['fake_installer']
        )
        self.assertEqual(malware_type.category, 'trojan')
        self.assertTrue(malware_type.characteristics['disguise'])


class BestPracticeTest(TestCase):
    """Test Best Practices functionality."""
    
    def test_create_best_practice(self):
        """Test creating a best practice."""
        practice = BestPractice.objects.create(
            title='Use VMs',
            category='vm_setup',
            description='Always use virtual machines',
            checklist_items=['Create VM', 'Take snapshot'],
            severity='critical',
            is_mandatory=True
        )
        self.assertTrue(practice.is_mandatory)
        self.assertEqual(practice.severity, 'critical')
        self.assertEqual(len(practice.checklist_items), 2)


class StaticAnalysisTest(TestCase):
    """Test Static Analysis functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(username='testuser', password='testpass123')
        self.file_upload = FileUpload.objects.create(
            original_filename='test.exe',
            file_size=1024,
            uploaded_by=self.user
        )
        self.scan_result = ScanResult.objects.create(
            file=self.file_upload,
            performed_by=self.user
        )
        
    def test_create_static_analysis(self):
        """Test creating static analysis result."""
        static = StaticAnalysisResult.objects.create(
            scan_result=self.scan_result,
            md5_hash='d41d8cd98f00b204e9800998ecf8427e',
            sha256_hash='e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855',
            entropy=7.5,
            is_packed=True
        )
        self.assertEqual(len(static.md5_hash), 32)
        self.assertEqual(len(static.sha256_hash), 64)
        self.assertTrue(static.is_packed)
        self.assertGreater(static.entropy, 7.0)


class DynamicAnalysisTest(TestCase):
    """Test Dynamic Analysis functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(username='testuser', password='testpass123')
        self.file_upload = FileUpload.objects.create(
            original_filename='test.exe',
            file_size=1024,
            uploaded_by=self.user
        )
        self.scan_result = ScanResult.objects.create(
            file=self.file_upload,
            performed_by=self.user
        )
        
    def test_create_dynamic_analysis(self):
        """Test creating dynamic analysis result."""
        dynamic = DynamicAnalysisResult.objects.create(
            scan_result=self.scan_result,
            sandbox_status='completed',
            execution_time=5.0,
            anti_vm_detected=False,
            network_connections=[{'protocol': 'TCP', 'destination': '192.0.2.1:80'}]
        )
        self.assertEqual(dynamic.sandbox_status, 'completed')
        self.assertEqual(dynamic.execution_time, 5.0)
        self.assertFalse(dynamic.anti_vm_detected)
        self.assertEqual(len(dynamic.network_connections), 1)


class AnalysisReportTest(TestCase):
    """Test Analysis Report functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(username='testuser', password='testpass123')
        self.file_upload = FileUpload.objects.create(
            original_filename='test.exe',
            file_size=1024,
            uploaded_by=self.user
        )
        self.scan_result = ScanResult.objects.create(
            file=self.file_upload,
            performed_by=self.user
        )
        
    def test_create_report(self):
        """Test creating an analysis report."""
        report = AnalysisReport.objects.create(
            scan_result=self.scan_result,
            report_format='json',
            executive_summary='Test summary',
            confidence_score=0.85,
            created_by=self.user
        )
        self.assertEqual(report.report_format, 'json')
        self.assertEqual(report.confidence_score, 0.85)
        self.assertIn('Test summary', report.executive_summary)


class ViewsTest(TestCase):
    """Test views functionality."""
    
    def setUp(self):
        self.client = Client()
        self.user = User.objects.create_user(username='testuser', password='testpass123')
        self.client.login(username='testuser', password='testpass123')
        
    def test_analysis_goals_view(self):
        """Test analysis goals view loads."""
        response = self.client.get('/malware-analyser/analysis-goals/')
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'Analysis Goals')
        
    def test_analysis_techniques_view(self):
        """Test analysis techniques view loads."""
        response = self.client.get('/malware-analyser/analysis-techniques/')
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'Analysis Techniques')
        
    def test_best_practices_view(self):
        """Test best practices view loads."""
        response = self.client.get('/malware-analyser/best-practices/')
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'Best Practices')


class DataPopulationTest(TestCase):
    """Test data population."""
    
    def test_initial_data_exists(self):
        """Test that initial data can be created."""
        # Create sample data
        AnalysisGoal.objects.create(
            name='Test Goal',
            goal_type='identification',
            description='Test',
            is_default=True
        )
        AnalysisTechnique.objects.create(
            name='Test Technique',
            category='basic_static',
            description='Test'
        )
        MalwareType.objects.create(
            name='Test Malware',
            category='trojan',
            description='Test'
        )
        BestPractice.objects.create(
            title='Test Practice',
            category='vm_setup',
            description='Test'
        )
        
        # Verify data exists
        self.assertEqual(AnalysisGoal.objects.count(), 1)
        self.assertEqual(AnalysisTechnique.objects.count(), 1)
        self.assertEqual(MalwareType.objects.count(), 1)
        self.assertEqual(BestPractice.objects.count(), 1)
