"""
Basic tests for malware analyser enhancements.
"""

from django.test import TestCase, Client
from django.contrib.auth import get_user_model
from malware_analyser.models import (
    AnalysisGoal, AnalysisTechnique, MalwareType, BestPractice,
    StaticAnalysisResult, DynamicAnalysisResult, AnalysisReport,
    FileUpload, ScanResult
)

User = get_user_model()


class AnalysisGoalTest(TestCase):
    """Test Analysis Goals functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(username='testuser', password='testpass123')
        
    def test_create_analysis_goal(self):
        """Test creating an analysis goal."""
        goal = AnalysisGoal.objects.create(
            name='Test Goal',
            goal_type='identification',
            description='Test description',
            priority=1,
            is_default=True,
            created_by=self.user
        )
        self.assertEqual(goal.name, 'Test Goal')
        self.assertEqual(goal.goal_type, 'identification')
        self.assertTrue(goal.is_default)
        
    def test_goal_string_representation(self):
        """Test string representation of goal."""
        goal = AnalysisGoal.objects.create(
            name='Test Goal',
            goal_type='functionality',
            description='Test',
            created_by=self.user
        )
        self.assertIn('Test Goal', str(goal))


class AnalysisTechniqueTest(TestCase):
    """Test Analysis Techniques functionality."""
    
    def test_create_technique(self):
        """Test creating an analysis technique."""
        technique = AnalysisTechnique.objects.create(
            name='Hash Calculation',
            category='basic_static',
            description='Calculate file hashes',
            guidance='Use md5sum, sha256sum',
            tools_required=['md5sum', 'sha256sum']
        )
        self.assertEqual(technique.name, 'Hash Calculation')
        self.assertEqual(technique.category, 'basic_static')
        self.assertEqual(len(technique.tools_required), 2)


class MalwareTypeTest(TestCase):
    """Test Malware Type classification."""
    
    def test_create_malware_type(self):
        """Test creating a malware type."""
        malware_type = MalwareType.objects.create(
            name='Test Trojan',
            category='trojan',
            description='A test trojan',
            characteristics={'disguise': True},
            detection_patterns=['fake_installer']
        )
        self.assertEqual(malware_type.category, 'trojan')
        self.assertTrue(malware_type.characteristics['disguise'])


class BestPracticeTest(TestCase):
    """Test Best Practices functionality."""
    
    def test_create_best_practice(self):
        """Test creating a best practice."""
        practice = BestPractice.objects.create(
            title='Use VMs',
            category='vm_setup',
            description='Always use virtual machines',
            checklist_items=['Create VM', 'Take snapshot'],
            severity='critical',
            is_mandatory=True
        )
        self.assertTrue(practice.is_mandatory)
        self.assertEqual(practice.severity, 'critical')
        self.assertEqual(len(practice.checklist_items), 2)


class StaticAnalysisTest(TestCase):
    """Test Static Analysis functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(username='testuser', password='testpass123')
        self.file_upload = FileUpload.objects.create(
            original_filename='test.exe',
            file_size=1024,
            uploaded_by=self.user
        )
        self.scan_result = ScanResult.objects.create(
            file=self.file_upload,
            performed_by=self.user
        )
        
    def test_create_static_analysis(self):
        """Test creating static analysis result."""
        static = StaticAnalysisResult.objects.create(
            scan_result=self.scan_result,
            md5_hash='d41d8cd98f00b204e9800998ecf8427e',
            sha256_hash='e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855',
            entropy=7.5,
            is_packed=True
        )
        self.assertEqual(len(static.md5_hash), 32)
        self.assertEqual(len(static.sha256_hash), 64)
        self.assertTrue(static.is_packed)
        self.assertGreater(static.entropy, 7.0)


class DynamicAnalysisTest(TestCase):
    """Test Dynamic Analysis functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(username='testuser', password='testpass123')
        self.file_upload = FileUpload.objects.create(
            original_filename='test.exe',
            file_size=1024,
            uploaded_by=self.user
        )
        self.scan_result = ScanResult.objects.create(
            file=self.file_upload,
            performed_by=self.user
        )
        
    def test_create_dynamic_analysis(self):
        """Test creating dynamic analysis result."""
        dynamic = DynamicAnalysisResult.objects.create(
            scan_result=self.scan_result,
            sandbox_status='completed',
            execution_time=5.0,
            anti_vm_detected=False,
            network_connections=[{'protocol': 'TCP', 'destination': '192.0.2.1:80'}]
        )
        self.assertEqual(dynamic.sandbox_status, 'completed')
        self.assertEqual(dynamic.execution_time, 5.0)
        self.assertFalse(dynamic.anti_vm_detected)
        self.assertEqual(len(dynamic.network_connections), 1)


class AnalysisReportTest(TestCase):
    """Test Analysis Report functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(username='testuser', password='testpass123')
        self.file_upload = FileUpload.objects.create(
            original_filename='test.exe',
            file_size=1024,
            uploaded_by=self.user
        )
        self.scan_result = ScanResult.objects.create(
            file=self.file_upload,
            performed_by=self.user
        )
        
    def test_create_report(self):
        """Test creating an analysis report."""
        report = AnalysisReport.objects.create(
            scan_result=self.scan_result,
            report_format='json',
            executive_summary='Test summary',
            confidence_score=0.85,
            created_by=self.user
        )
        self.assertEqual(report.report_format, 'json')
        self.assertEqual(report.confidence_score, 0.85)
        self.assertIn('Test summary', report.executive_summary)


class ViewsTest(TestCase):
    """Test views functionality."""
    
    def setUp(self):
        self.client = Client()
        self.user = User.objects.create_user(username='testuser', password='testpass123')
        self.client.login(username='testuser', password='testpass123')
        
    def test_analysis_goals_view(self):
        """Test analysis goals view loads."""
        response = self.client.get('/malware-analyser/analysis-goals/')
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'Analysis Goals')
        
    def test_analysis_techniques_view(self):
        """Test analysis techniques view loads."""
        response = self.client.get('/malware-analyser/analysis-techniques/')
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'Analysis Techniques')
        
    def test_best_practices_view(self):
        """Test best practices view loads."""
        response = self.client.get('/malware-analyser/best-practices/')
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, 'Best Practices')


class DataPopulationTest(TestCase):
    """Test data population."""
    
    def test_initial_data_exists(self):
        """Test that initial data can be created."""
        # Create sample data
        AnalysisGoal.objects.create(
            name='Test Goal',
            goal_type='identification',
            description='Test',
            is_default=True
        )
        AnalysisTechnique.objects.create(
            name='Test Technique',
            category='basic_static',
            description='Test'
        )
        MalwareType.objects.create(
            name='Test Malware',
            category='trojan',
            description='Test'
        )
        BestPractice.objects.create(
            title='Test Practice',
            category='vm_setup',
            description='Test'
        )
        
        # Verify data exists
        self.assertEqual(AnalysisGoal.objects.count(), 1)
        self.assertEqual(AnalysisTechnique.objects.count(), 1)
        self.assertEqual(MalwareType.objects.count(), 1)
        self.assertEqual(BestPractice.objects.count(), 1)


class MultiFormatEngineTest(TestCase):
    """Test multi-format analysis engine."""

    def test_engine_instantiation(self):
        """Engine should import and instantiate without error."""
        from malware_analyser.multi_format_engine import MultiFormatEngine
        engine = MultiFormatEngine()
        self.assertIsNotNone(engine)

    def test_elf_analyzer_fallback(self):
        """ELF analyzer should return a dict even on non-ELF data."""
        from malware_analyser.multi_format_engine import ELFAnalyzer
        import tempfile, os
        with tempfile.NamedTemporaryFile(delete=False, suffix='.bin') as f:
            f.write(b'not-an-elf-file')
            tmp = f.name
        try:
            result = ELFAnalyzer(tmp).analyze()
            self.assertIsInstance(result, dict)
        finally:
            os.unlink(tmp)

    def test_archive_analyzer_zip(self):
        """Archive analyzer should handle ZIP files."""
        from malware_analyser.multi_format_engine import ArchiveAnalyzer
        import tempfile, os, zipfile
        with tempfile.NamedTemporaryFile(delete=False, suffix='.zip') as f:
            tmp = f.name
        zf = zipfile.ZipFile(tmp, 'w')
        zf.writestr('hello.txt', 'hello world')
        zf.close()
        try:
            result = ArchiveAnalyzer(tmp).analyze()
            self.assertIsInstance(result, dict)
        finally:
            os.unlink(tmp)


class YaraEngineTest(TestCase):
    """Test YARA engine."""

    def test_engine_instantiation(self):
        """YARA engine should import and instantiate without error."""
        from malware_analyser.yara_engine import YaraEngine
        engine = YaraEngine()
        self.assertIsNotNone(engine)

    def test_scan_returns_list(self):
        """scan_data() should return a dict with matches."""
        from malware_analyser.yara_engine import YaraEngine
        engine = YaraEngine()
        result = engine.scan_data(b'Hello world test content')
        self.assertIsInstance(result, dict)
        self.assertIn('matches', result)


class MLEngineTest(TestCase):
    """Test ML detection engine."""

    def test_engine_instantiation(self):
        """ML engine should import and instantiate without error."""
        from malware_analyser.ml_engine import MLDetectionEngine
        engine = MLDetectionEngine()
        self.assertIsNotNone(engine)

    def test_predict_returns_dict(self):
        """predict() should return a dict with required keys."""
        from malware_analyser.ml_engine import MLDetectionEngine
        import tempfile, os
        engine = MLDetectionEngine()
        with tempfile.NamedTemporaryFile(delete=False) as f:
            f.write(b'\x00' * 1024)
            tmp = f.name
        try:
            result = engine.predict(tmp)
            self.assertIsInstance(result, dict)
            self.assertIn('is_malicious', result)
            self.assertIn('confidence', result)
        finally:
            os.unlink(tmp)


class ThreatIntelTest(TestCase):
    """Test threat intelligence integration."""

    def test_mitre_mapper_instantiation(self):
        """MITRE ATT&CK mapper should import without error."""
        from malware_analyser.threat_intel import MITREAttackMapper
        mapper = MITREAttackMapper()
        self.assertIsNotNone(mapper)

    def test_mapper_returns_list(self):
        """map_behaviors() should return a dict of behavior->technique mappings."""
        from malware_analyser.threat_intel import MITREAttackMapper
        mapper = MITREAttackMapper()
        result = mapper.map_behaviors(['process injection', 'anti-debug', 'registry persistence'])
        self.assertIsInstance(result, dict)


class IOCExportTest(TestCase):
    """Test IOC export functionality."""

    def test_ioc_bundle_creation(self):
        """IOCBundle should be creatable."""
        from malware_analyser.ioc_export import IOCBundle
        bundle = IOCBundle()
        self.assertIsNotNone(bundle)

    def test_stix_exporter_fallback(self):
        """STIX exporter should produce valid JSON without stix2 library."""
        from malware_analyser.ioc_export import STIXExporter, IOCBundle
        bundle = IOCBundle()
        bundle.ips = ['1.2.3.4']
        bundle.domains = ['evil.com']
        exporter = STIXExporter()
        result = exporter.export(bundle, sample_name='test.exe')
        self.assertIsInstance(result, dict)


class NewModelsTest(TestCase):
    """Test new database models."""

    def setUp(self):
        self.user = User.objects.create_user(username='modeltest', password='testpass123')

    def test_yara_rule_model(self):
        """YARARule model should be creatable."""
        from malware_analyser.models import YARARule
        rule = YARARule.objects.create(
            name='Test Rule',
            rule_content='rule test { condition: false }',
            author=self.user,
        )
        self.assertEqual(rule.name, 'Test Rule')
        self.assertFalse(rule.is_compiled)

    def test_attack_mapping_model(self):
        """ATTACKMapping model should be creatable."""
        from malware_analyser.models import ATTACKMapping, FileUpload, ScanResult
        from django.core.files.uploadedfile import SimpleUploadedFile
        upload = FileUpload.objects.create(
            original_filename='test.exe',
            file=SimpleUploadedFile('test.exe', b'MZ'),
            file_size=2,
            uploaded_by=self.user,
        )
        scan = ScanResult.objects.create(file=upload, performed_by=self.user)
        mapping = ATTACKMapping.objects.create(
            scan_result=scan,
            technique_id='T1055',
            technique_name='Process Injection',
            tactic='Defense Evasion',
            confidence=0.9,
        )
        self.assertEqual(mapping.technique_id, 'T1055')

    def test_calculate_hashes_real(self):
        """calculate_hashes should hash actual file content."""
        from malware_analyser.models import FileUpload
        from django.core.files.uploadedfile import SimpleUploadedFile
        import hashlib
        content = b'real file content for hashing'
        expected_md5 = hashlib.md5(content).hexdigest()
        expected_sha256 = hashlib.sha256(content).hexdigest()
        upload = FileUpload.objects.create(
            original_filename='hash_test.bin',
            file=SimpleUploadedFile('hash_test.bin', content),
            file_size=len(content),
            uploaded_by=self.user,
        )
        upload.calculate_hashes()
        self.assertEqual(upload.file_hash_md5, expected_md5)
        self.assertEqual(upload.file_hash_sha256, expected_sha256)
