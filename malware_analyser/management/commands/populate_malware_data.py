"""
Management command to populate malware analyser with initial data.
"""

from django.core.management.base import BaseCommand
from malware_analyser.models import (
    AnalysisGoal, AnalysisTechnique, MalwareType, BestPractice
)


class Command(BaseCommand):
    help = 'Populate malware analyser with initial data (goals, techniques, best practices)'

    def handle(self, *args, **options):
        self.stdout.write('Populating malware analyser data...')
        
        # Create Analysis Goals
        self.create_analysis_goals()
        
        # Create Analysis Techniques
        self.create_analysis_techniques()
        
        # Create Malware Types
        self.create_malware_types()
        
        # Create Best Practices
        self.create_best_practices()
        
        self.stdout.write(self.style.SUCCESS('Successfully populated malware analyser data'))

    def create_analysis_goals(self):
        """Create default analysis goals."""
        goals_data = [
            {
                'name': 'Malware Identification',
                'goal_type': 'identification',
                'description': 'Identify the type, family, and variant of the malware sample.',
                'priority': 1,
                'is_default': True
            },
            {
                'name': 'Functionality Analysis',
                'goal_type': 'functionality',
                'description': 'Understand what the malware does, its capabilities, and intended purpose.',
                'priority': 1,
                'is_default': True
            },
            {
                'name': 'IOC Extraction',
                'goal_type': 'iocs',
                'description': 'Extract Indicators of Compromise (IPs, domains, file hashes, registry keys).',
                'priority': 2,
                'is_default': True
            },
            {
                'name': 'Attribution & Origin',
                'goal_type': 'attribution',
                'description': 'Determine the origin, author, or threat actor behind the malware.',
                'priority': 3,
                'is_default': False
            },
            {
                'name': 'Behavior Analysis',
                'goal_type': 'behavior',
                'description': 'Analyze runtime behavior, system interactions, and evasion techniques.',
                'priority': 2,
                'is_default': True
            },
            {
                'name': 'Impact Assessment',
                'goal_type': 'impact',
                'description': 'Assess the potential impact and damage the malware can cause.',
                'priority': 2,
                'is_default': False
            },
        ]
        
        for goal_data in goals_data:
            AnalysisGoal.objects.get_or_create(
                name=goal_data['name'],
                defaults=goal_data
            )
        
        self.stdout.write('  - Created analysis goals')

    def create_analysis_techniques(self):
        """Create analysis techniques for each category."""
        techniques_data = [
            # Basic Static Analysis
            {
                'name': 'Hash Calculation',
                'category': 'basic_static',
                'description': 'Calculate cryptographic hashes (MD5, SHA1, SHA256) of the sample.',
                'guidance': '1. Use hash tools (md5sum, sha256sum)\n2. Compare against known malware databases\n3. Use VirusTotal or similar services',
                'tools_required': ['md5sum', 'sha256sum', 'VirusTotal API'],
                'documentation_url': 'https://docs.example.com/hash-analysis'
            },
            {
                'name': 'Strings Extraction',
                'category': 'basic_static',
                'description': 'Extract readable strings from the binary to identify URLs, IPs, and commands.',
                'guidance': '1. Use strings command\n2. Look for URLs, IPs, file paths\n3. Identify suspicious keywords',
                'tools_required': ['strings', 'FLOSS'],
                'documentation_url': 'https://docs.example.com/strings-analysis'
            },
            {
                'name': 'PE Header Analysis',
                'category': 'basic_static',
                'description': 'Analyze PE headers for Windows executables.',
                'guidance': '1. Use PE analysis tools\n2. Check compile time, imports, exports\n3. Identify suspicious sections',
                'tools_required': ['pefile', 'PEview', 'PE Explorer'],
                'documentation_url': 'https://docs.example.com/pe-analysis'
            },
            {
                'name': 'Packing Detection',
                'category': 'basic_static',
                'description': 'Detect if the sample is packed or obfuscated.',
                'guidance': '1. Calculate entropy\n2. Use PEiD or similar tools\n3. Check for common packers',
                'tools_required': ['PEiD', 'Detect It Easy', 'Entropy calculator'],
                'documentation_url': 'https://docs.example.com/packing-detection'
            },
            
            # Basic Dynamic Analysis
            {
                'name': 'Process Monitoring',
                'category': 'basic_dynamic',
                'description': 'Monitor processes created by the malware.',
                'guidance': '1. Use Process Monitor\n2. Track parent/child relationships\n3. Identify suspicious processes',
                'tools_required': ['Process Monitor', 'Process Explorer'],
                'documentation_url': 'https://docs.example.com/process-monitoring'
            },
            {
                'name': 'Network Monitoring',
                'category': 'basic_dynamic',
                'description': 'Monitor network activity and connections.',
                'guidance': '1. Use Wireshark or tcpdump\n2. Identify C2 servers\n3. Capture DNS queries',
                'tools_required': ['Wireshark', 'tcpdump', 'Fiddler'],
                'documentation_url': 'https://docs.example.com/network-monitoring'
            },
            {
                'name': 'File System Monitoring',
                'category': 'basic_dynamic',
                'description': 'Monitor file system changes.',
                'guidance': '1. Track files created/modified/deleted\n2. Check for persistence mechanisms\n3. Identify dropped files',
                'tools_required': ['Procmon', 'FSMon'],
                'documentation_url': 'https://docs.example.com/filesystem-monitoring'
            },
            {
                'name': 'Registry Monitoring',
                'category': 'basic_dynamic',
                'description': 'Monitor Windows registry changes.',
                'guidance': '1. Track registry modifications\n2. Identify persistence keys\n3. Check autorun entries',
                'tools_required': ['Regshot', 'Process Monitor'],
                'documentation_url': 'https://docs.example.com/registry-monitoring'
            },
            
            # Advanced Static Analysis
            {
                'name': 'Disassembly',
                'category': 'advanced_static',
                'description': 'Disassemble the binary for low-level analysis.',
                'guidance': '1. Use IDA Pro or Ghidra\n2. Identify key functions\n3. Analyze control flow',
                'tools_required': ['IDA Pro', 'Ghidra', 'radare2'],
                'documentation_url': 'https://docs.example.com/disassembly'
            },
            {
                'name': 'Decompilation',
                'category': 'advanced_static',
                'description': 'Decompile to higher-level code representation.',
                'guidance': '1. Use decompiler tools\n2. Understand program logic\n3. Identify malicious functions',
                'tools_required': ['Ghidra', 'IDA Hex-Rays', 'RetDec'],
                'documentation_url': 'https://docs.example.com/decompilation'
            },
            {
                'name': 'YARA Rule Scanning',
                'category': 'advanced_static',
                'description': 'Scan with YARA rules for pattern matching.',
                'guidance': '1. Use YARA tool\n2. Apply relevant rule sets\n3. Identify malware families',
                'tools_required': ['YARA', 'YARA rules database'],
                'documentation_url': 'https://docs.example.com/yara-scanning'
            },
            
            # Advanced Dynamic Analysis
            {
                'name': 'API Hooking',
                'category': 'advanced_dynamic',
                'description': 'Hook and trace API calls.',
                'guidance': '1. Use API monitoring tools\n2. Track suspicious API calls\n3. Identify malicious behavior',
                'tools_required': ['API Monitor', 'Cuckoo Sandbox'],
                'documentation_url': 'https://docs.example.com/api-hooking'
            },
            {
                'name': 'Memory Dumping',
                'category': 'advanced_dynamic',
                'description': 'Dump and analyze process memory.',
                'guidance': '1. Dump process memory\n2. Search for IOCs in memory\n3. Extract unpacked code',
                'tools_required': ['Volatility', 'WinDbg', 'x64dbg'],
                'documentation_url': 'https://docs.example.com/memory-analysis'
            },
            {
                'name': 'Anti-Analysis Detection',
                'category': 'advanced_dynamic',
                'description': 'Detect anti-VM, anti-debug, and evasion techniques.',
                'guidance': '1. Check for VM detection\n2. Identify debugger detection\n3. Find sandbox evasion',
                'tools_required': ['Pafish', 'Al-Khaser'],
                'documentation_url': 'https://docs.example.com/anti-analysis'
            },
        ]
        
        for technique_data in techniques_data:
            AnalysisTechnique.objects.get_or_create(
                name=technique_data['name'],
                defaults=technique_data
            )
        
        self.stdout.write('  - Created analysis techniques')

    def create_malware_types(self):
        """Create malware type classifications."""
        malware_types_data = [
            {
                'name': 'Generic Virus',
                'category': 'virus',
                'description': 'Self-replicating malware that infects files and programs.',
                'characteristics': {'replication': True, 'host_required': True},
                'detection_patterns': ['file_infection', 'code_injection']
            },
            {
                'name': 'Network Worm',
                'category': 'worm',
                'description': 'Self-replicating malware that spreads across networks.',
                'characteristics': {'replication': True, 'network_propagation': True},
                'detection_patterns': ['network_scanning', 'exploit_usage']
            },
            {
                'name': 'Trojan Horse',
                'category': 'trojan',
                'description': 'Malware disguised as legitimate software.',
                'characteristics': {'disguise': True, 'user_action_required': True},
                'detection_patterns': ['fake_installer', 'hidden_payload']
            },
            {
                'name': 'Ransomware',
                'category': 'ransomware',
                'description': 'Malware that encrypts files and demands ransom.',
                'characteristics': {'encryption': True, 'ransom_demand': True},
                'detection_patterns': ['file_encryption', 'ransom_note']
            },
            {
                'name': 'Remote Access Trojan',
                'category': 'rat',
                'description': 'Provides unauthorized remote access to infected system.',
                'characteristics': {'remote_control': True, 'backdoor': True},
                'detection_patterns': ['reverse_shell', 'remote_commands']
            },
            {
                'name': 'Spyware',
                'category': 'spyware',
                'description': 'Collects and exfiltrates sensitive information.',
                'characteristics': {'data_theft': True, 'stealth': True},
                'detection_patterns': ['keylogging', 'screen_capture', 'data_exfiltration']
            },
            {
                'name': 'Cryptominer',
                'category': 'cryptominer',
                'description': 'Uses system resources to mine cryptocurrency.',
                'characteristics': {'resource_consumption': True, 'persistence': True},
                'detection_patterns': ['high_cpu_usage', 'mining_pool_connection']
            },
        ]
        
        for malware_type_data in malware_types_data:
            MalwareType.objects.get_or_create(
                name=malware_type_data['name'],
                defaults=malware_type_data
            )
        
        self.stdout.write('  - Created malware types')

    def create_best_practices(self):
        """Create safety best practices."""
        best_practices_data = [
            {
                'title': 'Use Isolated Virtual Machines',
                'category': 'vm_setup',
                'description': 'Always analyze malware in isolated VMs to prevent infection of host systems.',
                'checklist_items': [
                    'Create dedicated analysis VM',
                    'Disable shared folders',
                    'Disable clipboard sharing',
                    'Use snapshots before analysis',
                    'Never analyze on production systems'
                ],
                'severity': 'critical',
                'is_mandatory': True,
                'display_order': 1
            },
            {
                'title': 'Network Isolation',
                'category': 'networking',
                'description': 'Disconnect or isolate network to prevent malware communication.',
                'checklist_items': [
                    'Disconnect from internet before execution',
                    'Use host-only network for monitoring',
                    'Set up fake internet (INetSim)',
                    'Monitor all network traffic',
                    'Block outbound connections'
                ],
                'severity': 'critical',
                'is_mandatory': True,
                'display_order': 2
            },
            {
                'title': 'Create VM Snapshots',
                'category': 'snapshots',
                'description': 'Take snapshots before analysis to enable quick restoration.',
                'checklist_items': [
                    'Take clean snapshot before analysis',
                    'Name snapshots clearly',
                    'Restore after each analysis',
                    'Keep multiple snapshot points',
                    'Verify snapshot integrity'
                ],
                'severity': 'high',
                'is_mandatory': True,
                'display_order': 3
            },
            {
                'title': 'Legal Authorization',
                'category': 'legal',
                'description': 'Ensure you have proper authorization for malware analysis.',
                'checklist_items': [
                    'Obtain written authorization',
                    'Document analysis purpose',
                    'Follow organizational policies',
                    'Comply with local laws',
                    'Maintain audit trail'
                ],
                'severity': 'critical',
                'is_mandatory': True,
                'display_order': 4
            },
            {
                'title': 'Safe File Handling',
                'category': 'isolation',
                'description': 'Handle malware samples safely to prevent accidental execution.',
                'checklist_items': [
                    'Use password-protected archives',
                    'Rename extensions to .bin or .vir',
                    'Store in secure, encrypted location',
                    'Never double-click samples',
                    'Use command-line for execution'
                ],
                'severity': 'high',
                'is_mandatory': False,
                'display_order': 5
            },
            {
                'title': 'Monitor Everything',
                'category': 'monitoring',
                'description': 'Set up comprehensive monitoring before running malware.',
                'checklist_items': [
                    'Start process monitor',
                    'Enable network capture',
                    'Monitor file system changes',
                    'Track registry modifications',
                    'Enable API tracing'
                ],
                'severity': 'high',
                'is_mandatory': False,
                'display_order': 6
            },
            {
                'title': 'Proper Cleanup',
                'category': 'cleanup',
                'description': 'Properly clean up after analysis to prevent contamination.',
                'checklist_items': [
                    'Restore VM from snapshot',
                    'Delete malware samples securely',
                    'Clear browser cache',
                    'Remove temporary files',
                    'Verify clean state'
                ],
                'severity': 'medium',
                'is_mandatory': False,
                'display_order': 7
            },
        ]
        
        for practice_data in best_practices_data:
            BestPractice.objects.get_or_create(
                title=practice_data['title'],
                defaults=practice_data
            )
        
        self.stdout.write('  - Created best practices')
