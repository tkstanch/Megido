{% extends "base.html" %}

{% block title %}Scan Results - Malware Analyser{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-clipboard-data"></i> Scan Results
    </h1>
    
    <!-- Scan Status -->
    <div class="row mb-4">
        <div class="col-md-12">
            {% if scan.is_malicious %}
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading">⚠️ THREAT DETECTED (STUB)</h4>
                <p>This file has been flagged as potentially malicious by the scanning engine.</p>
                <hr>
                <p class="mb-0"><strong>Detected Malware:</strong> {{ scan.detected_malware }}</p>
                <p class="mb-0"><strong>Threat Level:</strong> 
                    <span class="badge bg-danger">{{ scan.get_threat_level_display }}</span>
                </p>
            </div>
            {% else %}
            <div class="alert alert-success" role="alert">
                <h4 class="alert-heading">✓ No Threats Detected (STUB)</h4>
                <p class="mb-0">This file appears to be clean based on the scan criteria.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Scan Details -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Scan Details</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tr>
                            <th width="200">Scan ID:</th>
                            <td><code>{{ scan.scan_id }}</code></td>
                        </tr>
                        <tr>
                            <th>File:</th>
                            <td>{{ scan.file.original_filename }}</td>
                        </tr>
                        <tr>
                            <th>Scan Type:</th>
                            <td>{{ scan.get_scan_type_display }}</td>
                        </tr>
                        <tr>
                            <th>Started:</th>
                            <td>{{ scan.started_at }}</td>
                        </tr>
                        <tr>
                            <th>Completed:</th>
                            <td>{{ scan.completed_at|default:"In progress..." }}</td>
                        </tr>
                        <tr>
                            <th>Performed By:</th>
                            <td>{{ scan.performed_by.username }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Matched Signatures -->
    {% if matched_signatures %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5>Matched Malware Signatures</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Signature Name</th>
                                    <th>Type</th>
                                    <th>Severity</th>
                                    <th>Malware Family</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sig in matched_signatures %}
                                <tr>
                                    <td><strong>{{ sig.name }}</strong></td>
                                    <td>{{ sig.get_signature_type_display }}</td>
                                    <td>
                                        <span class="badge bg-{{ sig.severity }}">
                                            {{ sig.get_severity_display }}
                                        </span>
                                    </td>
                                    <td>{{ sig.malware_family|default:"Unknown" }}</td>
                                    <td>{{ sig.description|truncatechars:100 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Scan Details (JSON) -->
    {% if scan.scan_details %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Technical Details</h5>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3"><code>{{ scan.scan_details|safe }}</code></pre>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Actions -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Actions</h5>
                </div>
                <div class="card-body">
                    {% if scan.is_malicious %}
                    <div class="alert alert-warning mb-3" role="alert">
                        <h6 class="alert-heading">Cleaning Actions Available (STUB)</h6>
                        <p class="mb-0">The following actions are stub implementations for demonstration purposes.</p>
                    </div>
                    
                    <form method="post" action="{% url 'malware_analyser:clean_file' scan.file.file_id %}" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="quarantine">
                        <button type="submit" class="btn btn-warning me-2">
                            <i class="bi bi-lock"></i> Quarantine File (STUB)
                        </button>
                    </form>
                    
                    <form method="post" action="{% url 'malware_analyser:clean_file' scan.file.file_id %}" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete">
                        <button type="submit" class="btn btn-danger me-2">
                            <i class="bi bi-trash"></i> Delete File (STUB)
                        </button>
                    </form>
                    
                    <form method="post" action="{% url 'malware_analyser:clean_file' scan.file.file_id %}" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="clean">
                        <button type="submit" class="btn btn-info me-2">
                            <i class="bi bi-bandaid"></i> Clean/Disinfect (STUB)
                        </button>
                    </form>
                    {% endif %}
                    
                    <a href="{% url 'malware_analyser:dashboard' %}" class="btn btn-secondary">
                        <i class="bi bi-house"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
