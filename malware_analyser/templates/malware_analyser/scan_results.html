{% extends "base.html" %}
{% load static %}

{% block title %}Scan Results - Malware Analyser{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-primary-600 dark:hover:text-primary-400">Megido Security</a>
        <span>/</span>
        <a href="{% url 'malware_analyser:dashboard' %}" class="hover:text-primary-600 dark:hover:text-primary-400">Malware Analyser</a>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Scan Results</span>
    </nav>

    <!-- Page Title -->
    <div class="card">
        <div class="card-body text-center">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">üìä Scan Results</h1>
            <p class="text-gray-600 dark:text-gray-400">Detailed analysis and detection results</p>
        </div>
    </div>
    
    <!-- Scan Status -->
    {% if scan.is_malicious %}
    <div class="alert alert-danger">
        <h4 class="font-bold text-xl mb-2">‚ö†Ô∏è MALWARE DETECTED</h4>
        <p>This file has been identified as malicious by the scanning engine.</p>
        <hr class="my-3 border-red-300 dark:border-red-700">
        <p class="mb-1"><strong>Detected Malware:</strong> {{ scan.detected_malware }}</p>
        <p class="mb-1"><strong>Threat Level:</strong> 
            <span class="badge badge-danger">{{ scan.get_threat_level_display }}</span>
        </p>
        <hr class="my-3 border-red-300 dark:border-red-700">
        <p class="text-sm"><strong>‚ö†Ô∏è Educational Demo:</strong> This detection is for demonstration purposes. Never handle real malware outside secure sandboxes.</p>
    </div>
    {% else %}
    <div class="alert alert-success">
        <h4 class="font-bold text-xl mb-2">‚úì No Threats Detected</h4>
        <p>This file appears to be clean based on the scan criteria.</p>
    </div>
    {% endif %}
    
    <!-- Scan Details -->
    <div class="card">
        <div class="card-header">
            <h5>Scan Details</h5>
        </div>
        <div class="card-body">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300 w-48">Scan ID:</th>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100"><code class="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">{{ scan.scan_id }}</code></td>
                        </tr>
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">File:</th>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">{{ scan.file.original_filename }}</td>
                        </tr>
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">Scan Type:</th>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">{{ scan.get_scan_type_display }}</td>
                        </tr>
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">Started:</th>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">{{ scan.started_at }}</td>
                        </tr>
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">Completed:</th>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">{{ scan.completed_at|default:"In progress..." }}</td>
                        </tr>
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">Performed By:</th>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">{{ scan.performed_by.username }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Matched Signatures -->
    {% if matched_signatures %}
    <div class="card border-2 border-red-500 dark:border-red-700">
        <div class="card-header bg-red-500 text-white">
            <h5>Matched Malware Signatures</h5>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-800">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Signature Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Type</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Severity</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Malware Family</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Description</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                        {% for sig in matched_signatures %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td class="px-4 py-3 text-sm font-semibold text-gray-900 dark:text-gray-100">{{ sig.name }}</td>
                            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">{{ sig.get_signature_type_display }}</td>
                            <td class="px-4 py-3 text-sm">
                                {% if sig.severity == 'danger' %}
                                <span class="badge badge-danger">{{ sig.get_severity_display }}</span>
                                {% elif sig.severity == 'warning' %}
                                <span class="badge badge-warning">{{ sig.get_severity_display }}</span>
                                {% elif sig.severity == 'info' %}
                                <span class="badge badge-info">{{ sig.get_severity_display }}</span>
                                {% else %}
                                <span class="badge badge-secondary">{{ sig.get_severity_display }}</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">{{ sig.malware_family|default:"Unknown" }}</td>
                            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">{{ sig.description|truncatechars:100 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Scan Details (JSON) -->
    {% if scan.scan_details %}
    <div class="card">
        <div class="card-header">
            <h5>Technical Details</h5>
        </div>
        <div class="card-body">
            <pre class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto text-sm"><code class="text-gray-900 dark:text-gray-100">{{ scan.scan_details|safe }}</code></pre>
        </div>
    </div>
    {% endif %}
    
    <!-- Actions -->
    <div class="card">
        <div class="card-header">
            <h5>Available Actions</h5>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <!-- Analysis Actions -->
                <a href="{% url 'malware_analyser:static_analysis' scan.scan_id %}" class="btn btn-primary">
                    üìÑ Static Analysis
                </a>
                <a href="{% url 'malware_analyser:dynamic_analysis' scan.scan_id %}" class="btn btn-primary">
                    ‚ñ∂Ô∏è Dynamic Analysis
                </a>
                <a href="{% url 'malware_analyser:generate_report' scan.scan_id %}" class="btn btn-secondary">
                    üìä Generate Report
                </a>
                
                {% if scan.is_malicious %}
                <!-- Cleaning Actions -->
                <form method="post" action="{% url 'malware_analyser:clean_file' scan.file.file_id %}" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="quarantine">
                    <button type="submit" class="btn bg-yellow-500 hover:bg-yellow-600 text-white w-full">
                        üîí Quarantine File
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h5>Actions</h5>
        </div>
        <div class="card-body space-y-4">
            {% if scan.is_malicious %}
            <div class="alert alert-warning">
                <h6 class="font-bold mb-2">Cleaning Actions Available (STUB)</h6>
                <p>The following actions are stub implementations for demonstration purposes.</p>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <form method="post" action="{% url 'malware_analyser:clean_file' scan.file.file_id %}" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="quarantine">
                    <button type="submit" class="btn bg-yellow-500 hover:bg-yellow-600 text-white">
                        üîí Quarantine File (STUB)
                    </button>
                </form>
                
                <form method="post" action="{% url 'malware_analyser:clean_file' scan.file.file_id %}" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <button type="submit" class="btn btn-danger">
                        üóëÔ∏è Delete File (STUB)
                    </button>
                </form>
                
                <form method="post" action="{% url 'malware_analyser:clean_file' scan.file.file_id %}" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="clean">
                    <button type="submit" class="btn bg-blue-500 hover:bg-blue-600 text-white">
                        ü©π Clean/Disinfect (STUB)
                    </button>
                </form>
            </div>
            {% endif %}
            
            <div>
                <a href="{% url 'malware_analyser:dashboard' %}" class="btn btn-secondary">
                    üè† Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
