{% extends "base.html" %}
{% load static %}

{% block title %}Static Analysis - Malware Analyser{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-primary-600 dark:hover:text-primary-400">Megido Security</a>
        <span>/</span>
        <a href="{% url 'malware_analyser:dashboard' %}" class="hover:text-primary-600 dark:hover:text-primary-400">Malware Analyser</a>
        <span>/</span>
        <a href="{% url 'malware_analyser:scan_results' scan.scan_id %}" class="hover:text-primary-600 dark:hover:text-primary-400">Scan Results</a>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Static Analysis</span>
    </nav>

    <!-- Header -->
    <div class="card">
        <div class="card-body">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">üìÑ Static Analysis</h1>
            <p class="text-gray-600 dark:text-gray-400">File: {{ scan.file.original_filename }}</p>
        </div>
    </div>

    <!-- Run Static Analysis -->
    {% if not static_analysis.md5_hash %}
    <div class="card border-primary-500">
        <div class="card-body text-center">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Ready to Perform Static Analysis</h5>
            <p class="text-gray-600 dark:text-gray-400 mb-4">
                Static analysis will examine the file without executing it. This includes hash calculation, 
                string extraction, entropy analysis, and packing detection.
            </p>
            <form method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary btn-lg">
                    üî¨ Run Static Analysis
                </button>
            </form>
        </div>
    </div>
    {% else %}

    <!-- File Hashes -->
    <div class="card">
        <div class="card-header">
            <h5>üîê File Hashes</h5>
        </div>
        <div class="card-body">
            <div class="grid gap-4 md:grid-cols-3">
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">MD5</p>
                    <code class="text-sm font-mono bg-gray-100 dark:bg-gray-800 p-2 rounded block break-all">{{ static_analysis.md5_hash }}</code>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">SHA1</p>
                    <code class="text-sm font-mono bg-gray-100 dark:bg-gray-800 p-2 rounded block break-all">{{ static_analysis.sha1_hash }}</code>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">SHA256</p>
                    <code class="text-sm font-mono bg-gray-100 dark:bg-gray-800 p-2 rounded block break-all">{{ static_analysis.sha256_hash }}</code>
                </div>
            </div>
        </div>
    </div>

    <!-- Packing & Obfuscation -->
    <div class="card {% if static_analysis.is_packed %}border-yellow-500{% endif %}">
        <div class="card-header {% if static_analysis.is_packed %}bg-yellow-50 dark:bg-yellow-900/20{% endif %}">
            <h5>üì¶ Packing & Obfuscation Analysis</h5>
        </div>
        <div class="card-body">
            <div class="grid gap-4 md:grid-cols-2">
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Packing Status</p>
                    {% if static_analysis.is_packed %}
                    <span class="badge badge-warning">‚ö†Ô∏è Packing Detected</span>
                    {% else %}
                    <span class="badge badge-success">‚úì No Packing Detected</span>
                    {% endif %}
                    
                    {% if static_analysis.entropy %}
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                        <strong>Entropy:</strong> {{ static_analysis.entropy|floatformat:2 }} / 8.0
                        {% if static_analysis.entropy > 7.0 %}
                        <span class="text-yellow-600 dark:text-yellow-400">(High - suggests compression/encryption)</span>
                        {% elif static_analysis.entropy > 5.0 %}
                        <span class="text-blue-600 dark:text-blue-400">(Medium)</span>
                        {% else %}
                        <span class="text-green-600 dark:text-green-400">(Low)</span>
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
                <div>
                    {% if static_analysis.packer_detected %}
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Packer Detected</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ static_analysis.packer_detected }}</p>
                    {% endif %}
                    
                    {% if static_analysis.unpacking_suggestions %}
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 mt-3">Unpacking Suggestions</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ static_analysis.unpacking_suggestions }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Strings Analysis -->
    {% if static_analysis.strings_extracted %}
    <div class="card">
        <div class="card-header">
            <h5>üìù Extracted Strings</h5>
        </div>
        <div class="card-body">
            {% if static_analysis.suspicious_strings %}
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded p-3 mb-4">
                <p class="text-sm font-semibold text-yellow-900 dark:text-yellow-100 mb-2">‚ö†Ô∏è Suspicious Strings Found:</p>
                <div class="flex flex-wrap gap-2">
                    {% for string in static_analysis.suspicious_strings %}
                    <span class="badge badge-warning text-xs">{{ string }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="bg-gray-50 dark:bg-gray-800 rounded p-4">
                <pre class="text-xs font-mono text-gray-700 dark:text-gray-300 whitespace-pre-wrap overflow-x-auto max-h-96">{{ static_analysis.strings_extracted }}</pre>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- PE Analysis -->
    {% if static_analysis.pe_data %}
    <div class="card">
        <div class="card-header">
            <h5>ü™ü PE Header Analysis</h5>
        </div>
        <div class="card-body">
            <pre class="text-xs font-mono bg-gray-50 dark:bg-gray-800 p-4 rounded overflow-x-auto">{{ static_analysis.pe_data|safe }}</pre>
        </div>
    </div>
    {% endif %}

    <!-- YARA Matches -->
    {% if static_analysis.yara_matches %}
    <div class="card border-red-500">
        <div class="card-header bg-red-50 dark:bg-red-900/20">
            <h5 class="text-red-900 dark:text-red-100">üéØ YARA Rule Matches</h5>
        </div>
        <div class="card-body">
            <ul class="space-y-2">
                {% for match in static_analysis.yara_matches %}
                <li class="text-sm text-gray-700 dark:text-gray-300">{{ match }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Techniques Used -->
    <div class="card">
        <div class="card-header">
            <h5>üî¨ Analysis Techniques Applied</h5>
        </div>
        <div class="card-body">
            <div class="flex flex-wrap gap-2">
                {% for technique in static_analysis.techniques_used.all %}
                <span class="badge badge-primary">{{ technique.name }}</span>
                {% empty %}
                <span class="text-gray-500 dark:text-gray-400">No techniques recorded</span>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Back to Results -->
    <div class="text-center">
        <a href="{% url 'malware_analyser:scan_results' scan.scan_id %}" class="btn btn-secondary">
            ‚Üê Back to Scan Results
        </a>
    </div>
</div>
{% endblock %}
