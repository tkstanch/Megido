{% extends "base.html" %}
{% load static %}

{% block title %}Advanced Static Analysis - Malware Analyser{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-primary-600 dark:hover:text-primary-400">Megido Security</a>
        <span>/</span>
        <a href="{% url 'malware_analyser:dashboard' %}" class="hover:text-primary-600 dark:hover:text-primary-400">Malware Analyser</a>
        <span>/</span>
        <a href="{% url 'malware_analyser:scan_results' scan.scan_id %}" class="hover:text-primary-600 dark:hover:text-primary-400">Scan Results</a>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Advanced Static Analysis</span>
    </nav>

    <!-- Header -->
    <div class="card bg-gradient-to-r from-purple-500 to-blue-600 text-white">
        <div class="card-body">
            <h1 class="text-3xl font-bold mb-2">‚ú® Advanced Static Analysis</h1>
            <p class="text-blue-100">File: {{ scan.file.original_filename }}</p>
            <p class="text-sm text-blue-200 mt-2">üöÄ Powered by PE Parser, YARA Engine, and ML Detection</p>
        </div>
    </div>

    <!-- Run Static Analysis -->
    {% if not static_analysis.md5_hash %}
    <div class="card border-primary-500">
        <div class="card-body text-center">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Ready to Perform Advanced Static Analysis</h5>
            <p class="text-gray-600 dark:text-gray-400 mb-4">
                Our <strong>extra extremely advanced</strong> static analysis includes:
                <br>‚ú® Real PE structure parsing with section analysis
                <br>üéØ YARA rule scanning for known malware patterns
                <br>ü§ñ Machine Learning-based malware prediction
                <br>üìä Advanced entropy and byte distribution analysis
                <br>üîç Import/Export table analysis
                <br>‚ö†Ô∏è Anomaly detection (suspicious characteristics)
            </p>
            <form method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary btn-lg">
                    üöÄ Run Advanced Analysis
                </button>
            </form>
        </div>
    </div>
    {% else %}

    <!-- File Hashes -->
    <div class="card">
        <div class="card-header">
            <h5>üîê File Hashes</h5>
        </div>
        <div class="card-body">
            <div class="grid gap-4 md:grid-cols-3">
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">MD5</p>
                    <code class="text-sm font-mono bg-gray-100 dark:bg-gray-800 p-2 rounded block break-all">{{ static_analysis.md5_hash }}</code>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">SHA1</p>
                    <code class="text-sm font-mono bg-gray-100 dark:bg-gray-800 p-2 rounded block break-all">{{ static_analysis.sha1_hash }}</code>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">SHA256</p>
                    <code class="text-sm font-mono bg-gray-100 dark:bg-gray-800 p-2 rounded block break-all">{{ static_analysis.sha256_hash }}</code>
                </div>
            </div>
        </div>
    </div>

    <!-- Packing & Obfuscation -->
    <div class="card {% if static_analysis.is_packed %}border-yellow-500{% endif %}">
        <div class="card-header {% if static_analysis.is_packed %}bg-yellow-50 dark:bg-yellow-900/20{% endif %}">
            <h5>üì¶ Packing & Obfuscation Analysis</h5>
        </div>
        <div class="card-body">
            <div class="grid gap-4 md:grid-cols-2">
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Packing Status</p>
                    {% if static_analysis.is_packed %}
                    <span class="badge badge-warning">‚ö†Ô∏è Packing Detected</span>
                    {% else %}
                    <span class="badge badge-success">‚úì No Packing Detected</span>
                    {% endif %}
                    
                    {% if static_analysis.entropy %}
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                        <strong>Entropy:</strong> {{ static_analysis.entropy|floatformat:2 }} / 8.0
                        {% if static_analysis.entropy > 7.0 %}
                        <span class="text-yellow-600 dark:text-yellow-400">(High - suggests compression/encryption)</span>
                        {% elif static_analysis.entropy > 5.0 %}
                        <span class="text-blue-600 dark:text-blue-400">(Medium)</span>
                        {% else %}
                        <span class="text-green-600 dark:text-green-400">(Low)</span>
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
                <div>
                    {% if static_analysis.packer_detected %}
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Packer Detected</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ static_analysis.packer_detected }}</p>
                    {% endif %}
                    
                    {% if static_analysis.unpacking_suggestions %}
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 mt-3">Unpacking Suggestions</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ static_analysis.unpacking_suggestions }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ‚≠ê TEXTBOOK-LEVEL: Packer Detection ‚≠ê -->
    {% if static_analysis.pe_data.packer_detection.detected %}
    <div class="card border-orange-500">
        <div class="card-header bg-orange-50 dark:bg-orange-900/20">
            <h5 class="text-orange-900 dark:text-orange-100">üì¶ Packer/Protector Detected (PEiD-Style)</h5>
        </div>
        <div class="card-body">
            <div class="grid gap-4 md:grid-cols-2">
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Detected Packer</p>
                    <h6 class="text-xl font-bold text-orange-600 dark:text-orange-400">
                        {{ static_analysis.pe_data.packer_detection.packer_name }}
                    </h6>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        {{ static_analysis.pe_data.packer_detection.description }}
                    </p>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Detection Confidence</p>
                    <span class="badge 
                        {% if static_analysis.pe_data.packer_detection.confidence == 'High' %}badge-error
                        {% elif static_analysis.pe_data.packer_detection.confidence == 'Medium' %}badge-warning
                        {% else %}badge-info{% endif %} text-lg">
                        {{ static_analysis.pe_data.packer_detection.confidence }}
                    </span>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                        Category: {{ static_analysis.pe_data.packer_detection.category }}
                    </p>
                </div>
            </div>
            
            {% if static_analysis.pe_data.packer_detection.indicators %}
            <div class="mt-4 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded p-3">
                <p class="text-sm font-semibold text-orange-900 dark:text-orange-100 mb-2">Detection Indicators:</p>
                <ul class="list-disc list-inside text-sm text-orange-800 dark:text-orange-200 space-y-1">
                    {% for indicator in static_analysis.pe_data.packer_detection.indicators %}
                    <li>{{ indicator }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <div class="mt-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded p-3">
                <p class="text-sm text-blue-800 dark:text-blue-200">
                    üí° <strong>Unpacking Required:</strong> Packed executables hide their true code. Consider using automated unpackers or manual unpacking techniques before further analysis.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ‚≠ê TEXTBOOK-LEVEL: DOS Header ‚≠ê -->
    {% if static_analysis.pe_data.dos_header.valid %}
    <div class="card">
        <div class="card-header">
            <h5>üìã DOS Header (IMAGE_DOS_HEADER)</h5>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Legacy DOS compatibility header</p>
        </div>
        <div class="card-body">
            <div class="grid gap-3 md:grid-cols-3">
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Magic Signature</p>
                    <p class="font-mono text-sm">0x{{ static_analysis.pe_data.dos_header.e_magic|stringformat:"04X" }} (MZ)</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">PE Header Offset</p>
                    <p class="font-mono text-sm">0x{{ static_analysis.pe_data.dos_header.e_lfanew|stringformat:"08X" }}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Status</p>
                    <span class="badge badge-success text-xs">‚úì Valid</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ‚≠ê TEXTBOOK-LEVEL: COFF Header ‚≠ê -->
    {% if static_analysis.pe_data.coff_header %}
    <div class="card">
        <div class="card-header">
            <h5>üîß COFF File Header (IMAGE_FILE_HEADER)</h5>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Core PE file metadata</p>
        </div>
        <div class="card-body">
            <div class="grid gap-4 md:grid-cols-2">
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Machine Type</p>
                    <p class="text-sm">{{ static_analysis.pe_data.coff_header.machine_type }}</p>
                    <p class="text-xs font-mono text-gray-500 mt-1">0x{{ static_analysis.pe_data.coff_header.machine|stringformat:"04X" }}</p>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Compile Timestamp</p>
                    <p class="text-sm">{{ static_analysis.pe_data.coff_header.timestamp_str }}</p>
                    {% if static_analysis.pe_data.coff_header.timestamp_str == 'Invalid' %}
                    <span class="badge badge-warning text-xs mt-1">Possibly Tampered</span>
                    {% endif %}
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Number of Sections</p>
                    <p class="text-lg font-bold">{{ static_analysis.pe_data.coff_header.number_of_sections }}</p>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Characteristics</p>
                    <div class="flex flex-wrap gap-1">
                        {% for flag in static_analysis.pe_data.coff_header.characteristics_flags %}
                        <span class="badge badge-secondary text-xs">{{ flag }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ‚≠ê TEXTBOOK-LEVEL: Optional Header ‚≠ê -->
    {% if static_analysis.pe_data.optional_header %}
    <div class="card">
        <div class="card-header">
            <h5>‚öôÔ∏è Optional Header (IMAGE_OPTIONAL_HEADER)</h5>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">PE executable configuration</p>
        </div>
        <div class="card-body">
            <div class="grid gap-4 md:grid-cols-3">
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">PE Type</p>
                    <span class="badge badge-info">{{ static_analysis.pe_data.optional_header.type }}</span>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Entry Point Address</p>
                    <p class="font-mono text-sm">{{ static_analysis.pe_data.optional_header.address_of_entry_point|stringformat:"08X" }}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Image Base</p>
                    <p class="font-mono text-sm">{{ static_analysis.pe_data.optional_header.image_base|stringformat:"016X" }}</p>
                </div>
                {% if static_analysis.pe_data.optional_header.size_of_code %}
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Code Size</p>
                    <p class="text-sm">{{ static_analysis.pe_data.optional_header.size_of_code|filesizeformat }}</p>
                </div>
                {% endif %}
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Linker Version</p>
                    <p class="text-sm">{{ static_analysis.pe_data.optional_header.major_linker_version }}.{{ static_analysis.pe_data.optional_header.minor_linker_version }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ‚≠ê TEXTBOOK-LEVEL: Section Characteristics Analysis ‚≠ê -->
    {% if static_analysis.pe_data.section_analysis %}
    <div class="card">
        <div class="card-header">
            <h5>üì¶ Section Characteristics Analysis</h5>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Detailed permission and anomaly analysis</p>
        </div>
        <div class="card-body">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-800">
                        <tr>
                            <th class="px-3 py-2 text-left">Section</th>
                            <th class="px-3 py-2 text-left">Permissions</th>
                            <th class="px-3 py-2 text-left">Type</th>
                            <th class="px-3 py-2 text-left">Flags</th>
                            <th class="px-3 py-2 text-left">Warnings</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for section in static_analysis.pe_data.section_analysis %}
                        <tr class="border-t border-gray-200 dark:border-gray-700 {% if section.suspicious %}bg-red-50 dark:bg-red-900/10{% endif %}">
                            <td class="px-3 py-2 font-mono">{{ section.name }}</td>
                            <td class="px-3 py-2">
                                <span class="badge {% if section.suspicious %}badge-error{% else %}badge-secondary{% endif %}">
                                    {{ section.permissions }}
                                </span>
                            </td>
                            <td class="px-3 py-2">
                                {% if section.is_code %}<span class="badge badge-info text-xs">Code</span>{% endif %}
                                {% if section.is_data %}<span class="badge badge-secondary text-xs">Data</span>{% endif %}
                            </td>
                            <td class="px-3 py-2">
                                {% if section.is_executable %}<span class="text-xs">X</span>{% endif %}
                                {% if section.is_writable %}<span class="text-xs">W</span>{% endif %}
                                {% if section.is_readable %}<span class="text-xs">R</span>{% endif %}
                            </td>
                            <td class="px-3 py-2">
                                {% if section.warnings %}
                                <ul class="list-disc list-inside text-xs text-orange-600 dark:text-orange-400">
                                    {% for warning in section.warnings %}
                                    <li>{{ warning }}</li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <span class="text-xs text-green-600 dark:text-green-400">No issues</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ‚≠ê YARA Rule Matches ‚≠ê -->
    {% if static_analysis.yara_matches %}
    <div class="card border-red-500">
        <div class="card-header bg-red-50 dark:bg-red-900/20">
            <h5 class="text-red-900 dark:text-red-100">üéØ YARA Rule Matches - Malware Patterns Detected!</h5>
        </div>
        <div class="card-body">
            <div class="space-y-3">
                {% for match in static_analysis.yara_matches %}
                <div class="bg-red-50 dark:bg-red-900/10 border-l-4 border-red-500 p-4">
                    <div class="flex items-start justify-between mb-2">
                        <h6 class="font-bold text-red-900 dark:text-red-100">üö® Rule: {{ match.rule }}</h6>
                        <div class="flex gap-1">
                            {% for tag in match.tags %}
                            <span class="badge badge-error text-xs">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% if match.meta %}
                    <div class="text-sm text-gray-700 dark:text-gray-300">
                        {% for key, value in match.meta.items %}
                        <p><strong>{{ key }}:</strong> {{ value }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="mt-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded p-3">
                <p class="text-sm text-yellow-900 dark:text-yellow-100">
                    ‚ö†Ô∏è <strong>Note:</strong> YARA matches indicate the file contains patterns commonly found in malware. 
                    This is a strong indicator of malicious intent.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ‚≠ê PE Structure Analysis ‚≠ê -->
    {% if static_analysis.pe_data.is_pe %}
    <div class="card border-blue-500">
        <div class="card-header bg-blue-50 dark:bg-blue-900/20">
            <h5 class="text-blue-900 dark:text-blue-100">ü™ü PE (Portable Executable) Structure Analysis</h5>
        </div>
        <div class="card-body">
            <!-- PE Type & Characteristics -->
            <div class="grid gap-4 md:grid-cols-2 mb-4">
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">PE Type</p>
                    <span class="badge badge-info">{{ static_analysis.pe_data.pe_type }}</span>
                </div>
                {% if static_analysis.pe_data.characteristics %}
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Entry Point</p>
                    <code class="text-xs">{{ static_analysis.pe_data.characteristics.entry_point }}</code>
                </div>
                {% endif %}
            </div>

            <!-- PE Sections -->
            {% if static_analysis.pe_data.sections %}
            <div class="mb-4">
                <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">üì¶ Sections</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th class="px-3 py-2 text-left">Name</th>
                                <th class="px-3 py-2 text-left">Virtual Size</th>
                                <th class="px-3 py-2 text-left">Raw Size</th>
                                <th class="px-3 py-2 text-left">Entropy</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for section in static_analysis.pe_data.sections %}
                            <tr class="border-t border-gray-200 dark:border-gray-700">
                                <td class="px-3 py-2 font-mono">{{ section.name }}</td>
                                <td class="px-3 py-2">{{ section.virtual_size }}</td>
                                <td class="px-3 py-2">{{ section.raw_size }}</td>
                                <td class="px-3 py-2">
                                    <span class="{% if section.entropy > 7.0 %}text-red-600 dark:text-red-400 font-bold{% endif %}">
                                        {{ section.entropy|floatformat:2 }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Imports -->
            {% if static_analysis.pe_data.imports %}
            <div class="mb-4">
                <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">üì• Imported DLLs & Functions</p>
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    {% for import in static_analysis.pe_data.imports %}
                    <div class="bg-gray-50 dark:bg-gray-800 rounded p-2">
                        <p class="font-semibold text-sm">{{ import.dll }}</p>
                        <div class="flex flex-wrap gap-1 mt-1">
                            {% for func in import.functions %}
                            <span class="badge badge-secondary text-xs">{{ func }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Anomalies -->
            {% if static_analysis.pe_data.anomalies %}
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded p-3">
                <p class="text-sm font-semibold text-yellow-900 dark:text-yellow-100 mb-2">‚ö†Ô∏è Detected Anomalies:</p>
                <ul class="list-disc list-inside text-sm text-yellow-800 dark:text-yellow-200 space-y-1">
                    {% for anomaly in static_analysis.pe_data.anomalies %}
                    <li>{{ anomaly }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- ML Prediction Results -->
    {% if scan.scan_details.ml_prediction %}
    <div class="card {% if scan.scan_details.ml_prediction.is_malicious %}border-orange-500{% else %}border-green-500{% endif %}">
        <div class="card-header {% if scan.scan_details.ml_prediction.is_malicious %}bg-orange-50 dark:bg-orange-900/20{% else %}bg-green-50 dark:bg-green-900/20{% endif %}">
            <h5>ü§ñ Machine Learning Prediction</h5>
        </div>
        <div class="card-body">
            <div class="grid gap-4 md:grid-cols-3">
                <div class="text-center">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Prediction</p>
                    {% if scan.scan_details.ml_prediction.is_malicious %}
                    <span class="badge badge-error text-lg">‚ö†Ô∏è Malicious</span>
                    {% else %}
                    <span class="badge badge-success text-lg">‚úì Benign</span>
                    {% endif %}
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Confidence</p>
                    <p class="text-2xl font-bold">{{ scan.scan_details.ml_prediction.confidence|floatformat:1|mul:"100"|floatformat:0 }}%</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Model</p>
                    <span class="badge badge-info">{{ scan.scan_details.ml_prediction.model_used }}</span>
                </div>
            </div>
            {% if scan.scan_details.ml_prediction.explanation %}
            <div class="mt-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded p-3">
                <p class="text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2">Analysis Factors:</p>
                <ul class="list-disc list-inside text-sm text-blue-800 dark:text-blue-200">
                    {% for exp in scan.scan_details.ml_prediction.explanation %}
                    <li>{{ exp }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Strings Analysis -->
    {% if static_analysis.strings_extracted %}
    <div class="card">
        <div class="card-header">
            <h5>üìù Extracted Strings</h5>
        </div>
        <div class="card-body">
            {% if static_analysis.suspicious_strings %}
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded p-3 mb-4">
                <p class="text-sm font-semibold text-yellow-900 dark:text-yellow-100 mb-2">‚ö†Ô∏è Suspicious Strings Found:</p>
                <div class="flex flex-wrap gap-2">
                    {% for string in static_analysis.suspicious_strings %}
                    <span class="badge badge-warning text-xs">{{ string }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="bg-gray-50 dark:bg-gray-800 rounded p-4">
                <pre class="text-xs font-mono text-gray-700 dark:text-gray-300 whitespace-pre-wrap overflow-x-auto max-h-96">{{ static_analysis.strings_extracted }}</pre>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- PE Analysis -->
    {% if static_analysis.pe_data %}
    <div class="card">
        <div class="card-header">
            <h5>ü™ü PE Header Analysis</h5>
        </div>
        <div class="card-body">
            <pre class="text-xs font-mono bg-gray-50 dark:bg-gray-800 p-4 rounded overflow-x-auto">{{ static_analysis.pe_data|safe }}</pre>
        </div>
    </div>
    {% endif %}

    <!-- YARA Matches -->
    {% if static_analysis.yara_matches %}
    <div class="card border-red-500">
        <div class="card-header bg-red-50 dark:bg-red-900/20">
            <h5 class="text-red-900 dark:text-red-100">üéØ YARA Rule Matches</h5>
        </div>
        <div class="card-body">
            <ul class="space-y-2">
                {% for match in static_analysis.yara_matches %}
                <li class="text-sm text-gray-700 dark:text-gray-300">{{ match }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- ============================================ -->
    <!-- ADVANCED: ANTI-ANALYSIS DETECTION RESULTS -->
    <!-- ============================================ -->
    {% if static_analysis.pe_data and static_analysis.pe_data.anti_analysis %}
    {% with anti_analysis=static_analysis.pe_data.anti_analysis %}
    
    <!-- Evasion Score Summary -->
    <div class="card border-purple-500">
        <div class="card-header bg-gradient-to-r from-purple-600 to-indigo-600 text-white">
            <h5 class="mb-0">üõ°Ô∏è Anti-Analysis & Evasion Techniques Detection</h5>
            <p class="text-sm mt-1 opacity-90">Advanced Dynamic Analysis - Evasion Detection (Chapter 15-17)</p>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded">
                    <div class="text-3xl font-bold text-purple-600 dark:text-purple-400">{{ anti_analysis.evasion_score|default:0 }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Evasion Score</div>
                </div>
                <div class="text-center p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded">
                    <div class="text-xl font-bold text-indigo-600 dark:text-indigo-400">{{ anti_analysis.evasion_level|default:"Low"|upper }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Evasion Level</div>
                </div>
                <div class="text-center p-3 bg-red-50 dark:bg-red-900/20 rounded">
                    <div class="text-3xl font-bold text-red-600 dark:text-red-400">
                        {% if anti_analysis.anti_debug.detected %}‚úì{% else %}‚úó{% endif %}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Anti-Debug</div>
                </div>
                <div class="text-center p-3 bg-orange-50 dark:bg-orange-900/20 rounded">
                    <div class="text-3xl font-bold text-orange-600 dark:text-orange-400">
                        {% if anti_analysis.anti_vm.detected %}‚úì{% else %}‚úó{% endif %}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Anti-VM</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Anti-Debugging Detection -->
    {% if anti_analysis.anti_debug.detected %}
    <div class="card border-red-500">
        <div class="card-header bg-red-50 dark:bg-red-900/20">
            <h5 class="text-red-900 dark:text-red-100">
                üêõ Anti-Debugging Techniques ({{ anti_analysis.anti_debug.count }})
            </h5>
            <p class="text-sm mt-1">Chapter 16: Anti-Debugging - Debugger detection and evasion</p>
        </div>
        <div class="card-body">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">Technique</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">Description</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">Risk</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">Mitigation</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% for technique in anti_analysis.anti_debug.techniques %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td class="px-4 py-2 text-sm font-mono text-gray-900 dark:text-gray-100">{{ technique.technique }}</td>
                            <td class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300">{{ technique.description }}</td>
                            <td class="px-4 py-2">
                                <span class="badge {% if technique.risk == 'Critical' %}badge-danger{% elif technique.risk == 'High' %}badge-warning{% else %}badge-info{% endif %}">
                                    {{ technique.risk }}
                                </span>
                            </td>
                            <td class="px-4 py-2 text-xs text-gray-600 dark:text-gray-400">{{ technique.mitigation }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded">
                <p class="text-sm text-blue-900 dark:text-blue-100">
                    <strong>‚ö†Ô∏è Analysis Guidance:</strong> This malware uses anti-debugging techniques. 
                    Use debugger hiding plugins (ScyllaHide, TitanHide) or hardware breakpoints instead of software breakpoints.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Anti-VM Detection -->
    {% if anti_analysis.anti_vm.detected %}
    <div class="card border-orange-500">
        <div class="card-header bg-orange-50 dark:bg-orange-900/20">
            <h5 class="text-orange-900 dark:text-orange-100">
                üñ•Ô∏è Anti-VM Techniques ({{ anti_analysis.anti_vm.indicator_count }} indicators)
            </h5>
            <p class="text-sm mt-1">Chapter 17: Anti-VM - Virtual machine detection and evasion</p>
            <div class="mt-2">
                <span class="badge {% if anti_analysis.anti_vm.confidence == 'High' %}badge-danger{% elif anti_analysis.anti_vm.confidence == 'Medium' %}badge-warning{% else %}badge-info{% endif %}">
                    Confidence: {{ anti_analysis.anti_vm.confidence }}
                </span>
            </div>
        </div>
        <div class="card-body">
            <div class="space-y-3">
                {% for technique in anti_analysis.anti_vm.techniques %}
                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded border-l-4 border-orange-500">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900 dark:text-gray-100">{{ technique.type }}</div>
                            <div class="text-sm text-gray-700 dark:text-gray-300 mt-1">{{ technique.description }}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                Category: {{ technique.category }} | Artifact: <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">{{ technique.artifact }}</code>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded">
                <p class="text-sm text-blue-900 dark:text-blue-100">
                    <strong>‚ö†Ô∏è Analysis Guidance:</strong> This malware checks for VM artifacts. 
                    Use bare metal systems, hide VM indicators, or patch VM detection checks for proper analysis.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Process Injection Detection -->
    {% if anti_analysis.process_injection.detected %}
    <div class="card border-purple-500">
        <div class="card-header bg-purple-50 dark:bg-purple-900/20">
            <h5 class="text-purple-900 dark:text-purple-100">
                üíâ Process Injection Techniques ({{ anti_analysis.process_injection.count }})
            </h5>
            <p class="text-sm mt-1">Chapter 12: Covert Malware Launching - Code injection methods</p>
        </div>
        <div class="card-body">
            {% if anti_analysis.process_injection.patterns %}
            <div class="mb-4 p-4 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500">
                <h6 class="font-semibold text-red-900 dark:text-red-100 mb-2">üö® Complete Injection Patterns Detected:</h6>
                <ul class="space-y-2">
                    {% for pattern in anti_analysis.process_injection.patterns %}
                    <li>
                        <div class="font-semibold text-red-800 dark:text-red-200">{{ pattern.pattern }}</div>
                        <div class="text-sm text-red-700 dark:text-red-300">{{ pattern.description }}</div>
                        <div class="text-xs text-red-600 dark:text-red-400">APIs: {{ pattern.apis|join:", " }}</div>
                        <span class="badge badge-danger">{{ pattern.risk }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-semibold">API</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold">Method</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold">Description</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold">Risk</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold">Companions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% for technique in anti_analysis.process_injection.techniques %}
                        <tr>
                            <td class="px-4 py-2 text-sm font-mono">{{ technique.api }}</td>
                            <td class="px-4 py-2 text-sm">{{ technique.method }}</td>
                            <td class="px-4 py-2 text-sm">{{ technique.description }}</td>
                            <td class="px-4 py-2">
                                <span class="badge {% if technique.risk == 'Critical' %}badge-danger{% elif technique.risk == 'High' %}badge-warning{% else %}badge-info{% endif %}">
                                    {{ technique.risk }}
                                </span>
                            </td>
                            <td class="px-4 py-2 text-xs">{{ technique.companion_apis_found|join:", "|default:"None" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Encoding/Encryption Detection -->
    {% if anti_analysis.encoding.detected %}
    <div class="card border-green-500">
        <div class="card-header bg-green-50 dark:bg-green-900/20">
            <h5 class="text-green-900 dark:text-green-100">
                üîê Encoding & Cryptography ({{ anti_analysis.encoding.count }} algorithms)
            </h5>
            <p class="text-sm mt-1">Chapter 13: Data Encoding - Encryption and obfuscation detection</p>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for algo in anti_analysis.encoding.algorithms %}
                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900 dark:text-gray-100">{{ algo.algorithm }}</div>
                            <div class="text-sm text-gray-700 dark:text-gray-300">{{ algo.description }}</div>
                            <div class="mt-1">
                                <span class="badge badge-secondary">{{ algo.type }}</span>
                                <span class="badge {% if algo.confidence == 'High' %}badge-success{% else %}badge-info{% endif %}">
                                    {{ algo.confidence }} Confidence
                                </span>
                            </div>
                            {% if algo.api %}
                            <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">API: {{ algo.api }}</div>
                            {% endif %}
                            {% if algo.constant %}
                            <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Constant: {{ algo.constant }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if anti_analysis.encoding.high_entropy_blocks > 0 %}
            <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500">
                <h6 class="font-semibold text-yellow-900 dark:text-yellow-100">
                    ‚ö° High-Entropy Blocks: {{ anti_analysis.encoding.high_entropy_blocks }}
                </h6>
                <p class="text-sm text-yellow-800 dark:text-yellow-200 mt-1">
                    Detected {{ anti_analysis.encoding.high_entropy_blocks }} high-entropy blocks (>7.5), indicating encrypted/compressed data.
                </p>
                {% if anti_analysis.encoding.entropy_blocks %}
                <div class="mt-2 text-xs space-y-1">
                    {% for block in anti_analysis.encoding.entropy_blocks %}
                    <div class="text-yellow-700 dark:text-yellow-300">
                        Offset: {{ block.offset }} | Size: {{ block.size }} bytes | Entropy: {{ block.entropy }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Hook Detection -->
    {% if anti_analysis.hooks.detected %}
    <div class="card border-indigo-500">
        <div class="card-header bg-indigo-50 dark:bg-indigo-900/20">
            <h5 class="text-indigo-900 dark:text-indigo-100">
                ü™ù Hooking Techniques ({{ anti_analysis.hooks.count }})
            </h5>
            <p class="text-sm mt-1">Chapter 11: Malware Behavior - API hooking and interception</p>
        </div>
        <div class="card-body">
            <div class="space-y-3">
                {% for technique in anti_analysis.hooks.techniques %}
                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded border-l-4 border-indigo-500">
                    {% if technique.pattern %}
                    <div class="font-semibold text-indigo-900 dark:text-indigo-100">{{ technique.pattern }}</div>
                    <div class="text-sm text-gray-700 dark:text-gray-300">{{ technique.description }}</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">APIs: {{ technique.apis|join:", " }}</div>
                    <span class="badge badge-danger">{{ technique.risk }}</span>
                    {% else %}
                    <div class="font-semibold text-indigo-900 dark:text-indigo-100">{{ technique.api }} - {{ technique.type }}</div>
                    <div class="text-sm text-gray-700 dark:text-gray-300">{{ technique.description }}</div>
                    <span class="badge badge-warning">{{ technique.risk }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Persistence Detection -->
    {% if anti_analysis.persistence.detected %}
    <div class="card border-pink-500">
        <div class="card-header bg-pink-50 dark:bg-pink-900/20">
            <h5 class="text-pink-900 dark:text-pink-100">
                üîÑ Persistence Mechanisms ({{ anti_analysis.persistence.count }})
            </h5>
            <p class="text-sm mt-1">Chapter 11: Malware Behavior - Persistence and autostart mechanisms</p>
        </div>
        <div class="card-body">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-semibold">Method</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold">Details</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold">Risk</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold">Removal</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% for mechanism in anti_analysis.persistence.mechanisms %}
                        <tr>
                            <td class="px-4 py-2 text-sm font-semibold">{{ mechanism.method }}</td>
                            <td class="px-4 py-2 text-sm">
                                {{ mechanism.description }}
                                {% if mechanism.api %}<br><span class="text-xs font-mono">API: {{ mechanism.api }}</span>{% endif %}
                                {% if mechanism.key %}<br><span class="text-xs font-mono">Key: {{ mechanism.key }}</span>{% endif %}
                            </td>
                            <td class="px-4 py-2">
                                <span class="badge {% if mechanism.risk == 'High' %}badge-danger{% else %}badge-warning{% endif %}">
                                    {{ mechanism.risk }}
                                </span>
                            </td>
                            <td class="px-4 py-2 text-xs">{{ mechanism.removal_difficulty|default:"N/A" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Network Behavior Detection -->
    {% if anti_analysis.network_behavior.detected %}
    <div class="card border-blue-500">
        <div class="card-header bg-blue-50 dark:bg-blue-900/20">
            <h5 class="text-blue-900 dark:text-blue-100">
                üåê Network Behavior & C2 Patterns ({{ anti_analysis.network_behavior.count }} APIs)
            </h5>
            <p class="text-sm mt-1">Chapter 14: Malware-Focused Network Signatures - C2 communication detection</p>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded">
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ anti_analysis.network_behavior.urls_found }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">URLs Found</div>
                </div>
                <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded">
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ anti_analysis.network_behavior.ips_found }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">IPs Found</div>
                </div>
                <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded">
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">
                        {% if anti_analysis.network_behavior.irc_detected %}‚úì{% else %}‚úó{% endif %}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">IRC Detection</div>
                </div>
            </div>
            
            <div class="space-y-2">
                {% for api in anti_analysis.network_behavior.apis %}
                <div class="p-2 bg-gray-50 dark:bg-gray-800 rounded text-sm">
                    <span class="font-mono text-blue-600 dark:text-blue-400">{{ api.api }}</span>
                    <span class="text-gray-600 dark:text-gray-400">- {{ api.description }}</span>
                    <span class="badge badge-info ml-2">{{ api.category }}</span>
                </div>
                {% endfor %}
            </div>
            
            {% if anti_analysis.network_behavior.irc_detected %}
            <div class="mt-4 p-3 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500">
                <p class="text-sm text-red-900 dark:text-red-100">
                    <strong>üö® IRC Protocol Detected:</strong> This malware may be part of an IRC-based botnet!
                </p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% endwith %}
    {% endif %}
    <!-- END Anti-Analysis Detection -->

    <!-- Techniques Used -->
    <div class="card">
        <div class="card-header">
            <h5>üî¨ Analysis Techniques Applied</h5>
        </div>
        <div class="card-body">
            <div class="flex flex-wrap gap-2">
                {% for technique in static_analysis.techniques_used.all %}
                <span class="badge badge-primary">{{ technique.name }}</span>
                {% empty %}
                <span class="text-gray-500 dark:text-gray-400">No techniques recorded</span>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Back to Results -->
    <div class="text-center">
        <a href="{% url 'malware_analyser:scan_results' scan.scan_id %}" class="btn btn-secondary">
            ‚Üê Back to Scan Results
        </a>
    </div>
</div>
{% endblock %}
