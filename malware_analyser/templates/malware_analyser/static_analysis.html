{% extends "base.html" %}
{% load static %}

{% block title %}Advanced Static Analysis - Malware Analyser{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-primary-600 dark:hover:text-primary-400">Megido Security</a>
        <span>/</span>
        <a href="{% url 'malware_analyser:dashboard' %}" class="hover:text-primary-600 dark:hover:text-primary-400">Malware Analyser</a>
        <span>/</span>
        <a href="{% url 'malware_analyser:scan_results' scan.scan_id %}" class="hover:text-primary-600 dark:hover:text-primary-400">Scan Results</a>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Advanced Static Analysis</span>
    </nav>

    <!-- Header -->
    <div class="card bg-gradient-to-r from-purple-500 to-blue-600 text-white">
        <div class="card-body">
            <h1 class="text-3xl font-bold mb-2">‚ú® Advanced Static Analysis</h1>
            <p class="text-blue-100">File: {{ scan.file.original_filename }}</p>
            <p class="text-sm text-blue-200 mt-2">üöÄ Powered by PE Parser, YARA Engine, and ML Detection</p>
        </div>
    </div>

    <!-- Run Static Analysis -->
    {% if not static_analysis.md5_hash %}
    <div class="card border-primary-500">
        <div class="card-body text-center">
            <h5 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Ready to Perform Advanced Static Analysis</h5>
            <p class="text-gray-600 dark:text-gray-400 mb-4">
                Our <strong>extra extremely advanced</strong> static analysis includes:
                <br>‚ú® Real PE structure parsing with section analysis
                <br>üéØ YARA rule scanning for known malware patterns
                <br>ü§ñ Machine Learning-based malware prediction
                <br>üìä Advanced entropy and byte distribution analysis
                <br>üîç Import/Export table analysis
                <br>‚ö†Ô∏è Anomaly detection (suspicious characteristics)
            </p>
            <form method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary btn-lg">
                    üöÄ Run Advanced Analysis
                </button>
            </form>
        </div>
    </div>
    {% else %}

    <!-- File Hashes -->
    <div class="card">
        <div class="card-header">
            <h5>üîê File Hashes</h5>
        </div>
        <div class="card-body">
            <div class="grid gap-4 md:grid-cols-3">
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">MD5</p>
                    <code class="text-sm font-mono bg-gray-100 dark:bg-gray-800 p-2 rounded block break-all">{{ static_analysis.md5_hash }}</code>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">SHA1</p>
                    <code class="text-sm font-mono bg-gray-100 dark:bg-gray-800 p-2 rounded block break-all">{{ static_analysis.sha1_hash }}</code>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">SHA256</p>
                    <code class="text-sm font-mono bg-gray-100 dark:bg-gray-800 p-2 rounded block break-all">{{ static_analysis.sha256_hash }}</code>
                </div>
            </div>
        </div>
    </div>

    <!-- Packing & Obfuscation -->
    <div class="card {% if static_analysis.is_packed %}border-yellow-500{% endif %}">
        <div class="card-header {% if static_analysis.is_packed %}bg-yellow-50 dark:bg-yellow-900/20{% endif %}">
            <h5>üì¶ Packing & Obfuscation Analysis</h5>
        </div>
        <div class="card-body">
            <div class="grid gap-4 md:grid-cols-2">
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Packing Status</p>
                    {% if static_analysis.is_packed %}
                    <span class="badge badge-warning">‚ö†Ô∏è Packing Detected</span>
                    {% else %}
                    <span class="badge badge-success">‚úì No Packing Detected</span>
                    {% endif %}
                    
                    {% if static_analysis.entropy %}
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                        <strong>Entropy:</strong> {{ static_analysis.entropy|floatformat:2 }} / 8.0
                        {% if static_analysis.entropy > 7.0 %}
                        <span class="text-yellow-600 dark:text-yellow-400">(High - suggests compression/encryption)</span>
                        {% elif static_analysis.entropy > 5.0 %}
                        <span class="text-blue-600 dark:text-blue-400">(Medium)</span>
                        {% else %}
                        <span class="text-green-600 dark:text-green-400">(Low)</span>
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
                <div>
                    {% if static_analysis.packer_detected %}
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Packer Detected</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ static_analysis.packer_detected }}</p>
                    {% endif %}
                    
                    {% if static_analysis.unpacking_suggestions %}
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 mt-3">Unpacking Suggestions</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ static_analysis.unpacking_suggestions }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ‚≠ê YARA Rule Matches ‚≠ê -->
    {% if static_analysis.yara_matches %}
    <div class="card border-red-500">
        <div class="card-header bg-red-50 dark:bg-red-900/20">
            <h5 class="text-red-900 dark:text-red-100">üéØ YARA Rule Matches - Malware Patterns Detected!</h5>
        </div>
        <div class="card-body">
            <div class="space-y-3">
                {% for match in static_analysis.yara_matches %}
                <div class="bg-red-50 dark:bg-red-900/10 border-l-4 border-red-500 p-4">
                    <div class="flex items-start justify-between mb-2">
                        <h6 class="font-bold text-red-900 dark:text-red-100">üö® Rule: {{ match.rule }}</h6>
                        <div class="flex gap-1">
                            {% for tag in match.tags %}
                            <span class="badge badge-error text-xs">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% if match.meta %}
                    <div class="text-sm text-gray-700 dark:text-gray-300">
                        {% for key, value in match.meta.items %}
                        <p><strong>{{ key }}:</strong> {{ value }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="mt-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded p-3">
                <p class="text-sm text-yellow-900 dark:text-yellow-100">
                    ‚ö†Ô∏è <strong>Note:</strong> YARA matches indicate the file contains patterns commonly found in malware. 
                    This is a strong indicator of malicious intent.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ‚≠ê PE Structure Analysis ‚≠ê -->
    {% if static_analysis.pe_data.is_pe %}
    <div class="card border-blue-500">
        <div class="card-header bg-blue-50 dark:bg-blue-900/20">
            <h5 class="text-blue-900 dark:text-blue-100">ü™ü PE (Portable Executable) Structure Analysis</h5>
        </div>
        <div class="card-body">
            <!-- PE Type & Characteristics -->
            <div class="grid gap-4 md:grid-cols-2 mb-4">
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">PE Type</p>
                    <span class="badge badge-info">{{ static_analysis.pe_data.pe_type }}</span>
                </div>
                {% if static_analysis.pe_data.characteristics %}
                <div>
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Entry Point</p>
                    <code class="text-xs">{{ static_analysis.pe_data.characteristics.entry_point }}</code>
                </div>
                {% endif %}
            </div>

            <!-- PE Sections -->
            {% if static_analysis.pe_data.sections %}
            <div class="mb-4">
                <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">üì¶ Sections</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th class="px-3 py-2 text-left">Name</th>
                                <th class="px-3 py-2 text-left">Virtual Size</th>
                                <th class="px-3 py-2 text-left">Raw Size</th>
                                <th class="px-3 py-2 text-left">Entropy</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for section in static_analysis.pe_data.sections %}
                            <tr class="border-t border-gray-200 dark:border-gray-700">
                                <td class="px-3 py-2 font-mono">{{ section.name }}</td>
                                <td class="px-3 py-2">{{ section.virtual_size }}</td>
                                <td class="px-3 py-2">{{ section.raw_size }}</td>
                                <td class="px-3 py-2">
                                    <span class="{% if section.entropy > 7.0 %}text-red-600 dark:text-red-400 font-bold{% endif %}">
                                        {{ section.entropy|floatformat:2 }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Imports -->
            {% if static_analysis.pe_data.imports %}
            <div class="mb-4">
                <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">üì• Imported DLLs & Functions</p>
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    {% for import in static_analysis.pe_data.imports %}
                    <div class="bg-gray-50 dark:bg-gray-800 rounded p-2">
                        <p class="font-semibold text-sm">{{ import.dll }}</p>
                        <div class="flex flex-wrap gap-1 mt-1">
                            {% for func in import.functions %}
                            <span class="badge badge-secondary text-xs">{{ func }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Anomalies -->
            {% if static_analysis.pe_data.anomalies %}
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded p-3">
                <p class="text-sm font-semibold text-yellow-900 dark:text-yellow-100 mb-2">‚ö†Ô∏è Detected Anomalies:</p>
                <ul class="list-disc list-inside text-sm text-yellow-800 dark:text-yellow-200 space-y-1">
                    {% for anomaly in static_analysis.pe_data.anomalies %}
                    <li>{{ anomaly }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- ML Prediction Results -->
    {% if scan.scan_details.ml_prediction %}
    <div class="card {% if scan.scan_details.ml_prediction.is_malicious %}border-orange-500{% else %}border-green-500{% endif %}">
        <div class="card-header {% if scan.scan_details.ml_prediction.is_malicious %}bg-orange-50 dark:bg-orange-900/20{% else %}bg-green-50 dark:bg-green-900/20{% endif %}">
            <h5>ü§ñ Machine Learning Prediction</h5>
        </div>
        <div class="card-body">
            <div class="grid gap-4 md:grid-cols-3">
                <div class="text-center">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Prediction</p>
                    {% if scan.scan_details.ml_prediction.is_malicious %}
                    <span class="badge badge-error text-lg">‚ö†Ô∏è Malicious</span>
                    {% else %}
                    <span class="badge badge-success text-lg">‚úì Benign</span>
                    {% endif %}
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Confidence</p>
                    <p class="text-2xl font-bold">{{ scan.scan_details.ml_prediction.confidence|floatformat:1|mul:"100"|floatformat:0 }}%</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Model</p>
                    <span class="badge badge-info">{{ scan.scan_details.ml_prediction.model_used }}</span>
                </div>
            </div>
            {% if scan.scan_details.ml_prediction.explanation %}
            <div class="mt-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded p-3">
                <p class="text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2">Analysis Factors:</p>
                <ul class="list-disc list-inside text-sm text-blue-800 dark:text-blue-200">
                    {% for exp in scan.scan_details.ml_prediction.explanation %}
                    <li>{{ exp }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Strings Analysis -->
    {% if static_analysis.strings_extracted %}
    <div class="card">
        <div class="card-header">
            <h5>üìù Extracted Strings</h5>
        </div>
        <div class="card-body">
            {% if static_analysis.suspicious_strings %}
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded p-3 mb-4">
                <p class="text-sm font-semibold text-yellow-900 dark:text-yellow-100 mb-2">‚ö†Ô∏è Suspicious Strings Found:</p>
                <div class="flex flex-wrap gap-2">
                    {% for string in static_analysis.suspicious_strings %}
                    <span class="badge badge-warning text-xs">{{ string }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="bg-gray-50 dark:bg-gray-800 rounded p-4">
                <pre class="text-xs font-mono text-gray-700 dark:text-gray-300 whitespace-pre-wrap overflow-x-auto max-h-96">{{ static_analysis.strings_extracted }}</pre>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- PE Analysis -->
    {% if static_analysis.pe_data %}
    <div class="card">
        <div class="card-header">
            <h5>ü™ü PE Header Analysis</h5>
        </div>
        <div class="card-body">
            <pre class="text-xs font-mono bg-gray-50 dark:bg-gray-800 p-4 rounded overflow-x-auto">{{ static_analysis.pe_data|safe }}</pre>
        </div>
    </div>
    {% endif %}

    <!-- YARA Matches -->
    {% if static_analysis.yara_matches %}
    <div class="card border-red-500">
        <div class="card-header bg-red-50 dark:bg-red-900/20">
            <h5 class="text-red-900 dark:text-red-100">üéØ YARA Rule Matches</h5>
        </div>
        <div class="card-body">
            <ul class="space-y-2">
                {% for match in static_analysis.yara_matches %}
                <li class="text-sm text-gray-700 dark:text-gray-300">{{ match }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Techniques Used -->
    <div class="card">
        <div class="card-header">
            <h5>üî¨ Analysis Techniques Applied</h5>
        </div>
        <div class="card-body">
            <div class="flex flex-wrap gap-2">
                {% for technique in static_analysis.techniques_used.all %}
                <span class="badge badge-primary">{{ technique.name }}</span>
                {% empty %}
                <span class="text-gray-500 dark:text-gray-400">No techniques recorded</span>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Back to Results -->
    <div class="text-center">
        <a href="{% url 'malware_analyser:scan_results' scan.scan_id %}" class="btn btn-secondary">
            ‚Üê Back to Scan Results
        </a>
    </div>
</div>
{% endblock %}
