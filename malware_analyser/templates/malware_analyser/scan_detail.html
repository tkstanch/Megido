{% extends "base.html" %}

{% block title %}{{ title }} - Megido Security{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ title }}</h1>
    
    <div class="alert alert-info" role="alert">
        <strong>Stub Implementation:</strong> Scan results are simulated and do not reflect actual malware detection
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h4>Scan Information</h4>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Scan ID:</dt>
                <dd class="col-sm-9"><code>{{ scan.scan_id }}</code></dd>

                <dt class="col-sm-3">File Name:</dt>
                <dd class="col-sm-9">{{ scan.file_name }}</dd>

                <dt class="col-sm-3">File Size:</dt>
                <dd class="col-sm-9">{{ scan.file_size|filesizeformat }}</dd>

                <dt class="col-sm-3">MD5 Hash:</dt>
                <dd class="col-sm-9"><code>{{ scan.file_hash_md5|default:"Not calculated" }}</code></dd>

                <dt class="col-sm-3">SHA-256 Hash:</dt>
                <dd class="col-sm-9"><code>{{ scan.file_hash_sha256|default:"Not calculated" }}</code></dd>

                <dt class="col-sm-3">Scanned By:</dt>
                <dd class="col-sm-9">{{ scan.scanned_by.username }}</dd>

                <dt class="col-sm-3">Scanned At:</dt>
                <dd class="col-sm-9">{{ scan.scanned_at|date:"Y-m-d H:i:s" }}</dd>

                <dt class="col-sm-3">Status:</dt>
                <dd class="col-sm-9">
                    <span class="badge bg-{% if scan.scan_status == 'completed' %}success{% elif scan.scan_status == 'error' %}danger{% else %}warning{% endif %}">
                        {{ scan.get_scan_status_display }}
                    </span>
                </dd>
            </dl>
        </div>
    </div>

    <!-- Scan Results -->
    {% if scan.scan_status == 'completed' %}
    <div class="card mt-3">
        <div class="card-header {% if scan.threat_detected %}bg-danger text-white{% else %}bg-success text-white{% endif %}">
            <h4>Scan Results</h4>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Threat Detected:</dt>
                <dd class="col-sm-9">
                    {% if scan.threat_detected %}
                        <span class="badge bg-danger">YES</span>
                    {% else %}
                        <span class="badge bg-success">NO</span>
                    {% endif %}
                </dd>

                <dt class="col-sm-3">Threat Level:</dt>
                <dd class="col-sm-9">
                    <span class="badge bg-{% if scan.threat_level == 'critical' %}danger{% elif scan.threat_level == 'high' %}warning{% elif scan.threat_level == 'medium' %}info{% else %}secondary{% endif %}">
                        {{ scan.get_threat_level_display }}
                    </span>
                </dd>

                {% if scan.detection_name %}
                <dt class="col-sm-3">Detection Name:</dt>
                <dd class="col-sm-9">{{ scan.detection_name }}</dd>
                {% endif %}

                {% if scan.matched_signatures.exists %}
                <dt class="col-sm-3">Matched Signatures:</dt>
                <dd class="col-sm-9">
                    <ul>
                        {% for sig in scan.matched_signatures.all %}
                            <li>{{ sig.name }} ({{ sig.signature_type }})</li>
                        {% endfor %}
                    </ul>
                </dd>
                {% endif %}

                <dt class="col-sm-3">Action Taken:</dt>
                <dd class="col-sm-9">
                    <span class="badge bg-secondary">{{ scan.get_action_taken_display }}</span>
                </dd>
            </dl>

            {% if scan.scan_details %}
            <div class="alert alert-warning mt-3">
                <h6>Additional Details:</h6>
                <pre>{{ scan.scan_details|pprint }}</pre>
            </div>
            {% endif %}

            {% if scan.notes %}
            <div class="mt-3">
                <strong>Notes:</strong>
                <p>{{ scan.notes }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="card mt-3">
        <div class="card-body">
            <h5>Actions</h5>
            
            {% if scan.scan_status == 'pending' %}
                <button id="startScan" class="btn btn-primary" onclick="performScan('{{ scan.scan_id }}')">
                    Start Scan (Stub)
                </button>
            {% endif %}

            {% if scan.scan_status == 'completed' and scan.threat_detected and scan.action_taken == 'none' %}
                <button class="btn btn-warning" onclick="cleanFile('{{ scan.scan_id }}')">
                    Attempt Cleaning (Stub)
                </button>
            {% endif %}

            <a href="{% url 'malware_analyser:history' %}" class="btn btn-secondary">Back to History</a>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        <div class="mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function performScan(scanId) {
    const csrftoken = getCookie('csrftoken');
    const button = document.getElementById('startScan');
    button.disabled = true;
    button.innerHTML = 'Scanning...';
    
    fetch(`/malware_analyser/scan/${scanId}/perform/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
            button.disabled = false;
            button.innerHTML = 'Start Scan (Stub)';
        }
    })
    .catch(error => {
        alert('Error: ' + error);
        button.disabled = false;
        button.innerHTML = 'Start Scan (Stub)';
    });
}

function cleanFile(scanId) {
    if (!confirm('Attempt to clean this file? (STUB - No actual cleaning will occur)')) {
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    fetch(`/malware_analyser/scan/${scanId}/clean/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message || 'Cleaning attempted (stub)');
        window.location.reload();
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}
</script>
{% endblock %}
