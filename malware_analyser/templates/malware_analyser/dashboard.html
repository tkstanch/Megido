{% extends "base.html" %}
{% load static %}

{% block title %}Malware Analyser - Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="hover:text-primary-600 dark:hover:text-primary-400">Megido Security</a>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Malware Analyser</span>
        <span>/</span>
        <span class="text-gray-900 dark:text-white font-medium">Dashboard</span>
    </nav>

    <!-- Hero Section -->
    <div class="card bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-600 text-white">
        <div class="card-body text-center">
            <h1 class="text-4xl font-bold mb-2">‚ú® Extra Extremely Advanced Malware Analyser ‚ú®</h1>
            <p class="text-blue-100 text-lg">State-of-the-art malware detection with PE parsing, YARA scanning, and ML prediction</p>
            <div class="mt-4 flex justify-center space-x-4 text-sm">
                <div class="bg-white/20 rounded-lg px-4 py-2">
                    <span class="font-bold">üî¨</span> Multi-Engine Detection
                </div>
                <div class="bg-white/20 rounded-lg px-4 py-2">
                    <span class="font-bold">ü§ñ</span> AI-Powered Analysis
                </div>
                <div class="bg-white/20 rounded-lg px-4 py-2">
                    <span class="font-bold">üéØ</span> YARA Rule Engine
                </div>
            </div>
        </div>
    </div>
    
    <!-- Safety Warning Banner -->
    <div class="alert alert-danger">
        <h5 class="font-bold text-lg mb-2">‚ö†Ô∏è CRITICAL SAFETY AND LEGAL WARNINGS ‚ö†Ô∏è</h5>
        <p class="mb-2">
            <strong>EDUCATIONAL USE ONLY:</strong> This malware analyzer integrates with ClamAV for REAL malware detection.
            This is for educational and demonstration purposes only.
        </p>
        <ul class="list-disc list-inside space-y-1">
            <li><strong>NEVER</strong> use for production malware analysis or with real malicious files outside secure sandboxes</li>
            <li><strong>ALWAYS</strong> use in isolated, controlled, authorized testing environments only</li>
            <li><strong>LEGAL:</strong> Ensure compliance with all applicable laws and regulations</li>
            <li><strong>NO LIABILITY:</strong> Users are solely responsible for their use of this tool</li>
        </ul>
    </div>
    
    <!-- Statistics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="card bg-gradient-to-br from-primary-500 to-primary-600 text-white">
            <div class="card-body text-center">
                <div class="text-3xl mb-2">üì§</div>
                <div class="text-sm opacity-90">Total Uploads</div>
                <div class="text-2xl font-bold">{{ total_uploads }}</div>
            </div>
        </div>
        <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white">
            <div class="card-body text-center">
                <div class="text-3xl mb-2">üîç</div>
                <div class="text-sm opacity-90">Total Scans</div>
                <div class="text-2xl font-bold">{{ total_scans }}</div>
            </div>
        </div>
        <div class="card bg-gradient-to-br from-green-500 to-green-600 text-white">
            <div class="card-body text-center">
                <div class="text-3xl mb-2">‚úÖ</div>
                <div class="text-sm opacity-90">Clean Files</div>
                <div class="text-2xl font-bold">{{ clean_files }}</div>
            </div>
        </div>
        <div class="card bg-gradient-to-br from-red-500 to-red-600 text-white">
            <div class="card-body text-center">
                <div class="text-3xl mb-2">‚ö†Ô∏è</div>
                <div class="text-sm opacity-90">Infected Files</div>
                <div class="text-2xl font-bold">{{ infected_files }}</div>
            </div>
        </div>
    </div>

    <!-- ‚≠ê ADVANCED ANALYTICS ‚≠ê -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card border-purple-500">
            <div class="card-body text-center">
                <div class="text-2xl mb-2">üéØ</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">YARA Detections</div>
                <div class="text-xl font-bold text-purple-600 dark:text-purple-400">{{ yara_detections }}</div>
            </div>
        </div>
        <div class="card border-orange-500">
            <div class="card-body text-center">
                <div class="text-2xl mb-2">ü§ñ</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">ML Predictions</div>
                <div class="text-xl font-bold text-orange-600 dark:text-orange-400">{{ ml_detections }}</div>
            </div>
        </div>
        <div class="card border-blue-500">
            <div class="card-body text-center">
                <div class="text-2xl mb-2">ü™ü</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">PE Files Analyzed</div>
                <div class="text-xl font-bold text-blue-600 dark:text-blue-400">{{ pe_analyzed }}</div>
            </div>
        </div>
        <div class="card border-green-500">
            <div class="card-body text-center">
                <div class="text-2xl mb-2">üìä</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Detection Rate</div>
                <div class="text-xl font-bold text-green-600 dark:text-green-400">{{ detection_rate|floatformat:1 }}%</div>
            </div>
        </div>
    </div>

    <!-- Threat Level Distribution -->
    {% if threat_distribution %}
    <div class="card">
        <div class="card-header">
            <h5>üìà Threat Level Distribution</h5>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="text-center p-3 bg-red-50 dark:bg-red-900/20 rounded">
                    <div class="text-2xl font-bold text-red-600 dark:text-red-400">{{ threat_distribution.critical }}</div>
                    <div class="text-xs text-red-800 dark:text-red-200">Critical</div>
                </div>
                <div class="text-center p-3 bg-orange-50 dark:bg-orange-900/20 rounded">
                    <div class="text-2xl font-bold text-orange-600 dark:text-orange-400">{{ threat_distribution.high }}</div>
                    <div class="text-xs text-orange-800 dark:text-orange-200">High</div>
                </div>
                <div class="text-center p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded">
                    <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ threat_distribution.medium }}</div>
                    <div class="text-xs text-yellow-800 dark:text-yellow-200">Medium</div>
                </div>
                <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded">
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ threat_distribution.low }}</div>
                    <div class="text-xs text-blue-800 dark:text-blue-200">Low</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Detections with Methods -->
    {% if recent_detections %}
    <div class="card border-red-500">
        <div class="card-header bg-red-50 dark:bg-red-900/20">
            <h5 class="text-red-900 dark:text-red-100">üö® Recent Malware Detections</h5>
        </div>
        <div class="card-body">
            <div class="space-y-3">
                {% for detection in recent_detections %}
                <div class="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/10 rounded border-l-4 border-red-500">
                    <div>
                        <p class="font-semibold text-gray-900 dark:text-white">{{ detection.scan.file.original_filename }}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            <span class="font-mono text-xs">{{ detection.scan.detected_malware|truncatechars:50 }}</span>
                        </p>
                    </div>
                    <div class="text-right">
                        <span class="badge badge-error">{{ detection.methods }}</span>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ detection.scan.started_at|date:"M d, H:i" }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <h5>Quick Actions</h5>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <a href="{% url 'malware_analyser:upload_file' %}" class="btn btn-primary">
                    üì§ Upload & Scan
                </a>
                <a href="{% url 'malware_analyser:analysis_goals' %}" class="btn btn-secondary">
                    üéØ Analysis Goals
                </a>
                <a href="{% url 'malware_analyser:analysis_techniques' %}" class="btn btn-secondary">
                    üî¨ Techniques Guide
                </a>
                <a href="{% url 'malware_analyser:best_practices' %}" class="btn bg-orange-500 hover:bg-orange-600 text-white">
                    üõ°Ô∏è Best Practices
                </a>
                {% if user.is_staff %}
                <a href="{% url 'malware_analyser:manage_signatures' %}" class="btn btn-secondary">
                    üìÑ Signatures
                </a>
                <a href="{% url 'malware_analyser:create_test_malware' %}" class="btn bg-yellow-500 hover:bg-yellow-600 text-white">
                    ‚ö†Ô∏è Test Artifacts
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Recent Uploads and Scans -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Uploads -->
        <div class="card">
            <div class="card-header">
                <h5>Recent Uploads</h5>
            </div>
            <div class="card-body">
                {% if recent_uploads %}
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Filename</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Uploaded</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                            {% for upload in recent_uploads %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">{{ upload.original_filename|truncatechars:30 }}</td>
                                <td class="px-4 py-3 text-sm">
                                    {% if upload.scan_status == 'clean' %}
                                    <span class="badge badge-success">{{ upload.scan_status }}</span>
                                    {% elif upload.scan_status == 'infected' %}
                                    <span class="badge badge-danger">{{ upload.scan_status }}</span>
                                    {% else %}
                                    <span class="badge badge-warning">{{ upload.scan_status }}</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">{{ upload.uploaded_at|timesince }} ago</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-500 dark:text-gray-400">No uploads yet.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Scans -->
        <div class="card">
            <div class="card-header">
                <h5>Recent Scans</h5>
            </div>
            <div class="card-body">
                {% if recent_scans %}
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">File</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Result</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                            {% for scan in recent_scans %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">{{ scan.file.original_filename|truncatechars:25 }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">{{ scan.get_scan_type_display }}</td>
                                <td class="px-4 py-3 text-sm">
                                    {% if scan.is_malicious %}
                                    <span class="badge badge-danger">Malicious</span>
                                    {% else %}
                                    <span class="badge badge-success">Clean</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <a href="{% url 'malware_analyser:scan_results' scan.scan_id %}" class="btn btn-primary btn-sm">View</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-500 dark:text-gray-400">No scans yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
