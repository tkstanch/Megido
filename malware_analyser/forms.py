"""
MALWARE ANALYSER FORMS

Forms for file upload, malware signature management, and test artifact creation.
"""

from django import forms
from .models import FileUpload, MalwareSignature, TestMalwareArtifact


class FileUploadForm(forms.ModelForm):
    """
    Form for uploading files for malware scanning.
    ACCEPTS ALL FILE TYPES as per requirements.
    """
    class Meta:
        model = FileUpload
        fields = ['file']
        widgets = {
            'file': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': '*/*',  # Accept all file types
            })
        }
        help_texts = {
            'file': 'All file types accepted for scanning.'
        }


class MalwareSignatureForm(forms.ModelForm):
    """Form for creating/editing malware signatures."""
    class Meta:
        model = MalwareSignature
        fields = ['name', 'signature_type', 'signature_data', 'severity', 'description', 'malware_family', 'is_active']
        widgets = {
            'name': forms.TextInput(attrs={'class': 'form-control'}),
            'signature_type': forms.Select(attrs={'class': 'form-control'}),
            'signature_data': forms.Textarea(attrs={'class': 'form-control', 'rows': 4}),
            'severity': forms.Select(attrs={'class': 'form-control'}),
            'description': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
            'malware_family': forms.TextInput(attrs={'class': 'form-control'}),
            'is_active': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }


class TestMalwareCreationForm(forms.ModelForm):
    """
    Form for creating test malware artifacts.
    
    ⚠️  RESTRICTED TO STAFF/SUPERUSERS ONLY ⚠️
    
    This form includes explicit warnings about legal and ethical requirements.
    Only creates benign test files - NO ACTUAL MALWARE.
    """
    
    # Add confirmation checkbox
    confirmation = forms.BooleanField(
        required=True,
        label='I confirm that:',
        help_text=(
            'I have proper authorization to create test artifacts, '
            'I will only use them in authorized testing environments, '
            'and I understand the legal and ethical implications.'
        ),
        widget=forms.CheckboxInput(attrs={'class': 'form-check-input'})
    )
    
    class Meta:
        model = TestMalwareArtifact
        fields = ['name', 'artifact_type', 'description', 'purpose', 'authorization_reference']
        widgets = {
            'name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'e.g., EICAR Test File'
            }),
            'artifact_type': forms.Select(attrs={'class': 'form-control'}),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': 'Describe the test artifact and its characteristics'
            }),
            'purpose': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 3,
                'placeholder': 'Document the specific testing purpose and justification'
            }),
            'authorization_reference': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'e.g., Ticket #12345 or Approval from Security Team'
            }),
        }
    
    def clean(self):
        cleaned_data = super().clean()
        
        # Ensure confirmation is checked
        if not cleaned_data.get('confirmation'):
            raise forms.ValidationError(
                'You must confirm that you have proper authorization and understand the requirements.'
            )
        
        # Ensure purpose is documented
        if not cleaned_data.get('purpose'):
            raise forms.ValidationError(
                'Purpose must be documented for audit purposes.'
            )
        
        return cleaned_data
