"""
MALWARE ANALYSER ADMIN INTERFACE
"""

from django.contrib import admin
from .models import (
    MalwareSignature, FileUpload, ScanResult, 
    CleaningLog, TestMalwareArtifact, AuditLog
)


@admin.register(MalwareSignature)
class MalwareSignatureAdmin(admin.ModelAdmin):
    """Admin interface for malware signatures."""
    list_display = ['name', 'signature_type', 'severity', 'malware_family', 'is_active', 'created_at']
    list_filter = ['signature_type', 'severity', 'is_active', 'created_at']
    search_fields = ['name', 'malware_family', 'description']
    readonly_fields = ['created_at', 'created_by']
    fieldsets = (
        ('Signature Information', {
            'fields': ('name', 'signature_type', 'signature_data', 'severity')
        }),
        ('Details', {
            'fields': ('description', 'malware_family', 'is_active')
        }),
        ('Metadata', {
            'fields': ('created_at', 'created_by'),
            'classes': ('collapse',)
        }),
    )


@admin.register(FileUpload)
class FileUploadAdmin(admin.ModelAdmin):
    """Admin interface for uploaded files."""
    list_display = ['original_filename', 'uploaded_by', 'file_size', 'scan_status', 'uploaded_at']
    list_filter = ['scan_status', 'is_scanned', 'uploaded_at']
    search_fields = ['original_filename', 'file_hash_sha256', 'uploaded_by__username']
    readonly_fields = ['file_id', 'file_hash_md5', 'file_hash_sha256', 'uploaded_at']
    fieldsets = (
        ('File Information', {
            'fields': ('file_id', 'original_filename', 'file', 'file_size', 'mime_type')
        }),
        ('Hashes', {
            'fields': ('file_hash_md5', 'file_hash_sha256')
        }),
        ('Scan Status', {
            'fields': ('is_scanned', 'scan_status')
        }),
        ('Metadata', {
            'fields': ('uploaded_by', 'uploaded_at'),
            'classes': ('collapse',)
        }),
    )


@admin.register(ScanResult)
class ScanResultAdmin(admin.ModelAdmin):
    """Admin interface for scan results."""
    list_display = ['scan_id', 'file', 'scan_type', 'is_malicious', 'threat_level', 'started_at', 'completed_at']
    list_filter = ['scan_type', 'is_malicious', 'threat_level', 'started_at']
    search_fields = ['scan_id', 'file__original_filename', 'detected_malware']
    readonly_fields = ['scan_id', 'started_at']
    filter_horizontal = ['matched_signatures']
    fieldsets = (
        ('Scan Information', {
            'fields': ('scan_id', 'file', 'scan_type', 'performed_by')
        }),
        ('Results', {
            'fields': ('is_malicious', 'threat_level', 'detected_malware', 'matched_signatures')
        }),
        ('Details', {
            'fields': ('scan_details',),
            'classes': ('collapse',)
        }),
        ('Timing', {
            'fields': ('started_at', 'completed_at'),
            'classes': ('collapse',)
        }),
    )


@admin.register(CleaningLog)
class CleaningLogAdmin(admin.ModelAdmin):
    """Admin interface for cleaning logs."""
    list_display = ['cleaning_id', 'file', 'cleaning_action', 'success', 'performed_by', 'performed_at']
    list_filter = ['cleaning_action', 'success', 'performed_at']
    search_fields = ['cleaning_id', 'file__original_filename', 'action_details']
    readonly_fields = ['cleaning_id', 'performed_at']
    fieldsets = (
        ('Cleaning Information', {
            'fields': ('cleaning_id', 'scan_result', 'file', 'cleaning_action')
        }),
        ('Results', {
            'fields': ('success', 'action_details', 'backup_location')
        }),
        ('Metadata', {
            'fields': ('performed_by', 'performed_at'),
            'classes': ('collapse',)
        }),
    )


@admin.register(TestMalwareArtifact)
class TestMalwareArtifactAdmin(admin.ModelAdmin):
    """
    Admin interface for test malware artifacts.
    ⚠️  RESTRICTED ACCESS - Staff/Superuser only
    """
    list_display = ['name', 'artifact_type', 'created_by', 'created_at', 'is_active', 'destroyed_at']
    list_filter = ['artifact_type', 'is_active', 'created_at']
    search_fields = ['name', 'description', 'purpose', 'authorization_reference']
    readonly_fields = ['artifact_id', 'created_at']
    fieldsets = (
        ('⚠️ WARNING - TEST ARTIFACTS ONLY', {
            'fields': ('artifact_id', 'name', 'artifact_type'),
            'description': 'These are benign test artifacts only. No actual malware is created.'
        }),
        ('Description', {
            'fields': ('description', 'purpose', 'authorization_reference')
        }),
        ('Content', {
            'fields': ('file_content', 'file_path'),
            'classes': ('collapse',)
        }),
        ('Status', {
            'fields': ('is_active', 'destroyed_at')
        }),
        ('Metadata', {
            'fields': ('created_by', 'created_at'),
            'classes': ('collapse',)
        }),
    )
    
    def has_add_permission(self, request):
        """Only staff/superusers can create test artifacts."""
        return request.user.is_staff or request.user.is_superuser
    
    def has_change_permission(self, request, obj=None):
        """Only staff/superusers can edit test artifacts."""
        return request.user.is_staff or request.user.is_superuser
    
    def has_delete_permission(self, request, obj=None):
        """Only staff/superusers can delete test artifacts."""
        return request.user.is_staff or request.user.is_superuser


@admin.register(AuditLog)
class AuditLogAdmin(admin.ModelAdmin):
    """Admin interface for audit logs."""
    list_display = ['timestamp', 'user', 'action', 'resource_type', 'resource_id', 'success']
    list_filter = ['action', 'resource_type', 'success', 'timestamp']
    search_fields = ['user__username', 'action', 'resource_type', 'resource_id', 'ip_address']
    readonly_fields = ['log_id', 'timestamp', 'user', 'action', 'resource_type', 'resource_id', 
                       'ip_address', 'user_agent', 'details', 'success', 'error_message']
    fieldsets = (
        ('Log Information', {
            'fields': ('log_id', 'timestamp', 'user', 'action')
        }),
        ('Resource', {
            'fields': ('resource_type', 'resource_id')
        }),
        ('Request Details', {
            'fields': ('ip_address', 'user_agent'),
            'classes': ('collapse',)
        }),
        ('Result', {
            'fields': ('success', 'error_message', 'details'),
            'classes': ('collapse',)
        }),
    )
    
    def has_add_permission(self, request):
        """Audit logs are created automatically, not manually."""
        return False
    
    def has_delete_permission(self, request, obj=None):
        """Audit logs should not be deleted (for compliance)."""
        return False

