"""
Django Admin configuration for Malware Analyser app.

SECURITY WARNING:
- Admin access should be restricted to trusted staff only
- All actions are logged for audit trail
- Test sample generation requires superuser access
"""

from django.contrib import admin
from django.utils.html import format_html
from .models import ScanRecord, MalwareSignature, ActivityLog, TestMalwareSample


@admin.register(MalwareSignature)
class MalwareSignatureAdmin(admin.ModelAdmin):
    """Admin interface for malware signatures."""
    list_display = ['name', 'signature_type', 'severity', 'is_active', 'created_by', 'created_at']
    list_filter = ['signature_type', 'severity', 'is_active', 'created_at']
    search_fields = ['name', 'signature_value', 'description']
    readonly_fields = ['signature_id', 'created_at', 'updated_at']
    
    fieldsets = (
        ('Signature Information', {
            'fields': ('signature_id', 'name', 'signature_type', 'signature_value', 'description')
        }),
        ('Classification', {
            'fields': ('severity', 'is_active')
        }),
        ('Metadata', {
            'fields': ('created_by', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    def get_readonly_fields(self, request, obj=None):
        """Make created_by readonly after creation."""
        if obj:  # Editing existing object
            return self.readonly_fields + ('created_by',)
        return self.readonly_fields
    
    def save_model(self, request, obj, form, change):
        """Automatically set created_by to current user."""
        if not change:  # Only on creation
            obj.created_by = request.user
        super().save_model(request, obj, form, change)


@admin.register(ScanRecord)
class ScanRecordAdmin(admin.ModelAdmin):
    """Admin interface for scan records."""
    list_display = ['scan_id', 'file_name', 'scanned_by', 'threat_detected', 'threat_level', 
                    'scan_status', 'scanned_at', 'action_taken']
    list_filter = ['threat_detected', 'threat_level', 'scan_status', 'action_taken', 'scanned_at']
    search_fields = ['file_name', 'file_hash_md5', 'file_hash_sha256', 'detection_name']
    readonly_fields = ['scan_id', 'file_hash_md5', 'file_hash_sha256', 'scanned_at', 'scan_completed_at']
    
    fieldsets = (
        ('Scan Identification', {
            'fields': ('scan_id', 'file_name', 'file_size', 'file')
        }),
        ('File Hashes', {
            'fields': ('file_hash_md5', 'file_hash_sha256'),
            'classes': ('collapse',)
        }),
        ('Scan Status', {
            'fields': ('scan_status', 'scanned_by', 'scanned_at', 'scan_completed_at')
        }),
        ('Detection Results', {
            'fields': ('threat_detected', 'threat_level', 'detection_name', 'matched_signatures')
        }),
        ('Actions & Notes', {
            'fields': ('action_taken', 'notes', 'scan_details')
        }),
    )
    
    def get_readonly_fields(self, request, obj=None):
        """Make scan metadata readonly."""
        if obj:  # Editing existing object
            return self.readonly_fields + ('scanned_by', 'file_name', 'file_size')
        return self.readonly_fields
    
    def has_add_permission(self, request):
        """Prevent manual creation through admin (use upload view instead)."""
        return False


@admin.register(ActivityLog)
class ActivityLogAdmin(admin.ModelAdmin):
    """Admin interface for activity logs."""
    list_display = ['log_id', 'user', 'activity_type', 'success', 'timestamp', 'ip_address']
    list_filter = ['activity_type', 'success', 'timestamp']
    search_fields = ['user__username', 'description', 'ip_address']
    readonly_fields = ['log_id', 'user', 'activity_type', 'description', 'related_scan', 
                       'related_signature', 'ip_address', 'user_agent', 'timestamp', 
                       'success', 'error_message']
    
    def has_add_permission(self, request):
        """Prevent manual creation (logs are auto-generated)."""
        return False
    
    def has_change_permission(self, request, obj=None):
        """Prevent modification of audit logs."""
        return False
    
    def has_delete_permission(self, request, obj=None):
        """Only superusers can delete logs."""
        return request.user.is_superuser


@admin.register(TestMalwareSample)
class TestMalwareSampleAdmin(admin.ModelAdmin):
    """
    Admin interface for test malware samples.
    
    SECURITY: Only staff can view, only superusers can add/modify.
    """
    list_display = ['name', 'sample_type', 'created_by', 'created_at', 'is_active', 
                    'times_used', 'last_used']
    list_filter = ['sample_type', 'is_active', 'created_at']
    search_fields = ['name', 'description', 'expected_detection']
    readonly_fields = ['sample_id', 'created_at', 'times_used', 'last_used']
    
    fieldsets = (
        ('WARNING', {
            'fields': (),
            'description': '<div style="background-color: #ff6b6b; color: white; padding: 15px; '
                'border-radius: 5px; margin-bottom: 10px;">'
                '<strong>CRITICAL SECURITY WARNING</strong><br>'
                'Only create SAFE, NON-FUNCTIONAL test samples.<br>'
                'NEVER add real malware code.<br>'
                'All samples must be clearly marked as test data.'
                '</div>'
        }),
        ('Sample Information', {
            'fields': ('sample_id', 'name', 'sample_type', 'description', 'expected_detection')
        }),
        ('Test Content (SAFE ONLY)', {
            'fields': ('test_content', 'file_extension'),
            'description': 'Only enter safe, non-functional test data'
        }),
        ('Status', {
            'fields': ('is_active', 'created_by', 'created_at')
        }),
        ('Usage Statistics', {
            'fields': ('times_used', 'last_used'),
            'classes': ('collapse',)
        }),
    )
    
    def get_readonly_fields(self, request, obj=None):
        """Make created_by readonly after creation."""
        if obj:
            return self.readonly_fields + ('created_by',)
        return self.readonly_fields
    
    def save_model(self, request, obj, form, change):
        """Automatically set created_by to current user."""
        if not change:
            obj.created_by = request.user
        super().save_model(request, obj, form, change)
    
    def has_add_permission(self, request):
        """Only superusers can add test samples."""
        return request.user.is_superuser
    
    def has_change_permission(self, request, obj=None):
        """Only superusers can modify test samples."""
        return request.user.is_superuser
    
    def has_delete_permission(self, request, obj=None):
        """Only superusers can delete test samples."""
        return request.user.is_superuser
