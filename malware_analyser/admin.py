"""
MALWARE ANALYSER ADMIN INTERFACE
"""

from django.contrib import admin
from .models import (
    MalwareSignature, FileUpload, ScanResult, 
    CleaningLog, TestMalwareArtifact, AuditLog,
    AnalysisGoal, AnalysisTechnique, MalwareType, BestPractice,
    StaticAnalysisResult, DynamicAnalysisResult, AnalysisReport
)


@admin.register(MalwareSignature)
class MalwareSignatureAdmin(admin.ModelAdmin):
    """Admin interface for malware signatures."""
    list_display = ['name', 'signature_type', 'severity', 'malware_family', 'is_active', 'created_at']
    list_filter = ['signature_type', 'severity', 'is_active', 'created_at']
    search_fields = ['name', 'malware_family', 'description']
    readonly_fields = ['created_at', 'created_by']
    fieldsets = (
        ('Signature Information', {
            'fields': ('name', 'signature_type', 'signature_data', 'severity')
        }),
        ('Details', {
            'fields': ('description', 'malware_family', 'is_active')
        }),
        ('Metadata', {
            'fields': ('created_at', 'created_by'),
            'classes': ('collapse',)
        }),
    )


@admin.register(FileUpload)
class FileUploadAdmin(admin.ModelAdmin):
    """Admin interface for uploaded files."""
    list_display = ['original_filename', 'uploaded_by', 'file_size', 'scan_status', 'uploaded_at']
    list_filter = ['scan_status', 'is_scanned', 'uploaded_at']
    search_fields = ['original_filename', 'file_hash_sha256', 'uploaded_by__username']
    readonly_fields = ['file_id', 'file_hash_md5', 'file_hash_sha256', 'uploaded_at']
    fieldsets = (
        ('File Information', {
            'fields': ('file_id', 'original_filename', 'file', 'file_size', 'mime_type')
        }),
        ('Hashes', {
            'fields': ('file_hash_md5', 'file_hash_sha256')
        }),
        ('Scan Status', {
            'fields': ('is_scanned', 'scan_status')
        }),
        ('Metadata', {
            'fields': ('uploaded_by', 'uploaded_at'),
            'classes': ('collapse',)
        }),
    )


@admin.register(ScanResult)
class ScanResultAdmin(admin.ModelAdmin):
    """Admin interface for scan results."""
    list_display = ['scan_id', 'file', 'scan_type', 'is_malicious', 'threat_level', 'started_at', 'completed_at']
    list_filter = ['scan_type', 'is_malicious', 'threat_level', 'started_at']
    search_fields = ['scan_id', 'file__original_filename', 'detected_malware']
    readonly_fields = ['scan_id', 'started_at']
    filter_horizontal = ['matched_signatures']
    fieldsets = (
        ('Scan Information', {
            'fields': ('scan_id', 'file', 'scan_type', 'performed_by')
        }),
        ('Results', {
            'fields': ('is_malicious', 'threat_level', 'detected_malware', 'matched_signatures')
        }),
        ('Details', {
            'fields': ('scan_details',),
            'classes': ('collapse',)
        }),
        ('Timing', {
            'fields': ('started_at', 'completed_at'),
            'classes': ('collapse',)
        }),
    )


@admin.register(CleaningLog)
class CleaningLogAdmin(admin.ModelAdmin):
    """Admin interface for cleaning logs."""
    list_display = ['cleaning_id', 'file', 'cleaning_action', 'success', 'performed_by', 'performed_at']
    list_filter = ['cleaning_action', 'success', 'performed_at']
    search_fields = ['cleaning_id', 'file__original_filename', 'action_details']
    readonly_fields = ['cleaning_id', 'performed_at']
    fieldsets = (
        ('Cleaning Information', {
            'fields': ('cleaning_id', 'scan_result', 'file', 'cleaning_action')
        }),
        ('Results', {
            'fields': ('success', 'action_details', 'backup_location')
        }),
        ('Metadata', {
            'fields': ('performed_by', 'performed_at'),
            'classes': ('collapse',)
        }),
    )


@admin.register(TestMalwareArtifact)
class TestMalwareArtifactAdmin(admin.ModelAdmin):
    """
    Admin interface for test malware artifacts.
    ⚠️  RESTRICTED ACCESS - Staff/Superuser only
    """
    list_display = ['name', 'artifact_type', 'created_by', 'created_at', 'is_active', 'destroyed_at']
    list_filter = ['artifact_type', 'is_active', 'created_at']
    search_fields = ['name', 'description', 'purpose', 'authorization_reference']
    readonly_fields = ['artifact_id', 'created_at']
    fieldsets = (
        ('⚠️ WARNING - TEST ARTIFACTS ONLY', {
            'fields': ('artifact_id', 'name', 'artifact_type'),
            'description': 'These are benign test artifacts only. No actual malware is created.'
        }),
        ('Description', {
            'fields': ('description', 'purpose', 'authorization_reference')
        }),
        ('Content', {
            'fields': ('file_content', 'file_path'),
            'classes': ('collapse',)
        }),
        ('Status', {
            'fields': ('is_active', 'destroyed_at')
        }),
        ('Metadata', {
            'fields': ('created_by', 'created_at'),
            'classes': ('collapse',)
        }),
    )
    
    def has_add_permission(self, request):
        """Only staff/superusers can create test artifacts."""
        return request.user.is_staff or request.user.is_superuser
    
    def has_change_permission(self, request, obj=None):
        """Only staff/superusers can edit test artifacts."""
        return request.user.is_staff or request.user.is_superuser
    
    def has_delete_permission(self, request, obj=None):
        """Only staff/superusers can delete test artifacts."""
        return request.user.is_staff or request.user.is_superuser


@admin.register(AuditLog)
class AuditLogAdmin(admin.ModelAdmin):
    """Admin interface for audit logs."""
    list_display = ['timestamp', 'user', 'action', 'resource_type', 'resource_id', 'success']
    list_filter = ['action', 'resource_type', 'success', 'timestamp']
    search_fields = ['user__username', 'action', 'resource_type', 'resource_id', 'ip_address']
    readonly_fields = ['log_id', 'timestamp', 'user', 'action', 'resource_type', 'resource_id', 
                       'ip_address', 'user_agent', 'details', 'success', 'error_message']
    fieldsets = (
        ('Log Information', {
            'fields': ('log_id', 'timestamp', 'user', 'action')
        }),
        ('Resource', {
            'fields': ('resource_type', 'resource_id')
        }),
        ('Request Details', {
            'fields': ('ip_address', 'user_agent'),
            'classes': ('collapse',)
        }),
        ('Result', {
            'fields': ('success', 'error_message', 'details'),
            'classes': ('collapse',)
        }),
    )
    
    def has_add_permission(self, request):
        """Audit logs are created automatically, not manually."""
        return False
    
    def has_delete_permission(self, request, obj=None):
        """Audit logs should not be deleted (for compliance)."""
        return False


@admin.register(AnalysisGoal)
class AnalysisGoalAdmin(admin.ModelAdmin):
    """Admin interface for analysis goals."""
    list_display = ['name', 'goal_type', 'priority', 'is_default', 'created_at']
    list_filter = ['goal_type', 'priority', 'is_default']
    search_fields = ['name', 'description']
    readonly_fields = ['goal_id', 'created_at']
    fieldsets = (
        ('Goal Information', {
            'fields': ('goal_id', 'name', 'goal_type', 'priority')
        }),
        ('Description', {
            'fields': ('description',)
        }),
        ('Settings', {
            'fields': ('is_default',)
        }),
        ('Metadata', {
            'fields': ('created_by', 'created_at'),
            'classes': ('collapse',)
        }),
    )


@admin.register(AnalysisTechnique)
class AnalysisTechniqueAdmin(admin.ModelAdmin):
    """Admin interface for analysis techniques."""
    list_display = ['name', 'category', 'is_active', 'created_at']
    list_filter = ['category', 'is_active']
    search_fields = ['name', 'description']
    readonly_fields = ['technique_id', 'created_at']
    fieldsets = (
        ('Technique Information', {
            'fields': ('technique_id', 'name', 'category')
        }),
        ('Description', {
            'fields': ('description', 'guidance')
        }),
        ('Tools & Documentation', {
            'fields': ('tools_required', 'documentation_url')
        }),
        ('Settings', {
            'fields': ('is_active',)
        }),
        ('Metadata', {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )


@admin.register(MalwareType)
class MalwareTypeAdmin(admin.ModelAdmin):
    """Admin interface for malware types."""
    list_display = ['name', 'category', 'is_active', 'created_at']
    list_filter = ['category', 'is_active']
    search_fields = ['name', 'description']
    readonly_fields = ['type_id', 'created_at']
    fieldsets = (
        ('Type Information', {
            'fields': ('type_id', 'name', 'category')
        }),
        ('Description', {
            'fields': ('description',)
        }),
        ('Classification Data', {
            'fields': ('characteristics', 'detection_patterns')
        }),
        ('Settings', {
            'fields': ('is_active',)
        }),
        ('Metadata', {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )


@admin.register(BestPractice)
class BestPracticeAdmin(admin.ModelAdmin):
    """Admin interface for best practices."""
    list_display = ['title', 'category', 'severity', 'is_mandatory', 'display_order', 'is_active']
    list_filter = ['category', 'severity', 'is_mandatory', 'is_active']
    search_fields = ['title', 'description']
    readonly_fields = ['practice_id', 'created_at']
    fieldsets = (
        ('Practice Information', {
            'fields': ('practice_id', 'title', 'category')
        }),
        ('Description', {
            'fields': ('description', 'checklist_items')
        }),
        ('Settings', {
            'fields': ('severity', 'is_mandatory', 'display_order', 'is_active')
        }),
        ('Metadata', {
            'fields': ('created_at',),
            'classes': ('collapse',)
        }),
    )


@admin.register(StaticAnalysisResult)
class StaticAnalysisResultAdmin(admin.ModelAdmin):
    """Admin interface for static analysis results."""
    list_display = ['scan_result', 'md5_hash', 'is_packed', 'analyzed_at']
    list_filter = ['is_packed', 'analyzed_at']
    search_fields = ['md5_hash', 'sha256_hash', 'scan_result__file__original_filename']
    readonly_fields = ['analysis_id', 'analyzed_at']
    filter_horizontal = ['techniques_used']
    fieldsets = (
        ('Analysis Information', {
            'fields': ('analysis_id', 'scan_result', 'analyzed_at')
        }),
        ('Hashes', {
            'fields': ('md5_hash', 'sha1_hash', 'sha256_hash')
        }),
        ('Strings', {
            'fields': ('strings_extracted', 'suspicious_strings'),
            'classes': ('collapse',)
        }),
        ('PE Analysis', {
            'fields': ('pe_data', 'dependencies', 'imports', 'exports'),
            'classes': ('collapse',)
        }),
        ('Packing/Obfuscation', {
            'fields': ('is_packed', 'packer_detected', 'entropy', 'unpacking_suggestions')
        }),
        ('Rules & Signatures', {
            'fields': ('yara_matches', 'sigma_matches'),
            'classes': ('collapse',)
        }),
        ('Disassembly', {
            'fields': ('disassembly_summary', 'code_similarity_matches'),
            'classes': ('collapse',)
        }),
        ('Techniques', {
            'fields': ('techniques_used',)
        }),
    )


@admin.register(DynamicAnalysisResult)
class DynamicAnalysisResultAdmin(admin.ModelAdmin):
    """Admin interface for dynamic analysis results."""
    list_display = ['scan_result', 'sandbox_status', 'anti_vm_detected', 'injection_detected', 'analyzed_at']
    list_filter = ['sandbox_status', 'anti_vm_detected', 'anti_debug_detected', 'injection_detected', 'analyzed_at']
    search_fields = ['scan_result__file__original_filename']
    readonly_fields = ['analysis_id', 'analyzed_at']
    filter_horizontal = ['techniques_used']
    fieldsets = (
        ('Analysis Information', {
            'fields': ('analysis_id', 'scan_result', 'analyzed_at')
        }),
        ('Sandbox Execution', {
            'fields': ('sandbox_status', 'execution_time')
        }),
        ('Process Monitoring', {
            'fields': ('processes_created', 'child_processes'),
            'classes': ('collapse',)
        }),
        ('Filesystem Monitoring', {
            'fields': ('files_created', 'files_modified', 'files_deleted'),
            'classes': ('collapse',)
        }),
        ('Registry Monitoring', {
            'fields': ('registry_keys_created', 'registry_keys_modified', 'registry_keys_deleted'),
            'classes': ('collapse',)
        }),
        ('Network Monitoring', {
            'fields': ('network_connections', 'dns_queries', 'http_requests'),
            'classes': ('collapse',)
        }),
        ('Suspicious Events', {
            'fields': ('anti_vm_detected', 'anti_debug_detected', 'injection_detected', 'evasion_attempts', 'suspicious_api_calls')
        }),
        ('API Tracing', {
            'fields': ('api_trace',),
            'classes': ('collapse',)
        }),
        ('Memory Analysis', {
            'fields': ('memory_dumps', 'memory_iocs'),
            'classes': ('collapse',)
        }),
        ('Techniques', {
            'fields': ('techniques_used',)
        }),
    )


@admin.register(AnalysisReport)
class AnalysisReportAdmin(admin.ModelAdmin):
    """Admin interface for analysis reports."""
    list_display = ['scan_result', 'report_format', 'confidence_score', 'created_at', 'created_by']
    list_filter = ['report_format', 'created_at']
    search_fields = ['scan_result__file__original_filename', 'executive_summary']
    readonly_fields = ['report_id', 'created_at']
    filter_horizontal = ['goals_met', 'techniques_applied', 'malware_types']
    fieldsets = (
        ('Report Information', {
            'fields': ('report_id', 'scan_result', 'created_at', 'created_by')
        }),
        ('Analysis', {
            'fields': ('goals_met', 'techniques_applied', 'malware_types', 'confidence_score')
        }),
        ('IOCs', {
            'fields': ('indicators_of_compromise',),
            'classes': ('collapse',)
        }),
        ('Content', {
            'fields': ('executive_summary', 'detailed_findings', 'recommendations')
        }),
        ('Export', {
            'fields': ('report_format', 'report_file')
        }),
    )

