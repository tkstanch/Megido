"""
MALWARE ANALYSER VIEWS

⚠️  CRITICAL SAFETY AND LEGAL NOTICE ⚠️

All scanning and malware-related functionality in this module uses STUB implementations.
NO ACTUAL MALWARE is created, analyzed, or distributed.

See models.py for comprehensive legal warnings and ethical guidelines.
"""

from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.views.decorators.http import require_http_methods
from django.http import JsonResponse, HttpResponse
from django.contrib import messages
from django.utils.html import escape
from django.utils import timezone
from django.core.exceptions import PermissionDenied
from django.db import transaction
import mimetypes
import random

from .models import (
    MalwareSignature, FileUpload, ScanResult, 
    CleaningLog, TestMalwareArtifact, AuditLog
)
from .forms import (
    FileUploadForm, TestMalwareCreationForm, MalwareSignatureForm
)


def get_client_ip(request):
    """Extract client IP address from request."""
    x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
    if x_forwarded_for:
        ip = x_forwarded_for.split(',')[0]
    else:
        ip = request.META.get('REMOTE_ADDR', '127.0.0.1')
    return ip


def log_action(request, action, resource_type, resource_id='', success=True, error_message='', details=None):
    """Helper function to log actions to audit log."""
    AuditLog.objects.create(
        user=request.user if request.user.is_authenticated else None,
        action=action,
        resource_type=resource_type,
        resource_id=str(resource_id),
        ip_address=get_client_ip(request),
        user_agent=request.META.get('HTTP_USER_AGENT', '')[:500],
        details=details or {},
        success=success,
        error_message=error_message
    )


@login_required
def dashboard(request):
    """
    Main dashboard for Malware Analyser.
    Shows recent uploads, scans, and statistics.
    """
    recent_uploads = FileUpload.objects.filter(uploaded_by=request.user).order_by('-uploaded_at')[:10]
    recent_scans = ScanResult.objects.filter(performed_by=request.user).order_by('-started_at')[:10]
    
    # Statistics
    total_uploads = FileUpload.objects.filter(uploaded_by=request.user).count()
    total_scans = ScanResult.objects.filter(performed_by=request.user).count()
    infected_files = ScanResult.objects.filter(performed_by=request.user, is_malicious=True).count()
    clean_files = ScanResult.objects.filter(performed_by=request.user, is_malicious=False).count()
    
    context = {
        'recent_uploads': recent_uploads,
        'recent_scans': recent_scans,
        'total_uploads': total_uploads,
        'total_scans': total_scans,
        'infected_files': infected_files,
        'clean_files': clean_files,
    }
    
    log_action(request, 'view_dashboard', 'dashboard')
    return render(request, 'malware_analyser/dashboard.html', context)


@login_required
@require_http_methods(["GET", "POST"])
def upload_file(request):
    """
    Handle file upload for malware scanning.
    ACCEPTS ALL FILE TYPES as per requirements.
    """
    if request.method == 'POST':
        form = FileUploadForm(request.POST, request.FILES)
        if form.is_valid():
            try:
                uploaded_file = request.FILES['file']
                
                # Sanitize filename
                sanitized_filename = escape(uploaded_file.name)
                
                # Detect MIME type
                mime_type, _ = mimetypes.guess_type(uploaded_file.name)
                if not mime_type:
                    mime_type = 'application/octet-stream'
                
                # Create file upload record
                file_upload = FileUpload(
                    original_filename=sanitized_filename,
                    file=uploaded_file,
                    file_size=uploaded_file.size,
                    mime_type=mime_type,
                    uploaded_by=request.user
                )
                file_upload.save()
                
                # Calculate hashes (STUB)
                file_upload.calculate_hashes()
                
                log_action(
                    request, 
                    'file_upload', 
                    'file', 
                    file_upload.file_id,
                    details={'filename': sanitized_filename, 'size': uploaded_file.size}
                )
                
                messages.success(request, f'File "{sanitized_filename}" uploaded successfully. Redirecting to scan...')
                return redirect('malware_analyser:scan_file', file_id=file_upload.file_id)
                
            except Exception as e:
                error_msg = f'Error uploading file: {str(e)}'
                log_action(request, 'file_upload', 'file', success=False, error_message=error_msg)
                messages.error(request, error_msg)
        else:
            messages.error(request, 'Invalid form data. Please check your upload.')
    else:
        form = FileUploadForm()
    
    return render(request, 'malware_analyser/upload.html', {'form': form})


@login_required
def scan_file(request, file_id):
    """
    Perform malware scan on uploaded file.
    
    STUB IMPLEMENTATION: Real scanning would integrate with:
    - Antivirus engines (ClamAV, etc.)
    - YARA rule matching
    - Sandboxing systems
    - Behavioral analysis
    - Threat intelligence feeds
    """
    file_upload = get_object_or_404(FileUpload, file_id=file_id)
    
    # Check permissions
    if file_upload.uploaded_by != request.user and not request.user.is_staff:
        log_action(request, 'scan_file', 'file', file_id, success=False, error_message='Unauthorized access')
        raise PermissionDenied("You don't have permission to scan this file.")
    
    if request.method == 'POST':
        scan_type = request.POST.get('scan_type', 'full')
        
        # Create scan result
        scan_result = ScanResult.objects.create(
            file=file_upload,
            scan_type=scan_type,
            performed_by=request.user
        )
        
        # STUB: Perform signature-based scanning
        if scan_type in ['signature', 'full']:
            perform_signature_scan(scan_result, file_upload)
        
        # STUB: Perform heuristic scanning
        if scan_type in ['heuristic', 'full']:
            perform_heuristic_scan(scan_result, file_upload)
        
        # Mark as completed
        scan_result.completed_at = timezone.now()
        scan_result.save()
        
        # Update file upload status
        file_upload.is_scanned = True
        file_upload.scan_status = 'infected' if scan_result.is_malicious else 'clean'
        file_upload.save()
        
        log_action(
            request, 
            'scan_completed', 
            'scan', 
            scan_result.scan_id,
            details={
                'file_id': str(file_id),
                'scan_type': scan_type,
                'is_malicious': scan_result.is_malicious
            }
        )
        
        messages.success(request, f'Scan completed. File is {"INFECTED" if scan_result.is_malicious else "CLEAN"}.')
        return redirect('malware_analyser:scan_results', scan_id=scan_result.scan_id)
    
    context = {
        'file': file_upload,
    }
    return render(request, 'malware_analyser/scan.html', context)


def perform_signature_scan(scan_result, file_upload):
    """
    STUB: Signature-based malware detection.
    
    Real implementation would:
    1. Compare file hashes against known malware databases
    2. Match byte patterns using YARA rules
    3. Check against threat intelligence feeds
    4. Verify digital signatures
    """
    # Get active signatures
    signatures = MalwareSignature.objects.filter(is_active=True)
    
    matched_signatures = []
    
    for signature in signatures:
        if signature.signature_type == 'hash':
            # STUB: Compare hash
            if signature.signature_data == file_upload.file_hash_sha256:
                matched_signatures.append(signature)
                scan_result.is_malicious = True
                scan_result.threat_level = signature.severity
                scan_result.detected_malware = signature.name
        
        elif signature.signature_type == 'pattern':
            # STUB: Pattern matching (simplified)
            # Real implementation would use YARA or similar
            if signature.signature_data.lower() in file_upload.original_filename.lower():
                matched_signatures.append(signature)
    
    # Add matched signatures
    if matched_signatures:
        scan_result.matched_signatures.set(matched_signatures)
        scan_result.scan_details['signature_matches'] = len(matched_signatures)
    
    scan_result.scan_details['signature_scan_completed'] = True
    scan_result.save()


def perform_heuristic_scan(scan_result, file_upload):
    """
    STUB: Heuristic malware detection.
    
    Real implementation would:
    1. Analyze file structure and entropy
    2. Check for suspicious API calls
    3. Detect packing/obfuscation
    4. Analyze behavioral indicators
    5. Use machine learning models
    """
    # STUB: Simple heuristic checks based on filename and size
    suspicious_indicators = []
    
    # Check for suspicious extensions in filename
    suspicious_extensions = ['.exe', '.dll', '.scr', '.bat', '.cmd', '.vbs', '.js']
    for ext in suspicious_extensions:
        if file_upload.original_filename.lower().endswith(ext):
            suspicious_indicators.append(f'Executable file type: {ext}')
    
    # Check for double extensions (e.g., .pdf.exe)
    parts = file_upload.original_filename.lower().split('.')
    if len(parts) > 2:
        suspicious_indicators.append('Multiple file extensions detected')
    
    # STUB: Random detection for demonstration (10% chance)
    # Real implementation would never use randomness
    if random.random() < 0.1:
        suspicious_indicators.append('Heuristic pattern match')
        scan_result.is_malicious = True
        scan_result.threat_level = 'medium'
        scan_result.detected_malware = 'Heuristic.Suspicious'
    
    scan_result.scan_details['heuristic_scan_completed'] = True
    scan_result.scan_details['suspicious_indicators'] = suspicious_indicators
    scan_result.save()


@login_required
def scan_results(request, scan_id):
    """Display scan results."""
    scan_result = get_object_or_404(ScanResult, scan_id=scan_id)
    
    # Check permissions
    if scan_result.performed_by != request.user and not request.user.is_staff:
        log_action(request, 'view_scan_results', 'scan', scan_id, success=False, error_message='Unauthorized access')
        raise PermissionDenied("You don't have permission to view these scan results.")
    
    context = {
        'scan': scan_result,
        'matched_signatures': scan_result.matched_signatures.all(),
    }
    
    log_action(request, 'view_scan_results', 'scan', scan_id)
    return render(request, 'malware_analyser/scan_results.html', context)


@login_required
@require_http_methods(["POST"])
def clean_file(request, file_id):
    """
    Clean/remove detected malware from file.
    
    STUB IMPLEMENTATION: Real cleaning would involve:
    - Quarantine procedures
    - Safe file deletion
    - Disinfection where possible
    - System restoration
    - Registry cleanup (Windows)
    """
    file_upload = get_object_or_404(FileUpload, file_id=file_id)
    
    # Check permissions
    if file_upload.uploaded_by != request.user and not request.user.is_staff:
        log_action(request, 'clean_file', 'file', file_id, success=False, error_message='Unauthorized access')
        raise PermissionDenied("You don't have permission to clean this file.")
    
    # Get the latest scan result
    scan_result = file_upload.scan_results.order_by('-started_at').first()
    if not scan_result:
        messages.error(request, 'No scan results found for this file.')
        return redirect('malware_analyser:dashboard')
    
    action_type = request.POST.get('action', 'quarantine')
    
    # STUB: Perform cleaning action
    success = False
    action_details = ''
    
    if action_type == 'quarantine':
        # STUB: Quarantine file
        action_details = f'File quarantined at /quarantine/{file_upload.file_id} (STUB - not actually moved)'
        success = True
        file_upload.scan_status = 'clean'  # Mark as handled
        
    elif action_type == 'delete':
        # STUB: Delete file
        action_details = f'File marked for deletion (STUB - not actually deleted)'
        success = True
        file_upload.scan_status = 'clean'  # Mark as handled
        
    elif action_type == 'clean':
        # STUB: Attempt to clean/disinfect
        action_details = f'File cleaning attempted (STUB - no actual cleaning performed)'
        success = True
        
    file_upload.save()
    
    # Log the cleaning action
    cleaning_log = CleaningLog.objects.create(
        scan_result=scan_result,
        file=file_upload,
        cleaning_action=action_type,
        performed_by=request.user,
        success=success,
        action_details=action_details,
        backup_location=f'/quarantine/{file_upload.file_id}' if action_type == 'quarantine' else ''
    )
    
    log_action(
        request,
        'clean_file',
        'cleaning',
        cleaning_log.cleaning_id,
        success=success,
        details={'action': action_type, 'file_id': str(file_id)}
    )
    
    if success:
        messages.success(request, f'Cleaning action "{action_type}" completed successfully.')
    else:
        messages.error(request, f'Cleaning action "{action_type}" failed.')
    
    return redirect('malware_analyser:scan_results', scan_id=scan_result.scan_id)


def is_staff_or_superuser(user):
    """Check if user is staff or superuser."""
    return user.is_staff or user.is_superuser


@login_required
@user_passes_test(is_staff_or_superuser)
@require_http_methods(["GET", "POST"])
def create_test_malware(request):
    """
    Create test malware artifacts for safe testing.
    
    ⚠️  CRITICAL WARNING ⚠️
    This function is RESTRICTED to staff/superusers only.
    
    LEGAL REQUIREMENTS:
    - Only use in authorized testing environments
    - Obtain proper authorization before use
    - Document all usage for audit purposes
    
    STUB IMPLEMENTATION: Only creates benign test files.
    NO ACTUAL MALWARE IS CREATED.
    """
    if request.method == 'POST':
        form = TestMalwareCreationForm(request.POST)
        if form.is_valid():
            try:
                with transaction.atomic():
                    artifact = form.save(commit=False)
                    artifact.created_by = request.user
                    artifact.save()
                    
                    # Generate test content based on type
                    if artifact.artifact_type == 'eicar_test':
                        artifact.generate_eicar_test()
                    else:
                        artifact.generate_benign_test()
                    
                    log_action(
                        request,
                        'create_test_artifact',
                        'test_malware',
                        artifact.artifact_id,
                        details={
                            'name': artifact.name,
                            'type': artifact.artifact_type,
                            'purpose': artifact.purpose
                        }
                    )
                    
                    messages.success(request, f'Test artifact "{artifact.name}" created successfully.')
                    return redirect('malware_analyser:test_artifact_details', artifact_id=artifact.artifact_id)
                    
            except Exception as e:
                error_msg = f'Error creating test artifact: {str(e)}'
                log_action(request, 'create_test_artifact', 'test_malware', success=False, error_message=error_msg)
                messages.error(request, error_msg)
        else:
            messages.error(request, 'Invalid form data. Please check your input.')
    else:
        form = TestMalwareCreationForm()
    
    context = {
        'form': form,
    }
    return render(request, 'malware_analyser/create_test_malware.html', context)


@login_required
@user_passes_test(is_staff_or_superuser)
def test_artifact_details(request, artifact_id):
    """View details of a test malware artifact."""
    artifact = get_object_or_404(TestMalwareArtifact, artifact_id=artifact_id)
    
    log_action(request, 'view_test_artifact', 'test_malware', artifact_id)
    
    context = {
        'artifact': artifact,
    }
    return render(request, 'malware_analyser/test_artifact_details.html', context)


@login_required
@user_passes_test(is_staff_or_superuser)
def manage_signatures(request):
    """Manage malware signatures."""
    if request.method == 'POST':
        form = MalwareSignatureForm(request.POST)
        if form.is_valid():
            signature = form.save(commit=False)
            signature.created_by = request.user
            signature.save()
            
            log_action(
                request,
                'create_signature',
                'signature',
                signature.id,
                details={'name': signature.name, 'type': signature.signature_type}
            )
            
            messages.success(request, f'Signature "{signature.name}" created successfully.')
            return redirect('malware_analyser:manage_signatures')
        else:
            messages.error(request, 'Invalid form data.')
    else:
        form = MalwareSignatureForm()
    
    signatures = MalwareSignature.objects.all().order_by('-created_at')
    
    context = {
        'form': form,
        'signatures': signatures,
    }
    return render(request, 'malware_analyser/manage_signatures.html', context)
