"""
MALWARE ANALYSER UNIT TESTS

Tests for all major functionality including:
- File upload
- Signature-based scanning (stub)
- Heuristic scanning (stub)
- Malware cleaning (stub)
- Test artifact creation (authorization)
- Model relationships
"""

from django.test import TestCase, Client
from django.contrib.auth.models import User
from django.core.files.uploadedfile import SimpleUploadedFile
from django.utils import timezone
from django.urls import reverse
import uuid

from .models import (
    MalwareSignature, FileUpload, ScanResult,
    CleaningLog, TestMalwareArtifact, AuditLog
)


class MalwareSignatureTestCase(TestCase):
    """Test malware signature model and functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123!',
            is_staff=True
        )
    
    def test_signature_creation(self):
        """Test creating a malware signature."""
        signature = MalwareSignature.objects.create(
            name='Test Malware Signature',
            signature_type='hash',
            signature_data='abc123def456',
            severity='high',
            description='Test signature for unit testing',
            malware_family='TestFamily',
            created_by=self.user
        )
        
        self.assertEqual(signature.name, 'Test Malware Signature')
        self.assertEqual(signature.signature_type, 'hash')
        self.assertEqual(signature.severity, 'high')
        self.assertTrue(signature.is_active)
    
    def test_signature_string_representation(self):
        """Test string representation of signature."""
        signature = MalwareSignature.objects.create(
            name='Test Sig',
            signature_type='pattern',
            signature_data='test',
            created_by=self.user
        )
        
        self.assertIn('Test Sig', str(signature))
        self.assertIn('Byte Pattern', str(signature))


class FileUploadTestCase(TestCase):
    """Test file upload model and functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123!'
        )
        self.client = Client()
    
    def test_file_upload_creation(self):
        """Test creating a file upload record."""
        file_content = b'Test file content for scanning'
        file_upload = FileUpload.objects.create(
            original_filename='test_file.txt',
            file=SimpleUploadedFile('test.txt', file_content),
            file_size=len(file_content),
            mime_type='text/plain',
            uploaded_by=self.user
        )
        
        self.assertIsNotNone(file_upload.file_id)
        self.assertIsInstance(file_upload.file_id, uuid.UUID)
        self.assertEqual(file_upload.original_filename, 'test_file.txt')
        self.assertEqual(file_upload.scan_status, 'pending')
        self.assertFalse(file_upload.is_scanned)
    
    def test_file_hash_calculation(self):
        """Test hash calculation (STUB)."""
        file_content = b'Test content'
        file_upload = FileUpload.objects.create(
            original_filename='test.txt',
            file=SimpleUploadedFile('test.txt', file_content),
            file_size=len(file_content),
            mime_type='text/plain',
            uploaded_by=self.user
        )
        
        file_upload.calculate_hashes()
        
        # Hashes should be calculated (even if stub)
        self.assertIsNotNone(file_upload.file_hash_md5)
        self.assertIsNotNone(file_upload.file_hash_sha256)
        self.assertEqual(len(file_upload.file_hash_md5), 32)
        self.assertEqual(len(file_upload.file_hash_sha256), 64)
    
    def test_file_upload_view_requires_authentication(self):
        """Test that file upload requires authentication."""
        response = self.client.get(reverse('malware_analyser:upload_file'))
        # Should redirect to login
        self.assertEqual(response.status_code, 302)
    
    def test_file_upload_accepts_all_types(self):
        """Test that all file types are accepted."""
        self.client.login(username='testuser', password='testpass123!')
        
        # Test various file types
        file_types = [
            ('test.txt', b'text content', 'text/plain'),
            ('test.pdf', b'pdf content', 'application/pdf'),
            ('test.exe', b'exe content', 'application/x-msdownload'),
            ('test.jpg', b'jpg content', 'image/jpeg'),
        ]
        
        for filename, content, mime_type in file_types:
            uploaded_file = SimpleUploadedFile(filename, content)
            response = self.client.post(
                reverse('malware_analyser:upload_file'),
                {'file': uploaded_file}
            )
            # Should accept and redirect
            self.assertIn(response.status_code, [302, 200])


class ScanResultTestCase(TestCase):
    """Test scan result model and scanning functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123!'
        )
        self.file_upload = FileUpload.objects.create(
            original_filename='test.txt',
            file=SimpleUploadedFile('test.txt', b'test content'),
            file_size=100,
            mime_type='text/plain',
            uploaded_by=self.user
        )
    
    def test_scan_result_creation(self):
        """Test creating a scan result."""
        scan = ScanResult.objects.create(
            file=self.file_upload,
            scan_type='full',
            performed_by=self.user
        )
        
        self.assertIsNotNone(scan.scan_id)
        self.assertEqual(scan.file, self.file_upload)
        self.assertEqual(scan.threat_level, 'none')
        self.assertFalse(scan.is_malicious)
    
    def test_signature_based_scan(self):
        """Test signature-based scanning (STUB)."""
        # Create a signature
        signature = MalwareSignature.objects.create(
            name='Test Signature',
            signature_type='hash',
            signature_data='test_hash',
            severity='high',
            created_by=self.user
        )
        
        # Create scan
        scan = ScanResult.objects.create(
            file=self.file_upload,
            scan_type='signature',
            performed_by=self.user
        )
        
        # Add matched signature
        scan.matched_signatures.add(signature)
        scan.is_malicious = True
        scan.threat_level = 'high'
        scan.save()
        
        self.assertTrue(scan.is_malicious)
        self.assertEqual(scan.matched_signatures.count(), 1)
        self.assertEqual(scan.threat_level, 'high')
    
    def test_heuristic_scan(self):
        """Test heuristic scanning (STUB)."""
        scan = ScanResult.objects.create(
            file=self.file_upload,
            scan_type='heuristic',
            performed_by=self.user,
            scan_details={'heuristic_scan_completed': True}
        )
        
        self.assertEqual(scan.scan_type, 'heuristic')
        self.assertTrue(scan.scan_details.get('heuristic_scan_completed'))
    
    def test_scan_view_requires_authentication(self):
        """Test that scanning requires authentication."""
        client = Client()
        response = client.get(
            reverse('malware_analyser:scan_file', kwargs={'file_id': self.file_upload.file_id})
        )
        self.assertEqual(response.status_code, 302)  # Redirect to login


class CleaningLogTestCase(TestCase):
    """Test cleaning/removal functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123!'
        )
        self.file_upload = FileUpload.objects.create(
            original_filename='infected.exe',
            file=SimpleUploadedFile('infected.exe', b'malicious content'),
            file_size=100,
            mime_type='application/x-msdownload',
            uploaded_by=self.user
        )
        self.scan_result = ScanResult.objects.create(
            file=self.file_upload,
            scan_type='full',
            is_malicious=True,
            threat_level='high',
            detected_malware='Test.Malware',
            performed_by=self.user
        )
    
    def test_cleaning_log_creation(self):
        """Test creating a cleaning log."""
        cleaning_log = CleaningLog.objects.create(
            scan_result=self.scan_result,
            file=self.file_upload,
            cleaning_action='quarantine',
            performed_by=self.user,
            success=True,
            action_details='File quarantined successfully',
            backup_location='/quarantine/test'
        )
        
        self.assertIsNotNone(cleaning_log.cleaning_id)
        self.assertEqual(cleaning_log.cleaning_action, 'quarantine')
        self.assertTrue(cleaning_log.success)
    
    def test_quarantine_action(self):
        """Test quarantine action (STUB)."""
        cleaning_log = CleaningLog.objects.create(
            scan_result=self.scan_result,
            file=self.file_upload,
            cleaning_action='quarantine',
            performed_by=self.user,
            success=True
        )
        
        self.assertEqual(cleaning_log.cleaning_action, 'quarantine')
        self.assertTrue(cleaning_log.success)
    
    def test_delete_action(self):
        """Test delete action (STUB)."""
        cleaning_log = CleaningLog.objects.create(
            scan_result=self.scan_result,
            file=self.file_upload,
            cleaning_action='delete',
            performed_by=self.user,
            success=True
        )
        
        self.assertEqual(cleaning_log.cleaning_action, 'delete')
    
    def test_clean_action(self):
        """Test clean/disinfect action (STUB)."""
        cleaning_log = CleaningLog.objects.create(
            scan_result=self.scan_result,
            file=self.file_upload,
            cleaning_action='clean',
            performed_by=self.user,
            success=True
        )
        
        self.assertEqual(cleaning_log.cleaning_action, 'clean')


class TestMalwareArtifactTestCase(TestCase):
    """Test test malware artifact creation (authorization required)."""
    
    def setUp(self):
        self.staff_user = User.objects.create_user(
            username='staffuser',
            password='testpass123!',
            is_staff=True
        )
        self.regular_user = User.objects.create_user(
            username='regularuser',
            password='testpass123!'
        )
        self.client = Client()
    
    def test_artifact_creation_requires_staff(self):
        """Test that test artifact creation requires staff/superuser."""
        # Regular user should not have access
        self.client.login(username='regularuser', password='testpass123!')
        response = self.client.get(reverse('malware_analyser:create_test_malware'))
        self.assertEqual(response.status_code, 302)  # Redirect due to permission denied
        
        # Staff user should have access
        self.client.login(username='staffuser', password='testpass123!')
        response = self.client.get(reverse('malware_analyser:create_test_malware'))
        self.assertEqual(response.status_code, 200)
    
    def test_benign_test_artifact_creation(self):
        """Test creating a benign test artifact."""
        artifact = TestMalwareArtifact.objects.create(
            name='Benign Test File',
            artifact_type='benign_test',
            description='Test artifact for unit testing',
            purpose='Unit test validation',
            created_by=self.staff_user
        )
        
        artifact.generate_benign_test()
        
        self.assertIsNotNone(artifact.artifact_id)
        self.assertEqual(artifact.artifact_type, 'benign_test')
        self.assertIn('BENIGN TEST FILE', artifact.file_content)
        self.assertTrue(artifact.is_active)
    
    def test_eicar_test_generation(self):
        """Test EICAR test string generation."""
        artifact = TestMalwareArtifact.objects.create(
            name='EICAR Test',
            artifact_type='eicar_test',
            description='EICAR standard test file',
            purpose='AV testing',
            created_by=self.staff_user
        )
        
        artifact.generate_eicar_test()
        
        self.assertEqual(artifact.artifact_type, 'eicar_test')
        self.assertIn('EICAR-STANDARD-ANTIVIRUS-TEST-FILE', artifact.file_content)
    
    def test_artifact_authorization_documented(self):
        """Test that artifact creation requires authorization documentation."""
        artifact = TestMalwareArtifact.objects.create(
            name='Test Artifact',
            artifact_type='benign_test',
            description='Test',
            purpose='Testing',
            authorization_reference='Ticket #12345',
            created_by=self.staff_user
        )
        
        self.assertEqual(artifact.authorization_reference, 'Ticket #12345')


class AuditLogTestCase(TestCase):
    """Test audit logging functionality."""
    
    def setUp(self):
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123!'
        )
    
    def test_audit_log_creation(self):
        """Test creating an audit log entry."""
        log = AuditLog.objects.create(
            user=self.user,
            action='file_upload',
            resource_type='file',
            resource_id='test-uuid',
            ip_address='127.0.0.1',
            success=True
        )
        
        self.assertIsNotNone(log.log_id)
        self.assertEqual(log.action, 'file_upload')
        self.assertTrue(log.success)
    
    def test_audit_log_captures_failures(self):
        """Test that audit log captures failures."""
        log = AuditLog.objects.create(
            user=self.user,
            action='scan_file',
            resource_type='file',
            success=False,
            error_message='Permission denied'
        )
        
        self.assertFalse(log.success)
        self.assertEqual(log.error_message, 'Permission denied')


class IntegrationTestCase(TestCase):
    """Integration tests for complete workflows."""
    
    def setUp(self):
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123!'
        )
        self.client = Client()
        self.client.login(username='testuser', password='testpass123!')
    
    def test_complete_scan_workflow(self):
        """Test complete workflow: upload -> scan -> view results."""
        # 1. Upload file
        file_content = b'Test file for complete workflow'
        uploaded_file = SimpleUploadedFile('workflow_test.txt', file_content)
        
        response = self.client.post(
            reverse('malware_analyser:upload_file'),
            {'file': uploaded_file}
        )
        
        # Should redirect to scan page
        self.assertEqual(response.status_code, 302)
        
        # 2. Get the uploaded file
        file_upload = FileUpload.objects.filter(uploaded_by=self.user).first()
        self.assertIsNotNone(file_upload)
        
        # 3. Perform scan
        response = self.client.post(
            reverse('malware_analyser:scan_file', kwargs={'file_id': file_upload.file_id}),
            {'scan_type': 'full'}
        )
        
        # Should redirect to results
        self.assertEqual(response.status_code, 302)
        
        # 4. Check scan was created
        scan = ScanResult.objects.filter(file=file_upload).first()
        self.assertIsNotNone(scan)
        self.assertIsNotNone(scan.completed_at)


class SecurityTestCase(TestCase):
    """Security-focused tests."""
    
    def setUp(self):
        self.user1 = User.objects.create_user(
            username='user1',
            password='testpass123!'
        )
        self.user2 = User.objects.create_user(
            username='user2',
            password='testpass123!'
        )
        self.client = Client()
    
    def test_user_cannot_access_other_users_files(self):
        """Test that users cannot access other users' files."""
        # User1 uploads a file
        file_upload = FileUpload.objects.create(
            original_filename='private.txt',
            file=SimpleUploadedFile('private.txt', b'private content'),
            file_size=100,
            mime_type='text/plain',
            uploaded_by=self.user1
        )
        
        # User2 tries to scan it
        self.client.login(username='user2', password='testpass123!')
        response = self.client.get(
            reverse('malware_analyser:scan_file', kwargs={'file_id': file_upload.file_id})
        )
        
        # Should be denied (403 or redirect)
        self.assertIn(response.status_code, [403, 302])

