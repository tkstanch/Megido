# Generated migration for malware analyser upgrade

import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('malware_analyser', '0002_analysistechnique_bestpractice_malwaretype_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        # --- Extend ScanResult ---
        migrations.AddField(
            model_name='scanresult',
            name='celery_task_id',
            field=models.CharField(
                blank=True,
                help_text='Celery task ID for async analysis',
                max_length=255,
            ),
        ),
        migrations.AddField(
            model_name='scanresult',
            name='analysis_pipeline_status',
            field=models.JSONField(
                blank=True,
                default=dict,
                help_text='Per-stage pipeline status',
            ),
        ),
        migrations.AddField(
            model_name='scanresult',
            name='total_analysis_time',
            field=models.FloatField(
                blank=True,
                help_text='Total analysis time in seconds',
                null=True,
            ),
        ),
        # --- Extend StaticAnalysisResult ---
        migrations.AddField(
            model_name='staticanalysisresult',
            name='ssdeep_hash',
            field=models.CharField(
                blank=True,
                help_text='ssdeep fuzzy hash',
                max_length=255,
            ),
        ),
        migrations.AddField(
            model_name='staticanalysisresult',
            name='tlsh_hash',
            field=models.CharField(
                blank=True,
                help_text='TLSH locality-sensitive hash',
                max_length=255,
            ),
        ),
        migrations.AddField(
            model_name='staticanalysisresult',
            name='imphash',
            field=models.CharField(
                blank=True,
                help_text='PE import hash',
                max_length=32,
            ),
        ),
        migrations.AddField(
            model_name='staticanalysisresult',
            name='file_format',
            field=models.CharField(
                blank=True,
                choices=[
                    ('pe', 'PE (Windows)'),
                    ('elf', 'ELF (Linux)'),
                    ('macho', 'Mach-O (macOS)'),
                    ('apk', 'APK (Android)'),
                    ('doc', 'Document (Office/PDF)'),
                    ('firmware', 'Firmware'),
                    ('archive', 'Archive'),
                    ('other', 'Other'),
                ],
                default='other',
                max_length=20,
            ),
        ),
        migrations.AddField(
            model_name='staticanalysisresult',
            name='format_specific_data',
            field=models.JSONField(
                blank=True,
                default=dict,
                help_text='Format-specific analysis data',
            ),
        ),
        # --- Extend DynamicAnalysisResult ---
        migrations.AddField(
            model_name='dynamicanalysisresult',
            name='sandbox_type',
            field=models.CharField(
                blank=True,
                choices=[
                    ('cuckoo', 'Cuckoo Sandbox'),
                    ('cape', 'CAPE Sandbox'),
                    ('anyrun', 'ANY.RUN'),
                    ('docker', 'Local Docker'),
                    ('none', 'None'),
                ],
                default='none',
                max_length=50,
            ),
        ),
        migrations.AddField(
            model_name='dynamicanalysisresult',
            name='sandbox_report_url',
            field=models.URLField(
                blank=True,
                help_text='URL to full sandbox report',
            ),
        ),
        migrations.AddField(
            model_name='dynamicanalysisresult',
            name='dropped_files',
            field=models.JSONField(
                default=list,
                help_text='Files dropped during execution',
            ),
        ),
        migrations.AddField(
            model_name='dynamicanalysisresult',
            name='screenshots',
            field=models.JSONField(
                default=list,
                help_text='Screenshot file paths',
            ),
        ),
        migrations.AddField(
            model_name='dynamicanalysisresult',
            name='pcap_path',
            field=models.CharField(
                blank=True,
                help_text='Path to captured PCAP file',
                max_length=500,
            ),
        ),
        # --- New model: ThreatIntelResult ---
        migrations.CreateModel(
            name='ThreatIntelResult',
            fields=[
                ('result_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False, unique=True)),
                ('lookup_hash', models.CharField(db_index=True, help_text='Hash used for lookup', max_length=64)),
                ('source', models.CharField(
                    choices=[
                        ('virustotal', 'VirusTotal'),
                        ('malwarebazaar', 'MalwareBazaar'),
                        ('otx', 'AlienVault OTX'),
                        ('threatfox', 'ThreatFox'),
                        ('misp', 'MISP'),
                    ],
                    default='virustotal',
                    max_length=50,
                )),
                ('detection_ratio', models.CharField(blank=True, help_text='e.g. 45/72', max_length=20)),
                ('is_malicious', models.BooleanField(blank=True, null=True)),
                ('raw_response', models.JSONField(blank=True, default=dict, help_text='Raw API response')),
                ('cached_at', models.DateTimeField(auto_now_add=True)),
                ('expires_at', models.DateTimeField(blank=True, help_text='Cache expiry time', null=True)),
                ('file', models.ForeignKey(
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='threat_intel_results',
                    to='malware_analyser.fileupload',
                )),
            ],
            options={'ordering': ['-cached_at']},
        ),
        migrations.AddIndex(
            model_name='threatintelresult',
            index=models.Index(fields=['lookup_hash', 'source'], name='malware_ana_lookup__thrte_idx'),
        ),
        # --- New model: MalwareConfig ---
        migrations.CreateModel(
            name='MalwareConfig',
            fields=[
                ('config_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False, unique=True)),
                ('extractor_name', models.CharField(help_text='Name of the config extractor used', max_length=255)),
                ('malware_family', models.CharField(blank=True, max_length=255)),
                ('config_data', models.JSONField(default=dict, help_text='Extracted configuration data')),
                ('c2_urls', models.JSONField(default=list, help_text='Extracted C2 URLs/IPs')),
                ('encryption_keys', models.JSONField(default=list, help_text='Detected encryption keys')),
                ('campaign_id', models.CharField(blank=True, max_length=255)),
                ('extracted_at', models.DateTimeField(auto_now_add=True)),
                ('scan_result', models.ForeignKey(
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='malware_configs',
                    to='malware_analyser.scanresult',
                )),
            ],
            options={'ordering': ['-extracted_at']},
        ),
        # --- New model: NetworkAnalysisResult ---
        migrations.CreateModel(
            name='NetworkAnalysisResult',
            fields=[
                ('analysis_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False, unique=True)),
                ('pcap_file', models.CharField(blank=True, max_length=500)),
                ('protocols_detected', models.JSONField(default=list)),
                ('c2_indicators', models.JSONField(default=list, help_text='Detected C2 traffic indicators')),
                ('dns_queries', models.JSONField(default=list)),
                ('http_requests', models.JSONField(default=list)),
                ('tls_fingerprints', models.JSONField(default=list, help_text='JA3/JA3S fingerprints')),
                ('extracted_iocs', models.JSONField(default=dict, help_text='IPs, domains, URLs from traffic')),
                ('suricata_rules', models.TextField(blank=True, help_text='Auto-generated Suricata rules')),
                ('analyzed_at', models.DateTimeField(auto_now_add=True)),
                ('scan_result', models.OneToOneField(
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='network_analysis',
                    to='malware_analyser.scanresult',
                )),
            ],
            options={'ordering': ['-analyzed_at']},
        ),
        # --- New model: MemoryAnalysisResult ---
        migrations.CreateModel(
            name='MemoryAnalysisResult',
            fields=[
                ('analysis_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False, unique=True)),
                ('dump_path', models.CharField(blank=True, help_text='Path to memory dump file', max_length=500)),
                ('volatility_available', models.BooleanField(default=False)),
                ('plugin_results', models.JSONField(default=dict, help_text='Volatility plugin output keyed by plugin name')),
                ('injected_code', models.JSONField(default=list, help_text='Detected injected code regions')),
                ('hollowed_processes', models.JSONField(default=list)),
                ('extracted_strings', models.JSONField(default=list)),
                ('memory_iocs', models.JSONField(default=dict, help_text='IPs, domains, file paths from memory')),
                ('analyzed_at', models.DateTimeField(auto_now_add=True)),
                ('scan_result', models.OneToOneField(
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='memory_analysis',
                    to='malware_analyser.scanresult',
                )),
            ],
            options={'ordering': ['-analyzed_at']},
        ),
        # --- New model: YARARule ---
        migrations.CreateModel(
            name='YARARule',
            fields=[
                ('rule_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False, unique=True)),
                ('name', models.CharField(max_length=255)),
                ('rule_content', models.TextField(help_text='YARA rule source code')),
                ('description', models.TextField(blank=True)),
                ('is_compiled', models.BooleanField(default=False)),
                ('compile_error', models.TextField(blank=True, help_text='Compilation error message if any')),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('author', models.ForeignKey(
                    null=True,
                    on_delete=django.db.models.deletion.SET_NULL,
                    related_name='yara_rules',
                    to=settings.AUTH_USER_MODEL,
                )),
            ],
            options={'ordering': ['-created_at']},
        ),
        # --- New model: ATTACKMapping ---
        migrations.CreateModel(
            name='ATTACKMapping',
            fields=[
                ('mapping_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False, unique=True)),
                ('technique_id', models.CharField(help_text='ATT&CK technique ID (e.g. T1055)', max_length=20)),
                ('technique_name', models.CharField(max_length=255)),
                ('tactic', models.CharField(blank=True, help_text='ATT&CK tactic (e.g. Defense Evasion)', max_length=100)),
                ('evidence', models.TextField(blank=True, help_text='Evidence supporting the mapping')),
                ('confidence', models.FloatField(default=0.5, help_text='Confidence score 0-1')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('scan_result', models.ForeignKey(
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='attack_mappings',
                    to='malware_analyser.scanresult',
                )),
            ],
            options={'ordering': ['technique_id']},
        ),
        migrations.AddIndex(
            model_name='attackmapping',
            index=models.Index(fields=['scan_result', 'technique_id'], name='malware_ana_scan_re_attack_idx'),
        ),
    ]
