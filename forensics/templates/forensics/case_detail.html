{% extends "base.html" %}
{% load static %}
{% block title %}Case {{ case.case_number }} - Digital Forensics - Megido Security{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="max-w-6xl mx-auto">
    <div class="mb-6">
      <a href="{% url 'forensics:case_list' %}" class="text-blue-600 hover:text-blue-800 inline-flex items-center mb-2">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
        Back to Cases
      </a>
      <div class="flex items-start justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">{{ case.case_number }}</h1>
          <p class="text-xl text-gray-600 mt-1">{{ case.title }}</p>
        </div>
        <div class="flex gap-2">
          <a href="{% url 'forensics:report_generate' case.pk %}?format=html" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">Generate Report</a>
          <a href="{% url 'forensics:report_generate' case.pk %}?format=json" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">JSON Report</a>
        </div>
      </div>
    </div>
    {% if messages %}{% for message in messages %}<div class="mb-4 p-4 rounded {% if message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">{{ message }}</div>{% endfor %}{% endif %}
    <!-- Case Info -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow-md p-4">
        <dt class="text-xs font-medium text-gray-500 uppercase">Status</dt>
        <dd class="mt-1"><span class="px-2 py-1 text-sm rounded-full {% if case.status == 'open' %}bg-green-100 text-green-800{% elif case.status == 'active' %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-800{% endif %}">{{ case.get_status_display }}</span></dd>
      </div>
      <div class="bg-white rounded-lg shadow-md p-4">
        <dt class="text-xs font-medium text-gray-500 uppercase">Classification</dt>
        <dd class="mt-1 text-sm font-medium text-gray-900">{{ case.get_classification_display }}</dd>
      </div>
      <div class="bg-white rounded-lg shadow-md p-4">
        <dt class="text-xs font-medium text-gray-500 uppercase">Created</dt>
        <dd class="mt-1 text-sm text-gray-900">{{ case.created_at|date:"Y-m-d H:i" }}</dd>
      </div>
    </div>
    {% if case.description %}
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-2">Description</h2>
      <p class="text-gray-700">{{ case.description }}</p>
    </div>
    {% endif %}
    <!-- Evidence Items -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-900">Evidence Items ({{ evidence_items|length }})</h2>
      </div>
      {% if evidence_items %}
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50"><tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acquisition</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Verified</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
          </tr></thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for ev in evidence_items %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ ev.name }}</td>
              <td class="px-6 py-4 text-sm text-gray-500">{{ ev.get_acquisition_type_display }}</td>
              <td class="px-6 py-4 text-sm">{% if ev.integrity_verified %}<span class="text-green-600">âœ“</span>{% else %}<span class="text-gray-400">-</span>{% endif %}</td>
              <td class="px-6 py-4 text-sm text-gray-500">{{ ev.acquisition_timestamp|date:"Y-m-d" }}</td>
              <td class="px-6 py-4 text-sm"><a href="{% url 'forensics:evidence_detail' ev.pk %}" class="text-blue-600 hover:text-blue-900">View</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="p-6 text-center text-gray-500">No evidence items.</div>
      {% endif %}
    </div>
    <!-- Files -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900">Files ({{ files|length }})</h2>
      </div>
      {% if files %}
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50"><tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Filename</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entropy</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
          </tr></thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for f in files %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ f.original_filename }}</td>
              <td class="px-6 py-4 text-sm text-gray-500">{{ f.file_type }}</td>
              <td class="px-6 py-4 text-sm text-gray-500">{{ f.file_size|filesizeformat }}</td>
              <td class="px-6 py-4 text-sm {% if f.entropy and f.entropy > 7.2 %}text-red-600{% elif f.entropy and f.entropy > 6.8 %}text-yellow-600{% else %}text-gray-500{% endif %}">{{ f.entropy|floatformat:2|default:"-" }}</td>
              <td class="px-6 py-4 text-sm"><a href="{% url 'forensics:file_detail' f.pk %}" class="text-blue-600 hover:text-blue-900">View</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="p-6 text-center text-gray-500">No files linked to this case.</div>
      {% endif %}
    </div>
    <!-- IOCs -->
    {% if iocs %}
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900">IOC Indicators ({{ iocs|length }}+)</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50"><tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Value</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Confidence</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
          </tr></thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for ioc in iocs %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ ioc.ioc_type }}</td>
              <td class="px-6 py-4 text-sm font-mono text-gray-700 break-all">{{ ioc.ioc_value|truncatechars:80 }}</td>
              <td class="px-6 py-4 text-sm"><span class="px-2 py-1 rounded text-xs {% if ioc.confidence == 'high' %}bg-red-100 text-red-800{% elif ioc.confidence == 'medium' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">{{ ioc.confidence }}</span></td>
              <td class="px-6 py-4 text-sm text-gray-500">{{ ioc.source }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
    <!-- Timeline -->
    {% if timeline %}
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900">Timeline ({{ timeline|length }} events)</h2>
      </div>
      <div class="p-6">
        <div class="space-y-2">
          {% for ev in timeline %}
          <div class="flex gap-4 py-2 border-b border-gray-100">
            <span class="text-xs text-gray-400 font-mono w-36 shrink-0">{{ ev.event_time|date:"Y-m-d H:i" }}</span>
            <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-800 rounded shrink-0">{{ ev.event_type }}</span>
            <span class="text-sm text-gray-700">{{ ev.description }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
    <!-- Reports -->
    {% if reports %}
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900">Reports</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50"><tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Format</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Generated</th>
          </tr></thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for r in reports %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 text-sm text-gray-900">{{ r.title }}</td>
              <td class="px-6 py-4 text-sm text-gray-500">{{ r.get_report_type_display }}</td>
              <td class="px-6 py-4 text-sm text-gray-500">{{ r.format|upper }}</td>
              <td class="px-6 py-4 text-sm text-gray-500">{{ r.generated_at|date:"Y-m-d H:i" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
